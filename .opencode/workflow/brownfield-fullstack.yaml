name: Brownfield Full-Stack Enhancement Workflow
description: Workflow for enhancing existing codebases with new features or refactoring
type: brownfield
project_type: fullstack

# NOTE: This workflow is selected via keywords defined in .opencode/config.yaml workflow_selection section.
# The routing system matches user prompts against keywords in config.yaml, not this file.
# See .opencode/config.yaml for the authoritative keyword list used by the routing system.

# This workflow is optimized for existing projects:
# - Emphasizes impact analysis and compatibility
# - Includes migration planning and rollback strategies
# - Focuses on incremental improvements

steps:
  - step: 0
    name: "Planning Phase"
    agent: planner
    inputs:
      - user_requirements
      - existing_codebase
      - business_objectives
    outputs:
      - plan-{{workflow_id}}.md
      - plan-{{workflow_id}}.json
      - reasoning: .opencode/context/history/reasoning/{{workflow_id}}/00-planner.json
    validation:
      schema: .opencode/schema/plan.schema.json
      gate: .opencode/context/history/gates/{{workflow_id}}/00-planner.json
    description: |
      Plan brownfield enhancement workflow:
      - Analyze requirements and existing codebase
      - Coordinate enhancement strategy
      - Create structured improvement plan

  - step: 1
    name: "Codebase Discovery & Impact Analysis"
    agent: analyst
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - user_requirements
      - existing_codebase
      - business_objectives
    outputs:
      - project-brief-{{workflow_id}}.json
      - impact-analysis-{{workflow_id}}.json
      - reasoning: .opencode/context/history/reasoning/{{workflow_id}}/01-analyst.json
    validation:
      schema: .opencode/schema/project-brief.schema.json
      gate: .opencode/context/history/gates/{{workflow_id}}/01-analyst.json
    notes: |
      Focus on understanding existing patterns, identifying risks,
      and documenting current architecture before proposing changes.

  - step: 2
    name: "Enhancement Requirements"
    agent: pm
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - project-brief-{{workflow_id}}.json (from step 1)
      - impact-analysis-{{workflow_id}}.json (from step 1)
    outputs:
      - prd-{{workflow_id}}.json
      - migration-requirements-{{workflow_id}}.json
      - reasoning: .opencode/context/history/reasoning/{{workflow_id}}/02-pm.json
    validation:
      schema: .opencode/schema/prd.schema.json
      gate: .opencode/context/history/gates/{{workflow_id}}/02-pm.json
    notes: |
      Emphasize backward compatibility requirements,
      feature flags, and phased rollout considerations.

  - step: 3
    name: "Architecture Evolution"
    agent: architect
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - prd-{{workflow_id}}.json (from step 2)
      - impact-analysis-{{workflow_id}}.json (from step 1)
      - existing-architecture (optional)
    outputs:
      - system-architecture-{{workflow_id}}.json
      - migration-plan-{{workflow_id}}.json
      - reasoning: .opencode/context/history/reasoning/{{workflow_id}}/03-architect.json
    validation:
      schema: .opencode/schema/architecture.schema.json
      gate: .opencode/context/history/gates/{{workflow_id}}/03-architect.json
    notes: |
      Design for incremental adoption. Include rollback strategies
      and compatibility shims where needed.

  - step: 4
    name: "Database Migration Planning"
    agent: database-architect
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - system-architecture-{{workflow_id}}.json (from step 3)
      - prd-{{workflow_id}}.json (from step 2)
      - existing-schema (optional)
    outputs:
      - database-architecture-{{workflow_id}}.json
      - migration-scripts-{{workflow_id}}.json
      - rollback-plan-{{workflow_id}}.json
      - reasoning: .opencode/context/history/reasoning/{{workflow_id}}/04-database-architect.json
    validation:
      schema: .opencode/schema/architecture.schema.json
      gate: .opencode/context/history/gates/{{workflow_id}}/04-database-architect.json
    notes: |
      Plan zero-downtime migrations. Include dual-write strategies
      and data backfill procedures for existing records.

  - step: 5
    name: "Test Strategy & Regression Planning"
    agent: qa
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - system-architecture-{{workflow_id}}.json (from step 3)
      - database-architecture-{{workflow_id}}.json (from step 4)
      - impact-analysis-{{workflow_id}}.json (from step 1)
    outputs:
      - test-plan-{{workflow_id}}.json
      - regression-suite-{{workflow_id}}.json
      - reasoning: .opencode/context/history/reasoning/{{workflow_id}}/05-qa.json
    validation:
      schema: .opencode/schema/test-plan.schema.json
      gate: .opencode/context/history/gates/{{workflow_id}}/05-qa.json
    notes: |
      Focus on regression testing existing functionality.
      Include integration tests for migration procedures.

  - step: 6
    name: "Implementation"
    agent: developer
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - system-architecture-{{workflow_id}}.json (from step 3)
      - database-architecture-{{workflow_id}}.json (from step 4)
      - test-plan-{{workflow_id}}.json (from step 5)
      - migration-plan-{{workflow_id}}.json (from step 3)
    outputs:
      - dev-manifest-{{workflow_id}}.json
      - code-artifacts
      - migration-artifacts
      - reasoning: .opencode/context/history/reasoning/{{workflow_id}}/06-developer.json
    validation:
      schema: .opencode/schema/artifact_manifest.schema.json
      gate: .opencode/context/history/gates/{{workflow_id}}/06-developer.json
    notes: |
      Implement with feature flags. Create migration scripts
      that can be tested in staging before production.

  - step: 7
    name: "Quality Validation"
    agent: qa
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest-{{workflow_id}}.json (from step 6)
      - test-plan-{{workflow_id}}.json (from step 5)
      - regression-suite-{{workflow_id}}.json (from step 5)
    outputs:
      - quality-report-{{workflow_id}}.json
      - test-results-{{workflow_id}}.json
      - migration-test-results-{{workflow_id}}.json
      - reasoning: .opencode/context/history/reasoning/{{workflow_id}}/07-qa-final.json
    validation:
      gate: .opencode/context/history/gates/{{workflow_id}}/07-qa-final.json

completion_criteria:
  - All artifacts validated against schemas
  - Quality gates passed
  - Regression tests pass with no degradation
  - Migration scripts tested successfully
  - Rollback procedures validated
  - Code follows existing project patterns

rollback_triggers:
  - Test coverage drops below baseline
  - Performance regression detected
  - Migration scripts fail validation
  - Breaking changes to existing APIs
