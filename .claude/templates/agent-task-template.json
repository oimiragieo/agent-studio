{
  "$schema": "../schemas/agent-task.schema.json",
  "task_id": "implement-auth-middleware-001",
  "objective": "Implement JWT-based authentication middleware with role-based access control",
  "context": {
    "problem": "API endpoints lack authentication and authorization. Anyone can access sensitive user data without proper credentials or permission checks.",
    "why_now": "Security audit flagged this as critical vulnerability. Production deployment blocked until auth is implemented.",
    "previous_attempts": [
      "Tried basic auth - doesn't support token refresh or role-based permissions",
      "Evaluated OAuth2 libraries - too complex for current requirements"
    ],
    "related_files": [
      "src/middleware/auth.ts",
      "src/types/user.ts",
      "src/config/jwt.config.ts",
      ".env.example"
    ],
    "dependencies": [
      "User database schema must be finalized",
      "JWT secret must be configured in environment"
    ]
  },
  "deliverables": [
    {
      "type": "file",
      "path": "src/middleware/auth-middleware.ts",
      "description": "JWT authentication middleware with token validation and role checking",
      "format": "typescript",
      "validation": "Must pass type checking and unit tests with 90%+ coverage"
    },
    {
      "type": "test",
      "path": "src/middleware/auth-middleware.test.ts",
      "description": "Comprehensive test suite covering valid tokens, expired tokens, invalid signatures, and role-based access",
      "format": "typescript",
      "validation": "All tests must pass; coverage >= 90%"
    },
    {
      "type": "documentation",
      "path": "src/middleware/README.md",
      "description": "Usage guide with examples of applying middleware to routes and configuring roles",
      "format": "markdown",
      "validation": "Must include setup instructions, API examples, and troubleshooting section"
    }
  ],
  "constraints": {
    "max_time_minutes": 45,
    "max_file_reads": 15,
    "max_tokens": 50000,
    "must_validate": true,
    "allowed_tools": ["Read", "Write", "Edit", "Grep", "Glob"],
    "blocked_operations": [
      "Modifying production environment files",
      "Changing JWT secret rotation logic",
      "Bypassing security validation"
    ]
  },
  "success_criteria": [
    "Middleware correctly validates JWT tokens and rejects invalid/expired tokens",
    "Role-based access control blocks unauthorized users from protected routes",
    "All unit tests pass with >= 90% code coverage",
    "Documentation includes clear setup and usage examples",
    "No security vulnerabilities detected by security-architect review"
  ],
  "priority": "high",
  "assigned_agent": "developer",
  "reasoning_style": "step-by-step",
  "examples": [
    {
      "input": "Valid JWT token with 'admin' role accessing admin-only endpoint",
      "output": "Request proceeds to route handler; user object attached to request context",
      "explanation": "Demonstrates successful authentication and authorization flow"
    },
    {
      "input": "Expired JWT token accessing any protected endpoint",
      "output": "401 Unauthorized with error: 'Token expired'",
      "explanation": "Shows proper handling of expired tokens"
    },
    {
      "input": "Valid JWT token with 'user' role accessing admin-only endpoint",
      "output": "403 Forbidden with error: 'Insufficient permissions'",
      "explanation": "Demonstrates role-based access control enforcement"
    }
  ],
  "uncertainty_permission": true,
  "output_format": {
    "structure": "xml-tagged",
    "sections": [
      {
        "tag": "thinking",
        "description": "Step-by-step reasoning: analyze requirements, consider edge cases, plan implementation approach",
        "required": false
      },
      {
        "tag": "implementation",
        "description": "Complete middleware code with inline comments explaining security decisions",
        "required": true
      },
      {
        "tag": "tests",
        "description": "Test suite covering all success and failure scenarios",
        "required": true
      },
      {
        "tag": "validation",
        "description": "Self-check against success criteria and security best practices",
        "required": true
      }
    ]
  },
  "thinking_budget": 2000,
  "validation_schema": {
    "type": "object",
    "required": ["middleware_created", "tests_created", "coverage_percentage"],
    "properties": {
      "middleware_created": {
        "type": "boolean",
        "description": "Whether auth-middleware.ts was successfully created"
      },
      "tests_created": {
        "type": "boolean",
        "description": "Whether test file was created with passing tests"
      },
      "coverage_percentage": {
        "type": "number",
        "minimum": 90,
        "description": "Code coverage percentage (must be >= 90%)"
      },
      "security_review_passed": {
        "type": "boolean",
        "description": "Whether security review found no critical vulnerabilities"
      }
    }
  },
  "mode": "execute",
  "metadata": {
    "created_at": "2026-01-12T10:00:00Z",
    "created_by": "master-orchestrator",
    "workflow_id": "security-hardening-workflow",
    "step_number": 3,
    "tags": ["security", "authentication", "authorization", "middleware", "jwt"],
    "research_sources": [
      "https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/chain-of-thought",
      "https://aicompetence.org/json-prompting-supercharges-multi-agent-ai-systems/",
      "https://www.braintrust.dev/articles/systematic-prompt-engineering",
      "https://jwt.io/introduction/",
      "https://owasp.org/www-project-top-ten/"
    ]
  }
}
