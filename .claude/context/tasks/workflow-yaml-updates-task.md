# Workflow YAML Updates Task

## Task ID
workflow-yaml-updates-combined-2025-01-06

## Objective
Update all 14 workflow YAML files with combined improvements from Issues #1, #3, and #8.

## Workflows to Update
1. ai-system-flow.yaml
2. automated-enterprise-flow.yaml
3. bmad-greenfield-standard.yaml
4. browser-testing-flow.yaml
5. brownfield-fullstack.yaml
6. code-quality-flow.yaml
7. enterprise-track.yaml
8. greenfield-fullstack.yaml
9. incident-flow.yaml
10. legacy-modernization-flow.yaml
11. mobile-flow.yaml
12. performance-flow.yaml
13. quick-flow.yaml
14. ui-perfection-loop.yaml

## Required Changes for Each Workflow

### 1. Add Template Variable Documentation (at top of file)
```yaml
# Template Variables:
# - {{run_id}}: Unique run identifier (generated by run-manager.mjs)
# - {{plan_id}}: Plan identifier (generated by planner agent)
# - {{workflow_id}}: Workflow identifier (from workflow name)
# These are resolved at runtime by the workflow runner.
```

### 2. Update Step 0.1 (Plan Rating) with:
```yaml
- step: 0.1
  name: "Plan Rating"
  agent: orchestrator
  skill: response-rater
  provider_config: .claude/config/response-rater.yaml
  inputs:
    - .claude/context/runs/{{run_id}}/plans/{{plan_id}}.json
  outputs:
    - .claude/context/runs/{{run_id}}/plans/{{plan_id}}-rating.json
  validation:
    minimum_score: 7  # Adjust: incident=5, enterprise=8, security=9
    score_matrix: .claude/context/plan-review-matrix.json
    rubric_file: .claude/context/artifacts/standard-plan-rubric.json
    max_attempts: 3
  timeout_escalation:
    enabled: true
    use_cache_on_timeout: true
```

### 3. Fix All Path Template Variables
Replace all angle brackets with mustache syntax:
- `<run_id>` → `{{run_id}}`
- `<plan_id>` → `{{plan_id}}`
- `<workflow_id>` → `{{workflow_id}}`

### 4. Add Publishing Step (Step X.5) if not present
```yaml
- step: 7.5  # or appropriate step number
  name: "Publish Artifacts"
  agent: orchestrator
  skill: artifact-publisher
  condition: "validation_status == 'pass'"
  inputs:
    - artifact-registry.json
  outputs:
    - .claude/context/history/gates/{{workflow_id}}/07.5-publishing.json
  policy: auto-on-pass
  retry:
    max_attempts: 3
    backoff: exponential
    base_delay: 5
  error_handling:
    on_failure: retry_then_alert
    manual_retry:
      enabled: true
      command: "node .claude/tools/artifact-publisher.mjs --retry --run-id {{run_id}}"
```

### 5. Add Monitoring Section
```yaml
monitoring:
  enabled: true
  track_step_times: true
  alert_on_slow_steps: true
  slow_step_threshold: 300
  metrics_dir: .claude/context/metrics
```

### 6. Workflow-Specific Minimum Scores
- incident-flow.yaml: minimum_score: 5
- enterprise-track.yaml: minimum_score: 8
- automated-enterprise-flow.yaml: minimum_score: 8
- All others: minimum_score: 7

## Deliverables

1. All 14 workflow YAML files updated with changes above
2. Combined report at `.claude/context/reports/workflow-updates-combined-report.md`

## Validation

- Ensure YAML syntax is valid
- Verify all template variables use mustache syntax
- Confirm monitoring section added to all workflows
- Validate publishing step numbering is correct

## Notes

- Use proper Windows path handling (forward slashes or path.join)
- Validate paths before writing
- Clean up any temporary files created
