# Plan: Serena Codebase Integration

> **For Claude:** REQUIRED SUB-SKILL: Use executing-plans to implement this plan task-by-task.

**Goal:** Enhance existing .claude framework with valuable patterns from Serena codebase while avoiding duplication.

**Architecture:** Serena patterns will be integrated as enhancements to existing skills and documentation updates. No new Python runtime dependencies. Focus on portable patterns that work in CLI context.

**Tech Stack:** Markdown skills, JavaScript tools, YAML configuration

---

## Executive Summary

The Serena integration analysis reveals that **Phase 1 is already complete** - all 5 core Serena skills were previously integrated (project-onboarding, thinking-tools, summarize-changes, operational-modes, session-handoff). The remaining work focuses on:

1. **Lessons Learned Document** - Adopt best practices as framework documentation
2. **CLAUDE.md Enhancement** - Add Serena skill references to workflow section
3. **Skill Cross-References** - Ensure all integrated skills reference each other properly

## Objectives

- [x] Integrate core Serena workflow tools (ALREADY DONE - See learnings.md)
- [ ] Document lessons learned patterns in framework
- [ ] Update CLAUDE.md with new workflow skill references
- [ ] Verify cross-references between integrated skills

## Review Required

- [ ] **Architect Review**: Optional - Documentation updates only
- [ ] **Security Review**: Optional - No security-sensitive changes

### Review Focus Areas

- Architect: Skill cross-reference patterns, documentation consistency
- Security: N/A - No external integrations or code execution

---

## Phases

### Phase 1: Documentation - Lessons Learned Integration
**Dependencies**: None
**Parallel OK**: Yes

#### Context

Serena's `lessons_learned.md` contains valuable insights from real-world agent development:
- Separate tool logic from MCP implementation
- Autogenerated prompt factories
- Symbol-based editing over line numbers
- Dashboard/GUI for observability

These patterns should be captured in our framework memory.

#### Tasks

- [ ] **1.1** Extract and adapt Serena lessons learned (~5 min)
  - **Command**: Read `.claude.archive/.tmp/serena/lessons_learned.md` and summarize key patterns applicable to agent-studio
  - **Verify**: `grep "Serena Lessons" .claude/context/memory/learnings.md`
  - **Rollback**: `git checkout -- .claude/context/memory/learnings.md`

#### Phase 1 Error Handling
If any task fails:
1. Document error: `echo "Phase 1 failed: [error]" >> .claude/context/memory/issues.md`
2. Continue to Phase 2 (non-blocking documentation)

#### Phase 1 Verification Gate
```bash
grep -q "Serena" .claude/context/memory/learnings.md && echo "PASS: Lessons documented"
```

---

### Phase 2: CLAUDE.md Enhancement
**Dependencies**: None
**Parallel OK**: Yes (with Phase 1)

#### Context

CLAUDE.md Section 8.5 already references the Serena-integrated skills. Verify completeness and update if needed.

#### Tasks

- [ ] **2.1** Verify CLAUDE.md workflow skill references (~3 min)
  - **Command**: Check Section 8.5 contains: project-onboarding, thinking-tools, operational-modes, summarize-changes, session-handoff
  - **Verify**: `grep -c "project-onboarding\|thinking-tools\|operational-modes\|summarize-changes\|session-handoff" .claude/CLAUDE.md`
  - **Rollback**: N/A (read-only check)

- [ ] **2.2** Add missing skill references if any (~5 min) [conditional]
  - **Command**: Edit `.claude/CLAUDE.md` Section 8.5 to add any missing skill references
  - **Verify**: All 5 skills referenced in CLAUDE.md
  - **Rollback**: `git checkout -- .claude/CLAUDE.md`

#### Phase 2 Error Handling
If any task fails:
1. Document error in issues.md
2. Continue to Phase 3

#### Phase 2 Verification Gate
```bash
count=$(grep -c "project-onboarding\|thinking-tools\|operational-modes\|summarize-changes\|session-handoff" .claude/CLAUDE.md)
[ "$count" -ge 5 ] && echo "PASS: All skills referenced" || echo "FAIL: Missing references"
```

---

### Phase 3: Skill Cross-Reference Verification
**Dependencies**: Phase 1, Phase 2
**Parallel OK**: No

#### Context

Each integrated Serena skill should reference related skills in its `<integration>` section for discoverability.

#### Tasks

- [ ] **3.1** Verify project-onboarding cross-references (~2 min)
  - **Command**: `grep -A5 "Related Skills" .claude/skills/project-onboarding/SKILL.md`
  - **Verify**: Contains references to session-handoff, project-analyzer
  - **Rollback**: N/A (read-only)

- [ ] **3.2** Verify thinking-tools cross-references (~2 min) [parallel OK]
  - **Command**: `grep -A5 "Related Skills" .claude/skills/thinking-tools/SKILL.md`
  - **Verify**: Contains references to verification-before-completion, tdd, sequential-thinking
  - **Rollback**: N/A (read-only)

- [ ] **3.3** Verify summarize-changes cross-references (~2 min) [parallel OK]
  - **Command**: `grep -A5 "Related Skills" .claude/skills/summarize-changes/SKILL.md`
  - **Verify**: Contains references to thinking-tools, git-expert, commit-message-guidelines
  - **Rollback**: N/A (read-only)

- [ ] **3.4** Verify operational-modes cross-references (~2 min) [parallel OK]
  - **Command**: `grep -A5 "Related Skills" .claude/skills/operational-modes/SKILL.md`
  - **Verify**: Contains references to thinking-tools, writing-plans, tdd, summarize-changes
  - **Rollback**: N/A (read-only)

- [ ] **3.5** Verify session-handoff cross-references (~2 min) [parallel OK]
  - **Command**: `grep -A5 "Related Skills" .claude/skills/session-handoff/SKILL.md`
  - **Verify**: Contains references to project-onboarding, thinking-tools, summarize-changes
  - **Rollback**: N/A (read-only)

- [ ] **3.6** Fix any missing cross-references (~10 min) [conditional]
  - **Command**: Update skill files with missing cross-references
  - **Verify**: All skills have complete Related Skills sections
  - **Rollback**: `git checkout -- .claude/skills/*/SKILL.md`

#### Phase 3 Error Handling
If any task fails:
1. Document missing reference in issues.md
2. Add fix task to backlog

#### Phase 3 Verification Gate
```bash
for skill in project-onboarding thinking-tools summarize-changes operational-modes session-handoff; do
  grep -q "Related Skills" ".claude/skills/$skill/SKILL.md" || echo "FAIL: $skill missing Related Skills"
done
echo "Verification complete"
```

---

### Phase 4: Integration Validation
**Dependencies**: Phase 1, Phase 2, Phase 3
**Parallel OK**: No

#### Context

Final validation that all Serena patterns are properly integrated and documented.

#### Tasks

- [ ] **4.1** Run framework validation (~3 min)
  - **Command**: `npm test` (if test infrastructure exists)
  - **Verify**: Exit code 0
  - **Rollback**: N/A

- [ ] **4.2** Update learnings.md with integration status (~5 min)
  - **Command**: Append integration completion entry to learnings.md
  - **Verify**: `grep "Serena Integration Phase 2" .claude/context/memory/learnings.md`
  - **Rollback**: `git checkout -- .claude/context/memory/learnings.md`

- [ ] **4.3** Create integration report (~5 min)
  - **Command**: Create `.claude/context/reports/serena-integration-phase2-report.md` with summary
  - **Verify**: `ls .claude/context/reports/serena-integration-phase2-report.md`
  - **Rollback**: `rm .claude/context/reports/serena-integration-phase2-report.md`

#### Phase 4 Error Handling
If any task fails:
1. Document error
2. Mark integration as partial

#### Phase 4 Verification Gate
```bash
test -f ".claude/context/reports/serena-integration-phase2-report.md" && echo "PASS" || echo "FAIL"
```

---

## NOT IN SCOPE (Deferred/Rejected)

The following Serena features were analyzed but **NOT ported** for these reasons:

### 1. SolidLanguageServer (LSP Wrapper)
- **Reason**: Requires Python runtime, complex language server management
- **Our Alternative**: Claude Code has built-in language understanding

### 2. JetBrains Plugin Integration
- **Reason**: IDE-specific, not applicable to CLI-first framework
- **Our Alternative**: N/A - different use case

### 3. Token Counting System
- **Reason**: Claude handles this internally
- **Our Alternative**: Model's native context management

### 4. Dashboard UI (Flask-based)
- **Reason**: Out of scope for CLI framework, adds runtime dependency
- **Our Alternative**: File-based memory and reports

### 5. Prompt Factory (Jinja2)
- **Reason**: Adds complexity, our markdown approach is simpler
- **Our Alternative**: Direct markdown skills with clear sections

### 6. Memory CRUD Tools (Edit/Delete)
- **Reason**: Our memory system is simpler (Read/Write/Append)
- **Our Alternative**: Append-only memory with manual cleanup
- **Future**: Could add if needed, but YAGNI for now

### 7. Mode-based Tool Exclusion (Dynamic)
- **Reason**: Complex to implement in CLI, limited benefit
- **Our Alternative**: operational-modes skill with self-regulation guidance

---

## Risks

| Risk | Impact | Mitigation | Rollback |
|------|--------|------------|----------|
| Skill cross-references break | Low | Verify with grep | `git checkout -- .claude/skills/` |
| CLAUDE.md becomes too long | Low | Keep additions minimal | `git checkout -- .claude/CLAUDE.md` |
| Memory files corrupted | Low | Append-only changes | `git checkout -- .claude/context/memory/` |

---

## Timeline Summary

| Phase | Tasks | Est. Time | Parallel? |
|-------|-------|-----------|-----------|
| 1 | 1 | 5 min | Yes |
| 2 | 2 | 8 min | Yes |
| 3 | 6 | 20 min | Partial |
| 4 | 3 | 13 min | No |
| **Total** | **12** | **~46 min** | |

---

## Success Criteria

1. All 5 Serena skills have complete Memory Protocol sections (VERIFIED)
2. All 5 Serena skills have Related Skills cross-references
3. CLAUDE.md Section 8.5 references all workflow skills
4. learnings.md documents Serena integration patterns
5. Integration report created with summary

---

## Appendix: Already Integrated Skills

The following skills from Serena were integrated in the previous session (2026-01-24):

| Serena Tool | Our Skill | Status |
|-------------|-----------|--------|
| OnboardingTool | project-onboarding | COMPLETE |
| ThinkAbout*Tools | thinking-tools | COMPLETE |
| SummarizeChangesTool | summarize-changes | COMPLETE |
| Mode System | operational-modes | COMPLETE |
| PrepareForNewConversationTool | session-handoff | COMPLETE |

All skills have Memory Protocol sections and are fully functional.
