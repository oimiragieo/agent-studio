{
  "$schema": "../../schemas/a2a-test-scenario.schema.json",
  "scenario_id": "a2a-workflow-003",
  "name": "Workflow step failure and retry",
  "description": "Validate workflow retry mechanism on step failure",
  "category": "workflow-execution",
  "priority": "P1",
  "tags": ["workflow", "retry", "failure-recovery"],

  "preconditions": {
    "fixtures": [
      "mock-agent-responses/mock-developer-response-fail.json",
      "mock-agent-responses/mock-developer-response-success.json"
    ],
    "state": {},
    "environment": {
      "RETRY_ENABLED": true,
      "MAX_RETRIES": 3
    }
  },

  "steps": [
    {
      "step_id": "create-workflow-run-retry",
      "action": "validate_enforcement_gate",
      "input": {
        "runId": "test-workflow-retry-001",
        "workflow": "simple-build-flow",
        "step": 0,
        "task": "Build with retry testing",
        "agents": ["developer"],
        "retry_config": {
          "enabled": true,
          "max_attempts": 3,
          "backoff_ms": 1000
        }
      },
      "expected": {
        "allowed": true,
        "run_created": true
      },
      "timeout_ms": 5000
    },
    {
      "step_id": "execute-step-fail-first",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-workflow-retry-001-step-1",
        "objective": "Build application (will fail first)",
        "context": {
          "problem": "Build the application",
          "why_now": "Testing retry mechanism"
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/build-output.js",
            "description": "Build artifact"
          }
        ],
        "constraints": {
          "max_time_minutes": 5
        },
        "success_criteria": ["Build successful"],
        "verification": {
          "verification_type": "static",
          "evidence_required": true
        },
        "assigned_agent": "developer"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 5000
    },
    {
      "step_id": "inject-fail-response",
      "action": "inject_mock_response",
      "input": {
        "agent": "developer",
        "response_fixture": "mock-developer-response-fail.json",
        "task_id": "test-workflow-retry-001-step-1",
        "simulate_failure": true
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    },
    {
      "step_id": "verify-failure-detected",
      "action": "invoke_posttooluse_hook",
      "input": {
        "hook": "post-delegation-verifier.mjs",
        "tool_name": "Task",
        "tool_input": {
          "task_id": "test-workflow-retry-001-step-1"
        },
        "tool_result": {
          "content": "Build failed. Error: Module not found."
        }
      },
      "expected": {
        "verification_verdict": "FAIL",
        "should_retry": true
      },
      "timeout_ms": 5000
    },
    {
      "step_id": "execute-retry-attempt",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-workflow-retry-001-step-1-retry-1",
        "objective": "Build application (retry)",
        "context": {
          "problem": "Retry build after failure",
          "why_now": "Automatic retry",
          "retry_attempt": 1
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/build-output.js",
            "description": "Build artifact"
          }
        ],
        "constraints": {
          "max_time_minutes": 5
        },
        "success_criteria": ["Build successful"],
        "verification": {
          "verification_type": "static",
          "evidence_required": true
        },
        "assigned_agent": "developer"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 5000
    },
    {
      "step_id": "inject-success-response",
      "action": "inject_mock_response",
      "input": {
        "agent": "developer",
        "response_fixture": "mock-developer-response-success.json",
        "task_id": "test-workflow-retry-001-step-1-retry-1"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    }
  ],

  "assertions": [
    {
      "type": "first_attempt_failed",
      "target": "steps.verify-failure-detected.result.verification_verdict",
      "operator": "equals",
      "expected": "FAIL"
    },
    {
      "type": "retry_triggered",
      "target": "steps.verify-failure-detected.result.should_retry",
      "operator": "equals",
      "expected": true
    },
    {
      "type": "retry_attempt_count",
      "target": "workflow.step_1.attempt_count",
      "operator": "equals",
      "expected": 2
    },
    {
      "type": "backoff_applied",
      "target": "workflow.step_1.backoff_applied",
      "operator": "equals",
      "expected": true
    },
    {
      "type": "final_status",
      "target": "workflow.status",
      "operator": "equals",
      "expected": "completed"
    }
  ],

  "cleanup": {
    "remove_files": [
      ".claude/context/tmp/build-output.js",
      ".claude/context/runtime/runs/test-workflow-retry-001/"
    ],
    "restore_state": true
  },

  "metadata": {
    "created_at": "2026-01-16T00:00:00Z",
    "author": "developer",
    "related_hooks": ["post-delegation-verifier.mjs"]
  }
}
