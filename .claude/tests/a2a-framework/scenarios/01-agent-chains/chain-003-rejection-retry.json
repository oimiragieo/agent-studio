{
  "$schema": "../../schemas/a2a-test-scenario.schema.json",
  "scenario_id": "a2a-chain-003",
  "name": "Chain with rejection and retry",
  "description": "Validate that when code-reviewer rejects, developer receives feedback and retries",
  "category": "agent-chain",
  "priority": "P1",
  "tags": ["chain", "retry", "rejection", "feedback"],

  "preconditions": {
    "fixtures": [
      "mock-agent-responses/mock-developer-response-with-issue.json",
      "mock-agent-responses/mock-code-reviewer-reject.json",
      "mock-agent-responses/mock-developer-response-fixed.json",
      "mock-agent-responses/mock-code-reviewer-approve.json"
    ],
    "state": {},
    "environment": {}
  },

  "steps": [
    {
      "step_id": "delegate-developer-initial",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-chain-003-dev-1",
        "objective": "Create authentication function",
        "context": {
          "problem": "Need auth function with intentional issue for testing",
          "why_now": "Testing retry mechanism"
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/test-chain-003/auth.mjs",
            "description": "Authentication function (with issue)"
          }
        ],
        "constraints": {
          "max_time_minutes": 10
        },
        "success_criteria": ["Function created"],
        "verification": {
          "verification_type": "static",
          "evidence_required": true
        },
        "assigned_agent": "developer"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 10000
    },
    {
      "step_id": "inject-developer-initial",
      "action": "inject_mock_response",
      "input": {
        "agent": "developer",
        "response_fixture": "mock-developer-response-with-issue.json",
        "task_id": "test-chain-003-dev-1"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    },
    {
      "step_id": "delegate-reviewer-initial",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-chain-003-review-1",
        "objective": "Review authentication function",
        "context": {
          "problem": "Validate code quality",
          "why_now": "Pre-merge validation",
          "related_files": [".claude/context/tmp/test-chain-003/auth.mjs"]
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/test-chain-003/review-1.json",
            "description": "Code review (expected to reject)"
          }
        ],
        "constraints": {
          "max_time_minutes": 5
        },
        "success_criteria": ["Review completed", "Verdict provided"],
        "verification": {
          "verification_type": "manual",
          "evidence_required": true
        },
        "assigned_agent": "code-reviewer"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 5000
    },
    {
      "step_id": "inject-reviewer-reject",
      "action": "inject_mock_response",
      "input": {
        "agent": "code-reviewer",
        "response_fixture": "mock-code-reviewer-reject.json",
        "task_id": "test-chain-003-review-1",
        "verdict": "CONCERNS"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    },
    {
      "step_id": "verify-rejection",
      "action": "invoke_posttooluse_hook",
      "input": {
        "hook": "post-delegation-verifier.mjs",
        "tool_name": "Task",
        "tool_input": {
          "task_id": "test-chain-003-review-1"
        },
        "tool_result": {
          "content": "Review completed. Verdict: CONCERNS. Issues: Missing input validation."
        }
      },
      "expected": {
        "decision": "approve",
        "errors": [],
        "warnings": ["Agent reported CONCERNS verdict"]
      },
      "timeout_ms": 5000
    },
    {
      "step_id": "delegate-developer-retry",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-chain-003-dev-2",
        "objective": "Fix authentication function based on review feedback",
        "context": {
          "problem": "Address review concerns: Missing input validation",
          "why_now": "Retry after rejection",
          "related_files": [
            ".claude/context/tmp/test-chain-003/auth.mjs",
            ".claude/context/tmp/test-chain-003/review-1.json"
          ]
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/test-chain-003/auth.mjs",
            "description": "Fixed authentication function"
          }
        ],
        "constraints": {
          "max_time_minutes": 10
        },
        "success_criteria": ["Issues fixed", "Input validation added"],
        "verification": {
          "verification_type": "static",
          "evidence_required": true
        },
        "assigned_agent": "developer"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 10000
    },
    {
      "step_id": "inject-developer-fixed",
      "action": "inject_mock_response",
      "input": {
        "agent": "developer",
        "response_fixture": "mock-developer-response-fixed.json",
        "task_id": "test-chain-003-dev-2"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    },
    {
      "step_id": "delegate-reviewer-retry",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-chain-003-review-2",
        "objective": "Re-review fixed authentication function",
        "context": {
          "problem": "Validate fixes applied",
          "why_now": "Second review after fixes",
          "related_files": [".claude/context/tmp/test-chain-003/auth.mjs"]
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/test-chain-003/review-2.json",
            "description": "Final code review"
          }
        ],
        "constraints": {
          "max_time_minutes": 5
        },
        "success_criteria": ["Review completed", "Verdict: PASS"],
        "verification": {
          "verification_type": "manual",
          "evidence_required": true
        },
        "assigned_agent": "code-reviewer"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 5000
    },
    {
      "step_id": "inject-reviewer-approve",
      "action": "inject_mock_response",
      "input": {
        "agent": "code-reviewer",
        "response_fixture": "mock-code-reviewer-approve.json",
        "task_id": "test-chain-003-review-2",
        "verdict": "PASS"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    }
  ],

  "assertions": [
    {
      "type": "hook_output",
      "target": "steps.verify-rejection.result.verification_verdict",
      "operator": "equals",
      "expected": "CONCERNS"
    },
    {
      "type": "retry_triggered",
      "target": "steps",
      "operator": "count_equals",
      "expected": 9
    },
    {
      "type": "final_verdict",
      "target": "steps.inject-reviewer-approve.input.verdict",
      "operator": "equals",
      "expected": "PASS"
    },
    {
      "type": "feedback_propagation",
      "target": "steps.delegate-developer-retry.input.context.related_files",
      "operator": "contains",
      "expected": ".claude/context/tmp/test-chain-003/review-1.json"
    }
  ],

  "cleanup": {
    "remove_files": [
      ".claude/context/tmp/test-chain-003/auth.mjs",
      ".claude/context/tmp/test-chain-003/review-1.json",
      ".claude/context/tmp/test-chain-003/review-2.json"
    ],
    "restore_state": true
  },

  "metadata": {
    "created_at": "2026-01-16T00:00:00Z",
    "author": "developer",
    "related_hooks": ["post-delegation-verifier.mjs"]
  }
}
