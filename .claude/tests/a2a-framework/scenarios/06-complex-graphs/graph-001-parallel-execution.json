{
  "$schema": "../../schemas/a2a-test-scenario.schema.json",
  "scenario_id": "a2a-graph-001",
  "name": "Parallel agent execution (max 2)",
  "description": "Validate that independent agents can execute in parallel (max 2)",
  "category": "complex-graph",
  "priority": "P1",
  "tags": ["parallel", "concurrency", "independent-tasks"],

  "preconditions": {
    "fixtures": [
      "mock-agent-responses/mock-analyst-response.json",
      "mock-agent-responses/mock-developer-response.json"
    ],
    "state": {},
    "environment": {
      "MAX_PARALLEL_TASKS": 2
    }
  },

  "steps": [
    {
      "step_id": "delegate-analyst",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-parallel-analyst-001",
        "objective": "Analyze codebase architecture",
        "context": {
          "problem": "Need architecture analysis",
          "why_now": "Planning refactoring"
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/analysis-report.md",
            "description": "Architecture analysis"
          }
        ],
        "constraints": {
          "max_time_minutes": 15
        },
        "success_criteria": ["Analysis completed"],
        "verification": {
          "verification_type": "manual",
          "evidence_required": true
        },
        "assigned_agent": "analyst"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    },
    {
      "step_id": "delegate-developer",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-parallel-developer-001",
        "objective": "Implement feature X (unrelated to analysis)",
        "context": {
          "problem": "New feature development",
          "why_now": "Sprint requirement"
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/feature-x.mjs",
            "description": "Feature implementation"
          }
        ],
        "constraints": {
          "max_time_minutes": 20
        },
        "success_criteria": ["Feature implemented"],
        "verification": {
          "verification_type": "static",
          "evidence_required": true
        },
        "assigned_agent": "developer"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    },
    {
      "step_id": "verify-parallel-execution",
      "action": "verify_state_change",
      "input": {
        "path": ".claude/context/runtime/parallel-execution.json",
        "expected": {
          "parallel_execution": true,
          "task_count": 2
        }
      },
      "expected": {
        "parallel_execution": true
      },
      "timeout_ms": 2000
    },
    {
      "step_id": "inject-analyst-response",
      "action": "inject_mock_response",
      "input": {
        "agent": "analyst",
        "response_fixture": "mock-analyst-response.json",
        "task_id": "test-parallel-analyst-001"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    },
    {
      "step_id": "inject-developer-response",
      "action": "inject_mock_response",
      "input": {
        "agent": "developer",
        "response_fixture": "mock-developer-response.json",
        "task_id": "test-parallel-developer-001"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    }
  ],

  "assertions": [
    {
      "type": "parallel_execution",
      "target": "steps.verify-parallel-execution.result.parallel_execution",
      "operator": "equals",
      "expected": true
    },
    {
      "type": "start_time_concurrent",
      "target": "task_start_times_diff_ms",
      "operator": "less_than",
      "expected": 1000
    },
    {
      "type": "both_completed",
      "target": "completed_tasks",
      "operator": "count_equals",
      "expected": 2
    },
    {
      "type": "no_blocking",
      "target": "execution_blocking",
      "operator": "equals",
      "expected": false
    }
  ],

  "cleanup": {
    "remove_files": [
      ".claude/context/tmp/analysis-report.md",
      ".claude/context/tmp/feature-x.mjs",
      ".claude/context/runtime/parallel-execution.json"
    ],
    "restore_state": true
  },

  "metadata": {
    "created_at": "2026-01-16T00:00:00Z",
    "author": "developer",
    "related_hooks": ["agent-task-template-enforcer.mjs"]
  }
}
