{
  "$schema": "../../schemas/a2a-test-scenario.schema.json",
  "scenario_id": "a2a-graph-002",
  "name": "Fan-out and fan-in pattern",
  "description": "Validate fan-out to multiple agents and fan-in aggregation",
  "category": "complex-graph",
  "priority": "P1",
  "tags": ["fan-out", "fan-in", "aggregation", "dag"],

  "preconditions": {
    "fixtures": [
      "mock-agent-responses/mock-architect-response.json",
      "mock-agent-responses/mock-developer-response.json",
      "mock-agent-responses/mock-qa-response.json"
    ],
    "state": {},
    "environment": {}
  },

  "steps": [
    {
      "step_id": "delegate-architect-design",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-fanout-arch-001",
        "objective": "Design 3-component system",
        "context": {
          "problem": "Design modular system with 3 components",
          "why_now": "Architecture phase"
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/design-3comp.md",
            "description": "3-component design"
          }
        ],
        "constraints": {
          "max_time_minutes": 20
        },
        "success_criteria": ["3 components designed"],
        "verification": {
          "verification_type": "manual",
          "evidence_required": true
        },
        "assigned_agent": "architect"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 5000
    },
    {
      "step_id": "inject-architect-response",
      "action": "inject_mock_response",
      "input": {
        "agent": "architect",
        "response_fixture": "mock-architect-response.json",
        "task_id": "test-fanout-arch-001",
        "components": ["ComponentA", "ComponentB", "ComponentC"]
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    },
    {
      "step_id": "fan-out-batch-1",
      "action": "simulate_agent_chain",
      "input": {
        "agents": [
          {
            "type": "developer",
            "task": "Implement ComponentA",
            "response_fixture": "mock-developer-response.json",
            "deliverable": ".claude/context/tmp/component-a.mjs"
          },
          {
            "type": "developer",
            "task": "Implement ComponentB",
            "response_fixture": "mock-developer-response.json",
            "deliverable": ".claude/context/tmp/component-b.mjs"
          }
        ],
        "parallel": true,
        "max_parallel": 2
      },
      "expected": {
        "all_completed": true,
        "parallel_execution": true
      },
      "timeout_ms": 20000
    },
    {
      "step_id": "fan-out-batch-2",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-fanout-dev-c-001",
        "objective": "Implement ComponentC",
        "context": {
          "problem": "Final component implementation",
          "why_now": "Completing fan-out",
          "related_files": [".claude/context/tmp/design-3comp.md"]
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/component-c.mjs",
            "description": "ComponentC implementation"
          }
        ],
        "constraints": {
          "max_time_minutes": 15
        },
        "success_criteria": ["ComponentC implemented"],
        "verification": {
          "verification_type": "static",
          "evidence_required": true
        },
        "assigned_agent": "developer"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 15000
    },
    {
      "step_id": "inject-developer-c-response",
      "action": "inject_mock_response",
      "input": {
        "agent": "developer",
        "response_fixture": "mock-developer-response.json",
        "task_id": "test-fanout-dev-c-001"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 1000
    },
    {
      "step_id": "fan-in-qa",
      "action": "simulate_task_delegation",
      "input": {
        "task_id": "test-fanin-qa-001",
        "objective": "Validate all 3 components",
        "context": {
          "problem": "Unified validation of all components",
          "why_now": "Fan-in aggregation",
          "related_files": [
            ".claude/context/tmp/component-a.mjs",
            ".claude/context/tmp/component-b.mjs",
            ".claude/context/tmp/component-c.mjs"
          ]
        },
        "deliverables": [
          {
            "type": "file",
            "path": ".claude/context/tmp/unified-validation.json",
            "description": "Unified QA report"
          }
        ],
        "constraints": {
          "max_time_minutes": 10
        },
        "success_criteria": ["All 3 components validated", "Unified report generated"],
        "verification": {
          "verification_type": "automated",
          "evidence_required": true
        },
        "assigned_agent": "qa"
      },
      "expected": {
        "decision": "approve"
      },
      "timeout_ms": 10000
    }
  ],

  "assertions": [
    {
      "type": "developer_tasks",
      "target": "developer_task_count",
      "operator": "equals",
      "expected": 3
    },
    {
      "type": "all_developers_completed",
      "target": "all_developers_done_before_qa",
      "operator": "equals",
      "expected": true
    },
    {
      "type": "qa_input_complete",
      "target": "steps.fan-in-qa.input.context.related_files.length",
      "operator": "equals",
      "expected": 3
    },
    {
      "type": "unified_validation",
      "target": ".claude/context/tmp/unified-validation.json",
      "operator": "exists",
      "expected": true
    },
    {
      "type": "validation_components",
      "target": "unified_validation.components.length",
      "operator": "equals",
      "expected": 3
    }
  ],

  "cleanup": {
    "remove_files": [
      ".claude/context/tmp/design-3comp.md",
      ".claude/context/tmp/component-a.mjs",
      ".claude/context/tmp/component-b.mjs",
      ".claude/context/tmp/component-c.mjs",
      ".claude/context/tmp/unified-validation.json"
    ],
    "restore_state": true
  },

  "metadata": {
    "created_at": "2026-01-16T00:00:00Z",
    "author": "developer",
    "related_hooks": ["agent-task-template-enforcer.mjs", "post-delegation-verifier.mjs"]
  }
}
