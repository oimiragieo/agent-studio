# Hallucination Prevention & Accuracy Strategies
# Techniques to reduce false information and improve factual accuracy

# ==============================================================================
# Core Prevention Strategies
# ==============================================================================

strategies:
  # 1. Permission to admit uncertainty
  admit_uncertainty:
    enabled: true
    system_prompt_addition: |
      If you don't have sufficient information to answer accurately, say "I don't know"
      rather than generating potentially incorrect information. It's better to admit
      uncertainty than to provide false information.

  # 2. Citation requirements
  citation_based:
    enabled: true
    require_citations: true
    system_prompt_addition: |
      When making factual claims:
      1. Support each claim with direct quotations from provided documents
      2. If no supporting evidence exists, explicitly state this
      3. Distinguish between verified facts and inferences

  # 3. Quote extraction (for long documents)
  quote_extraction:
    enabled: true
    system_prompt_addition: |
      Before analysis, extract relevant verbatim quotes from the document.
      This grounds your response in actual text rather than inferred content.

  # 4. Source restriction
  source_restriction:
    enabled: true
    system_prompt_addition: |
      Base your response ONLY on the provided materials. Do NOT use general knowledge
      unless explicitly requested. If information isn't in the provided sources,
      state that clearly.

  # 5. Stepwise reasoning
  stepwise_reasoning:
    enabled: true
    use_chain_of_thought: true
    system_prompt_addition: |
      Explain your reasoning step by step. This helps expose faulty assumptions
      or logic gaps before reaching conclusions.

# ==============================================================================
# Verification Methods
# ==============================================================================

verification:
  # Multi-run comparison
  multi_run:
    enabled: true
    num_runs: 3
    temperature: 0.3  # Lower temperature for consistency
    compare_outputs: true
    flag_inconsistencies: true
    threshold_similarity: 0.85  # Flag if similarity <85%

  # Iterative validation
  iterative_validation:
    enabled: true
    steps:
      - name: "Generate initial response"
      - name: "Extract factual claims"
      - name: "Validate each claim against sources"
      - name: "Retract unsupported claims"
      - name: "Regenerate with verified claims only"

  # Self-consistency check
  self_consistency:
    enabled: true
    system_prompt_addition: |
      After generating your response, review it for:
      1. Internal contradictions
      2. Unsupported claims
      3. Speculation presented as fact

      Flag any issues before finalizing.

# ==============================================================================
# Document-Grounded Responses
# ==============================================================================

document_grounding:
  # Quote-first approach
  quote_first:
    enabled: true
    workflow:
      - "Extract relevant quotes from documents"
      - "Analyze quotes for meaning"
      - "Synthesize findings"
      - "Cite quote sources"

  # Citation format
  citation_format:
    style: "inline"  # Options: inline, footnote, bibliography
    required_elements:
      - source_document
      - page_or_line_number
      - direct_quote
    example: |
      According to the documentation (doc.pdf, p.5): "Claude supports up to 200K tokens"

  # Source tracking
  source_tracking:
    enabled: true
    track_which_documents_used: true
    track_which_sections_cited: true
    flag_uncited_claims: true

# ==============================================================================
# Factual Accuracy Scoring
# ==============================================================================

accuracy_scoring:
  # Automated fact-checking
  automated:
    enabled: true
    methods:
      - name: "Citation verification"
        description: "Verify all citations match source material"
        weight: 0.4

      - name: "Consistency check"
        description: "Check for internal contradictions"
        weight: 0.3

      - name: "Source coverage"
        description: "Verify claims are supported by sources"
        weight: 0.3

  # Scoring thresholds
  thresholds:
    excellent: 0.95  # >95% accuracy
    good: 0.85       # 85-95% accuracy
    acceptable: 0.75 # 75-85% accuracy
    poor: 0.75       # <75% accuracy - flag for review

  # Action on low scores
  low_score_actions:
    flag_for_review: true
    require_regeneration: true
    notify_user: true

# ==============================================================================
# Known Hallucination Patterns
# ==============================================================================

hallucination_patterns:
  # Common patterns to watch for
  patterns:
    - name: "Fabricated statistics"
      description: "Specific numbers without source citations"
      detection: "Regex match for percentages and numbers"
      mitigation: "Require citation for all statistics"

    - name: "Non-existent sources"
      description: "Citations to documents that don't exist"
      detection: "Verify all cited sources exist"
      mitigation: "Block citations to unverified sources"

    - name: "Misattributed quotes"
      description: "Quotes attributed to wrong source"
      detection: "Verify quote text matches attributed source"
      mitigation: "Validate all quotes against source material"

    - name: "Speculative facts"
      description: "Speculation presented as certainty"
      detection: "Flag words like 'probably', 'might', 'could be'"
      mitigation: "Require explicit uncertainty markers"

    - name: "Temporal confusion"
      description: "Incorrect dates or timeframes"
      detection: "Verify dates against source timeline"
      mitigation: "Require explicit date citations"

# ==============================================================================
# Quality Gates
# ==============================================================================

quality_gates:
  # Pre-response gates
  pre_response:
    - check: "All facts have citations"
      required: true

    - check: "No internal contradictions"
      required: true

    - check: "Uncertainty expressed where appropriate"
      required: false  # Recommended but not required

  # Post-response validation
  post_response:
    - check: "Citations verified against sources"
      automated: true

    - check: "Consistency across multiple runs"
      automated: true
      threshold: 0.85

    - check: "No fabricated information detected"
      automated: true

# ==============================================================================
# Agent-Specific Configurations
# ==============================================================================

agent_configs:
  # Analyst: Highest accuracy requirements
  analyst:
    require_citations: true
    multi_run_verification: true
    num_runs: 3
    source_restriction: "strict"

  # Architect: Balance accuracy with creativity
  architect:
    require_citations: true
    multi_run_verification: false
    source_restriction: "moderate"
    allow_informed_speculation: true

  # Developer: Code accuracy critical
  developer:
    require_citations: false  # Code doesn't need citations
    verify_code_accuracy: true
    test_generated_code: true

  # QA: Verification role
  qa:
    require_citations: true
    multi_run_verification: true
    cross_reference_findings: true

# ==============================================================================
# Monitoring & Metrics
# ==============================================================================

monitoring:
  # Track hallucination rates
  metrics:
    hallucination_rate:
      calculation: "hallucinations_detected / total_responses"
      target: 0.05  # <5% target

    citation_coverage:
      calculation: "cited_claims / total_claims"
      target: 0.90  # >90% citation coverage

    consistency_score:
      calculation: "consistent_runs / total_runs"
      target: 0.85  # >85% consistency

  # Logging
  logging:
    log_detected_hallucinations: true
    log_location: ".claude/context/quality/hallucinations.log"
    log_format: "json"

  # Alerts
  alerts:
    alert_on_high_rate: true
    threshold: 0.10  # Alert if hallucination rate >10%
    notification_channel: "slack"

# ==============================================================================
# Continuous Improvement
# ==============================================================================

improvement:
  # Feedback collection
  collect_feedback:
    enabled: true
    track_false_positives: true
    track_false_negatives: true

  # Model refinement
  refinement:
    update_detection_patterns: true
    improve_thresholds: true
    refine_verification_methods: true

  # Reporting
  reporting:
    generate_weekly_report: true
    include_metrics:
      - "Hallucination rate"
      - "Citation coverage"
      - "Consistency scores"
      - "Common hallucination patterns"
