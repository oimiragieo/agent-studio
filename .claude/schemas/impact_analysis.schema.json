{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "Impact Analysis",
  "description": "Schema for impact analysis artifacts generated by impact-analyzer agent",
  "required": ["analysis_id", "analysis_date", "risk_level", "risk_score", "breaking_changes", "affected_modules", "summary"],
  "properties": {
    "analysis_id": {
      "type": "string",
      "description": "Unique identifier for the impact analysis"
    },
    "analysis_date": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the analysis was performed"
    },
    "analyst": {
      "type": "string",
      "description": "Agent or user who performed the analysis",
      "default": "Ripple (Impact Analyzer Agent)"
    },
    "proposed_change": {
      "type": "string",
      "description": "Brief description of the proposed change being analyzed"
    },
    "summary": {
      "type": "object",
      "required": ["risk_level", "risk_score", "breaking_changes"],
      "properties": {
        "risk_level": {
          "type": "string",
          "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"],
          "description": "Overall risk level assessment"
        },
        "risk_score": {
          "type": "number",
          "minimum": 1,
          "maximum": 10,
          "description": "Numeric risk score (1-10)"
        },
        "breaking_changes": {
          "type": "boolean",
          "description": "Whether breaking changes are present"
        },
        "affected_modules_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of modules affected"
        },
        "impact_scope_percentage": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Estimated percentage of codebase impacted"
        },
        "executive_summary": {
          "type": "string",
          "description": "Brief executive summary of the impact analysis"
        }
      }
    },
    "risk_level": {
      "type": "string",
      "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"],
      "description": "Overall risk level assessment"
    },
    "risk_score": {
      "type": "number",
      "minimum": 1,
      "maximum": 10,
      "description": "Numeric risk score (1-10)"
    },
    "breaking_changes": {
      "type": "boolean",
      "description": "Whether breaking changes are present"
    },
    "affected_modules": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "List of affected module names or paths"
    },
    "change_scope": {
      "type": "object",
      "properties": {
        "files_changed": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["file", "change_type"],
            "properties": {
              "file": {
                "type": "string",
                "description": "File path"
              },
              "change_type": {
                "type": "string",
                "enum": ["added", "modified", "deleted", "renamed"],
                "description": "Type of change"
              },
              "lines_added": {
                "type": "integer",
                "minimum": 0
              },
              "lines_removed": {
                "type": "integer",
                "minimum": 0
              }
            }
          }
        },
        "total_files": {
          "type": "integer",
          "minimum": 0
        },
        "total_lines_changed": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "dependency_impact": {
      "type": "object",
      "properties": {
        "direct_dependents": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Files/modules that directly depend on changed code"
        },
        "transitive_dependents": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Files/modules with indirect dependencies on changed code"
        },
        "blast_radius": {
          "type": "object",
          "properties": {
            "files_affected": {
              "type": "integer",
              "minimum": 0
            },
            "modules_affected": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        "circular_dependencies_detected": {
          "type": "boolean",
          "description": "Whether circular dependencies were detected"
        },
        "dependency_graph_mermaid": {
          "type": "string",
          "description": "Mermaid diagram of the dependency graph"
        }
      }
    },
    "api_surface": {
      "type": "object",
      "properties": {
        "public_apis_modified": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "api_name": {
                "type": "string"
              },
              "change_type": {
                "type": "string",
                "enum": ["added", "modified", "deprecated", "removed"]
              },
              "breaking": {
                "type": "boolean"
              },
              "description": {
                "type": "string"
              }
            }
          }
        },
        "breaking_changes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "api": {
                "type": "string"
              },
              "description": {
                "type": "string"
              },
              "migration_path": {
                "type": "string"
              }
            }
          }
        },
        "consumer_impact": {
          "type": "object",
          "properties": {
            "internal_consumers": {
              "type": "integer",
              "minimum": 0
            },
            "external_consumers": {
              "type": "integer",
              "minimum": 0
            },
            "affected_consumer_list": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "database_impact": {
      "type": "object",
      "properties": {
        "schema_changes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "table": {
                "type": "string"
              },
              "change_type": {
                "type": "string",
                "enum": ["create_table", "drop_table", "add_column", "drop_column", "modify_column", "add_index", "drop_index", "add_constraint", "drop_constraint"]
              },
              "description": {
                "type": "string"
              },
              "reversible": {
                "type": "boolean"
              }
            }
          }
        },
        "migration_required": {
          "type": "boolean"
        },
        "migration_complexity": {
          "type": "string",
          "enum": ["simple", "moderate", "complex", "critical"]
        },
        "data_transformation_required": {
          "type": "boolean"
        },
        "rollback_feasible": {
          "type": "string",
          "enum": ["yes", "no", "partial"]
        },
        "estimated_migration_time": {
          "type": "string",
          "description": "Estimated time for migration to complete"
        }
      }
    },
    "test_coverage_impact": {
      "type": "object",
      "properties": {
        "tests_requiring_updates": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Test files that need to be updated"
        },
        "new_tests_required": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "New tests that should be written"
        },
        "estimated_test_changes": {
          "type": "integer",
          "minimum": 0
        },
        "untested_affected_paths": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Code paths affected but lacking test coverage"
        },
        "regression_test_scope": {
          "type": "string",
          "enum": ["minimal", "targeted", "comprehensive", "full"]
        }
      }
    },
    "integration_points": {
      "type": "object",
      "properties": {
        "external_services_affected": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "service_name": {
                "type": "string"
              },
              "impact_description": {
                "type": "string"
              },
              "requires_coordination": {
                "type": "boolean"
              }
            }
          }
        },
        "internal_services_affected": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "event_webhook_changes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "event_type": {
                "type": "string"
              },
              "change_description": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "performance_implications": {
      "type": "object",
      "properties": {
        "hot_paths_affected": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "cache_invalidation_required": {
          "type": "boolean"
        },
        "estimated_performance_impact": {
          "type": "string",
          "enum": ["none", "minor", "moderate", "significant", "severe"]
        },
        "resource_utilization_change": {
          "type": "object",
          "properties": {
            "cpu": {
              "type": "string",
              "enum": ["decrease", "no_change", "minor_increase", "significant_increase"]
            },
            "memory": {
              "type": "string",
              "enum": ["decrease", "no_change", "minor_increase", "significant_increase"]
            },
            "io": {
              "type": "string",
              "enum": ["decrease", "no_change", "minor_increase", "significant_increase"]
            }
          }
        }
      }
    },
    "security_surface": {
      "type": "object",
      "properties": {
        "new_attack_vectors": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "vector": {
                "type": "string"
              },
              "severity": {
                "type": "string",
                "enum": ["low", "medium", "high", "critical"]
              },
              "mitigation": {
                "type": "string"
              }
            }
          }
        },
        "auth_authz_changes": {
          "type": "object",
          "properties": {
            "authentication_modified": {
              "type": "boolean"
            },
            "authorization_modified": {
              "type": "boolean"
            },
            "description": {
              "type": "string"
            }
          }
        },
        "data_exposure_risk": {
          "type": "string",
          "enum": ["none", "low", "medium", "high", "critical"]
        },
        "secrets_handling_changes": {
          "type": "boolean"
        },
        "encryption_changes": {
          "type": "boolean"
        }
      }
    },
    "risk_factors": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["factor", "severity"],
        "properties": {
          "factor": {
            "type": "string",
            "description": "Description of the risk factor"
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"]
          },
          "likelihood": {
            "type": "string",
            "enum": ["unlikely", "possible", "likely", "certain"]
          },
          "mitigation": {
            "type": "string",
            "description": "Recommended mitigation approach"
          }
        }
      }
    },
    "required_updates": {
      "type": "object",
      "properties": {
        "tests": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "documentation": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "configuration": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "team_notifications": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "mitigation_recommendations": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["recommendation", "priority"],
        "properties": {
          "recommendation": {
            "type": "string"
          },
          "priority": {
            "type": "string",
            "enum": ["P0", "P1", "P2", "P3"]
          },
          "effort": {
            "type": "string",
            "enum": ["minimal", "low", "medium", "high"]
          },
          "owner": {
            "type": "string"
          }
        }
      }
    },
    "approval_requirements": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["role", "reason"],
        "properties": {
          "role": {
            "type": "string",
            "description": "Role or team that must approve"
          },
          "reason": {
            "type": "string",
            "description": "Reason this approval is required"
          },
          "approved": {
            "type": "boolean",
            "default": false
          },
          "approved_by": {
            "type": "string"
          },
          "approved_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "rollout_recommendations": {
      "type": "object",
      "properties": {
        "phased_rollout_recommended": {
          "type": "boolean"
        },
        "feature_flag_required": {
          "type": "boolean"
        },
        "monitoring_requirements": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "rollback_plan": {
          "type": "string",
          "description": "Description of the rollback plan"
        },
        "rollback_time_estimate": {
          "type": "string",
          "description": "Estimated time to rollback if needed"
        },
        "success_criteria": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Criteria to determine successful rollout"
        }
      }
    }
  }
}
