{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "Infrastructure Configuration",
  "description": "Schema for infrastructure resource definitions and configuration",
  "required": ["project_name", "environment", "resources", "environment_variables"],
  "properties": {
    "project_name": {
      "type": "string",
      "description": "Name of the project"
    },
    "environment": {
      "type": "string",
      "enum": ["development", "staging", "production"],
      "description": "Target environment"
    },
    "cloud_provider": {
      "type": "string",
      "enum": ["gcp", "aws", "azure", "local"],
      "description": "Cloud provider for infrastructure"
    },
    "resources": {
      "type": "object",
      "description": "Concrete infrastructure resource definitions",
      "properties": {
        "compute": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string",
                "description": "Resource name with unique suffix (e.g., app-backend-dev-a3f2b1c). Must be globally unique for cloud resources."
              },
              "unique_suffix": {
                "type": "string",
                "description": "Unique suffix appended to resource name to prevent global namespace collisions (e.g., a3f2b1c)"
              },
              "naming_strategy": {
                "type": "string",
                "enum": ["deterministic", "unique_hash", "project_id", "uuid"],
                "description": "Strategy used to generate unique suffix: deterministic (for reproducible names), unique_hash (hash-based), project_id (uses GCP project ID), uuid (short UUID)"
              },
              "type": {
                "type": "string",
                "description": "Resource type (e.g., cloud-run, compute-engine, lambda)"
              },
              "region": {
                "type": "string",
                "description": "Deployment region"
              },
              "specifications": {
                "type": "object",
                "description": "Resource specifications (CPU, memory, etc.)"
              },
              "connection_string": {
                "type": "string",
                "description": "Connection string template (use placeholders for secrets, never include actual passwords or API keys)"
              },
              "connection_string_secret_ref": {
                "type": "string",
                "pattern": "^projects/[^/]+/secrets/[^/]+/versions/[^/]+$",
                "description": "Secret Manager reference for connection credentials (if applicable)"
              }
            },
            "required": ["name", "type"]
          }
        },
        "storage": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string",
                "description": "Storage resource name with unique suffix (e.g., app-assets-dev-a3f2b1c). Must be globally unique (GCP buckets: 3-63 chars, lowercase, alphanumeric and hyphens only)"
              },
              "unique_suffix": {
                "type": "string",
                "description": "Unique suffix appended to resource name to prevent global namespace collisions"
              },
              "naming_strategy": {
                "type": "string",
                "enum": ["deterministic", "unique_hash", "project_id", "uuid"],
                "description": "Strategy used to generate unique suffix"
              },
              "type": {
                "type": "string",
                "description": "Storage type (e.g., gcs-bucket, s3-bucket, storage-account)"
              },
              "region": {
                "type": "string"
              },
              "access_pattern": {
                "type": "string",
                "enum": ["public", "private", "authenticated"],
                "description": "Access pattern for storage"
              }
            },
            "required": ["name", "type"]
          }
        },
        "database": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string",
                "description": "Database instance name with unique suffix (e.g., app-db-dev-a3f2b1c). Must be globally unique for cloud databases."
              },
              "unique_suffix": {
                "type": "string",
                "description": "Unique suffix appended to resource name to prevent global namespace collisions"
              },
              "naming_strategy": {
                "type": "string",
                "enum": ["deterministic", "unique_hash", "project_id", "uuid"],
                "description": "Strategy used to generate unique suffix"
              },
              "connection_string": {
                "type": "string",
                "description": "Database connection string template (use {DB_PASSWORD} placeholder, never include actual passwords). Actual password must be fetched from Secret Manager at runtime."
              },
              "connection_string_secret_ref": {
                "type": "string",
                "pattern": "^projects/[^/]+/secrets/[^/]+/versions/[^/]+$",
                "description": "Secret Manager reference for database password (format: projects/{project_id}/secrets/{secret_name}/versions/{version})"
              },
              "type": {
                "type": "string",
                "description": "Database type (e.g., cloud-sql, rds, cosmos-db)"
              },
              "engine": {
                "type": "string",
                "description": "Database engine (e.g., postgresql, mysql, mongodb)"
              },
              "connection_string": {
                "type": "string",
                "description": "Database connection string"
              },
              "region": {
                "type": "string"
              }
            },
            "required": ["name", "type", "engine"]
          }
        },
        "networking": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string",
                "description": "Network resource name with unique suffix (e.g., app-vpc-dev-a3f2b1c)"
              },
              "unique_suffix": {
                "type": "string",
                "description": "Unique suffix appended to resource name"
              },
              "naming_strategy": {
                "type": "string",
                "enum": ["deterministic", "unique_hash", "project_id", "uuid"],
                "description": "Strategy used to generate unique suffix"
              },
              "type": {
                "type": "string",
                "description": "Network resource type (e.g., vpc, subnet, load-balancer)"
              },
              "cidr": {
                "type": "string",
                "description": "CIDR block for network"
              }
            },
            "required": ["name", "type"]
          }
        },
        "messaging": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string",
                "description": "Message queue/topic name with unique suffix (e.g., app-events-dev-a3f2b1c)"
              },
              "unique_suffix": {
                "type": "string",
                "description": "Unique suffix appended to resource name"
              },
              "naming_strategy": {
                "type": "string",
                "enum": ["deterministic", "unique_hash", "project_id", "uuid"],
                "description": "Strategy used to generate unique suffix"
              },
              "type": {
                "type": "string",
                "description": "Messaging type (e.g., pub-sub, sqs, service-bus)"
              },
              "region": {
                "type": "string"
              }
            },
            "required": ["name", "type"]
          }
        }
      }
    },
    "environment_variables": {
      "type": "object",
      "description": "Environment variables required for application configuration",
      "additionalProperties": {
        "type": "string",
        "description": "Environment variable value or placeholder"
      }
    },
    "service_accounts": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "Service account name"
          },
          "roles": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "IAM roles assigned to service account"
          },
          "key_path": {
            "type": "string",
            "description": "Path to service account key file (for local development)"
          }
        },
        "required": ["name"]
      }
    },
    "api_endpoints": {
      "type": "object",
      "description": "API endpoint URLs for services",
      "additionalProperties": {
        "type": "string",
        "description": "Endpoint URL"
      }
    },
    "terraform_config": {
      "type": "object",
      "description": "Terraform configuration reference",
      "properties": {
        "module_path": {
          "type": "string",
          "description": "Path to Terraform module"
        },
        "variables": {
          "type": "object",
          "description": "Terraform variable values"
        }
      }
    },
    "naming_conventions": {
      "type": "object",
      "description": "Naming convention patterns used for resources",
      "properties": {
        "pattern": {
          "type": "string",
          "description": "Naming pattern with unique suffix (e.g., {project}-{resource}-{env}-{unique_suffix})"
        },
        "default_strategy": {
          "type": "string",
          "enum": ["deterministic", "unique_hash", "project_id", "uuid"],
          "description": "Default naming strategy for generating unique suffixes"
        },
        "examples": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "secret_references": {
      "type": "object",
      "description": "Secret Manager references for all sensitive values. NEVER include actual secrets in this configuration.",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "secret_id": {
            "type": "string",
            "pattern": "^projects/[^/]+/secrets/[^/]+/versions/[^/]+$",
            "description": "Full Secret Manager path (format: projects/{project_id}/secrets/{secret_name}/versions/{version})"
          },
          "environment_variable": {
            "type": "string",
            "description": "Environment variable name that should contain the secret_id (e.g., DB_PASSWORD_SECRET_ID)"
          },
          "local_development_note": {
            "type": "string",
            "description": "Instructions for local development (e.g., 'Set DB_PASSWORD in .env, never commit .env')"
          }
        },
        "required": ["secret_id", "environment_variable"]
      }
    },
    "security_validation": {
      "type": "object",
      "description": "Security validation metadata (added by validation process)",
      "properties": {
        "no_hardcoded_secrets": {
          "type": "boolean",
          "description": "Validation result: true if no hardcoded secrets found"
        },
        "all_secrets_use_references": {
          "type": "boolean",
          "description": "Validation result: true if all secrets use Secret Manager references"
        },
        "resource_names_have_suffixes": {
          "type": "boolean",
          "description": "Validation result: true if all resource names include unique suffixes"
        },
        "connection_strings_use_placeholders": {
          "type": "boolean",
          "description": "Validation result: true if all connection strings use placeholders for secrets"
        },
        "validated_at": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when security validation was performed"
        }
      }
    }
  }
}
