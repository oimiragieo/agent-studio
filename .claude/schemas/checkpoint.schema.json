{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://llm-rules.dev/schemas/checkpoint.schema.json",
  "title": "Workflow Checkpoint Schema",
  "description": "Defines the structure for workflow checkpoints used in error recovery and state restoration",
  "type": "object",
  "required": [
    "checkpoint_id",
    "run_id",
    "workflow",
    "step",
    "timestamp",
    "status",
    "completed_steps",
    "artifacts"
  ],
  "properties": {
    "checkpoint_id": {
      "type": "string",
      "pattern": "^checkpoint-[a-z0-9-]+$",
      "description": "Unique identifier for this checkpoint",
      "examples": ["checkpoint-phase-1", "checkpoint-implementation-complete"]
    },
    "run_id": {
      "type": "string",
      "description": "ID of the workflow run this checkpoint belongs to",
      "examples": ["run-001", "workflow-greenfield-2025-01-06"]
    },
    "workflow": {
      "type": "string",
      "description": "Name of the workflow being checkpointed",
      "examples": ["greenfield-fullstack", "performance-flow", "legacy-modernization-flow"]
    },
    "step": {
      "type": "number",
      "description": "Step number where checkpoint was created (e.g., 3.5 for after step 3)",
      "examples": [0.5, 2.5, 5.5]
    },
    "phase": {
      "type": "string",
      "description": "Human-readable phase name",
      "examples": ["planning", "design", "implementation", "validation"]
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when checkpoint was created"
    },
    "status": {
      "type": "string",
      "enum": ["created", "valid", "restored", "expired", "invalidated"],
      "description": "Current status of this checkpoint"
    },
    "completed_steps": {
      "type": "array",
      "items": {
        "type": "number"
      },
      "description": "List of step numbers that have been completed",
      "examples": [
        [1, 2, 3],
        [0, 1, 2, 3, 4, 5]
      ]
    },
    "artifacts": {
      "type": "array",
      "description": "List of artifacts created up to this checkpoint",
      "items": {
        "type": "object",
        "required": ["name", "path"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Artifact name",
            "examples": ["plan.json", "system-architecture.json", "dev-manifest.json"]
          },
          "path": {
            "type": "string",
            "description": "Absolute or relative path to artifact file",
            "examples": [
              ".claude/context/artifacts/plan-greenfield.json",
              ".claude/context/runs/run-001/artifacts/system-architecture.json"
            ]
          },
          "hash": {
            "type": "string",
            "description": "SHA-256 hash of artifact content for validation",
            "pattern": "^[a-f0-9]{64}$"
          },
          "size": {
            "type": "number",
            "description": "File size in bytes"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "When artifact was created"
          }
        }
      }
    },
    "state": {
      "type": "object",
      "description": "Additional state data needed for recovery",
      "additionalProperties": true,
      "properties": {
        "agents_used": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of agents invoked up to this checkpoint"
        },
        "skills_invoked": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of skills used up to this checkpoint"
        },
        "validation_status": {
          "type": "string",
          "enum": ["pass", "fail", "pending", "skipped"],
          "description": "Validation status at checkpoint"
        },
        "gate_results": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "step": { "type": "number" },
              "status": { "type": "string" },
              "errors": { "type": "array", "items": { "type": "string" } }
            }
          },
          "description": "Validation gate results"
        }
      }
    },
    "recovery_instructions": {
      "type": "string",
      "description": "Human-readable instructions for recovering from this checkpoint",
      "examples": [
        "Restore from Phase 3 checkpoint. Re-run Step 4 with developer agent.",
        "State valid up to implementation. Review artifacts in /artifacts/ and continue from Step 6."
      ]
    },
    "metadata": {
      "type": "object",
      "description": "Additional metadata about the checkpoint",
      "properties": {
        "created_by": {
          "type": "string",
          "description": "Agent that created this checkpoint",
          "examples": ["orchestrator", "master-orchestrator"]
        },
        "parent_checkpoint": {
          "type": "string",
          "description": "Previous checkpoint ID if this is a continuation",
          "pattern": "^checkpoint-[a-z0-9-]+$"
        },
        "expiration": {
          "type": "string",
          "format": "date-time",
          "description": "When this checkpoint expires and can be cleaned up"
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Tags for categorizing checkpoints",
          "examples": [
            ["phase-1", "planning"],
            ["implementation", "validated"]
          ]
        }
      }
    }
  },
  "examples": [
    {
      "checkpoint_id": "checkpoint-phase-3",
      "run_id": "run-greenfield-001",
      "workflow": "greenfield-fullstack",
      "step": 3.5,
      "phase": "design",
      "timestamp": "2026-01-06T10:30:00Z",
      "status": "valid",
      "completed_steps": [0, 1, 2, 3],
      "artifacts": [
        {
          "name": "plan.json",
          "path": ".claude/context/runs/run-greenfield-001/artifacts/plan.json",
          "hash": "a1b2c3d4e5f6...",
          "size": 4096,
          "created_at": "2026-01-06T10:15:00Z"
        },
        {
          "name": "system-architecture.json",
          "path": ".claude/context/runs/run-greenfield-001/artifacts/system-architecture.json",
          "hash": "f6e5d4c3b2a1...",
          "size": 8192,
          "created_at": "2026-01-06T10:25:00Z"
        }
      ],
      "state": {
        "agents_used": ["planner", "architect", "database-architect"],
        "skills_invoked": ["response-rater", "rule-selector", "scaffolder"],
        "validation_status": "pass",
        "gate_results": [
          { "step": 1, "status": "pass", "errors": [] },
          { "step": 2, "status": "pass", "errors": [] },
          { "step": 3, "status": "pass", "errors": [] }
        ]
      },
      "recovery_instructions": "Restore from Phase 3 checkpoint. All design artifacts validated. Continue with Step 4 (implementation).",
      "metadata": {
        "created_by": "orchestrator",
        "parent_checkpoint": "checkpoint-phase-2",
        "expiration": "2026-01-13T10:30:00Z",
        "tags": ["design-phase", "validated", "greenfield"]
      }
    }
  ]
}
