{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "Plan",
  "description": "Schema for plan artifacts generated by Planner agent",
  "required": ["plan_id", "name", "objectives", "steps", "status", "created_at"],
  "properties": {
    "plan_id": {
      "type": "string",
      "description": "Unique identifier for the plan (e.g., plan-<timestamp>)",
      "pattern": "^plan-[a-zA-Z0-9_-]+$"
    },
    "name": {
      "type": "string",
      "description": "Human-readable name of the plan"
    },
    "objectives": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Clear, measurable objectives that this plan aims to achieve",
      "minItems": 1
    },
    "context": {
      "type": "object",
      "description": "Background information and context for the plan",
      "properties": {
        "background": {
          "type": "string",
          "description": "Background information that led to this plan"
        },
        "requirements": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of requirements addressed by this plan"
        },
        "constraints": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Constraints that must be considered"
        },
        "assumptions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Assumptions made during planning"
        }
      }
    },
    "plan_type": {
      "type": "string",
      "enum": ["flat", "hierarchical"],
      "description": "Type of plan: 'flat' for simple step-based plans, 'hierarchical' for phase-based plans",
      "default": "flat"
    },
    "approval_status": {
      "type": "object",
      "description": "Document approval status for document-driven control",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["draft", "pending_review", "approved", "rejected", "requires_changes"],
          "description": "Current approval status"
        },
        "approved_by": {
          "type": ["string", "null"],
          "description": "Agent that approved the plan (null if not approved)"
        },
        "approved_at": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "When plan was approved (null if not approved)"
        },
        "reviewer": {
          "type": ["string", "null"],
          "description": "Agent currently reviewing the plan"
        },
        "rejection_reason": {
          "type": ["string", "null"],
          "description": "Reason for rejection (if rejected)"
        }
      }
    },
    "steps": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["step_number", "name", "agent", "tasks", "success_criteria"],
        "properties": {
          "step_number": {
            "type": ["integer", "string"],
            "description": "Step number or identifier"
          },
          "name": {
            "type": "string",
            "description": "Human-readable name of the step"
          },
          "agent": {
            "type": "string",
            "description": "Agent assigned to execute this step"
          },
          "dependencies": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "List of step identifiers this step depends on (e.g., ['step-0', 'step-1'])"
          },
          "tasks": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Specific tasks to be completed in this step",
            "minItems": 1
          },
          "success_criteria": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Measurable criteria indicating step completion",
            "minItems": 1
          },
          "risks": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Potential risks for this step"
          },
          "mitigation": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Risk mitigation strategies"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "in_progress", "completed", "blocked"],
            "description": "Current execution status of the step"
          }
        }
      },
      "description": "Array of plan steps with dependencies, tasks, and success criteria (for flat plans)"
    },
    "phases": {
      "type": "array",
      "description": "Array of phases for hierarchical plans (when plan_type is 'hierarchical')",
      "items": {
        "type": "object",
        "required": ["phase_id", "phase_name", "status"],
        "properties": {
          "phase_id": {
            "type": "string",
            "description": "Unique identifier for the phase"
          },
          "phase_name": {
            "type": "string",
            "description": "Human-readable name of the phase"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "in_progress", "completed", "failed", "blocked"],
            "description": "Current execution status of the phase"
          },
          "phase_plan_path": {
            "type": "string",
            "description": "Path to detailed phase plan file (if separate)"
          },
          "description": {
            "type": "string",
            "description": "Description of what this phase accomplishes"
          },
          "estimated_tasks": {
            "type": "integer",
            "description": "Estimated number of tasks in this phase"
          },
          "completed_tasks": {
            "type": "integer",
            "description": "Number of completed tasks in this phase"
          },
          "tasks": {
            "type": "array",
            "description": "Detailed tasks for this phase (if included in master plan)",
            "items": {
              "type": "object",
              "required": ["task_id", "description", "assigned_agent", "status"],
              "properties": {
                "task_id": {
                  "type": "string",
                  "description": "Unique identifier for the task"
                },
                "description": {
                  "type": "string",
                  "description": "Task description"
                },
                "assigned_agent": {
                  "type": "string",
                  "description": "Agent assigned to execute this task"
                },
                "status": {
                  "type": "string",
                  "enum": ["pending", "in_progress", "completed", "failed", "blocked"],
                  "description": "Current execution status"
                },
                "priority": {
                  "type": "string",
                  "enum": ["P0", "P1", "P2", "P3"],
                  "description": "Task priority"
                },
                "dependencies": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "description": "List of task IDs this task depends on"
                },
                "files": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "description": "Files to be modified/created in this task"
                }
              }
            }
          },
          "started_at": {
            "type": "string",
            "format": "date-time",
            "description": "When phase execution started"
          },
          "completed_at": {
            "type": "string",
            "format": "date-time",
            "description": "When phase execution completed"
          }
        }
      }
    },
    "overall_status": {
      "type": "object",
      "description": "Overall plan status (for hierarchical plans)",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["planning", "in_progress", "completed", "failed", "paused"],
          "description": "Overall plan status"
        },
        "current_phase": {
          "type": "string",
          "description": "Current phase ID being executed"
        },
        "total_phases": {
          "type": "integer",
          "description": "Total number of phases"
        },
        "completed_phases": {
          "type": "integer",
          "description": "Number of completed phases"
        }
      }
    },
    "dependencies": {
      "type": "object",
      "description": "Graph of step dependencies",
      "additionalProperties": {
        "type": "array",
        "items": {
          "type": "string"
        }
      }
    },
    "risks": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["risk", "mitigation"],
        "properties": {
          "risk": {
            "type": "string",
            "description": "Description of the risk"
          },
          "mitigation": {
            "type": "string",
            "description": "Mitigation strategy for this risk"
          },
          "severity": {
            "type": "string",
            "enum": ["high", "medium", "low"],
            "description": "Severity level of the risk"
          }
        }
      },
      "description": "Plan-level risks and mitigation strategies"
    },
    "success_criteria": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["criterion"],
        "properties": {
          "criterion": {
            "type": "string",
            "description": "Description of the success criterion"
          },
          "measurement": {
            "type": "string",
            "description": "How to measure success for this criterion"
          }
        }
      },
      "description": "Plan-level success criteria"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the plan was created"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the plan was last updated"
    },
    "status": {
      "type": "string",
      "enum": ["draft", "validated", "in_execution", "completed", "cancelled"],
      "description": "Current status of the plan"
    },
    "owner": {
      "type": "string",
      "description": "Agent or user responsible for the plan"
    },
    "workflow": {
      "type": "string",
      "description": "Associated workflow name"
    }
  }
}
