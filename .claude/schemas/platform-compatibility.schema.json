{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "platform-compatibility.schema.json",
  "title": "Platform Compatibility Matrix",
  "description": "Schema for platform capability definitions used in CUJ validation",
  "type": "object",
  "required": ["version", "platforms"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of the compatibility matrix"
    },
    "last_updated": {
      "type": "string",
      "format": "date",
      "description": "Last update date (YYYY-MM-DD)"
    },
    "description": {
      "type": "string",
      "description": "Description of the matrix purpose"
    },
    "capability_definitions": {
      "type": "object",
      "description": "Definitions of each capability",
      "additionalProperties": {
        "type": "string"
      }
    },
    "capability_levels": {
      "type": "object",
      "description": "Definitions of capability support levels",
      "additionalProperties": {
        "type": "string"
      }
    },
    "platforms": {
      "type": "object",
      "description": "Platform definitions",
      "additionalProperties": {
        "$ref": "#/$defs/platform"
      },
      "minProperties": 1
    },
    "execution_mode_requirements": {
      "type": "object",
      "description": "Requirements for each execution mode",
      "additionalProperties": {
        "$ref": "#/$defs/executionModeRequirement"
      }
    },
    "compatibility_rules": {
      "type": "object",
      "description": "Rules for determining compatibility",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "description": { "type": "string" },
          "algorithm": { "type": "string" }
        }
      }
    },
    "validation_functions": {
      "type": "object",
      "description": "Function signatures for validation",
      "additionalProperties": {
        "type": "string"
      }
    }
  },
  "$defs": {
    "capabilityLevel": {
      "oneOf": [
        { "type": "boolean" },
        {
          "type": "string",
          "enum": ["limited", "platform-specific", "codex-only", "untested"]
        }
      ],
      "description": "Support level for a capability"
    },
    "capabilities": {
      "type": "object",
      "description": "Platform capability settings",
      "properties": {
        "skills": { "$ref": "#/$defs/capabilityLevel" },
        "workflows": { "$ref": "#/$defs/capabilityLevel" },
        "mcp": { "$ref": "#/$defs/capabilityLevel" },
        "hooks": { "$ref": "#/$defs/capabilityLevel" },
        "agents": { "$ref": "#/$defs/capabilityLevel" },
        "schemas": { "$ref": "#/$defs/capabilityLevel" },
        "rules": { "$ref": "#/$defs/capabilityLevel" }
      },
      "additionalProperties": { "$ref": "#/$defs/capabilityLevel" }
    },
    "platform": {
      "type": "object",
      "required": ["display_name", "capabilities"],
      "properties": {
        "display_name": {
          "type": "string",
          "description": "Human-readable platform name"
        },
        "description": {
          "type": "string",
          "description": "Platform description"
        },
        "version_tested": {
          "type": "string",
          "description": "Version of platform tested"
        },
        "capabilities": {
          "$ref": "#/$defs/capabilities"
        },
        "skill_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of supported skills"
        },
        "agent_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of supported agents"
        },
        "workflow_execution": {
          "type": "string",
          "enum": ["native", "via-extension", "task-tool-pattern", "none", "untested"],
          "description": "How workflows are executed on this platform"
        },
        "supported_skills": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of explicitly supported skills (for limited platforms)"
        },
        "excluded_skills": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of explicitly excluded skills"
        },
        "supported_agents": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of supported agents (for limited platforms)"
        },
        "skill_location": {
          "type": "string",
          "description": "Alternative location for skills"
        },
        "notes": {
          "type": "string",
          "description": "Additional notes about the platform"
        }
      },
      "additionalProperties": true
    },
    "executionModeRequirement": {
      "type": "object",
      "properties": {
        "required_capabilities": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Capabilities required for this execution mode"
        },
        "fallback_pattern": {
          "type": ["string", "null"],
          "description": "Fallback pattern if native execution not supported"
        },
        "notes": {
          "type": "string",
          "description": "Notes about execution mode requirements"
        }
      }
    }
  }
}
