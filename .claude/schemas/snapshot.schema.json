{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://llm-rules.com/schemas/snapshot.schema.json",
  "title": "Snapshot",
  "version": "1.0.0",
  "description": "Schema for state snapshots generated by snapshot-manager skill for Conductor workflows",
  "type": "object",
  "required": ["snapshot_id", "type", "created_at", "state"],
  "properties": {
    "snapshot_id": {
      "type": "string",
      "pattern": "^snap-[a-z0-9-]+$",
      "description": "Unique identifier for this snapshot"
    },
    "type": {
      "type": "string",
      "enum": [
        "auto",
        "manual",
        "checkpoint",
        "milestone",
        "pre-change",
        "post-change",
        "recovery",
        "session-end"
      ],
      "description": "Type of snapshot"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when snapshot was created"
    },
    "name": {
      "type": "string",
      "maxLength": 100,
      "description": "Human-readable name for this snapshot"
    },
    "description": {
      "type": "string",
      "maxLength": 500,
      "description": "Description of what this snapshot captures"
    },
    "trigger": {
      "type": "object",
      "description": "What triggered this snapshot",
      "properties": {
        "source": {
          "type": "string",
          "enum": [
            "user",
            "scheduler",
            "workflow-step",
            "track-completion",
            "error-recovery",
            "agent",
            "hook",
            "api"
          ],
          "description": "Source that triggered the snapshot"
        },
        "event": {
          "type": "string",
          "description": "Specific event that triggered the snapshot"
        },
        "agent_id": {
          "type": "string",
          "description": "Agent that created the snapshot (if applicable)"
        },
        "workflow_id": {
          "type": "string",
          "description": "Workflow ID (if triggered by workflow)"
        },
        "step_number": {
          "type": "integer",
          "minimum": 0,
          "description": "Workflow step number (if applicable)"
        }
      }
    },
    "state": {
      "type": "object",
      "required": ["version"],
      "description": "Captured state data",
      "properties": {
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "State schema version"
        },
        "project": {
          "type": "object",
          "description": "Project state",
          "properties": {
            "root_path": {
              "type": "string",
              "description": "Project root path"
            },
            "analysis_id": {
              "type": "string",
              "description": "Reference to latest project analysis"
            },
            "git_ref": {
              "type": "string",
              "description": "Git commit SHA or branch at snapshot time"
            },
            "git_dirty": {
              "type": "boolean",
              "description": "Whether working tree had uncommitted changes"
            }
          }
        },
        "tracks": {
          "type": "object",
          "description": "Track states",
          "properties": {
            "active_track_id": {
              "type": "string",
              "description": "Currently active track"
            },
            "track_states": {
              "type": "object",
              "description": "State of each track by ID",
              "additionalProperties": {
                "type": "object",
                "required": ["status", "progress"],
                "properties": {
                  "status": {
                    "type": "string",
                    "enum": [
                      "not-started",
                      "in-progress",
                      "paused",
                      "completed",
                      "blocked",
                      "failed"
                    ]
                  },
                  "progress": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 100
                  },
                  "current_step": {
                    "type": "integer",
                    "minimum": 0
                  },
                  "completed_steps": {
                    "type": "array",
                    "items": { "type": "integer" }
                  }
                }
              }
            }
          }
        },
        "suggestions": {
          "type": "object",
          "description": "Suggestion states",
          "properties": {
            "pending_count": {
              "type": "integer",
              "minimum": 0
            },
            "accepted_count": {
              "type": "integer",
              "minimum": 0
            },
            "rejected_count": {
              "type": "integer",
              "minimum": 0
            },
            "active_suggestions": {
              "type": "array",
              "description": "IDs of active suggestions",
              "items": { "type": "string" }
            }
          }
        },
        "workflows": {
          "type": "object",
          "description": "Workflow execution state",
          "properties": {
            "active_runs": {
              "type": "array",
              "description": "Active workflow run IDs",
              "items": { "type": "string" }
            },
            "completed_runs": {
              "type": "array",
              "description": "Recently completed run IDs",
              "items": { "type": "string" }
            },
            "run_summaries": {
              "type": "object",
              "description": "Summary of each run by ID",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "workflow_name": { "type": "string" },
                  "status": {
                    "type": "string",
                    "enum": ["pending", "running", "completed", "failed", "cancelled"]
                  },
                  "current_step": { "type": "integer" },
                  "total_steps": { "type": "integer" }
                }
              }
            }
          }
        },
        "agents": {
          "type": "object",
          "description": "Agent state",
          "properties": {
            "active_agents": {
              "type": "array",
              "items": { "type": "string" }
            },
            "agent_summaries": {
              "type": "object",
              "description": "Summary of agent activity by agent type",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "tasks_completed": { "type": "integer", "minimum": 0 },
                  "tasks_in_progress": { "type": "integer", "minimum": 0 },
                  "last_active": { "type": "string", "format": "date-time" }
                }
              }
            }
          }
        },
        "artifacts": {
          "type": "object",
          "description": "Artifact state",
          "properties": {
            "count": {
              "type": "integer",
              "minimum": 0
            },
            "recent": {
              "type": "array",
              "description": "Recently created artifacts",
              "maxItems": 20,
              "items": {
                "type": "object",
                "required": ["path", "type"],
                "properties": {
                  "path": { "type": "string" },
                  "type": { "type": "string" },
                  "created_at": { "type": "string", "format": "date-time" },
                  "size_bytes": { "type": "integer", "minimum": 0 }
                }
              }
            }
          }
        },
        "context": {
          "type": "object",
          "description": "Context window state",
          "properties": {
            "tokens_used": {
              "type": "integer",
              "minimum": 0
            },
            "tokens_limit": {
              "type": "integer",
              "minimum": 0
            },
            "compression_level": {
              "type": "integer",
              "minimum": 0,
              "maximum": 5,
              "description": "Current compression level (0=none, 5=maximum)"
            },
            "files_in_context": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Files currently in context"
            }
          }
        },
        "custom": {
          "type": "object",
          "description": "Custom state data (skill-specific)",
          "additionalProperties": true
        }
      }
    },
    "delta": {
      "type": "object",
      "description": "Changes since previous snapshot",
      "properties": {
        "previous_snapshot_id": {
          "type": "string",
          "description": "ID of the previous snapshot"
        },
        "changes": {
          "type": "array",
          "description": "List of changes",
          "items": {
            "type": "object",
            "required": ["type", "path"],
            "properties": {
              "type": {
                "type": "string",
                "enum": ["added", "modified", "deleted", "moved"]
              },
              "path": {
                "type": "string",
                "description": "Path in state object that changed"
              },
              "old_value": {
                "description": "Previous value (for modified/deleted)"
              },
              "new_value": {
                "description": "New value (for added/modified)"
              }
            }
          }
        },
        "files_changed": {
          "type": "array",
          "description": "Project files changed since last snapshot",
          "items": {
            "type": "object",
            "required": ["path", "action"],
            "properties": {
              "path": { "type": "string" },
              "action": {
                "type": "string",
                "enum": ["created", "modified", "deleted", "renamed"]
              },
              "lines_added": { "type": "integer", "minimum": 0 },
              "lines_removed": { "type": "integer", "minimum": 0 }
            }
          }
        }
      }
    },
    "restore_info": {
      "type": "object",
      "description": "Information needed to restore this snapshot",
      "properties": {
        "restorable": {
          "type": "boolean",
          "default": true,
          "description": "Whether this snapshot can be restored"
        },
        "restore_type": {
          "type": "string",
          "enum": ["full", "partial", "state-only"],
          "description": "Type of restoration supported"
        },
        "dependencies": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Other snapshots this depends on"
        },
        "git_operations_required": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Git operations needed for restoration"
        },
        "estimated_restore_time_ms": {
          "type": "integer",
          "minimum": 0
        },
        "warnings": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Warnings about restoring this snapshot"
        }
      }
    },
    "validation": {
      "type": "object",
      "description": "Snapshot validation status",
      "properties": {
        "is_valid": {
          "type": "boolean"
        },
        "validated_at": {
          "type": "string",
          "format": "date-time"
        },
        "checksum": {
          "type": "string",
          "description": "SHA-256 checksum of state data"
        },
        "errors": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "retention": {
      "type": "object",
      "description": "Retention policy for this snapshot",
      "properties": {
        "policy": {
          "type": "string",
          "enum": ["auto", "keep-forever", "keep-until", "keep-count"],
          "description": "Retention policy type"
        },
        "expires_at": {
          "type": "string",
          "format": "date-time",
          "description": "When snapshot expires (if applicable)"
        },
        "priority": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Priority for retention (higher = keep longer)"
        },
        "pinned": {
          "type": "boolean",
          "default": false,
          "description": "Whether snapshot is pinned (never auto-delete)"
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional metadata",
      "properties": {
        "manager_version": { "type": "string" },
        "compression": {
          "type": "string",
          "enum": ["none", "gzip", "lz4"],
          "description": "Compression used for storage"
        },
        "size_bytes": {
          "type": "integer",
          "minimum": 0,
          "description": "Size of snapshot in bytes"
        },
        "project_id": { "type": "string" },
        "session_id": { "type": "string" },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        },
        "notes": {
          "type": "string",
          "description": "User notes about this snapshot"
        }
      }
    }
  }
}
