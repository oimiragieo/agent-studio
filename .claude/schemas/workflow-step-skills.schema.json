{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "workflow-step-skills.schema.json",
  "title": "Workflow Step Skill Requirements Schema",
  "description": "Schema for defining skill requirements per workflow step. This schema is designed to be referenced from workflow.schema.json and enforced by the skill-enforcement module.",
  "version": "2.0.0",

  "definitions": {
    "skill_name": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Skill name in kebab-case format. Must match a skill in .claude/skills/ directory.",
      "examples": [
        "scaffolder",
        "rule-auditor",
        "repo-rag",
        "response-rater",
        "sequential-thinking"
      ]
    },

    "skill_list": {
      "type": "array",
      "items": { "$ref": "#/definitions/skill_name" },
      "uniqueItems": true,
      "description": "Array of unique skill names"
    },

    "triggered_skill": {
      "type": "object",
      "description": "Skill that activates based on pattern matching against task description or context",
      "required": ["pattern", "skills"],
      "properties": {
        "pattern": {
          "type": "string",
          "description": "Regex pattern to match against task description. Case-insensitive. Use | for alternatives.",
          "examples": [
            "new component|create component|generate component",
            "fix|bug|error|issue",
            "refactor|optimize|improve",
            "security|auth|password|credential",
            "test|spec|coverage"
          ]
        },
        "skills": {
          "$ref": "#/definitions/skill_list",
          "description": "Skills to activate when pattern matches"
        },
        "priority": {
          "type": "string",
          "enum": ["required", "recommended", "optional"],
          "default": "recommended",
          "description": "Priority level when triggered. 'required' blocks execution if skill not used, 'recommended' generates warning, 'optional' logs info only."
        },
        "context_keys": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Context keys to check in addition to task description (e.g., ['modified_files', 'commit_message'])"
        },
        "skill_params": {
          "type": "object",
          "additionalProperties": true,
          "description": "Parameters to pass to triggered skills. Supports template variables."
        }
      },
      "additionalProperties": false
    },

    "skill_output_mapping": {
      "type": "object",
      "description": "Maps a skill to its expected output artifacts for validation and traceability",
      "required": ["primary"],
      "properties": {
        "primary": {
          "type": "string",
          "description": "Primary artifact path produced by this skill. Supports template variables like {{workflow_id}}, {{step}}, {{run_id}}."
        },
        "secondary": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Secondary artifacts produced by this skill"
        },
        "schema": {
          "type": "string",
          "description": "Path to JSON schema for validating skill output"
        },
        "required_for_completion": {
          "type": "boolean",
          "default": true,
          "description": "Whether this output must exist for step to be considered complete"
        }
      },
      "additionalProperties": false
    },

    "validation_config": {
      "type": "object",
      "description": "Validation configuration for skill usage compliance",
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["blocking", "warning", "info"],
          "default": "blocking",
          "description": "Validation mode: 'blocking' fails step if skills not used, 'warning' logs warning but continues, 'info' logs info only"
        },
        "min_compliance": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "default": 100,
          "description": "Minimum percentage of required skills that must be used. 100 = all required skills must be used."
        },
        "allow_unlisted_skills": {
          "type": "boolean",
          "default": true,
          "description": "Allow skills not in required/recommended/triggered lists. If false, unexpected skills trigger warnings."
        },
        "require_output_validation": {
          "type": "boolean",
          "default": false,
          "description": "Require output artifacts from skills to be validated against their schemas"
        },
        "compliance_report_path": {
          "type": "string",
          "description": "Path to save skill compliance report. Supports template variables."
        },
        "on_failure": {
          "type": "string",
          "enum": ["block", "warn_and_continue", "retry", "escalate"],
          "default": "block",
          "description": "Action when validation fails: 'block' stops execution, 'warn_and_continue' logs and proceeds, 'retry' attempts step again, 'escalate' notifies orchestrator"
        },
        "max_retries": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5,
          "default": 1,
          "description": "Maximum retry attempts when on_failure is 'retry'"
        }
      },
      "additionalProperties": false
    }
  },

  "type": "object",
  "description": "Complete skill requirements definition for a workflow step",
  "properties": {
    "required": {
      "$ref": "#/definitions/skill_list",
      "description": "Skills that MUST be invoked during this step. Step execution is blocked if any are missing."
    },

    "triggered": {
      "type": "array",
      "items": { "$ref": "#/definitions/triggered_skill" },
      "description": "Skills that activate conditionally based on pattern matching. Evaluated in order; first match wins for each skill."
    },

    "recommended": {
      "$ref": "#/definitions/skill_list",
      "description": "Skills that SHOULD be used but won't block execution. Generates warnings in validation logs if missing."
    },

    "forbidden": {
      "$ref": "#/definitions/skill_list",
      "description": "Skills that MUST NOT be used in this step. Useful for security-sensitive steps. Execution blocked if any are invoked."
    },

    "outputs": {
      "type": "object",
      "additionalProperties": { "$ref": "#/definitions/skill_output_mapping" },
      "description": "Maps skills to their expected output artifacts. Keys are skill names.",
      "examples": [
        {
          "rule-auditor": {
            "primary": "code-review-{{workflow_id}}.json",
            "secondary": ["violations-{{workflow_id}}.json"],
            "schema": ".claude/schemas/code-review.schema.json"
          }
        }
      ]
    },

    "validation": {
      "$ref": "#/definitions/validation_config",
      "description": "Validation settings for skill usage compliance"
    },

    "inherit_from_agent": {
      "type": "boolean",
      "default": true,
      "description": "Whether to inherit required/recommended skills from agent's skill-integration-matrix.json entry. Step-level skills are merged with agent defaults."
    },

    "override_agent_skills": {
      "type": "boolean",
      "default": false,
      "description": "If true, step-level skills completely replace agent defaults instead of merging. Use when step needs a different skill set than agent default."
    }
  },

  "additionalProperties": false,

  "examples": [
    {
      "required": ["scaffolder", "rule-auditor", "repo-rag"],
      "triggered": [
        {
          "pattern": "new component|create component",
          "skills": ["scaffolder", "test-generator"],
          "priority": "required"
        },
        {
          "pattern": "security|auth",
          "skills": ["rule-auditor"],
          "priority": "required",
          "skill_params": {
            "rule_categories": ["security", "authentication"]
          }
        }
      ],
      "recommended": ["test-generator", "code-style-validator"],
      "validation": {
        "mode": "blocking",
        "min_compliance": 100,
        "on_failure": "block"
      }
    },
    {
      "required": ["plan-generator", "sequential-thinking"],
      "recommended": ["diagram-generator"],
      "validation": {
        "mode": "warning",
        "min_compliance": 80
      },
      "inherit_from_agent": true
    },
    {
      "required": ["rule-auditor", "dependency-analyzer"],
      "forbidden": ["scaffolder"],
      "outputs": {
        "rule-auditor": {
          "primary": "compliance-report-{{workflow_id}}.json",
          "schema": ".claude/schemas/compliance-report.schema.json",
          "required_for_completion": true
        }
      },
      "validation": {
        "mode": "blocking",
        "min_compliance": 100,
        "require_output_validation": true
      }
    }
  ]
}
