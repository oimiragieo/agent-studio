#!/usr/bin/env node
/**
 * Tests for Skill Creation Guard Hook
 *
 * Tests validation of SKILL.md writes to ensure skill-creator workflow is followed.
 */

'use strict';

const assert = require('assert');
const path = require('path');
const fs = require('fs');

// Import the module under test
const {
  validateSkillCreation,
  isSkillFile,
  isInSkillsDir,
  extractSkillName,
  checkSkillCreatorActive,
  markSkillCreatorActive,
  clearSkillCreatorActive,
  SKILL_FILE_PATTERN,
  SKILLS_DIR_PATTERN,
  SKILL_CREATOR_STATE_FILE,
  PROJECT_ROOT,
} = require('./skill-creation-guard.cjs');

// =============================================================================
// TEST UTILITIES
// =============================================================================

let testsPassed = 0;
let testsFailed = 0;

function test(name, fn) {
  try {
    fn();
    testsPassed++;
    console.log(`  ✓ ${name}`);
  } catch (err) {
    testsFailed++;
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
  }
}

function describe(name, fn) {
  console.log(`\n${name}`);
  fn();
}

// =============================================================================
// TESTS: isSkillFile
// =============================================================================

describe('isSkillFile', () => {
  test('returns true for valid SKILL.md path (unix)', () => {
    assert.strictEqual(isSkillFile('.claude/skills/test-skill/SKILL.md'), true);
  });

  test('returns true for valid SKILL.md path (windows)', () => {
    assert.strictEqual(isSkillFile('.claude\\skills\\test-skill\\SKILL.md'), true);
  });

  test('returns true for absolute path with SKILL.md', () => {
    assert.strictEqual(isSkillFile('C:\\dev\\project\\.claude\\skills\\test-skill\\SKILL.md'), true);
  });

  test('returns false for non-SKILL.md file in skills dir', () => {
    assert.strictEqual(isSkillFile('.claude/skills/test-skill/main.cjs'), false);
  });

  test('returns false for SKILL.md in wrong location', () => {
    assert.strictEqual(isSkillFile('.claude/agents/core/SKILL.md'), false);
  });

  test('returns false for empty path', () => {
    assert.strictEqual(isSkillFile(''), false);
  });

  test('returns false for null path', () => {
    assert.strictEqual(isSkillFile(null), false);
  });

  test('is case-insensitive for file name', () => {
    assert.strictEqual(isSkillFile('.claude/skills/test-skill/skill.md'), true);
  });
});

// =============================================================================
// TESTS: isInSkillsDir
// =============================================================================

describe('isInSkillsDir', () => {
  test('returns true for file in skills directory', () => {
    assert.strictEqual(isInSkillsDir('.claude/skills/test-skill/main.cjs'), true);
  });

  test('returns true for SKILL.md', () => {
    assert.strictEqual(isInSkillsDir('.claude/skills/test-skill/SKILL.md'), true);
  });

  test('returns false for agent file', () => {
    assert.strictEqual(isInSkillsDir('.claude/agents/core/developer.md'), false);
  });

  test('returns false for root skills dir (no skill name)', () => {
    // This should be false because there's no skill subfolder
    assert.strictEqual(isInSkillsDir('.claude/skills/SKILL.md'), false);
  });
});

// =============================================================================
// TESTS: extractSkillName
// =============================================================================

describe('extractSkillName', () => {
  test('extracts skill name from unix path', () => {
    assert.strictEqual(extractSkillName('.claude/skills/my-awesome-skill/SKILL.md'), 'my-awesome-skill');
  });

  test('extracts skill name from windows path', () => {
    assert.strictEqual(
      extractSkillName('.claude\\skills\\my-awesome-skill\\SKILL.md'),
      'my-awesome-skill'
    );
  });

  test('extracts skill name from nested file', () => {
    assert.strictEqual(
      extractSkillName('.claude/skills/test-skill/scripts/main.cjs'),
      'test-skill'
    );
  });

  test('returns null for non-skill path', () => {
    assert.strictEqual(extractSkillName('.claude/agents/core/developer.md'), null);
  });

  test('returns null for empty path', () => {
    assert.strictEqual(extractSkillName(''), null);
  });
});

// =============================================================================
// TESTS: validateSkillCreation (with mocked state)
// =============================================================================

describe('validateSkillCreation', () => {
  // Store original env
  const originalEnv = process.env.SKILL_CREATION_GUARD;

  test('allows non-watched tools', () => {
    const result = validateSkillCreation('Read', { file_path: '.claude/skills/test/SKILL.md' });
    assert.strictEqual(result.pass, true);
  });

  test('allows writes to non-SKILL.md files', () => {
    const result = validateSkillCreation('Write', {
      file_path: '.claude/skills/test/scripts/main.cjs',
    });
    assert.strictEqual(result.pass, true);
  });

  test('allows writes outside skills directory', () => {
    const result = validateSkillCreation('Write', { file_path: '.claude/agents/core/developer.md' });
    assert.strictEqual(result.pass, true);
  });

  test('blocks SKILL.md write when skill-creator not active (block mode)', () => {
    process.env.SKILL_CREATION_GUARD = 'block';
    clearSkillCreatorActive(); // Ensure no active state

    const result = validateSkillCreation('Write', {
      file_path: '.claude/skills/test-skill/SKILL.md',
    });
    assert.strictEqual(result.pass, false);
    assert.strictEqual(result.result, 'block');
    assert.ok(result.message.includes('SKILL CREATION GUARD VIOLATION'));
  });

  test('warns on SKILL.md write when skill-creator not active (warn mode)', () => {
    process.env.SKILL_CREATION_GUARD = 'warn';
    clearSkillCreatorActive();

    const result = validateSkillCreation('Write', {
      file_path: '.claude/skills/test-skill/SKILL.md',
    });
    assert.strictEqual(result.pass, true);
    assert.strictEqual(result.result, 'warn');
    assert.ok(result.message.includes('SKILL CREATION GUARD VIOLATION'));
  });

  test('allows SKILL.md write when enforcement is off', () => {
    process.env.SKILL_CREATION_GUARD = 'off';
    clearSkillCreatorActive();

    const result = validateSkillCreation('Write', {
      file_path: '.claude/skills/test-skill/SKILL.md',
    });
    assert.strictEqual(result.pass, true);
  });

  test('allows SKILL.md write when skill-creator is active', () => {
    process.env.SKILL_CREATION_GUARD = 'block';
    markSkillCreatorActive('test-skill');

    const result = validateSkillCreation('Write', {
      file_path: '.claude/skills/test-skill/SKILL.md',
    });
    assert.strictEqual(result.pass, true);

    clearSkillCreatorActive(); // Cleanup
  });

  test('blocks Edit to SKILL.md when skill-creator not active', () => {
    process.env.SKILL_CREATION_GUARD = 'block';
    clearSkillCreatorActive();

    const result = validateSkillCreation('Edit', {
      file_path: '.claude/skills/existing-skill/SKILL.md',
      old_string: 'old',
      new_string: 'new',
    });
    assert.strictEqual(result.pass, false);
    assert.strictEqual(result.result, 'block');
  });

  test('violation message includes skill name', () => {
    process.env.SKILL_CREATION_GUARD = 'block';
    clearSkillCreatorActive();

    const result = validateSkillCreation('Write', {
      file_path: '.claude/skills/my-custom-skill/SKILL.md',
    });
    assert.ok(result.message.includes('my-custom-skill'));
  });

  // Restore original env
  test('cleanup: restore original environment', () => {
    if (originalEnv !== undefined) {
      process.env.SKILL_CREATION_GUARD = originalEnv;
    } else {
      delete process.env.SKILL_CREATION_GUARD;
    }
    clearSkillCreatorActive();
    assert.ok(true);
  });
});

// =============================================================================
// TESTS: State Management
// =============================================================================

describe('State Management', () => {
  test('markSkillCreatorActive creates state file', () => {
    clearSkillCreatorActive();

    const result = markSkillCreatorActive('test-skill');
    assert.strictEqual(result, true);

    const state = checkSkillCreatorActive();
    assert.strictEqual(state.active, true);
    assert.strictEqual(state.skillName, 'test-skill');

    clearSkillCreatorActive();
  });

  test('clearSkillCreatorActive removes state file', () => {
    markSkillCreatorActive('test-skill');

    const result = clearSkillCreatorActive();
    assert.strictEqual(result, true);

    const state = checkSkillCreatorActive();
    assert.strictEqual(state.active, false);
  });

  test('checkSkillCreatorActive returns false when no state', () => {
    clearSkillCreatorActive();

    const state = checkSkillCreatorActive();
    assert.strictEqual(state.active, false);
  });

  test('state includes elapsed time', () => {
    markSkillCreatorActive('timing-test');

    const state = checkSkillCreatorActive();
    assert.strictEqual(state.active, true);
    assert.ok(typeof state.elapsedMs === 'number');
    assert.ok(state.elapsedMs >= 0);
    assert.ok(state.elapsedMs < 1000); // Should be very recent

    clearSkillCreatorActive();
  });
});

// =============================================================================
// TESTS: Edge Cases
// =============================================================================

describe('Edge Cases', () => {
  test('handles undefined tool input', () => {
    const result = validateSkillCreation('Write', undefined);
    assert.strictEqual(result.pass, true);
  });

  test('handles empty tool input', () => {
    const result = validateSkillCreation('Write', {});
    assert.strictEqual(result.pass, true);
  });

  test('handles file_path in different input formats', () => {
    // Test with file_path directly
    let result = validateSkillCreation('Read', { file_path: '.claude/agents/core/dev.md' });
    assert.strictEqual(result.pass, true);

    // Test with filePath (camelCase)
    result = validateSkillCreation('Read', { filePath: '.claude/agents/core/dev.md' });
    assert.strictEqual(result.pass, true);
  });
});

// =============================================================================
// RUN TESTS
// =============================================================================

console.log('\n=== Skill Creation Guard Tests ===');

// Run all tests
console.log('\n--- Results ---');
console.log(`Passed: ${testsPassed}`);
console.log(`Failed: ${testsFailed}`);

if (testsFailed > 0) {
  process.exit(1);
}
