#!/usr/bin/env node
/**
 * @deprecated REPLACED BY unified-creator-guard.cjs
 * ================================================
 *
 * This file is deprecated and no longer used. It has been replaced by:
 *   .claude/hooks/routing/unified-creator-guard.cjs
 *
 * The unified guard protects ALL creator artifacts (skills, agents, hooks,
 * workflows, templates, schemas) not just skills.
 *
 * Migration date: 2026-01-27
 * Reason: Consolidation of individual creator guards into unified system
 *
 * -----------------------------------------------------------------------
 * ORIGINAL DOCUMENTATION (for reference):
 * -----------------------------------------------------------------------
 *
 * Skill Creation Guard Hook
 * ==========================
 *
 * Prevents direct writes to .claude/skills/<skill-name>/SKILL.md without
 * invoking the skill-creator workflow. This addresses the Router bypass
 * pattern discovered in the ripgrep skill creation session.
 *
 * Root Cause (from reflection): Router bypassed skill-creator workflow by
 * directly copying files, creating an "invisible" skill that was missing
 * CLAUDE.md entry, skill catalog, and agent assignments.
 *
 * Trigger: PreToolUse (matches: Edit|Write)
 *
 * ENFORCEMENT MODES:
 * - SKILL_CREATION_GUARD=block (default): Block direct SKILL.md writes
 * - SKILL_CREATION_GUARD=warn: Warn but allow
 * - SKILL_CREATION_GUARD=off: Disable enforcement
 *
 * Exit codes:
 * - 0: Allow operation
 * - 2: Block operation (SEC-008: fail-closed on error)
 *
 * Override: Set SKILL_CREATION_GUARD=off for debugging only.
 *
 * @module skill-creation-guard
 */

'use strict';

const path = require('path');
const fs = require('fs');
const {
  parseHookInputAsync,
  getToolName,
  getToolInput,
  extractFilePath,
  getEnforcementMode,
  formatResult,
  auditLog,
} = require('../../lib/utils/hook-input.cjs');

// =============================================================================
// CONSTANTS
// =============================================================================

/**
 * Pattern to detect SKILL.md files in skills directory
 * Matches: .claude/skills/<skill-name>/SKILL.md
 */
const SKILL_FILE_PATTERN = /\.claude[\/\\]skills[\/\\][^\/\\]+[\/\\]SKILL\.md$/i;

/**
 * Pattern to detect any file in skills directory
 * Used for broader detection of skill creation activity
 */
const SKILLS_DIR_PATTERN = /\.claude[\/\\]skills[\/\\][^\/\\]+[\/\\]/i;

/**
 * State file to track skill-creator invocations
 * This is set by the Skill() tool when skill-creator is invoked
 */
const SKILL_CREATOR_STATE_FILE = '.claude/context/runtime/skill-creator-active.json';

/**
 * Time window (ms) in which skill-creator must have been invoked
 * Default: 10 minutes (allows for research + creation)
 */
const SKILL_CREATOR_WINDOW_MS = 10 * 60 * 1000;

/**
 * Tools that this hook monitors
 */
const WATCHED_TOOLS = ['Edit', 'Write'];

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

/**
 * Find project root by looking for .claude directory
 * @returns {string} Project root path
 */
function findProjectRoot() {
  let dir = __dirname;
  while (dir !== path.parse(dir).root) {
    if (fs.existsSync(path.join(dir, '.claude'))) {
      return dir;
    }
    dir = path.dirname(dir);
  }
  return process.cwd();
}

const PROJECT_ROOT = findProjectRoot();

/**
 * Check if a file path is a SKILL.md file
 * @param {string} filePath - File path to check
 * @returns {boolean}
 */
function isSkillFile(filePath) {
  if (!filePath) return false;
  return SKILL_FILE_PATTERN.test(filePath);
}

/**
 * Check if a file path is in the skills directory
 * @param {string} filePath - File path to check
 * @returns {boolean}
 */
function isInSkillsDir(filePath) {
  if (!filePath) return false;
  return SKILLS_DIR_PATTERN.test(filePath);
}

/**
 * Extract skill name from file path
 * @param {string} filePath - File path to extract from
 * @returns {string|null}
 */
function extractSkillName(filePath) {
  const match = filePath.match(/skills[\/\\]([^\/\\]+)[\/\\]/i);
  return match ? match[1] : null;
}

/**
 * Check if skill-creator was recently invoked
 * @returns {{ active: boolean, invokedAt?: string, elapsedMs?: number }}
 */
function checkSkillCreatorActive() {
  try {
    const statePath = path.join(PROJECT_ROOT, SKILL_CREATOR_STATE_FILE);
    if (!fs.existsSync(statePath)) {
      return { active: false };
    }

    const state = JSON.parse(fs.readFileSync(statePath, 'utf8'));
    if (!state.invokedAt) {
      return { active: false };
    }

    const invokedAt = new Date(state.invokedAt).getTime();
    const now = Date.now();
    const elapsedMs = now - invokedAt;

    if (elapsedMs <= SKILL_CREATOR_WINDOW_MS) {
      return {
        active: true,
        invokedAt: state.invokedAt,
        elapsedMs,
        skillName: state.skillName,
      };
    }

    return { active: false, elapsedMs };
  } catch (err) {
    // If we can't read state, assume skill-creator not active
    return { active: false };
  }
}

/**
 * Mark skill-creator as active
 * Called when skill-creator skill is invoked
 * @param {string} [skillName] - Optional skill name being created
 */
function markSkillCreatorActive(skillName) {
  try {
    const statePath = path.join(PROJECT_ROOT, SKILL_CREATOR_STATE_FILE);
    const stateDir = path.dirname(statePath);

    // Ensure directory exists
    if (!fs.existsSync(stateDir)) {
      fs.mkdirSync(stateDir, { recursive: true });
    }

    const state = {
      invokedAt: new Date().toISOString(),
      skillName: skillName || null,
    };

    fs.writeFileSync(statePath, JSON.stringify(state, null, 2));
    return true;
  } catch (err) {
    // Log error but don't fail
    if (process.env.DEBUG_HOOKS) {
      console.error('Failed to mark skill-creator active:', err.message);
    }
    return false;
  }
}

/**
 * Clear skill-creator active state
 * Called when skill creation is complete
 */
function clearSkillCreatorActive() {
  try {
    const statePath = path.join(PROJECT_ROOT, SKILL_CREATOR_STATE_FILE);
    if (fs.existsSync(statePath)) {
      fs.unlinkSync(statePath);
    }
    return true;
  } catch (err) {
    return false;
  }
}

// =============================================================================
// VALIDATION FUNCTIONS
// =============================================================================

/**
 * Validate skill creation attempt
 * @param {string} toolName - Tool being used
 * @param {Object} toolInput - Tool input
 * @returns {{ pass: boolean, result?: string, message?: string }}
 */
function validateSkillCreation(toolName, toolInput) {
  // Only check Edit/Write tools
  if (!WATCHED_TOOLS.includes(toolName)) {
    return { pass: true };
  }

  const enforcement = getEnforcementMode('SKILL_CREATION_GUARD', 'block');
  if (enforcement === 'off') {
    auditLog('skill-creation-guard', 'security_override_used', {
      override: 'SKILL_CREATION_GUARD=off',
    });
    return { pass: true };
  }

  // Extract file path
  const filePath = extractFilePath(toolInput);
  if (!filePath) {
    return { pass: true };
  }

  // Check if this is a SKILL.md file
  if (!isSkillFile(filePath)) {
    return { pass: true };
  }

  // This is a SKILL.md write - check if skill-creator is active
  const creatorState = checkSkillCreatorActive();

  if (creatorState.active) {
    // skill-creator was recently invoked - allow
    return { pass: true };
  }

  // Extract skill name for the error message
  const skillName = extractSkillName(filePath) || 'unknown';

  // VIOLATION: Direct SKILL.md write without skill-creator
  const message = `
+======================================================================+
|  SKILL CREATION GUARD VIOLATION                                      |
+======================================================================+
|  You are attempting to write directly to a SKILL.md file:            |
|    ${filePath.slice(-60).padEnd(60)}|
|                                                                      |
|  This bypasses the skill-creator workflow, which ensures:            |
|    - CLAUDE.md is updated with skill documentation                   |
|    - Skill catalog is updated for discoverability                    |
|    - Relevant agents are assigned the skill                          |
|    - Proper validation and testing occurs                            |
|                                                                      |
|  CORRECT APPROACH: Invoke skill-creator first                        |
|                                                                      |
|  Skill({ skill: "skill-creator" })                                   |
|                                                                      |
|  Then use the skill-creator workflow to create: ${skillName.padEnd(18)}|
|                                                                      |
|  Without skill-creator, the skill will be INVISIBLE to:              |
|    - Router (won't appear in routing decisions)                      |
|    - Agents (won't be assigned to any agent)                         |
|    - Users (won't appear in skill catalog)                           |
+======================================================================+
`;

  if (enforcement === 'block') {
    return { pass: false, result: 'block', message };
  } else {
    return { pass: true, result: 'warn', message };
  }
}

// =============================================================================
// MAIN EXECUTION
// =============================================================================

/**
 * Main execution function
 */
async function main() {
  try {
    // Parse the hook input
    const hookInput = await parseHookInputAsync();

    if (!hookInput) {
      // No input - allow (fail open for missing input)
      process.exit(0);
    }

    // Get tool name and input
    const toolName = getToolName(hookInput);
    const toolInput = getToolInput(hookInput);

    // Skip if not a watched tool
    if (!toolName || !WATCHED_TOOLS.includes(toolName)) {
      process.exit(0);
    }

    // Validate skill creation
    const result = validateSkillCreation(toolName, toolInput);

    if (!result.pass) {
      // Log the violation
      const filePath = extractFilePath(toolInput);
      auditLog('skill-creation-guard', `security_${result.result}`, {
        tool: toolName,
        file: filePath,
        reason: 'Direct SKILL.md write without skill-creator workflow',
      });

      // Output block/warn result
      console.log(formatResult(result.result, result.message));
      process.exit(result.result === 'block' ? 2 : 0);
    }

    if (result.result === 'warn') {
      console.warn(result.message);
    }

    // All checks passed
    process.exit(0);
  } catch (err) {
    // SEC-008: Allow debug override for troubleshooting
    if (process.env.HOOK_FAIL_OPEN === 'true') {
      auditLog('skill-creation-guard', 'fail_open_override', { error: err.message });
      process.exit(0);
    }

    // Audit log the error
    auditLog('skill-creation-guard', 'error_fail_closed', { error: err.message });

    // SEC-008: Fail closed - deny when security state unknown
    process.exit(2);
  }
}

// Run if this is the main module
if (require.main === module) {
  main();
}

// Export for testing and programmatic use
module.exports = {
  main,
  validateSkillCreation,
  isSkillFile,
  isInSkillsDir,
  extractSkillName,
  checkSkillCreatorActive,
  markSkillCreatorActive,
  clearSkillCreatorActive,
  // Constants
  SKILL_FILE_PATTERN,
  SKILLS_DIR_PATTERN,
  SKILL_CREATOR_STATE_FILE,
  SKILL_CREATOR_WINDOW_MS,
  WATCHED_TOOLS,
  PROJECT_ROOT,
};
