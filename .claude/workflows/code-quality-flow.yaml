name: Code Quality Improvement Workflow
description: Systematic code quality improvement, refactoring, and compliance validation
type: code-quality
project_type: enhancement
publish_policy: auto-on-pass  # Automatically publish artifacts after validation passes

# Error Recovery Configuration
recovery:
  enabled: true
  checkpoint_dir: ".claude/context/runs/{{run_id}}/checkpoints"

retry_config:
  max_attempts: 3
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

fallback_agents:
  developer: [code-reviewer, qa]
  architect: [developer, security-architect]
  qa: [developer, code-reviewer]
  planner: [architect, pm]
  code-reviewer: [refactoring-specialist, security-architect]
  refactoring-specialist: [developer, architect]
  code-simplifier: [code-reviewer, refactoring-specialist]
  security-architect: [compliance-auditor, code-reviewer]
  compliance-auditor: [security-architect, qa]

# NOTE: trigger_keywords here are for documentation only.
# The actual workflow selection uses keywords from .claude/config.yaml workflow_selection section.
# See .claude/config.yaml for the authoritative keyword list used by the routing system.
trigger_keywords:
  - "code quality"
  - "code review"
  - "refactor"
  - "tech debt"
  - "code smell"
  - "clean up"

# Workflow-Level Context Inputs
# These inputs must be provided when the workflow is initialized (by orchestrator or user).
# They are passed directly to agents as context, not loaded from artifact files.
#
# Required Inputs:
#   - target_files: Array of file/directory paths to analyze
#     Example: ["src/", "lib/", "app/components/"]
#   - coding_standards: String or array of coding standards to apply
#     Example: "PEP 8" or ["Airbnb JavaScript Style Guide", "Google Java Style"]
#
# How to Provide:
#   1. Via orchestrator: Pass as context object when initializing workflow
#      Example:
#        {
#          "target_files": ["src/", "lib/"],
#          "coding_standards": "PEP 8"
#        }
#
#   2. Via command line: Set as environment variables
#      Example:
#        export TARGET_FILES='["src/", "lib/"]'
#        export CODING_STANDARDS="PEP 8"
#
#   3. Via JSON config file: Include in workflow initialization parameters
#      Example config.json:
#        {
#          "workflow": "code-quality-flow",
#          "inputs": {
#            "target_files": ["src/", "lib/"],
#            "coding_standards": "PEP 8"
#          }
#        }
#
# Validation: These inputs are validated by the orchestrator before workflow execution.
# If not provided, the workflow will fail with a clear error message.
#
# Agent Usage: Agents receive these inputs as context variables (not artifact files).
# Agents should check for these inputs in their context and use them for their analysis.
# Example agent code:
#   const targetFiles = context.target_files || [];
#   const codingStandards = context.coding_standards || "default";
workflow_inputs:
  required:
    - target_files
    - coding_standards
  optional: []

steps:
  - step: 0
    name: "Planning Phase"
    agent: planner
    inputs:
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze (e.g., ["src/", "lib/", "app/components/"])
      - coding_standards  # Coding standards to apply (e.g., "PEP 8", "Airbnb JavaScript Style Guide", "Google Java Style")
    outputs:
      - plan-{{workflow_id}}.md
      - plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-planner.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - plan-generator
        - sequential-thinking
      recommended:
        - diagram-generator
        - classifier
      triggered:
        - pattern: "complex|large|multi-phase"
          skills: [sequential-thinking, diagram-generator]
          priority: required
        - pattern: "security|auth|compliance"
          skills: [sequential-thinking]
          priority: required
          skill_params:
            focus_areas: ["security", "compliance"]
      outputs:
        plan-generator:
          primary: "plan-{{workflow_id}}.json"
          schema: ".claude/schemas/plan.schema.json"
          required_for_completion: true
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
    validation:
      schema: .claude/schemas/plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-planner.json
    description: |
      Plan code quality improvement workflow:
      - Analyze code quality requirements
      - Coordinate with specialists for planning
      - Create structured improvement plan
      - **Publishing**: After validation, use `artifact-publisher` skill to publish plan artifacts to project feed

  - step: 0.1
    name: "Plan Rating Gate"
    agent: orchestrator
    type: validation
    skill: response-rater
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
    outputs:
      - .claude/context/runs/<run_id>/plans/<plan_id>-rating.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00.1-orchestrator.json
    validation:
      minimum_score: 7
      rubric_file: .claude/context/artifacts/standard-plan-rubric.json
      gate: .claude/context/history/gates/{{workflow_id}}/00.1-orchestrator.json
    retry:
      max_attempts: 3
      on_failure: escalate_to_human
    description: |
      Rate plan quality using response-rater skill.
      - Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
      - Minimum passing score: 7/10
      - If score < 7: Return to Planner with feedback, request improvements, re-rate until passing
      - If score >= 7: Proceed with workflow execution
      - Log rating in reasoning file and artifact metadata
      - Never execute an unrated plan - this is a hard requirement

  - step: 1
    name: "Code Review Analysis"
    agent: code-reviewer
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze
      - coding_standards  # Coding standards to apply
    outputs:
      - code-review-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-code-reviewer.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - rule-auditor
        - code-style-validator
        - explaining-rules
      recommended:
        - fixing-rule-violations
        - dependency-analyzer
      triggered:
        - pattern: "security|auth|password|credential"
          skills: [rule-auditor]
          priority: required
          skill_params:
            rule_categories: ["security", "authentication"]
        - pattern: "performance|optimize|slow"
          skills: [dependency-analyzer]
          priority: recommended
      outputs:
        rule-auditor:
          primary: "code-review-{{workflow_id}}.json"
          secondary: ["violations-{{workflow_id}}.json"]
          schema: ".claude/schemas/code-review.schema.json"
          required_for_completion: true
        code-style-validator:
          primary: "style-report-{{workflow_id}}.json"
          required_for_completion: false
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
        compliance_report_path: ".claude/context/runs/{{run_id}}/skill-compliance-01.json"
    validation:
      schema: .claude/schemas/code-review.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/01-code-reviewer.json
    description: |
      Systematic analysis of code quality including:
      - Adherence to coding standards
      - Design pattern usage
      - Code complexity metrics
      - Security considerations
      - Test coverage assessment

  - step: 1.5
    name: "Dependency Research (Optional)"
    agent: developer
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - dependency-analysis-{{workflow_id}}.json (optional, from previous analysis)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze
    outputs:
      - breaking-changes-research-{{workflow_id}}.json
      - migration-guides-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01.5-developer.json
    validation:
      schema: .claude/schemas/breaking_changes_research.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/01.5-developer.json
    description: |
      Research breaking changes and migration guides for outdated dependencies:
      - Use web search tools (Exa/WebFetch) to research breaking changes
      - Find migration guides and changelogs for major version updates
      - Document breaking changes, migration paths, and risk assessments
      - Only executes if dependency-analysis artifact exists from previous step
      - This step is optional and will be skipped if dependency-analysis-{{workflow_id}}.json is not available

  - step: 2
    name: "Refactoring Planning"
    agent: refactoring-specialist
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - code-review-{{workflow_id}}.json (from step 1)
      - breaking-changes-research-{{workflow_id}}.json (optional, from step 1.5)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze
      - coding_standards  # Coding standards to apply
    outputs:
      - refactoring-plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-refactoring-specialist.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - repo-rag
        - rule-auditor
        - fixing-rule-violations
      recommended:
        - diagram-generator
        - code-style-validator
      triggered:
        - pattern: "breaking change|migration|upgrade"
          skills: [repo-rag, diagram-generator]
          priority: required
        - pattern: "complex|large-scale|multi-file"
          skills: [diagram-generator]
          priority: recommended
      outputs:
        fixing-rule-violations:
          primary: "refactoring-plan-{{workflow_id}}.json"
          schema: ".claude/schemas/refactoring-plan.schema.json"
          required_for_completion: true
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
    validation:
      schema: .claude/schemas/refactoring-plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/02-refactoring-specialist.json
    description: |
      Safe transformation strategy including:
      - Prioritized refactoring tasks
      - Dependency impact analysis
      - Incremental migration paths
      - Risk mitigation strategies

  - step: 3
    name: "Implementation"
    agent: developer
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - refactoring-plan-{{workflow_id}}.json (from step 2)
      - code-review-{{workflow_id}}.json (from step 1)
      - breaking-changes-research-{{workflow_id}}.json (optional, from step 1.5)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to refactor
      - coding_standards  # Coding standards to apply
    outputs:
      - dev-manifest.json
      - code-artifacts
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-developer.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - scaffolder
        - rule-auditor
        - repo-rag
      recommended:
        - test-generator
        - claude-md-generator
        - code-style-validator
      triggered:
        - pattern: "new component|create component|generate component"
          skills: [scaffolder, test-generator]
          priority: required
        - pattern: "fix|bug|error"
          skills: [repo-rag, rule-auditor]
          priority: required
        - pattern: "refactor|optimize"
          skills: [rule-auditor, code-style-validator]
          priority: required
        - pattern: "test|spec|coverage"
          skills: [test-generator]
          priority: required
      outputs:
        scaffolder:
          primary: "dev-manifest.json"
          schema: ".claude/schemas/artifact_manifest.schema.json"
          required_for_completion: true
        test-generator:
          primary: "test-manifest-{{workflow_id}}.json"
          required_for_completion: false
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: retry
        max_retries: 2
    validation:
      schema: .claude/schemas/artifact_manifest.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03-developer.json
    description: |
      Apply refactoring changes:
      - Implement refactoring plan
      - Apply code quality improvements
      - Fix code smells and anti-patterns
      - Update tests as needed

  - step: 3.5
    name: "Post-Refactoring Code Review"
    agent: code-reviewer
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest.json (from step 3)
      - refactoring-plan-{{workflow_id}}.json (from step 2)
      - code-review-{{workflow_id}}.json (from step 1)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories analyzed
      - coding_standards  # Coding standards to apply
    outputs:
      - code-review-post-refactoring-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03.5-code-reviewer.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - rule-auditor
        - code-style-validator
      recommended:
        - fixing-rule-violations
        - explaining-rules
      triggered:
        - pattern: "regression|breaking|compatibility"
          skills: [rule-auditor, explaining-rules]
          priority: required
        - pattern: "style|format|lint"
          skills: [code-style-validator]
          priority: required
      outputs:
        rule-auditor:
          primary: "code-review-post-refactoring-{{workflow_id}}.json"
          schema: ".claude/schemas/code-review.schema.json"
          required_for_completion: true
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: escalate
    validation:
      schema: .claude/schemas/code-review.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03.5-code-reviewer.json
    on_failure: "Return to implementation step with feedback"
    description: |
      Review refactored code for quality, security, and codebase impact:
      - Verify refactoring plan was correctly applied
      - Check for unintended regressions
      - Validate code quality improvements
      - Ensure coding standards compliance
      - Review security implications

  - step: 3.7
    name: "Code Simplification Review"
    agent: code-simplifier
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest.json (from step 3)
      - code-review-post-refactoring-{{workflow_id}}.json (from step 3.5)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze for simplification
      - coding_standards  # Coding standards to apply
    outputs:
      - simplification-report-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03.7-code-simplifier.json
    validation:
      schema: .claude/schemas/simplification-report.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03.7-code-simplifier.json
    on_failure: "Return to implementation step with simplification feedback"
    description: |
      Simplification review to ensure code is understandable by all developers:
      - Measure cognitive complexity and nesting depth
      - Identify over-engineering and premature abstractions
      - Flag code that fails the "junior developer test"
      - Provide before/after transformation examples
      - Block merge if complexity score > 7/10

  - step: 3.8
    name: "Security Code Review"
    agent: security-architect
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest.json (from step 3)
      - code-review-post-refactoring-{{workflow_id}}.json (from step 3.5)
      - refactoring-plan-{{workflow_id}}.json (from step 2)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze for security issues
      - coding_standards  # Coding standards to apply
    outputs:
      - security-code-review-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03.8-security-architect.json
    validation:
      schema: .claude/schemas/security-code-review.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03.8-security-architect.json
    on_failure: "Return to implementation step with security feedback"
    description: |
      Security-focused code review of refactored code:
      - Check for security vulnerabilities introduced by refactoring
      - Review authentication and authorization patterns
      - Validate input validation and sanitization
      - Check for hardcoded secrets or credentials
      - Review error handling and logging for security leaks
      - Verify secure coding practices followed
      - Block merge if critical security issues found

  - step: 4
    name: "Compliance Validation"
    agent: compliance-auditor
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest.json (from step 3)
      - refactoring-plan-{{workflow_id}}.json (from step 2)
      - code-review-{{workflow_id}}.json (from step 1)
      - code-review-post-refactoring-{{workflow_id}}.json (from step 3.5)
      - simplification-report-{{workflow_id}}.json (from step 3.7)
      - security-code-review-{{workflow_id}}.json (from step 3.8)
      - breaking-changes-research-{{workflow_id}}.json (optional, from step 1.5)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze
      - coding_standards  # Coding standards to apply
    outputs:
      - compliance-report-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-compliance-auditor.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - rule-auditor
        - dependency-analyzer
        - explaining-rules
      recommended:
        - doc-generator
        - pdf-generator
      triggered:
        - pattern: "OWASP|security|vulnerability"
          skills: [rule-auditor, dependency-analyzer]
          priority: required
          skill_params:
            rule_categories: ["security", "owasp", "vulnerability"]
        - pattern: "GDPR|HIPAA|SOC2|PCI|compliance"
          skills: [explaining-rules]
          priority: required
        - pattern: "report|audit|documentation"
          skills: [doc-generator, pdf-generator]
          priority: recommended
      outputs:
        rule-auditor:
          primary: "compliance-report-{{workflow_id}}.json"
          schema: ".claude/schemas/compliance-report.schema.json"
          required_for_completion: true
        dependency-analyzer:
          primary: "dependency-audit-{{workflow_id}}.json"
          required_for_completion: false
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
        require_output_validation: true
    validation:
      schema: .claude/schemas/compliance-report.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/04-compliance-auditor.json
    description: |
      Verify compliance with:
      - Industry standards (OWASP, etc.)
      - Coding guidelines
      - Security best practices (from security code review)
      - Documentation requirements

  - step: 5
    name: "Quality Validation"
    agent: qa
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest.json (from step 3)
      - code-review-{{workflow_id}}.json (from step 1)
      - code-review-post-refactoring-{{workflow_id}}.json (from step 3.5)
      - simplification-report-{{workflow_id}}.json (from step 3.7)
      - refactoring-plan-{{workflow_id}}.json (from step 2)
      - compliance-report-{{workflow_id}}.json (from step 4)
      - breaking-changes-research-{{workflow_id}}.json (optional, from step 1.5)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze
      - coding_standards  # Coding standards to apply
    outputs:
      - quality-report-{{workflow_id}}.json
      - test-results-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/05-qa.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - test-generator
        - rule-auditor
        - evaluator
      recommended:
        - response-rater
        - chrome-devtools
        - summarizer
      triggered:
        - pattern: "unit test|integration test|e2e"
          skills: [test-generator]
          priority: required
        - pattern: "browser|ui|visual"
          skills: [chrome-devtools]
          priority: required
        - pattern: "coverage|metrics|quality gate"
          skills: [evaluator]
          priority: required
        - pattern: "report|summary|findings"
          skills: [summarizer]
          priority: recommended
      outputs:
        test-generator:
          primary: "test-results-{{workflow_id}}.json"
          schema: ".claude/schemas/test-results.schema.json"
          required_for_completion: true
        evaluator:
          primary: "quality-report-{{workflow_id}}.json"
          schema: ".claude/schemas/quality-report.schema.json"
          required_for_completion: true
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
        require_output_validation: true
        compliance_report_path: ".claude/context/runs/{{run_id}}/skill-compliance-05.json"
    validation:
      schema: .claude/schemas/quality-report.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/05-qa.json
      # Validation Notes:
      # Primary output: quality-report-{{workflow_id}}.json
      #   - Validated against quality-report.schema.json by workflow runner
      # Secondary output: test-results-{{workflow_id}}.json
      #   - Schema: .claude/schemas/test-results.schema.json
      #   - Automatically validated by workflow runner after primary output validation passes
      #   - Validation timing: post-generation (after primary output passes)
      #   - If validation fails, the workflow runner will report the error and step will fail
      #   - The QA agent must ensure this artifact is created and conforms to the schema
      secondary_outputs:
        - artifact: test-results-{{workflow_id}}.json
          schema: .claude/schemas/test-results.schema.json
          validation_timing: post-generation
    description: |
      Final quality validation:
      - Test coverage verification
      - Regression testing
      - Quality gate assessment
      - Sign-off recommendation
      - **Publishing**: After validation, use `artifact-publisher` skill to publish quality-report and test-results to project feed

  - step: 5.5
    name: "Publish Artifacts"
    agent: orchestrator
    skill: artifact-publisher
    condition: "validation_status == 'pass'"
    inputs:
      - artifact-registry.json
    policy: auto-on-pass
    retry:
      max_attempts: 3
      on_failure: log_and_continue

completion_criteria:
  - Code review completed with actionable findings
  - Refactoring plan approved
  - Code simplification review passed (complexity score <= 7)
  - Compliance requirements met
  - Quality gates passed
