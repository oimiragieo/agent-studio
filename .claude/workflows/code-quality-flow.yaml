name: Code Quality Improvement Workflow
description: Systematic code quality improvement, refactoring, and compliance validation
type: code-quality
project_type: enhancement

# NOTE: trigger_keywords here are for documentation only.
# The actual workflow selection uses keywords from .claude/config.yaml workflow_selection section.
# See .claude/config.yaml for the authoritative keyword list used by the routing system.
trigger_keywords:
  - "code quality"
  - "code review"
  - "refactor"
  - "tech debt"
  - "code smell"
  - "clean up"

# Workflow-Level Context Inputs
# These inputs must be provided when the workflow is initialized (by orchestrator or user).
# They are passed directly to agents as context, not loaded from artifact files.
#
# Required Inputs:
#   - target_files: Array of file/directory paths to analyze
#     Example: ["src/", "lib/", "app/components/"]
#   - coding_standards: String or array of coding standards to apply
#     Example: "PEP 8" or ["Airbnb JavaScript Style Guide", "Google Java Style"]
#
# How to Provide:
#   1. Via orchestrator: Pass as context object when initializing workflow
#      Example:
#        {
#          "target_files": ["src/", "lib/"],
#          "coding_standards": "PEP 8"
#        }
#
#   2. Via command line: Set as environment variables
#      Example:
#        export TARGET_FILES='["src/", "lib/"]'
#        export CODING_STANDARDS="PEP 8"
#
#   3. Via JSON config file: Include in workflow initialization parameters
#      Example config.json:
#        {
#          "workflow": "code-quality-flow",
#          "inputs": {
#            "target_files": ["src/", "lib/"],
#            "coding_standards": "PEP 8"
#          }
#        }
#
# Validation: These inputs are validated by the orchestrator before workflow execution.
# If not provided, the workflow will fail with a clear error message.
#
# Agent Usage: Agents receive these inputs as context variables (not artifact files).
# Agents should check for these inputs in their context and use them for their analysis.
# Example agent code:
#   const targetFiles = context.target_files || [];
#   const codingStandards = context.coding_standards || "default";
workflow_inputs:
  required:
    - target_files
    - coding_standards
  optional: []

steps:
  - step: 0
    name: "Planning Phase"
    agent: planner
    inputs:
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze (e.g., ["src/", "lib/", "app/components/"])
      - coding_standards  # Coding standards to apply (e.g., "PEP 8", "Airbnb JavaScript Style Guide", "Google Java Style")
    outputs:
      - plan-{{workflow_id}}.md
      - plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-planner.json
    validation:
      schema: .claude/schemas/plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-planner.json
    description: |
      Plan code quality improvement workflow:
      - Analyze code quality requirements
      - Coordinate with specialists for planning
      - Create structured improvement plan

  - step: 1
    name: "Code Review Analysis"
    agent: code-reviewer
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze
      - coding_standards  # Coding standards to apply
    outputs:
      - code-review-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-code-reviewer.json
    validation:
      schema: .claude/schemas/code-review.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/01-code-reviewer.json
    description: |
      Systematic analysis of code quality including:
      - Adherence to coding standards
      - Design pattern usage
      - Code complexity metrics
      - Security considerations
      - Test coverage assessment

  - step: 2
    name: "Refactoring Planning"
    agent: refactoring-specialist
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - code-review-{{workflow_id}}.json (from step 1)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze
      - coding_standards  # Coding standards to apply
    outputs:
      - refactoring-plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-refactoring-specialist.json
    validation:
      schema: .claude/schemas/refactoring-plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/02-refactoring-specialist.json
    description: |
      Safe transformation strategy including:
      - Prioritized refactoring tasks
      - Dependency impact analysis
      - Incremental migration paths
      - Risk mitigation strategies

  - step: 3
    name: "Compliance Validation"
    agent: compliance-auditor
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - refactoring-plan-{{workflow_id}}.json (from step 2)
      - code-review-{{workflow_id}}.json (from step 1)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze
      - coding_standards  # Coding standards to apply
    outputs:
      - compliance-report-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-compliance-auditor.json
    validation:
      schema: .claude/schemas/compliance-report.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03-compliance-auditor.json
    description: |
      Verify compliance with:
      - Industry standards (OWASP, etc.)
      - Coding guidelines
      - Security best practices
      - Documentation requirements

  - step: 4
    name: "Quality Validation"
    agent: qa
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - code-review-{{workflow_id}}.json (from step 1)
      - refactoring-plan-{{workflow_id}}.json (from step 2)
      - compliance-report-{{workflow_id}}.json (from step 3)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files  # List of files/directories to analyze
      - coding_standards  # Coding standards to apply
    outputs:
      - quality-report-{{workflow_id}}.json
      - test-results-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-qa.json
    validation:
      schema: .claude/schemas/quality-report.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/04-qa.json
      # Validation Notes:
      # Primary output: quality-report-{{workflow_id}}.json
      #   - Validated against quality-report.schema.json by workflow runner
      # Secondary output: test-results-{{workflow_id}}.json
      #   - Schema: .claude/schemas/test-results.schema.json
      #   - Automatically validated by workflow runner after primary output validation passes
      #   - Validation timing: post-generation (after primary output passes)
      #   - If validation fails, the workflow runner will report the error and step will fail
      #   - The QA agent must ensure this artifact is created and conforms to the schema
      secondary_outputs:
        - artifact: test-results-{{workflow_id}}.json
          schema: .claude/schemas/test-results.schema.json
          validation_timing: post-generation
    description: |
      Final quality validation:
      - Test coverage verification
      - Regression testing
      - Quality gate assessment
      - Sign-off recommendation

completion_criteria:
  - Code review completed with actionable findings
  - Refactoring plan approved
  - Compliance requirements met
  - Quality gates passed
