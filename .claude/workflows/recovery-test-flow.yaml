name: Error Recovery and Checkpoint Restoration Workflow
description: Comprehensive testing of error recovery mechanisms, checkpoint creation, and workflow resilience
type: testing
project_type: validation
publish_policy: auto-on-pass  # Automatically publish artifacts after validation passes

# Error Recovery Configuration
recovery:
  enabled: true
  checkpoint_dir: ".claude/context/runs/{{run_id}}/checkpoints"
  test_mode: true  # Enable test mode for recovery testing
  checkpoint_phases: [1, 3, 5]  # Create checkpoints at these phase boundaries

retry_config:
  max_attempts: 3
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

fallback_agents:
  planner: [architect, pm]
  qa: [developer, code-reviewer]
  technical-writer: [developer, pm]
  developer: [refactoring-specialist, code-reviewer]
  orchestrator: [planner]

# NOTE: trigger_keywords here are for documentation only.
# The actual workflow selection uses keywords from .claude/config.yaml workflow_selection section.
# See .claude/config.yaml for the authoritative keyword list used by the routing system.
trigger_keywords:
  - "test error recovery"
  - "test checkpoint"
  - "recovery test"
  - "checkpoint restoration"
  - "workflow resilience"

# Workflow-Level Context Inputs
workflow_inputs:
  required:
    - test_scenario  # "checkpoint_creation" | "checkpoint_restoration" | "fallback_routing" | "full_recovery"
  optional:
    - failure_step  # Step number to simulate failure (for restoration tests)
    - checkpoint_phase  # Phase to restore from (1, 3, or 5)

steps:
  - step: 0
    name: "Planning Phase"
    agent: planner
    inputs:
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - test_scenario  # Test scenario to execute
      - failure_step  # (optional) Step to simulate failure
      - checkpoint_phase  # (optional) Phase to restore from
    outputs:
      - plan-{{workflow_id}}.md
      - plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-planner.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - plan-generator
        - sequential-thinking
      recommended:
        - diagram-generator
      triggered:
        - pattern: "recovery|checkpoint|resilience"
          skills: [sequential-thinking, diagram-generator]
          priority: required
      outputs:
        plan-generator:
          primary: "plan-{{workflow_id}}.json"
          schema: ".claude/schemas/plan.schema.json"
          required_for_completion: true
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
    validation:
      schema: .claude/schemas/plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-planner.json
    description: |
      Create comprehensive recovery test plan:
      - Analyze checkpoint scenarios and recovery paths
      - Identify fallback strategies
      - Define test success criteria
      - Create structured recovery test plan

  - step: 0.1
    name: "Plan Rating Gate"
    agent: orchestrator
    type: validation
    skill: response-rater
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
    outputs:
      - .claude/context/runs/{{run_id}}/plans/{{plan_id}}-rating.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00.1-orchestrator.json
    validation:
      minimum_score: 7
      rubric_file: .claude/context/artifacts/standard-plan-rubric.json
      gate: .claude/context/history/gates/{{workflow_id}}/00.1-orchestrator.json
    retry:
      max_attempts: 3
      on_failure: escalate_to_human
    description: |
      Rate plan quality using response-rater skill.
      - Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
      - Minimum passing score: 7/10
      - If score < 7: Return to Planner with feedback, request improvements, re-rate
      - If score >= 7: Proceed with workflow execution
      - Log rating in reasoning file and artifact metadata
      - Never execute an unrated plan - this is a hard requirement

  - step: 1
    name: "Checkpoint Creation Test (Phase 1)"
    agent: qa
    checkpoint_phase: 1
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
    outputs:
      - checkpoint-phase-1-{{workflow_id}}.json
      - checkpoint-validation-phase-1-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-qa.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - recovery
        - evaluator
      recommended:
        - summarizer
      triggered:
        - pattern: "checkpoint|recovery|restoration"
          skills: [recovery]
          priority: required
      outputs:
        recovery:
          primary: "checkpoint-phase-1-{{workflow_id}}.json"
          schema: ".claude/schemas/checkpoint.schema.json"
          required_for_completion: true
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
    validation:
      schema: .claude/schemas/checkpoint.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/01-qa.json
    description: |
      Validate checkpoint creation at Phase 1 boundary:
      - Create checkpoint after planning phase
      - Verify checkpoint conforms to checkpoint.schema.json
      - Validate checkpoint includes all required fields
      - Check checkpoint includes completed steps, artifacts, state snapshot
      - Save checkpoint to .claude/context/runs/{{run_id}}/checkpoints/

  - step: 2
    name: "Simulated Work - Phase 2"
    agent: developer
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - checkpoint-phase-1-{{workflow_id}}.json (from step 1)
    outputs:
      - phase-2-work-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-developer.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/02-developer.json
    description: |
      Simulate work for Phase 2:
      - Create artifacts for Phase 2
      - Progress workflow state
      - Prepare for Phase 3 checkpoint

  - step: 3
    name: "Checkpoint Creation Test (Phase 3)"
    agent: qa
    checkpoint_phase: 3
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - checkpoint-phase-1-{{workflow_id}}.json (from step 1)
      - phase-2-work-{{workflow_id}}.json (from step 2)
    outputs:
      - checkpoint-phase-3-{{workflow_id}}.json
      - checkpoint-validation-phase-3-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-qa.json
    validation:
      schema: .claude/schemas/checkpoint.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03-qa.json
    description: |
      Validate checkpoint creation at Phase 3 boundary:
      - Create checkpoint after design phase
      - Verify checkpoint includes all work from Phase 1-3
      - Validate checkpoint integrity
      - Check state accuracy

  - step: 4
    name: "Checkpoint Restoration Test"
    agent: qa
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - checkpoint-phase-3-{{workflow_id}}.json (from step 3)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - checkpoint_phase  # (optional) Phase to restore from
    outputs:
      - restoration-validation-{{workflow_id}}.json
      - restored-state-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-qa.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - recovery
        - evaluator
      recommended: []
      triggered:
        - pattern: "restore|recovery|checkpoint"
          skills: [recovery]
          priority: required
      outputs:
        recovery:
          primary: "restoration-validation-{{workflow_id}}.json"
          schema: ".claude/schemas/restoration-validation.schema.json"
          required_for_completion: true
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
    validation:
      schema: .claude/schemas/restoration-validation.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/04-qa.json
    description: |
      Test checkpoint restoration:
      - Simulate failure scenario
      - Restore from saved checkpoint (Phase 3)
      - Verify state integrity and artifact preservation
      - Validate completed steps match checkpoint
      - Verify artifacts restored to correct locations
      - Check validation gates passed
      - Ensure no data loss or corruption

  - step: 5
    name: "Fallback Agent Routing Test"
    agent: qa
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - restoration-validation-{{workflow_id}}.json (from step 4)
    outputs:
      - fallback-routing-log-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/05-qa.json
    validation:
      schema: .claude/schemas/fallback-routing-log.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/05-qa.json
    description: |
      Test fallback agent routing:
      - Trigger primary agent failure
      - Validate fallback routing to appropriate agent
      - Verify context preservation across routing
      - Check task context preserved (original description, artifacts, fallback history)
      - Validate fallback agent completes task successfully
      - Log all fallback events with timestamps

  - step: 6
    name: "Recovery Documentation"
    agent: technical-writer
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - checkpoint-validation-phase-1-{{workflow_id}}.json (from step 1)
      - checkpoint-validation-phase-3-{{workflow_id}}.json (from step 3)
      - restoration-validation-{{workflow_id}}.json (from step 4)
      - fallback-routing-log-{{workflow_id}}.json (from step 5)
    outputs:
      - recovery-documentation-{{workflow_id}}.md
      - recovery-playbook-{{workflow_id}}.md
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/06-technical-writer.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/06-technical-writer.json
    description: |
      Document recovery events and create playbook:
      - Log all recovery operations
      - Document checkpoint creation and restoration
      - Record fallback routing events
      - Create recovery playbook for future reference
      - Save to .claude/context/logs/recovery.log

  - step: 7
    name: "Final Validation Report"
    agent: qa
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - checkpoint-validation-phase-1-{{workflow_id}}.json (from step 1)
      - checkpoint-validation-phase-3-{{workflow_id}}.json (from step 3)
      - restoration-validation-{{workflow_id}}.json (from step 4)
      - fallback-routing-log-{{workflow_id}}.json (from step 5)
      - recovery-documentation-{{workflow_id}}.md (from step 6)
    outputs:
      - recovery-test-report-{{workflow_id}}.json
      - recovery-metrics-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/07-qa.json
    validation:
      schema: .claude/schemas/recovery-test-report.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/07-qa.json
    description: |
      Generate final validation report:
      - Verify all checkpoint creation tests passed
      - Validate checkpoint restoration successful
      - Confirm fallback routing worked correctly
      - Check all artifacts preserved and validated
      - Document recovery metrics (timing, accuracy, success rates)
      - Provide comprehensive recovery test summary

  - step: 7.5
    name: "Publish Artifacts"
    agent: orchestrator
    skill: artifact-publisher
    condition: "validation_status == 'pass'"
    inputs:
      - artifact-registry.json
    policy: auto-on-pass
    retry:
      max_attempts: 3
      on_failure: log_and_continue

completion_criteria:
  - Plan created and rated (score >= 7/10)
  - Plan rating recorded in run state
  - Checkpoint created after Phase 1 with schema validation
  - Checkpoint created after Phase 3 with schema validation
  - Checkpoint restoration successful with 100% state accuracy
  - Fallback agent receives task with preserved context
  - Recovery events logged to .claude/context/logs/recovery.log
  - All artifacts restored from checkpoint correctly
  - Recovery playbook created
  - Final validation report generated

test_scenarios:
  checkpoint_creation:
    description: "Validate checkpoint creation at phase boundaries"
    phases: [1, 3, 5]
    validation: "Checkpoints exist and conform to schema"

  checkpoint_restoration:
    description: "Test restoration from checkpoint"
    restore_from_phase: 3
    simulate_failure_at_step: 4
    validation: "State restored exactly, no data loss"

  fallback_routing:
    description: "Test fallback agent routing"
    primary_agent: developer
    expected_fallback: refactoring-specialist
    validation: "Task context preserved, routing successful"

  full_recovery:
    description: "End-to-end recovery flow"
    checkpoints: [1, 3, 5]
    failure_step: 6
    restore_from_phase: 5
    validation: "Complete recovery, workflow continues successfully"

recovery_metrics:
  checkpoint_creation_time: "< 500ms"
  checkpoint_file_size: "< 100KB"
  restoration_time: "< 2s"
  state_accuracy: "100%"
  fallback_routing_time: "< 100ms"
  context_preservation: "100%"
