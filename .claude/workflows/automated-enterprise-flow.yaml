name: Automated Enterprise Workflow
description: Automated plan → implement → debug → fix cycle with multi-AI validation and shift-work orchestration
type: enterprise
project_type: enterprise

# NOTE: trigger_keywords here are for documentation only.
# The actual workflow selection uses keywords from .claude/config.yaml workflow_selection section.
trigger_keywords:
  - "automated workflow"
  - "enterprise automation"
  - "plan implement debug fix"
  - "automated development"
  - "continuous development"
  - "shift-work"

# Workflow inputs
inputs:
  project_name:
    type: string
    description: "Project name for workflow execution"
    required: true
  plan_file:
    type: string
    description: "Path to plan file (optional, will create if not provided)"
    required: false
  max_iterations:
    type: number
    description: "Maximum iterations for plan → implement → debug → fix cycle (default: 10)"
    required: false
    default: 10
  validators:
    type: array
    description: "List of validators to use (default: cursor,gemini,codex)"
    required: false
    default: ["cursor", "gemini", "codex"]
  auto_fix:
    type: boolean
    description: "Enable automatic fixing of issues (default: true)"
    required: false
    default: true
  spawn_cursor:
    type: boolean
    description: "Spawn new Cursor window on handoff (default: false)"
    required: false
    default: false

# Workflow context directory
context_dir: .claude/context/automated-enterprise/{{workflow_id}}

steps:
  # Phase 0: Planning
  - step: 0
    name: "Planning Phase"
    agent: planner
    inputs:
      - project_name
      - plan_file
    outputs:
      - plan-{{workflow_id}}.md
      - plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-planner.json
    validation:
      schema: .claude/schemas/plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-planner.json
    description: |
      Create comprehensive plan:
      - Analyze requirements
      - Break down into tasks with dependencies
      - Assign agents to tasks
      - Define test requirements
      - Create phase-based structure

  # Phase 1: Implementation
  - step: 1
    name: "Implementation Phase"
    agent: orchestrator
    tool: workflow-automator
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - project_name
      - max_iterations
      - validators
      - auto_fix
    outputs:
      - implementation-results.json
      - code-artifacts
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-orchestrator.json
    validation:
      schema: .claude/schemas/automated-implementation.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/01-orchestrator.json
    description: |
      Automated implementation:
      - Execute plan tasks sequentially or in parallel
      - Delegate to assigned agents (developer, architect, etc.)
      - Capture all artifacts and outputs
      - Track task completion status
      - Use workflow-automator tool for orchestration

  # Phase 2: Validation
  - step: 2
    name: "Multi-AI Validation"
    agent: model-orchestrator
    tool: multi-ai-validator
    inputs:
      - implementation-results.json (from step 1)
      - project_name
      - validators
    outputs:
      - validation-report.json
      - consensus-issues.json
      - disagreements.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-model-orchestrator.json
    validation:
      schema: .claude/schemas/multi-ai-validation.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/02-model-orchestrator.json
    description: |
      Multi-AI validation:
      - Run validation with Cursor/Gemini/Codex validators
      - Calculate consensus on issues
      - Identify disagreements
      - Generate validation report
      - Route issues to appropriate agents

  # Phase 3: Fix
  - step: 3
    name: "Fix Phase"
    agent: orchestrator
    condition: "validation-report.consensus_issues.length > 0"
    inputs:
      - validation-report.json (from step 2)
      - consensus-issues.json (from step 2)
      - implementation-results.json (from step 1)
      - auto_fix
    outputs:
      - fix-results.json
      - updated-code-artifacts
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-orchestrator.json
    validation:
      schema: .claude/schemas/automated-fix.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03-orchestrator.json
    description: |
      Automated fixing:
      - Route issues to appropriate agents (developer, architect, security)
      - Apply fixes based on validation results
      - Update code artifacts
      - Track fix status

  # Phase 4: Re-validation
  - step: 4
    name: "Re-validation"
    agent: model-orchestrator
    tool: multi-ai-validator
    condition: "fix-results.fixes_applied.length > 0"
    inputs:
      - fix-results.json (from step 3)
      - project_name
      - validators
    outputs:
      - re-validation-report.json
      - final-status.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-model-orchestrator.json
    validation:
      schema: .claude/schemas/multi-ai-validation.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/04-model-orchestrator.json
    description: |
      Re-validate after fixes:
      - Run validation again on fixed code
      - Verify fixes resolved issues
      - Generate final status report

# Iteration configuration
iteration:
  enabled: true
  max_iterations: "{{max_iterations}}"
  loop_back_step: 1  # Loop back to Implementation Phase
  condition:
    type: "and"
    checks:
      - field: "final_status.consensus_issues"
        operator: ">"
        value: 0
      - field: "iteration_count"
        operator: "<"
        value: "{{max_iterations}}"
  context_preservation:
    - plan-{{workflow_id}}.json
    - implementation-results.json
    - validation-report.json
  iteration_summary:
    generate: true
    output_file: iteration-summary.json

# Context monitoring and handoff
context_management:
  monitor_threshold: 0.7  # 70% context usage triggers alert
  handoff_threshold: 0.9  # 90% context usage triggers handoff
  handoff_tool: orchestrator-handoff
  spawn_cursor: "{{spawn_cursor}}"
  handoff_package:
    include_plans: true
    include_artifacts: true
    include_state: true

# Output files
outputs:
  - plan-{{workflow_id}}.md
  - plan-{{workflow_id}}.json
  - implementation-results.json
  - validation-report.json
  - consensus-issues.json
  - disagreements.json
  - fix-results.json
  - re-validation-report.json
  - final-status.json
  - iteration-summary.json
  - workflow-state.json

# Completion criteria
completion_criteria:
  - All plan tasks completed
  - Validation report shows 0 consensus issues
  - All fixes verified
  - Final status is "completed"
  - No critical disagreements

# Integration points
integrations:
  workflow_automator:
    tool: workflow-automator
    enabled: true
    auto_fix: "{{auto_fix}}"
    max_iterations: "{{max_iterations}}"
  multi_ai_validator:
    tool: multi-ai-validator
    enabled: true
    validators: "{{validators}}"
  context_monitor:
    tool: context-monitor
    enabled: true
    threshold: 0.7
  orchestrator_handoff:
    tool: orchestrator-handoff
    enabled: true
    spawn_cursor: "{{spawn_cursor}}"
