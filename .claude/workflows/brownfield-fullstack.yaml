name: Brownfield Full-Stack Enhancement Workflow
description: Workflow for enhancing existing codebases with new features or refactoring
type: brownfield
project_type: fullstack

# Error Recovery Configuration
recovery:
  enabled: true
  checkpoint_dir: '.claude/context/runtime/runs/{{run_id}}/checkpoints'

retry_config:
  max_attempts: 3
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

fallback_agents:
  developer: [code-reviewer, qa]
  architect: [developer, security-architect]
  qa: [developer, code-reviewer]
  planner: [architect, pm]
  business-analyst: [pm, architect]
  impact-analyzer: [architect, developer]
  refactoring-specialist: [developer, architect]
  security-architect: [compliance-auditor, code-reviewer]
  code-reviewer: [developer, security-architect]
  code-simplifier: [code-reviewer, developer]
  technical-writer: [developer, pm]

# NOTE: This workflow is selected via keywords defined in .claude/config.yaml workflow_selection section.
# The routing system matches user prompts against keywords in config.yaml, not this file.
# See .claude/config.yaml for the authoritative keyword list used by the routing system.

# This workflow is optimized for existing projects:
# - Emphasizes impact analysis and compatibility
# - Includes migration planning and rollback strategies
# - Focuses on incremental improvements

# Parallel Execution Configuration
# Steps with the same parallel_group execute concurrently for 67% time savings
# See .claude/tools/workflow/parallel-executor.mjs for implementation
parallel_execution:
  enabled: true
  fail_fast: false # Continue with other parallel steps even if one fails
  timeout_per_step: 300000 # 5 minutes per step

steps:
  - step: 0
    name: 'Planning Phase'
    agent: planner
    inputs:
      - user_requirements
      - existing_codebase
      - business_objectives
    outputs:
      - plan-{{workflow_id}}.md
      - plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-planner.json
    validation:
      schema: .claude/schemas/plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-planner.json
    description: |
      Plan brownfield enhancement workflow:
      - Analyze requirements and existing codebase
      - Coordinate enhancement strategy
      - Create structured improvement plan

  - step: 0.1
    name: 'Plan Rating Gate'
    agent: orchestrator
    type: validation
    skill: response-rater
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
    outputs:
      - .claude/context/runtime/runs/{{run_id}}/plans/{{plan_id}}-rating.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00.1-orchestrator.json
    validation:
      minimum_score: 7
      rubric_file: .claude/context/artifacts/standard-plan-rubric.json
      schema: .claude/schemas/plan-rating.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00.1-orchestrator.json
    retry:
      max_attempts: 3
      on_failure: escalate_to_human
    description: |
      Rate plan quality using response-rater skill.
      - Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
      - Minimum passing score: 7/10
      - If score < 7: Return to Planner with feedback, request improvements, re-rate until passing
      - If score >= 7: Proceed with workflow execution
      - Log rating in reasoning file and artifact metadata
      - Never execute an unrated plan - this is a hard requirement

  - step: 1
    name: 'Codebase Discovery & Impact Analysis'
    agent: business-analyst
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - user_requirements
      - existing_codebase
      - business_objectives
    outputs:
      - project-brief.json
      - impact-analysis.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-business-analyst.json
    validation:
      schema: .claude/schemas/project_brief.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/01-business-analyst.json
    notes: |
      Focus on understanding existing patterns, identifying risks,
      and documenting current architecture before proposing changes.

  - step: 2
    name: 'Enhancement Requirements'
    agent: pm
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - project-brief.json (from step 1)
      - impact-analysis.json (from step 1)
    outputs:
      - prd.json
      - migration-requirements.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-pm.json
    validation:
      schema: .claude/schemas/product_requirements.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/02-pm.json
    notes: |
      Emphasize backward compatibility requirements,
      feature flags, and phased rollout considerations.

  - step: 3
    name: 'Architecture Evolution'
    agent: architect
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - prd.json (from step 2)
      - impact-analysis.json (from step 1)
      - existing-architecture (optional)
    outputs:
      - system-architecture.json
      - migration-plan.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-architect.json
    validation:
      schema: .claude/schemas/system_architecture.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03-architect.json
    notes: |
      Design for incremental adoption. Include rollback strategies
      and compatibility shims where needed.

  - step: 4
    name: 'Database Migration Planning'
    agent: database-architect
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - system-architecture.json (from step 3)
      - prd.json (from step 2)
      - existing-schema (optional)
    outputs:
      - database-architecture.json
      - migration-scripts.json
      - rollback-plan.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-database-architect.json
    validation:
      schema: .claude/schemas/database_architecture.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/04-database-architect.json
    notes: |
      Plan zero-downtime migrations. Include dual-write strategies
      and data backfill procedures for existing records.

  - step: 5
    name: 'Test Strategy & Regression Planning'
    agent: qa
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - system-architecture.json (from step 3)
      - database-architecture.json (from step 4)
      - impact-analysis.json (from step 1)
    outputs:
      - test-plan.json
      - regression-suite.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/05-qa.json
    validation:
      schema: .claude/schemas/test_plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/05-qa.json
    notes: |
      Focus on regression testing existing functionality.
      Include integration tests for migration procedures.

  - step: 6
    name: 'Implementation'
    agent: developer
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - system-architecture.json (from step 3)
      - database-architecture.json (from step 4)
      - test-plan.json (from step 5)
      - migration-plan.json (from step 3)
    outputs:
      - dev-manifest.json
      - code-artifacts
      - migration-artifacts
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/06-developer.json
    validation:
      schema: .claude/schemas/artifact_manifest.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/06-developer.json
    notes: |
      Implement with feature flags. Create migration scripts
      that can be tested in staging before production.

  - step: 7
    name: 'Code Review'
    agent: code-reviewer
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest.json (from step 6)
      - system-architecture.json (from step 3)
      - impact-analysis.json (from step 1)
    outputs:
      - code-review-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/07-code-reviewer.json
    validation:
      schema: .claude/schemas/code-review.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/07-code-reviewer.json
    on_failure: 'Return to implementation step with feedback'
    description: |
      Review brownfield enhancements for quality, security, and codebase impact:
      - Verify backward compatibility maintained
      - Check integration with existing patterns
      - Review migration strategies and rollback procedures
      - Validate feature flag implementation
      - Ensure minimal disruption to existing functionality

  - step: 8
    name: 'Quality Validation'
    agent: qa
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest.json (from step 6)
      - code-review-{{workflow_id}}.json (from step 7)
      - test-plan.json (from step 5)
      - regression-suite.json (from step 5)
    outputs:
      - quality-report.json
      - test-results.json
      - migration-test-results.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/08-qa-final.json
    validation:
      schema: .claude/schemas/quality-report.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/08-qa-final.json
    secondary_outputs:
      - artifact: test-results.json
        schema: .claude/schemas/test-results.schema.json
      - artifact: migration-test-results.json
        schema: .claude/schemas/test-results.schema.json

  - step: 8.5
    name: 'Publish Artifacts'
    agent: orchestrator
    skill: artifact-publisher
    condition: "validation_status == 'pass'"
    inputs:
      - artifact-registry.json
    policy: auto-on-pass
    validation:
      schema: .claude/schemas/artifact-registry.schema.json
    retry:
      max_attempts: 3
      on_failure: log_and_continue

completion_criteria:
  - All artifacts validated against schemas
  - Quality gates passed
  - Regression tests pass with no degradation
  - Migration scripts tested successfully
  - Rollback procedures validated
  - Code follows existing project patterns

rollback_triggers:
  - Test coverage drops below baseline
  - Performance regression detected
  - Migration scripts fail validation
  - Breaking changes to existing APIs
