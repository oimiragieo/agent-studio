name: Legacy System Modernization Workflow
description: Incremental modernization of legacy systems with risk mitigation and phased migration
type: legacy-modernization
project_type: modernization

# Error Recovery Configuration
recovery:
  enabled: true
  checkpoint_dir: ".claude/context/runs/{{run_id}}/checkpoints"

retry_config:
  max_attempts: 3
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

fallback_agents:
  developer: [code-reviewer, qa]
  architect: [developer, security-architect]
  qa: [developer, code-reviewer]
  planner: [architect, pm]
  legacy-modernizer: [architect, developer]
  impact-analyzer: [architect, developer]
  refactoring-specialist: [developer, architect]
  security-architect: [compliance-auditor, code-reviewer]
  compliance-auditor: [security-architect, qa]
  code-reviewer: [developer, security-architect]
  technical-writer: [developer, pm]

# NOTE: trigger_keywords here are for documentation only.
# The actual workflow selection uses keywords from .claude/config.yaml workflow_selection section.
# See .claude/config.yaml for the authoritative keyword list used by the routing system.
trigger_keywords:
  - "legacy modernization"
  - "legacy system"
  - "modernize legacy"
  - "migrate legacy"
  - "refactor legacy"
  - "rewrite legacy"
  - "technical debt"
  - "legacy codebase"

steps:
  - step: 0
    name: "Planning Phase"
    agent: planner
    inputs:
      - legacy_system_description
      - modernization_goals
      - constraints
      - business_requirements
    outputs:
      - plan-{{workflow_id}}.md
      - plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-planner.json
    validation:
      schema: .claude/schemas/plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-planner.json
    description: |
      Plan legacy modernization project:
      - Analyze modernization requirements and scope
      - Coordinate with modernization specialists
      - Create phased migration plan
      - Define success criteria and rollback strategy

  - step: 0.1
    name: "Plan Rating Gate"
    agent: orchestrator
    type: validation
    skill: response-rater
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
    outputs:
      - plan-rating-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00.1-orchestrator.json
    validation:
      minimum_score: 7
      rubric_file: .claude/context/artifacts/standard-plan-rubric.json
      gate: .claude/context/history/gates/{{workflow_id}}/00.1-orchestrator.json
    retry:
      max_attempts: 3
      on_failure: escalate_to_human
    description: |
      Rate plan quality using response-rater skill.
      - Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
      - Minimum passing score: 7/10
      - If score < 7: Return to Planner with feedback, request improvements, re-rate until passing
      - If score >= 7: Proceed with workflow execution
      - Log rating in reasoning file and artifact metadata
      - Never execute an unrated plan - this is a hard requirement

  - step: 1
    name: "Legacy System Analysis"
    agent: analyst
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - legacy_system_description
      - existing_codebase
      - documentation
    outputs:
      - legacy-analysis.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-analyst.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/01-analyst.json
    description: |
      Comprehensive legacy system analysis:
      - Technology stack assessment
      - Code complexity analysis
      - Business logic extraction
      - Integration point identification
      - Dependency mapping
      - Technical debt assessment
      - Risk identification
      - Data model analysis
      - Performance baseline
      - Security vulnerabilities

  - step: 2
    name: "Modernization Strategy Design"
    agent: legacy-modernizer
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - legacy-analysis.json (from step 1)
      - modernization_goals
      - business_requirements
    outputs:
      - modernization-strategy.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-legacy-modernizer.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/02-legacy-modernizer.json
    description: |
      Legacy modernization strategy:
      - Modernization approach selection (rewrite, refactor, strangler fig, etc.)
      - Technology migration path
      - Incremental migration phases
      - Dual-run strategy (old and new systems in parallel)
      - Data migration strategy
      - API compatibility layer design
      - Feature flag strategy
      - Risk mitigation approach
      - Rollback plan
      - Testing strategy
      - Go-live criteria

  - step: 3
    name: "Target Architecture Design"
    agent: architect
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - legacy-analysis.json (from step 1)
      - modernization-strategy.json (from step 2)
    outputs:
      - target-architecture.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-architect.json
    validation:
      schema: .claude/schemas/system_architecture.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03-architect.json
    description: |
      Design target modern architecture:
      - Modern technology stack selection
      - Architecture patterns (microservices, modular monolith, etc.)
      - Service boundaries
      - Data architecture
      - API design principles
      - Integration patterns
      - Security architecture
      - Observability and monitoring
      - Scalability design
      - Cloud-native considerations

  - step: 4
    name: "Incremental Implementation"
    agent: developer
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - modernization-strategy.json (from step 2)
      - target-architecture.json (from step 3)
      - legacy-analysis.json (from step 1)
    outputs:
      - dev-manifest.json
      - code-artifacts
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-developer.json
    validation:
      schema: .claude/schemas/artifact_manifest.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/04-developer.json
    description: |
      Phased modernization implementation:
      - Implement first migration phase
      - Create API compatibility layers
      - Implement feature flags for gradual rollout
      - Data migration scripts
      - Dual-write mechanisms (write to both old and new systems)
      - Fallback mechanisms
      - Monitoring and logging
      - Integration with legacy system
      - Preserve business logic
      - Test coverage for critical paths

  - step: 5
    name: "Code Review"
    agent: code-reviewer
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest.json (from step 4)
      - modernization-strategy.json (from step 2)
      - target-architecture.json (from step 3)
    outputs:
      - code-review-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/05-code-reviewer.json
    validation:
      schema: .claude/schemas/code-review.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/05-code-reviewer.json
    on_failure: "Return to implementation step with feedback"
    description: |
      Review modernization implementation for quality, security, and codebase impact:
      - Verify business logic preservation
      - Check backward compatibility
      - Validate rollback mechanisms
      - Review data migration integrity
      - Ensure feature flag implementation
      - Verify dual-run compatibility
      - Check monitoring and observability

  - step: 6
    name: "Migration Validation & Testing"
    agent: qa
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest.json (from step 4)
      - code-review-{{workflow_id}}.json (from step 5)
      - modernization-strategy.json (from step 2)
      - legacy-analysis.json (from step 1)
    outputs:
      - migration-test-results.json
      - quality-report.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/06-qa.json
    description: |
      Comprehensive migration testing:
      - Business logic verification (new matches old)
      - Data migration validation
      - Performance comparison (old vs new)
      - Integration testing
      - Regression testing
      - User acceptance testing
      - Load testing
      - Rollback procedure testing
      - Feature flag functionality testing
      - Dual-run mode validation
      - Monitoring and alerting validation

  - step: 6.5
    name: "Publish Artifacts"
    agent: orchestrator
    skill: artifact-publisher
    condition: "validation_status == 'pass'"
    inputs:
      - artifact-registry.json
    policy: auto-on-pass
    retry:
      max_attempts: 3
      on_failure: log_and_continue

completion_criteria:
  - First migration phase implemented successfully
  - All tests passing
  - Backward compatibility verified
  - Rollback plan tested
  - Monitoring in place
  - Documentation updated
  - Stakeholder approval obtained
