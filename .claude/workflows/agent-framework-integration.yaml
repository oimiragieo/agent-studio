name: Agent Framework Integration Test
description: >
  Memory-safe, end-to-end integration test for the LLM-RULES agent framework.
  Validates baseline suites, smokes every agent once, verifies observability outputs,
  triggers one intentional guard denial, and writes reproducible deliverables.
type: testing
project_type: validation
publish_policy: manual

recovery:
  enabled: true
  checkpoint_dir: '.claude/context/runtime/runs/{{run_id}}/checkpoints'

retry_config:
  max_attempts: 2
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

# NOTE: Workflow selection is primarily driven by the router agent. These patterns exist
# as an additional safety net for humans reading the file and for future tooling.
trigger_patterns:
  - 'agent integration'
  - 'agent-framework integration'
  - 'framework integration test'
  - 'agent-integration-v1-'
  - 'verify-agent-integration'

steps:
  - step: 0
    name: 'Setup + Context Snapshot'
    agent: developer
    inputs:
      - workflow_id
      - repo_root
    outputs:
      - .claude/context/artifacts/testing/{{workflow_id}}-logs/project-current.txt
      - .claude/context/artifacts/testing/{{workflow_id}}-logs/instruments.txt
    validation:
      schema: .claude/schemas/generic-json.schema.json
    description: |
      Goal: set project context and capture a lightweight snapshot.
      Requirements:
      - Do not dump command output to chat; redirect to files under:
        `.claude/context/artifacts/testing/{{workflow_id}}-logs/`
      Commands:
      - `node .claude/tools/project.mjs use "agent-integration"`
      - `node .claude/tools/project.mjs current > .claude/context/artifacts/testing/{{workflow_id}}-logs/project-current.txt 2>&1`
      - `node .claude/tools/instruments.mjs list > .claude/context/artifacts/testing/{{workflow_id}}-logs/instruments.txt 2>&1`

  - step: 1
    name: 'Baseline Suites (Must Pass)'
    agent: qa
    inputs:
      - workflow_id
    outputs:
      - .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-test-tools.log
      - .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-test.log
      - .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-validate.log
      - .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-validate-workflow.log
      - .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-validate-references.log
      - .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-validate-docs-links.log
      - .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-validate-agents.log
      - .claude/context/artifacts/testing/{{workflow_id}}-logs/workflow-dryrun-suite.json
    validation:
      schema: .claude/schemas/generic-json.schema.json
    blocking: true
    description: |
      Goal: run baseline commands and save outputs to log files.
      Requirements:
      - Run sequentially.
      - Redirect output to files (avoid huge chat output).
      Commands:
      - `pnpm test:tools > .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-test-tools.log 2>&1`
      - `pnpm test > .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-test.log 2>&1`
      - `pnpm validate > .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-validate.log 2>&1`
      - `pnpm validate:workflow > .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-validate-workflow.log 2>&1`
      - `pnpm validate:references > .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-validate-references.log 2>&1`
      - `pnpm validate:docs-links > .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-validate-docs-links.log 2>&1`
      - `pnpm validate:agents > .claude/context/artifacts/testing/{{workflow_id}}-logs/pnpm-validate-agents.log 2>&1`
      - `node .claude/tools/workflow-dryrun-suite.mjs > .claude/context/artifacts/testing/{{workflow_id}}-logs/workflow-dryrun-suite.json 2>&1`
      If any command fails:
      - Stop and mark the run FAIL in the final report (include the first failing command + log path).

  - step: 2
    name: 'Agent Smoke (Every Agent Once)'
    agent: developer
    inputs:
      - workflow_id
    outputs:
      - .claude/context/artifacts/testing/{{workflow_id}}-agent-smoke/
    validation:
      schema: .claude/schemas/generic-json.schema.json
    description: |
      Goal: produce one smoke receipt per agent while minimizing Claude Code host-process memory growth.

      Preferred approach (headless, process-isolated):
      - Run:
        `node .claude/tools/run-agent-smoke-headless.mjs --workflow-id {{workflow_id}}`
      - This runs separate `claude -p` processes per agent and writes:
        - `.claude/context/artifacts/testing/{{workflow_id}}-agent-smoke/<agent>.json`
        - `.claude/context/artifacts/testing/{{workflow_id}}-agent-smoke/_summary.json`

      Notes:
      - This avoids embedding 38+ subagent transcripts into the current Claude Code UI session (a known OOM risk).
      - If the headless runner is unavailable, fall back to strictly sequential Task spawns with receipt-only output.

  - step: 3
    name: 'Observability + Denial Proof'
    agent: analyst
    inputs:
      - workflow_id
      - debug_log_path (optional)
    outputs:
      - .claude/context/artifacts/observability/{{workflow_id}}/bundle.json
      - .claude/context/reports/observability/{{workflow_id}}-report.md
    validation:
      schema: .claude/schemas/observability-bundle.schema.json
    description: |
      Goal: prove hooks/agents/tools are observable and the denial path is hook-based.
      Requirements:
      - Trigger exactly one denial using the Read tool on a directory (e.g. `.claude/agents/`).
      - Confirm in tool-events that the denied entry includes:
        - denied: true
        - tool: "Read"
        - denied_by: "read-path-guard"
      Commands (capture or reference in final report):
      - `node .claude/tools/events-tail.mjs --lines 200`
      - `node .claude/tools/metrics-summary.mjs --json`
      - `node .claude/tools/resume-status.mjs --json`
      - `node .claude/tools/observability-bundle.mjs --id {{workflow_id}} --output-root .claude/context`
        (include `--debug-log "<path>"` if provided)

  - step: 4
    name: 'Deliverables + Verification'
    agent: technical-writer
    inputs:
      - workflow_id
    outputs:
      - .claude/context/reports/testing/{{workflow_id}}-run-report.md
      - .claude/context/artifacts/testing/{{workflow_id}}-run-results.json
      - .claude/context/artifacts/testing/{{workflow_id}}-verification.json
      - .claude/context/reports/testing/{{workflow_id}}-verification-report.md
    validation:
      schema: .claude/schemas/generic-json.schema.json
    description: |
      Goal: write the final report/results and run the verifier.
      Requirements:
      - Report must link to the results JSON via exact paths.
      - Run the verifier:
        `node .claude/tools/verify-agent-integration.mjs --workflow-id {{workflow_id}} --json`
