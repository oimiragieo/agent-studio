name: Brownfield Project Onboarding Workflow
description: Automated onboarding workflow for existing projects - detects tech stack, configures rules, analyzes architecture, and creates project snapshot
type: onboarding
project_type: brownfield

# Error Recovery Configuration
recovery:
  enabled: true
  checkpoint_dir: '.claude/context/runtime/runs/{{run_id}}/checkpoints'

retry_config:
  max_attempts: 3
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

fallback_agents:
  analyst: [architect, developer]
  architect: [developer, code-reviewer]
  developer: [code-reviewer, qa]
  security-architect: [compliance-auditor, code-reviewer]
  code-reviewer: [developer, architect]
  technical-writer: [developer, analyst]
  orchestrator: [analyst, architect]

# Workflow is selected via:
# - Direct invocation: /onboard or /brownfield-onboard
# - CUJ reference: CUJ-061 (Brownfield Onboarding)
# - Keywords: "onboard existing", "analyze project", "setup brownfield"
# See .claude/config.yaml workflow_selection for authoritative routing

# Key Benefits:
# - 80% faster brownfield onboarding via automated tech stack detection
# - Auto-configures rules based on detected frameworks
# - Creates comprehensive project snapshot for future reference
# - Recommends appropriate agents for detected frameworks
# - Generates actionable project summary with tech debt indicators

# Skills Used:
# - project-analyzer: Automated codebase analysis (Step 1)
# - rule-selector: Dynamic rule configuration (Step 2)
# - doc-generator: Documentation generation (Step 6)
# - artifact-publisher: Artifact publishing (Step 7)

steps:
  - step: 0
    name: 'Onboarding Initialization'
    agent: orchestrator
    type: initialization
    inputs:
      - project_path # Path to existing project (required)
      - onboarding_goals # Optional: specific areas to focus on
    outputs:
      - onboarding-config-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-orchestrator.json
    validation:
      schema: .claude/schemas/onboarding-config.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-orchestrator.json
    description: |
      Initialize brownfield onboarding workflow:
      - Validate project path exists and is accessible
      - Check for existing .claude configuration
      - Create onboarding session configuration
      - Set up artifact registry for onboarding outputs
      - Initialize checkpoint for recovery if interrupted

  - step: 1
    name: 'Automated Project Analysis'
    agent: analyst
    skill: project-analyzer
    inputs:
      - onboarding-config-{{workflow_id}}.json (from step 0)
      - project_path
    outputs:
      - project-analysis.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-analyst.json
    validation:
      schema: .claude/schemas/project-analysis.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/01-analyst.json
    description: |
      Execute project-analyzer skill for comprehensive codebase analysis:
      - Detect project type (frontend, backend, fullstack, library, cli, mobile, monorepo)
      - Identify frameworks from package.json, requirements.txt, go.mod, etc.
      - Generate file statistics and language breakdown
      - Map component relationships and module structure
      - Detect architecture patterns (MVC, layered, hexagonal, microservices)
      - Analyze dependency health and outdated packages
      - Identify code quality indicators (linting, testing, type safety)
      - Detect technical debt and anti-patterns
      - Generate prioritized improvement recommendations
      - Target execution time: < 30 seconds for typical projects (< 10k files)

  - step: 2
    name: 'Rule Configuration'
    agent: analyst
    skill: rule-selector
    inputs:
      - project-analysis.json (from step 1)
    outputs:
      - rule-configuration.json
      - manifest-update.yaml
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-analyst.json
    validation:
      schema: .claude/schemas/rule-configuration.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/02-analyst.json
    description: |
      Execute rule-selector skill to configure optimal rules:
      - Query rule-index.json for rules matching detected technologies
      - Prioritize master rules over library rules
      - Generate stack profile in manifest.yaml format
      - Exclude irrelevant rules (undetected technologies)
      - Configure rule priority order
      - Document rule selection rationale

      Rule Selection Process:
      1. Map detected frameworks to rule index technology_map
      2. Select master rules (TECH_STACK_NEXTJS, PROTOCOL_ENGINEERING, etc.)
      3. Supplement with library rules for specific technologies
      4. Exclude rules for undetected technologies
      5. Configure loading policy (max_rules_files: 5-10 based on stack)

  - step: 3
    name: 'Agent Recommendation Analysis'
    agent: architect
    inputs:
      - project-analysis.json (from step 1)
      - rule-configuration.json (from step 2)
    outputs:
      - agent-recommendations.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-architect.json
    validation:
      schema: .claude/schemas/agent-recommendations.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03-architect.json
    description: |
      Analyze project characteristics and recommend appropriate agents:

      Agent Selection Criteria:
      - Frontend heavy → ux-expert, accessibility-expert, mobile-developer (if React Native)
      - Backend API → api-designer, database-architect, security-architect
      - Fullstack → architect, developer, qa, technical-writer
      - Legacy codebase → legacy-modernizer, refactoring-specialist, impact-analyzer
      - Performance issues → performance-engineer, developer, qa
      - Security concerns → security-architect, compliance-auditor, code-reviewer
      - AI/ML components → llm-architect, model-orchestrator, api-designer
      - Mobile (React Native/Flutter) → mobile-developer, ux-expert
      - Monorepo → architect, devops, developer

      Output includes:
      - Primary agents (always recommended for this project type)
      - Supporting agents (recommended for specific concerns)
      - Specialized agents (based on tech debt/recommendations)
      - Agent activation triggers (when to involve each agent)

  - step: 4
    name: 'Security & Compliance Assessment'
    agent: security-architect
    inputs:
      - project-analysis.json (from step 1)
      - agent-recommendations.json (from step 3)
    outputs:
      - security-assessment.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-security-architect.json
    validation:
      schema: .claude/schemas/security-assessment.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/04-security-architect.json
    description: |
      Evaluate security posture of existing project:
      - Review dependency vulnerabilities (from project-analysis.json)
      - Assess authentication/authorization patterns
      - Identify secrets management practices
      - Check for sensitive data exposure risks
      - Evaluate API security (if applicable)
      - Review security-related code patterns
      - Generate security improvement recommendations
      - Prioritize by risk level (P0-P3)

      Focus areas:
      - Known vulnerabilities in dependencies
      - Hardcoded secrets detection
      - Authentication configuration
      - Input validation patterns
      - CORS and security headers (for web apps)
      - SQL injection / XSS prevention

  - step: 5
    name: 'Architecture Summary'
    agent: architect
    inputs:
      - project-analysis.json (from step 1)
      - agent-recommendations.json (from step 3)
      - security-assessment.json (from step 4)
    outputs:
      - architecture-summary.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/05-architect.json
    validation:
      schema: .claude/schemas/architecture-summary.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/05-architect.json
    description: |
      Create comprehensive architecture summary:
      - Current architecture pattern assessment
      - Component relationship map
      - Data flow analysis
      - Integration points with external systems
      - Scalability assessment
      - Maintainability score
      - Architecture improvement recommendations

      Key outputs:
      - Architecture diagram (Mermaid format)
      - Component inventory
      - Dependency graph
      - Technical debt summary with remediation priorities
      - Recommended architecture improvements

  - step: 6
    name: 'Onboarding Documentation'
    agent: technical-writer
    skill: doc-generator
    inputs:
      - project-analysis.json (from step 1)
      - rule-configuration.json (from step 2)
      - agent-recommendations.json (from step 3)
      - security-assessment.json (from step 4)
      - architecture-summary.json (from step 5)
    outputs:
      - project-snapshot.json
      - onboarding-report.md
      - GETTING_STARTED_BROWNFIELD.md
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/06-technical-writer.json
    validation:
      schema: .claude/schemas/project-snapshot.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/06-technical-writer.json
    description: |
      Generate comprehensive onboarding documentation:

      1. Onboarding Report (onboarding-report.md):
         - Executive summary of project analysis
         - Tech stack overview with versions
         - Architecture pattern and structure
         - Recommended agents and triggers
         - Configured rules summary
         - Security assessment highlights
         - Technical debt summary
         - Prioritized improvement roadmap

      2. Project Snapshot (project-snapshot.json):
         - Structured JSON combining all analysis outputs
         - Used for future reference and comparison
         - Supports incremental re-analysis
         - Includes timestamp and analyzer version

      3. Getting Started Guide (GETTING_STARTED_BROWNFIELD.md):
         - Quick start for new developers
         - Project setup instructions
         - Key commands and workflows
         - Recommended development practices
         - Agent invocation patterns for this project

  - step: 7
    name: 'Publish Onboarding Artifacts'
    agent: orchestrator
    skill: artifact-publisher
    condition: "validation_status == 'pass'"
    inputs:
      - artifact-registry.json
    outputs:
      - publish-status.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/07-orchestrator.json
    validation:
      schema: .claude/schemas/publish-status.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/07-orchestrator.json
    policy: auto-on-pass
    publish_targets: ['project_feed', 'cursor']
    retry:
      max_attempts: 3
      on_failure: log_and_continue
    description: |
      Publish onboarding artifacts for cross-platform access:
      - project-analysis.json → project_feed
      - rule-configuration.json → cursor (for IDE integration)
      - onboarding-report.md → project_feed
      - project-snapshot.json → project_feed (for future comparison)

      Artifacts are tagged with:
      - workflow_id
      - project_type
      - detected_frameworks
      - onboarding_timestamp

completion_criteria:
  - Project analysis completed successfully
  - Rules configured based on detected tech stack
  - Agent recommendations generated
  - Security assessment completed
  - Architecture summary created
  - Onboarding documentation generated
  - Project snapshot saved for future reference
  - Artifacts published to project feed

# Quality gates for onboarding validation
quality_gates:
  project_analysis:
    required: true
    schema: .claude/schemas/project-analysis.schema.json
    minimum_confidence: 0.7 # Framework detection confidence threshold
  rule_configuration:
    required: true
    minimum_rules: 3 # At least 3 rules should be selected
  agent_recommendations:
    required: true
    minimum_primary_agents: 2 # At least 2 primary agents recommended
  security_assessment:
    required: true
    block_on_critical: true # Block if critical vulnerabilities found

# Output summary format
output_summary:
  format: markdown
  sections:
    - project_type
    - detected_frameworks
    - recommended_rules
    - recommended_agents
    - security_highlights
    - tech_debt_summary
    - next_steps
