name: Code Review Workflow
description: Comprehensive code review with systematic analysis and multi-AI validation support
type: code-review
project_type: review
publish_policy: auto-on-pass # Automatically publish artifacts after validation passes

# Error Recovery Configuration
recovery:
  enabled: true
  checkpoint_dir: '.claude/context/runtime/runs/{{run_id}}/checkpoints'

retry_config:
  max_attempts: 3
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

fallback_agents:
  code-reviewer: [refactoring-specialist, security-architect]
  security-architect: [compliance-auditor, code-reviewer]
  qa: [developer, code-reviewer]
  planner: [architect, pm]
  developer: [code-reviewer, qa]

# NOTE: trigger_keywords here are for documentation only.
# The actual workflow selection uses keywords from .claude/config.yaml workflow_selection section.
# See .claude/config.yaml for the authoritative keyword list used by the routing system.
trigger_keywords:
  - 'code review'
  - '/review'
  - 'review code'
  - 'review this'
  - 'PR review'
  - 'pull request review'

# Workflow-Level Context Inputs
workflow_inputs:
  required:
    - target_files # List of files/directories to review (e.g., ["src/", "lib/", "app/components/"])
  optional:
    - coding_standards # Coding standards to apply (e.g., "PEP 8", "Airbnb JavaScript Style Guide")
    - review_depth # Depth of review: "shallow" | "standard" | "deep"
    - security_focus # Boolean: prioritize security analysis

steps:
  - step: 0
    name: 'Planning Phase'
    agent: planner
    inputs:
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files # List of files/directories to review
      - coding_standards # (optional) Coding standards to apply
      - review_depth # (optional) Depth of review
      - security_focus # (optional) Prioritize security analysis
    outputs:
      - plan-{{workflow_id}}.md
      - plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-planner.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - plan-generator
        - sequential-thinking
      recommended:
        - classifier
      triggered:
        - pattern: 'security|auth|compliance'
          skills: [sequential-thinking]
          priority: required
          skill_params:
            focus_areas: ['security', 'compliance']
      outputs:
        plan-generator:
          primary: 'plan-{{workflow_id}}.json'
          schema: '.claude/schemas/plan.schema.json'
          required_for_completion: true
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
    validation:
      schema: .claude/schemas/plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-planner.json
    description: |
      Plan code review workflow:
      - Analyze code scope and requirements
      - Determine review depth and focus areas
      - Create structured review plan
      - **Publishing**: After validation, use `artifact-publisher` skill to publish plan artifacts to project feed

  - step: 0.1
    name: 'Plan Rating Gate'
    agent: orchestrator
    type: validation
    skill: response-rater
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
    outputs:
      - .claude/context/runtime/runs/{{run_id}}/plans/{{plan_id}}-rating.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00.1-orchestrator.json
    validation:
      minimum_score: 7
      rubric_file: .claude/context/artifacts/standard-plan-rubric.json
      gate: .claude/context/history/gates/{{workflow_id}}/00.1-orchestrator.json
    retry:
      max_attempts: 3
      on_failure: escalate_to_human
    description: |
      Rate plan quality using response-rater skill.
      - Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
      - Minimum passing score: 7/10
      - If score < 7: Return to Planner with feedback, request improvements, re-rate until passing
      - If score >= 7: Proceed with workflow execution
      - Log rating in reasoning file and artifact metadata
      - Never execute an unrated plan - this is a hard requirement

  - step: 1
    name: 'Code Analysis'
    agent: code-reviewer
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files # List of files/directories to review
      - coding_standards # (optional) Coding standards to apply
      - review_depth # (optional) Depth of review
      - security_focus # (optional) Prioritize security analysis
    outputs:
      - code-review-report-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-code-reviewer.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - rule-auditor
        - code-style-validator
        - explaining-rules
      recommended:
        - fixing-rule-violations
        - dependency-analyzer
      triggered:
        - pattern: 'security|auth|password|credential'
          skills: [rule-auditor]
          priority: required
          skill_params:
            rule_categories: ['security', 'authentication']
        - pattern: 'performance|optimize|slow'
          skills: [dependency-analyzer]
          priority: recommended
      outputs:
        rule-auditor:
          primary: 'code-review-report-{{workflow_id}}.json'
          secondary: ['violations-{{workflow_id}}.json']
          schema: '.claude/schemas/code-review.schema.json'
          required_for_completion: true
        code-style-validator:
          primary: 'style-report-{{workflow_id}}.json'
          required_for_completion: false
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
    validation:
      schema: .claude/schemas/code-review.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/01-code-reviewer.json
    description: |
      Systematic analysis of code quality including:
      - Adherence to coding standards
      - Design pattern usage
      - Code complexity metrics
      - Security considerations
      - Test coverage assessment
      - Rule compliance validation

  - step: 1.5
    name: 'Multi-AI Code Review (Optional)'
    agent: code-reviewer
    skill: multi-ai-code-review
    condition: 'user_requested_multi_ai_review OR critical_security_changes'
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - code-review-report-{{workflow_id}}.json (from step 1)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files # List of files/directories to review
    outputs:
      - multi-ai-review-report-{{workflow_id}}.json
      - multi-ai-review-synthesis-{{workflow_id}}.md (optional)
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01.5-code-reviewer.json
    # Multi-AI review skill configuration (Cursor Recommendations #1-4)
    skill_config:
      # CLI validation before execution (Cursor Recommendation #1)
      skip_cli_validation: false
      # Schema validation mode (Cursor Recommendation #3)
      validation_mode: blocking # fail fast on invalid schema
      # Provider configuration with fallback (Cursor Recommendation #4)
      # Provider priority defined in .claude/config.yaml codex_skills.provider_priority
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - multi-ai-code-review
      recommended: []
      triggered: []
      outputs:
        multi-ai-code-review:
          primary: 'multi-ai-review-report-{{workflow_id}}.json'
          secondary: ['multi-ai-review-synthesis-{{workflow_id}}.md']
          schema: '.claude/schemas/multi-ai-review-report.schema.json'
          required_for_completion: true
      validation:
        mode: blocking # NEW: fail fast on invalid outputs (Cursor Recommendation #3)
        min_compliance: 100
        on_failure: block
    validation:
      schema: .claude/schemas/multi-ai-review-report.schema.json
      mode: blocking # NEW: Schema validation blocking mode (Cursor Recommendation #3)
      gate: .claude/context/history/gates/{{workflow_id}}/01.5-code-reviewer.json
    description: |
      Multi-provider code review using Claude, Gemini, and optionally Codex:
      - Run independent reviews via headless AI CLIs
      - Aggregate findings across providers for consensus
      - Identify security, bug, and performance issues
      - Generate structured report with severity ratings
      - Optionally produce PR-ready Markdown synthesis
      - Default providers: claude,gemini (fast, reliable)
      - Enterprise providers: claude,gemini,codex (more perspectives)
      - CI mode: --ci flag for automated reviews with strict JSON output
      - This step is triggered when user explicitly requests multi-AI validation
      - Automatically triggered when security triggers indicate critical changes

  - step: 2
    name: 'Review Report Generation'
    agent: code-reviewer
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - code-review-report-{{workflow_id}}.json (from step 1)
      - multi-ai-review-report-{{workflow_id}}.json (optional, from step 1.5)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files # List of files/directories reviewed
    outputs:
      - review-summary-{{workflow_id}}.json
      - issue-list-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-code-reviewer.json
    validation:
      schema: .claude/schemas/review-summary.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/02-code-reviewer.json
    description: |
      Generate comprehensive review report:
      - Consolidate findings from code analysis
      - Integrate multi-AI review findings (if available)
      - Categorize issues by severity (critical, high, medium, low)
      - Provide actionable recommendations
      - List prioritized issues with file locations

  - step: 3
    name: 'Fix Suggestions'
    agent: developer
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - review-summary-{{workflow_id}}.json (from step 2)
      - issue-list-{{workflow_id}}.json (from step 2)
      - code-review-report-{{workflow_id}}.json (from step 1)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files # List of files/directories reviewed
    outputs:
      - fix-suggestions-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-developer.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - fixing-rule-violations
        - repo-rag
      recommended:
        - scaffolder
        - code-style-validator
      triggered:
        - pattern: 'security|vulnerability|exploit'
          skills: [fixing-rule-violations, repo-rag]
          priority: required
          skill_params:
            focus_areas: ['security']
      outputs:
        fixing-rule-violations:
          primary: 'fix-suggestions-{{workflow_id}}.json'
          schema: '.claude/schemas/fix-suggestions.schema.json'
          required_for_completion: true
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: retry
        max_retries: 2
    validation:
      schema: .claude/schemas/fix-suggestions.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03-developer.json
    description: |
      Generate specific fix suggestions:
      - Provide code examples for each issue
      - Prioritize fixes by severity and impact
      - Include refactoring recommendations
      - Suggest design pattern improvements
      - Provide security fix examples where applicable

  - step: 3.5
    name: 'Security Review (Conditional)'
    agent: security-architect
    condition: 'security_focus == true OR critical_security_issues_found'
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - code-review-report-{{workflow_id}}.json (from step 1)
      - review-summary-{{workflow_id}}.json (from step 2)
      - multi-ai-review-report-{{workflow_id}}.json (optional, from step 1.5)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files # List of files/directories reviewed
    outputs:
      - security-review-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03.5-security-architect.json
    validation:
      schema: .claude/schemas/security-review.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03.5-security-architect.json
    description: |
      Conditional security-focused review:
      - Only executes if security_focus flag is true or critical security issues found
      - Deep security analysis of code patterns
      - Authentication and authorization validation
      - Input validation and sanitization review
      - Secrets management and encryption verification
      - OWASP Top 10 vulnerability assessment
      - Security best practices compliance

  - step: 4
    name: 'Quality Validation'
    agent: qa
    inputs:
      # Artifact inputs (from previous steps)
      - plan-{{workflow_id}}.json (from step 0)
      - code-review-report-{{workflow_id}}.json (from step 1)
      - review-summary-{{workflow_id}}.json (from step 2)
      - fix-suggestions-{{workflow_id}}.json (from step 3)
      - security-review-{{workflow_id}}.json (optional, from step 3.5)
      # Workflow-level context inputs (provided at workflow start, not artifact files)
      - target_files # List of files/directories reviewed
    outputs:
      - quality-validation-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-qa.json
    # Phase 2A: Skill requirements for this step
    skill_requirements:
      required:
        - evaluator
        - rule-auditor
      recommended:
        - response-rater
        - summarizer
      triggered:
        - pattern: 'coverage|metrics|quality gate'
          skills: [evaluator]
          priority: required
        - pattern: 'report|summary|findings'
          skills: [summarizer]
          priority: recommended
      outputs:
        evaluator:
          primary: 'quality-validation-{{workflow_id}}.json'
          schema: '.claude/schemas/quality-validation.schema.json'
          required_for_completion: true
      validation:
        mode: blocking
        min_compliance: 100
        on_failure: block
    validation:
      schema: .claude/schemas/quality-validation.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/04-qa.json
    description: |
      Final quality validation:
      - Validate review completeness
      - Verify all critical issues identified
      - Assess fix suggestion quality
      - Validate security review (if applicable)
      - Sign-off on review quality
      - **Publishing**: After validation, use `artifact-publisher` skill to publish final review artifacts

  - step: 4.5
    name: 'Publish Artifacts'
    agent: orchestrator
    skill: artifact-publisher
    condition: "validation_status == 'pass'"
    inputs:
      - artifact-registry.json
    policy: auto-on-pass
    retry:
      max_attempts: 3
      on_failure: log_and_continue

completion_criteria:
  - Code analysis completed with systematic review
  - Issues categorized by severity with file locations
  - Fix suggestions provided with code examples
  - Security review completed (if applicable)
  - Quality validation passed
  - All artifacts validated against schemas
