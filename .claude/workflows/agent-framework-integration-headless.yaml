name: Agent Framework Integration Test (Headless)
description: >
  UI-safe integration test runner. Executes the full agent framework integration suite
  by invoking the headless runner (`pnpm integration:headless:json`) from a single step,
  then surfaces the generated report/results paths.
type: testing
project_type: validation
publish_policy: manual

recovery:
  enabled: true
  checkpoint_dir: '.claude/context/runtime/runs/{{run_id}}/checkpoints'

trigger_patterns:
  - 'agent integration headless'
  - 'headless integration test'
  - 'integration:headless:json'
  - 'agent-framework integration headless'

steps:
  - step: 0
    name: 'Run Headless Integration Suite'
    agent: qa
    inputs:
      - workflow_id
    outputs:
      - .claude/context/reports/testing/{{workflow_id}}-run-report.md
      - .claude/context/artifacts/testing/{{workflow_id}}-run-results.json
      - .claude/context/artifacts/testing/{{workflow_id}}-verification.json
      - .claude/context/reports/testing/{{workflow_id}}-verification-report.md
    validation:
      schema: .claude/schemas/generic-json.schema.json
    blocking: true
    description: |
      Goal: avoid Claude Code UI OOM by running the integration suite in process-isolated headless mode.

      Run:
      - `pnpm integration:headless:json`

      Then locate the newest `agent-integration-v1-*` artifacts under:
      - `.claude/context/reports/testing/`
      - `.claude/context/artifacts/testing/`

      If the user supplied a specific `workflow_id`, ensure the headless output uses that id by running:
      - `node .claude/tools/run-agent-framework-integration-headless.mjs --workflow-id {{workflow_id}} --json --expected-agents core --timeout-ms 90000 --store-payloads --denial-test`
