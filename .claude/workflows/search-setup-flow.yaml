name: Search Functionality Workflow
description: Initialize and execute Algolia-powered semantic search across codebase and documentation
type: search-utility
project_type: utility
publish_policy: auto-on-pass

# Error Recovery Configuration
recovery:
  enabled: true
  checkpoint_dir: '.claude/context/runs/{{run_id}}/checkpoints'

retry_config:
  max_attempts: 3
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

fallback_agents:
  analyst: [orchestrator, pm]
  orchestrator: [analyst]

# NOTE: This workflow is selected via keywords defined in .claude/config.yaml workflow_selection section.
# The routing system matches user prompts against keywords in config.yaml, not this file.
# See .claude/config.yaml for the authoritative keyword list used by the routing system.

steps:
  - step: 0
    name: 'Query Analysis'
    agent: analyst
    inputs:
      - user_search_query
      - search_context (optional)
    outputs:
      - analyzed-query.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-analyst.json
    validation:
      schema: .claude/schemas/search_query.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-analyst.json
    description: |
      Analyze and enhance user search query:
      - Parse user's search intent
      - Identify key search terms
      - Apply semantic query expansion
      - Determine optimal search filters
      - Generate structured query parameters

  - step: 1
    name: 'Initialize Search Service'
    agent: orchestrator
    skill: algolia-search
    inputs:
      - analyzed-query.json (from step 0)
      - environment_config
    outputs:
      - search-config.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-orchestrator.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/01-orchestrator.json
      custom_checks:
        - api_credentials_valid
        - search_indexes_available
        - rate_limits_not_exceeded
    description: |
      Initialize Algolia search service:
      - Verify API credentials (ALGOLIA_API_KEY, ALGOLIA_APP_ID)
      - Check search index availability
      - Configure search client
      - Set up query parameters and filters
      - Initialize result caching if enabled
      - Verify rate limiting configuration

  - step: 2
    name: 'Execute Search'
    agent: orchestrator
    skill: algolia-search
    inputs:
      - analyzed-query.json (from step 0)
      - search-config.json (from step 1)
    outputs:
      - search-results.json
      - search-metadata.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-orchestrator.json
    validation:
      schema: .claude/schemas/search_results.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/02-orchestrator.json
      custom_checks:
        - results_within_latency_threshold
        - relevance_scores_above_minimum
        - no_api_errors
    description: |
      Execute Algolia search query:
      - Submit query to Algolia API
      - Apply semantic search algorithms
      - Retrieve matching documents
      - Calculate relevance scores
      - Extract code snippets with context
      - Collect search execution metadata
      - Handle pagination for large result sets
      - Apply result ranking and filtering

  - step: 3
    name: 'Format and Present Results'
    agent: analyst
    inputs:
      - search-results.json (from step 2)
      - search-metadata.json (from step 2)
      - user_search_query
    outputs:
      - formatted-results.json
      - result-summary.md
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-analyst.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/03-analyst.json
    description: |
      Format and present search results:
      - Organize results by relevance
      - Format code snippets with syntax highlighting
      - Generate result summary
      - Provide links to full documentation
      - Highlight matched keywords
      - Include contextual information (Â±5 lines)
      - Calculate and display relevance scores
      - Generate "refine search" suggestions

  - step: 4
    name: 'Cache Results (Optional)'
    agent: orchestrator
    condition: 'cache_enabled == true'
    inputs:
      - analyzed-query.json (from step 0)
      - search-results.json (from step 2)
    outputs:
      - cache-entry.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-orchestrator.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/04-orchestrator.json
    description: |
      Cache search results for performance:
      - Generate cache key from query parameters
      - Store results with TTL (default: 1 hour)
      - Update cache statistics
      - Implement LRU eviction policy
      - Only executes if caching is enabled

completion_criteria:
  - Search executed successfully
  - Results returned within latency threshold
  - Relevance scores meet minimum threshold
  - Results formatted and presented
  - No API errors or rate limiting
