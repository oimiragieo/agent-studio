# Hook Updater Workflow
#
# EVOLVE workflow for updating existing hooks via safe modification.
# Executable by WorkflowEngine at .claude/lib/workflow/workflow-engine.cjs
#
# Key differences from hook-creator:
# - Loads existing hook state before modification
# - Validates changes don't break hook consumers
# - Creates backup before modification
# - Re-runs tests after changes
# - Updates settings.json registration if needed

name: hook-updater-workflow
description: Update existing hooks following the EVOLVE process with backup and validation
version: 1.0.0
artifact_type: hook
input_location: .claude/hooks/

# Updater-specific configuration
updater_config:
  backup_enabled: true
  backup_location: .claude/context/backups/hooks/
  compatibility_check: true
  registration_targets:
    - ".claude/settings.json"
    - ".claude/hooks/README.md"
    - ".claude/context/memory/learnings.md"
  protected_exports:
    - validate
    - main

phases:
  evaluate:
    description: Verify hook exists and changes are justified
    steps:
      - id: check-evolution-state
        action: function
        handler: checkEvolutionState
        description: Verify evolution state is idle or can accept new evolution
      - id: load-existing-hook
        action: function
        handler: loadExistingHook
        description: Load current hook definition from file
        inputs:
          - hook_name
        outputs:
          - hook_path
          - test_path
          - current_content
          - current_exports
      - id: identify-changes
        action: prompt
        description: Gather what changes are needed
        outputs:
          - change_description
          - change_type
          - affected_functions
      - id: validate-change-justification
        action: function
        handler: validateChangeJustification
        description: Ensure changes are justified and documented
        inputs:
          - change_description
          - change_type
        outputs:
          - justification_valid
          - justification_reason
      - id: update-state-evaluate
        action: function
        handler: updateEvolutionState
        description: Update evolution-state.json to evaluating
    gates:
      - id: gate-evaluate-exists
        condition: "steps['load-existing-hook'].output.hook_path !== null"
        on_fail: abort
        message: "Hook does not exist. Use hook-creator-workflow to create new hooks."
      - id: gate-evaluate-justified
        condition: "steps['validate-change-justification'].output.justification_valid === true"
        on_fail: abort
        message: "Changes must be justified with clear rationale."

  validate:
    description: Check changes don't break hook functionality
    steps:
      - id: check-protected-exports
        action: function
        handler: checkProtectedExports
        description: Ensure protected exports are not being removed
        inputs:
          - affected_functions
          - current_exports
        outputs:
          - exports_intact
          - violations
      - id: check-signature-changes
        action: function
        handler: checkSignatureChanges
        description: Determine if function signatures are changing
        inputs:
          - change_description
          - current_content
        outputs:
          - signature_changed
          - signature_details
      - id: check-registration-impact
        action: function
        handler: checkRegistrationImpact
        description: Check if changes affect settings.json registration
        inputs:
          - change_description
          - hook_name
        outputs:
          - registration_affected
          - registration_changes
      - id: update-state-validate
        action: function
        handler: updateEvolutionState
        description: Update evolution-state.json to validating
    gates:
      - id: gate-validate-exports
        condition: "steps['check-protected-exports'].output.exports_intact === true"
        on_fail: abort
        message: "Cannot remove protected exports (validate, main)"
      - id: gate-validate-signature
        condition: "steps['check-signature-changes'].output.signature_changed === false"
        on_fail: warn
        message: "Signature changes may break callers. Review carefully."

  obtain:
    description: Research best practices for the change type (optional)
    optional: true
    steps:
      - id: analyze-change-patterns
        action: function
        handler: analyzeChangePatterns
        description: Look at similar changes in other hooks
        inputs:
          - change_type
        outputs:
          - pattern_analysis
          - recommendations
      - id: review-existing-tests
        action: function
        handler: reviewExistingTests
        description: Review existing test cases for the hook
        inputs:
          - test_path
        outputs:
          - test_coverage
          - uncovered_areas
      - id: update-state-obtain
        action: function
        handler: updateEvolutionState
        description: Update evolution-state.json to obtaining
    gates:
      - id: gate-obtain
        condition: "true"
        on_fail: pass
        message: "Research phase is optional for updates"

  lock:
    description: Create backup and apply changes
    steps:
      - id: create-backup
        action: function
        handler: createBackup
        description: Backup current hook and test files before modification
        inputs:
          - hook_path
          - test_path
        outputs:
          - backup_id
          - backup_paths
      - id: apply-changes
        action: function
        handler: applyChanges
        description: Apply the requested changes to hook content
        inputs:
          - current_content
          - change_description
          - affected_functions
        outputs:
          - updated_content
          - changes_applied
      - id: write-updated-hook
        action: write
        description: Write the updated hook file
        inputs:
          - updated_content
          - hook_path
        outputs:
          - hook_updated
      - id: update-tests-if-needed
        action: function
        handler: updateTestsIfNeeded
        description: Update test file if function behavior changed
        inputs:
          - test_path
          - change_description
          - changes_applied
        outputs:
          - tests_updated
          - new_test_content
      - id: update-state-lock
        action: function
        handler: updateEvolutionState
        description: Update evolution-state.json to locking
    gates:
      - id: gate-lock-backup
        condition: "steps['create-backup'].output.backup_id !== null"
        on_fail: abort
        message: "Backup must be created before modification"
      - id: gate-lock-write
        condition: "steps['write-updated-hook'].output.hook_updated === true"
        on_fail: retry
        max_retries: 3
        message: "Failed to write updated hook file"

  verify:
    description: Run tests and validate exports
    steps:
      - id: run-tests
        action: function
        handler: runHookTests
        description: Execute the test file to verify hook functionality
        inputs:
          - test_path
        outputs:
          - tests_passed
          - test_results
          - failure_reason
      - id: validate-exports
        action: function
        handler: validateExports
        description: Verify hook still exports validate() and main()
        inputs:
          - hook_path
        outputs:
          - exports_valid
          - missing_exports
      - id: check-graceful-degradation
        action: function
        handler: checkGracefulDegradation
        description: Verify hook still defaults to warn mode
        inputs:
          - hook_path
        outputs:
          - graceful_degradation
      - id: lint-hook
        action: function
        handler: lintHook
        description: Check for common issues after changes
        inputs:
          - hook_path
        outputs:
          - lint_passed
          - lint_issues
      - id: update-state-verify
        action: function
        handler: updateEvolutionState
        description: Update evolution-state.json to verifying
    gates:
      - id: gate-verify-tests
        condition: "steps['run-tests'].output.tests_passed === true"
        on_fail: return_to_lock
        message: "Tests failed after update. Fix implementation."
      - id: gate-verify-exports
        condition: "steps['validate-exports'].output.exports_valid === true"
        on_fail: return_to_lock
        message: "Hook must still export validate() and main()"
      - id: gate-verify-graceful
        condition: "steps['check-graceful-degradation'].output.graceful_degradation === true"
        on_fail: return_to_lock
        message: "Hook must still default to warn mode"

  enable:
    description: Update registrations and record changes
    steps:
      - id: update-settings-if-needed
        action: function
        handler: updateSettingsIfNeeded
        description: Update settings.json if registration changed
        inputs:
          - registration_affected
          - registration_changes
          - hook_name
        outputs:
          - settings_updated
      - id: update-hooks-readme
        action: function
        handler: updateHooksReadme
        description: Update hook documentation in README.md
        inputs:
          - hook_name
          - change_description
        outputs:
          - readme_updated
      - id: update-memory
        action: function
        handler: updateMemory
        description: Record hook update in learnings.md
        inputs:
          - hook_name
          - change_description
          - changes_applied
        outputs:
          - memory_updated
      - id: cleanup-backup-on-success
        action: function
        handler: cleanupBackupOnSuccess
        description: Optionally clean up backup after successful update
        inputs:
          - backup_id
        outputs:
          - backup_cleaned
      - id: update-state-enable
        action: function
        handler: updateEvolutionState
        description: Update evolution-state.json to idle with completed evolution
        inputs:
          - hook_name
          - change_description
      - id: verify-registration
        action: function
        handler: verifyRegistration
        description: Verify hook is still properly registered
        inputs:
          - hook_name
        outputs:
          - verification_passed
    gates:
      - id: gate-enable-verify
        condition: "steps['verify-registration'].output.verification_passed === true"
        on_fail: retry
        max_retries: 2
        message: "Hook registration verification failed after update"

# Rollback/compensate actions for each phase
compensate:
  lock:
    - action: restore_backup
      target: backup_id
      description: Restore hook and test files from backup
  enable:
    - action: revert_settings
      target: ".claude/settings.json"
      description: Revert settings.json changes if made
    - action: revert_readme
      target: ".claude/hooks/README.md"
      description: Revert README changes
    - action: revert_memory
      target: ".claude/context/memory/learnings.md"
      description: Remove update entry from learnings

# Iron Laws for hook updates
iron_laws:
  - id: no-update-without-backup
    rule: "Every update MUST create a backup first"
    enforcement: gate-lock-backup
  - id: no-removal-of-validate
    rule: "Cannot remove validate() export"
    enforcement: gate-validate-exports
  - id: no-removal-of-main
    rule: "Cannot remove main() export"
    enforcement: gate-validate-exports
  - id: no-update-without-justification
    rule: "Changes must be justified with clear rationale"
    enforcement: gate-evaluate-justified
  - id: tests-must-pass
    rule: "All tests must pass after update"
    enforcement: gate-verify-tests
  - id: maintain-graceful-degradation
    rule: "Hook must still default to warn mode"
    enforcement: gate-verify-graceful
