name: Incident Response Workflow
description: Production incident response, crisis management, and post-mortem analysis
type: incident
project_type: operations

# Error Recovery Configuration
recovery:
  enabled: true
  checkpoint_dir: '.claude/context/runtime/runs/{{run_id}}/checkpoints'

retry_config:
  max_attempts: 3
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

fallback_agents:
  developer: [code-reviewer, qa]
  architect: [developer, security-architect]
  qa: [developer, code-reviewer]
  planner: [architect, pm]
  incident-responder: [devops, developer]
  devops: [architect, developer]
  security-architect: [compliance-auditor, devops]
  code-reviewer: [developer, security-architect]
  technical-writer: [developer, pm]

# NOTE: trigger_keywords here are for documentation only.
# The actual workflow selection uses keywords from .claude/config.yaml workflow_selection section.
# See .claude/config.yaml for the authoritative keyword list used by the routing system.
trigger_keywords:
  - 'incident'
  - 'outage'
  - 'production issue'
  - 'post-mortem'
  - 'crisis'
  - 'downtime'
  - 'emergency'

priority: critical

steps:
  - step: 0
    name: 'Planning Phase'
    agent: planner
    inputs:
      - incident_report
      - system_status
      - affected_services
    outputs:
      - plan-{{workflow_id}}.md
      - plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-planner.json
    validation:
      schema: .claude/schemas/plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-planner.json
    description: |
      Rapid incident response planning:
      - Assess incident severity and scope
      - Create structured response plan
      - Coordinate response team activation

  - step: 0.1
    name: 'Plan Rating Gate'
    agent: orchestrator
    type: validation
    skill: response-rater
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
    outputs:
      - .claude/context/runtime/runs/{{run_id}}/plans/{{plan_id}}-rating.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00.1-orchestrator.json
    validation:
      minimum_score: 5
      rubric_file: .claude/context/artifacts/standard-plan-rubric.json
      schema: .claude/schemas/plan-rating.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00.1-orchestrator.json
      emergency_bypass: true
    retry:
      max_attempts: 3
      on_failure: escalate_to_human
    description: |
      Rate plan quality using response-rater skill.
      - Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
      - Minimum passing score: 5/10 (lowered threshold for incident response)
      - Emergency bypass: Critical incidents can skip rating if time-sensitive
      - If score < 5: Return to Planner with feedback, request improvements, re-rate
      - If score >= 5: Proceed with workflow execution

  - step: 1
    name: 'Incident Triage'
    agent: incident-responder
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - incident_report
      - system_status
      - affected_services
    outputs:
      - triage-assessment.json
      - immediate-actions.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-incident-responder.json
    validation:
      schema: .claude/schemas/incident-triage.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/01-incident-responder.json
    description: |
      Rapid incident assessment:
      - Severity classification
      - Impact assessment
      - Affected users/services
      - Initial hypothesis
      - Communication plan
      - Immediate mitigation steps

  - step: 2
    name: 'Infrastructure Analysis'
    agent: devops
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - triage-assessment.json (from step 1)
      - system_logs
      - metrics
    outputs:
      - infrastructure-analysis.json
      - remediation-plan.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-devops.json
    validation:
      schema: .claude/schemas/infrastructure-analysis.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/02-devops.json
    description: |
      Infrastructure investigation:
      - Log analysis
      - Metric correlation
      - Resource utilization
      - Deployment history
      - Configuration drift detection
      - Rollback assessment

  - step: 3
    name: 'Security Assessment'
    agent: security-architect
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - triage-assessment.json (from step 1)
      - infrastructure-analysis.json (from step 2)
    outputs:
      - security-assessment.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-security-architect.json
    validation:
      schema: .claude/schemas/security-assessment.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03-security-architect.json
    description: |
      Security incident evaluation:
      - Breach indicators
      - Vulnerability assessment
      - Attack vector analysis
      - Data exposure evaluation
      - Compliance impact
      - Forensic preservation

  - step: 3.5
    name: 'Compliance Impact Assessment'
    agent: compliance-auditor
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - triage-assessment.json (from step 1)
      - security-assessment.json (from step 3)
    outputs:
      - compliance-impact.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03.5-compliance-auditor.json
    validation:
      schema: .claude/schemas/compliance-report.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03.5-compliance-auditor.json
    description: |
      Compliance and regulatory impact:
      - Data breach notification requirements (GDPR, CCPA, etc.)
      - PII/PHI exposure assessment
      - Regulatory reporting obligations
      - Breach notification timelines
      - Customer communication requirements
      - Documentation and evidence preservation
      - SOC2/ISO27001/HIPAA/PCI-DSS impact
      - Legal and contractual obligations
      - Third-party vendor notifications

  - step: 4
    name: 'Code Review'
    agent: code-reviewer
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - remediation-plan.json (from step 2)
      - security-assessment.json (from step 3)
    outputs:
      - code-review-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-code-reviewer.json
    validation:
      schema: .claude/schemas/code-review.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/04-code-reviewer.json
    on_failure: 'Return to remediation step with feedback'
    description: |
      Review remediation implementation for quality, security, and codebase impact:
      - Verify fix addresses root cause
      - Check for unintended side effects
      - Validate security implications
      - Ensure proper error handling
      - Review rollback procedures

  - step: 5
    name: 'Resolution Validation'
    agent: qa
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - remediation-plan.json (from step 2)
      - security-assessment.json (from step 3)
      - code-review-{{workflow_id}}.json (from step 4)
    outputs:
      - resolution-report.json
      - post-mortem.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/05-qa.json
    validation:
      schema: .claude/schemas/incident-resolution.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/05-qa.json
    secondary_outputs:
      - artifact: post-mortem.json
        schema: .claude/schemas/post-mortem.schema.json
    description: |
      Resolution and post-mortem:
      - Fix verification
      - Regression testing
      - Service restoration confirmation
      - Root cause documentation
      - Prevention recommendations
      - Process improvements

  - step: 5.5
    name: 'Publish Artifacts'
    agent: orchestrator
    skill: artifact-publisher
    condition: "validation_status == 'pass'"
    inputs:
      - artifact-registry.json
    policy: auto-on-pass
    validation:
      schema: .claude/schemas/artifact-registry.schema.json
    retry:
      max_attempts: 3
      on_failure: log_and_continue

completion_criteria:
  - Incident severity assessed
  - Root cause identified
  - Remediation applied
  - Service restored
  - Post-mortem documented
  - Prevention measures defined
