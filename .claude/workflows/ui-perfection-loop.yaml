name: UI Perfection Loop Workflow
description: Iterative 4-phase workflow for achieving 95%+ UI quality through visual perfection, accessibility, and enterprise polish
type: ui-perfection
project_type: ui-optimization

# Error Recovery Configuration
recovery:
  enabled: true
  checkpoint_dir: ".claude/context/runs/{{run_id}}/checkpoints"

retry_config:
  max_attempts: 3
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

fallback_agents:
  developer: [code-reviewer, qa]
  architect: [developer, security-architect]
  qa: [developer, code-reviewer]
  planner: [architect, pm]
  react-component-developer: [developer, ux-expert]
  ux-expert: [pm, accessibility-expert]
  accessibility-expert: [ux-expert, qa]
  code-reviewer: [developer, ux-expert]
  performance-engineer: [developer, architect]

# NOTE: trigger_keywords here are for documentation only.
# The actual workflow selection uses keywords from .claude/config.yaml workflow_selection section.
# See .claude/config.yaml for the authoritative keyword list used by the routing system.
trigger_keywords:
  - "ui perfection"
  - "visual perfection"
  - "ui polish"
  - "ux optimization"
  - "glassmorphism"
  - "ui audit"
  - "visual quality"
  - "ui refinement"

# Workflow inputs
inputs:
  target_component:
    type: string
    description: "Component or page path to optimize"
    required: true
  reference_images:
    type: array
    description: "Array of user-provided image paths (optional)"
    required: false
    default: []
  target_score:
    type: number
    description: "Minimum score threshold (default: 95)"
    required: false
    default: 95
  glassmorphism_required:
    type: boolean
    description: "Boolean flag for glassmorphism enforcement"
    required: false
    default: false
  max_iterations:
    type: number
    description: "Maximum number of iterations (default: 5)"
    required: false
    default: 5

# Workflow context directory
context_dir: .claude/context/ui-perfection/{{workflow_id}}

steps:
  # Phase 0: Planning
  - step: 0
    name: "Planning Phase"
    agent: planner
    inputs:
      - target_component
      - reference_images
      - glassmorphism_required
      - target_score
    outputs:
      - plan-{{workflow_id}}.md
      - plan-{{workflow_id}}.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/00-planner.json
    validation:
      schema: .claude/schemas/plan.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/00-planner.json
    description: |
      Plan UI perfection workflow:
      - Analyze UI requirements and target score
      - Coordinate UI improvement strategy
      - Create structured perfection plan

  # Phase 1: Capture & Audit
  - step: 1
    name: "UX Analysis"
    agent: ux-expert
    parallel: true
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - target_component
      - reference_images
      - glassmorphism_required
    outputs:
      - ui-audit-ux.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/01-ux-expert.json
    validation:
      schema: .claude/schemas/ui-audit-report.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/01-ux-expert.json
    description: |
      UX analysis and visual assessment:
      - Visual hierarchy evaluation
      - Design consistency review
      - Enterprise polish assessment
      - Glassmorphism compliance (if required)
      - Design system alignment
      - User experience flow analysis
      - Visual design patterns review

  - step: 2
    name: "Accessibility Audit"
    agent: accessibility-expert
    parallel: true
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - target_component
      - reference_images
    outputs:
      - ui-audit-a11y.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/02-accessibility-expert.json
    validation:
      schema: .claude/schemas/ui-audit-report.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/02-accessibility-expert.json
    description: |
      Accessibility and WCAG compliance:
      - Color contrast analysis
      - Keyboard navigation assessment
      - Screen reader compatibility
      - ARIA attribute validation
      - Focus management review
      - Semantic HTML structure
      - Responsive design accessibility

  # Phase 2: Grading & Validation
  - step: 3
    name: "Score Calculation & Multi-AI Validation"
    agent: model-orchestrator
    tool: multi-ai-validator
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - ui-audit-ux.json (from step 1)
      - ui-audit-a11y.json (from step 2)
      - target_score
      - iteration_count
      - target_component
    outputs:
      - grading-score.json
      - gemini-validation.json
      - validation-report.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/03-model-orchestrator.json
    validation:
      schema: .claude/schemas/multi-ai-validation.schema.json
      gate: .claude/context/history/gates/{{workflow_id}}/03-model-orchestrator.json
    description: |
      Scoring and multi-AI validation:
      - Calculate visual hierarchy score (0-100)
      - Calculate consistency score (0-100)
      - Calculate accessibility score (0-100)
      - Calculate enterprise polish score (0-100)
      - Run multi-AI validation (Cursor/Gemini/Codex) using gemini-validator agent
      - Use Gemini CLI for validation: `gemini validate --target <component> --model gemini-pro`
      - Apply consensus rule (if Gemini score >10 points lower, use Gemini score)
      - Calculate total weighted score
      - Generate penalty and recommendation lists
      - Generate validation report with consensus issues

  # Phase 3: Execution
  - step: 4
    name: "Implementation"
    agent: developer
    parallel: false
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - grading-score.json (from step 3)
      - ui-audit-ux.json (from step 1)
      - ui-audit-a11y.json (from step 2)
      - target_component
    outputs:
      - dev-manifest.json
      - code-artifacts
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/04-developer.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/04-developer.json
    description: |
      Implementation of UI improvements:
      - Apply visual hierarchy fixes
      - Implement consistency improvements
      - Apply enterprise polish enhancements
      - Fix accessibility issues
      - Implement glassmorphism (if required)
      - Update component styling
      - Ensure design system compliance

  - step: 5
    name: "Mobile Optimization"
    agent: mobile-developer
    parallel: false
    condition: "mobile_issues_detected"
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - grading-score.json (from step 3)
      - dev-manifest.json (from step 4)
      - target_component
    outputs:
      - mobile-optimization.json
      - code-artifacts
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/05-mobile-developer.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/05-mobile-developer.json
    description: |
      Mobile-specific optimizations:
      - Responsive design fixes
      - Touch target optimization
      - Mobile layout improvements
      - Performance optimization for mobile
      - Mobile accessibility enhancements

  # Phase 4: Verification
  - step: 6
    name: "Quality Verification"
    agent: qa
    inputs:
      - plan-{{workflow_id}}.json (from step 0)
      - dev-manifest.json (from step 4)
      - mobile-optimization.json (from step 5, optional)
      - grading-score.json (from step 3)
      - ui-audit-ux.json (from step 1)
      - ui-audit-a11y.json (from step 2)
      - target_component
    outputs:
      - verification-report.json
      - final-score.json
      - iteration-metadata.json
      - reasoning: .claude/context/history/reasoning/{{workflow_id}}/06-qa.json
    validation:
      gate: .claude/context/history/gates/{{workflow_id}}/06-qa.json
      schema: .claude/schemas/ui-audit-report.schema.json
    description: |
      Quality verification with anti-hallucination protocol:
      - Visual regression testing
      - Accessibility re-audit
      - Cross-browser testing
      - Responsive design validation
      - Performance metrics check
      - Screenshot comparison (if reference images provided)
      - Calculate final score
      - Generate iteration metadata (current_iteration, max_iterations, previous_score, score_improvement, should_continue)
      - Verify improvements match audit recommendations
      - Note: mobile-optimization.json is optional - step 5 may be skipped if no mobile issues detected

  - step: 6.5
    name: "Publish Artifacts"
    agent: orchestrator
    skill: artifact-publisher
    condition: "validation_status == 'pass'"
    inputs:
      - artifact-registry.json
    policy: auto-on-pass
    retry:
      max_attempts: 3
      on_failure: log_and_continue

# Iteration configuration
# Workflow engine handles iteration decision based on final-score.json from step 6
iteration:
  enabled: true
  max_iterations: 5
  loop_back_step: 1  # Loop back to UX Analysis (step 1), not planning
  condition:
    type: "and"
    checks:
      - field: "final_score"
        operator: "<"
        value: "{{target_score}}"
      - field: "iteration_count"
        operator: "<"
        value: "{{max_iterations}}"
  context_preservation:
    - ui-audit-ux.json
    - ui-audit-a11y.json
    - grading-score.json
    - reference_images
  iteration_summary:
    generate: true
    output_file: iteration-summary.json

# Output files
outputs:
  - ui-audit-ux.json
  - ui-audit-a11y.json
  - grading-score.json
  - gemini-validation.json
  - dev-manifest.json
  - mobile-optimization.json
  - verification-report.json
  - final-score.json
  - iteration-summary.json

# Completion criteria
completion_criteria:
  - Final UI quality score >= target_score (default: 95)
  - All accessibility issues resolved
  - Visual hierarchy optimized
  - Design consistency achieved
  - Enterprise polish applied
  - Verification tests passing
  - No critical visual regressions

# Integration points
integrations:
  mobile_workflow:
    trigger_condition: "mobile_issues_detected == true"
    workflow_file: .claude/workflows/mobile-flow.yaml
    shared_artifacts:
      - mobile-ux-spec.json
  accessibility_workflow:
    enabled: true
    agent: accessibility-expert
    wcag_validation: true
    playwright_testing: true

