# UI Perfection Loop - Tool Integration Guide

This document describes how the UI Perfection Loop workflow integrates with available tools and MCP servers.

## Overview

The UI Perfection Loop workflow uses a combination of MCP tools, agent capabilities, and workflow orchestration to achieve iterative UI quality improvements. This guide explains the tool alternatives and integration patterns.

## Tool Categories

### 1. Screenshot Capture & Image Analysis

**User-Provided Screenshots:**
- Workflow accepts `reference_images` as input parameter (array of file paths)
- Supports both absolute and relative paths
- Images stored in `.claude/context/ui-perfection/{{workflow_id}}/screenshots/`
- Validation: Paths are checked for existence before processing

**Filesystem MCP Integration:**
- Use Filesystem MCP to read image files from provided paths
- Store comparison screenshots for iteration tracking
- Path format: Accepts both absolute (`/path/to/image.png`) and relative (`./screenshots/ref.png`)

**Example Usage:**
```yaml
inputs:
  reference_images:
    - "./designs/reference-1.png"
    - "./designs/reference-2.png"
```

**Storage Structure:**
```
.claude/context/ui-perfection/{workflow_id}/
├── screenshots/
│   ├── iteration-1/
│   │   ├── before.png
│   │   ├── after.png
│   │   └── reference.png
│   └── iteration-2/
│       └── ...
```

### 2. Gemini Validation

**Model Orchestrator Agent:**
- In Phase 2 (Grading), `model-orchestrator` agent receives grading request
- Routes validation to Gemini via configured model routing
- Configuration file: `.claude/tools/model-routing-config.yaml`
- Script: `.claude/tools/model-router.sh`

**Validation Process:**
1. UX Expert and Accessibility Expert generate initial scores
2. Model Orchestrator routes to Gemini for external validation
3. Gemini provides:
   - Validation score (0-100)
   - External critique
   - Design pattern recommendations
4. Consensus rule applied: If Gemini score >10 points lower than internal score, use Gemini score

**Integration Pattern:**
```yaml
step: 3
name: "Score Calculation & Gemini Validation"
agent: model-orchestrator
inputs:
  - ui-audit-ux.json (from step 1)
  - ui-audit-a11y.json (from step 2)
description: |
  Routes to Gemini via model-router.sh for external validation
```

**Output:**
- `gemini-validation.json`: Contains Gemini's score and critique
- `grading-score.json`: Final score after consensus rule application

### 3. Search Tools

**Available MCP Search Tools:**
- **MCP_search_knowledge**: For design patterns, best practices, UI/UX guidelines
- **MCP_search_code**: For codebase-specific UI patterns and component examples

**Usage in Workflow:**
- UX Expert uses search_knowledge for design pattern research
- Developer uses search_code for component implementation examples
- Accessibility Expert uses search_knowledge for WCAG guidelines

**Example Queries:**
- "glassmorphism design patterns"
- "WCAG 2.1 AA color contrast requirements"
- "enterprise UI polish best practices"
- "visual hierarchy design principles"

**Important:** Always use the configured MCP search tools (`MCP_search_knowledge`, `MCP_search_code`) instead of external tools like "Exa". These are integrated with the LLM-RULES system and provide consistent results.

### 4. Visual Testing

**Playwright Integration:**
- Reference: `.claude/rules-master/TOOL_PLAYWRIGHT_MASTER.md`
- QA agent can generate Playwright screenshot tests in Phase 4
- Tests stored in `.claude/context/ui-perfection/{{workflow_id}}/tests/`
- Supports visual regression testing

**Screenshot Testing Pattern:**
```typescript
// Generated by QA agent during verification
import { test, expect } from '@playwright/test';

test('UI Perfection - Visual Regression', async ({ page }) => {
  await page.goto('/target-component');
  await expect(page).toHaveScreenshot('ui-perfection-baseline.png');
});
```

**Accessibility Testing:**
- QA agent uses Playwright accessibility testing patterns
- Reference: `TOOL_PLAYWRIGHT_MASTER.md` accessibility section
- Includes:
  - Color contrast validation
  - Keyboard navigation testing
  - Screen reader compatibility
  - ARIA attribute validation

### 5. File Operations

**Filesystem MCP:**
- Reading UI component files
- Writing updated component files
- Reading/writing JSON reports
- Managing context directory structure

**Path Configuration:**
- All outputs: `.claude/context/ui-perfection/{{workflow_id}}/`
- Reports: `reports/` subdirectory
- Screenshots: `screenshots/` subdirectory
- Tests: `tests/` subdirectory
- Code artifacts: Written to actual component locations

**File Reading Pattern:**
```yaml
# Workflow reads target component
inputs:
  target_component: "app/components/UserProfile.tsx"
```

**File Writing Pattern:**
```yaml
# Developer agent writes updates
outputs:
  - code_artifacts  # Updated component files
  - implementation-manifest.json  # Change log
```

## Agent Tool Assignments

### UX Expert
- **Tools**: shadcn, Markitdown, Read, Search, Edit (CSS/Tailwind only)
- **MCP Tools**: Filesystem (read images), Search (design patterns)
- **Restrictions**: No Bash, No Docker

### Accessibility Expert
- **Tools**: Read, Search, Edit (accessibility fixes)
- **MCP Tools**: Filesystem, Search (WCAG guidelines)
- **Restrictions**: No Bash, No Docker

### Model Orchestrator
- **Tools**: Read, Bash, Grep, Glob, Sequential Thinking
- **MCP Tools**: Model routing (Gemini)
- **Scripts**: `.claude/tools/model-router.sh`

### Developer
- **Tools**: shadcn, Git, GitHub Official, Markitdown, Read, Edit, Bash, Grep, Glob, Filesystem, SQLite
- **MCP Tools**: Filesystem (read/write), shadcn (components)
- **Restrictions**: No dangerous Bash commands

### Mobile Developer
- **Tools**: Same as Developer
- **MCP Tools**: Filesystem, shadcn
- **Focus**: Mobile-specific optimizations

### QA
- **Tools**: Curl, Docker, SQLite, Read, Search, Bash, Grep, Glob
- **MCP Tools**: Filesystem (screenshots), Playwright (testing)
- **Restrictions**: No Edit (code) - only test generation

## Workflow Iteration Context

**Context Preservation:**
During iterations, the following artifacts are preserved:
- `ui-audit-ux.json`: Previous UX analysis
- `ui-audit-a11y.json`: Previous accessibility audit
- `grading-score.json`: Previous scoring results
- `reference_images`: User-provided reference images

**Iteration Tracking:**
- Each iteration creates a new subdirectory: `iteration-{n}/`
- Previous iteration artifacts remain accessible
- Final iteration summary includes all iteration history

## Integration with Other Workflows

### Mobile Workflow Integration
- If mobile-specific issues detected, can trigger `mobile-flow.yaml`
- Shares `mobile-ux-spec.json` between workflows
- Mobile-developer agent coordinates between workflows

### Accessibility Workflow Integration
- Leverages accessibility-expert's existing WCAG validation
- Uses Playwright accessibility testing patterns
- Integrates with existing accessibility audit workflows

## Tool Alternatives Summary

| Requirement | Tool Alternative | Implementation |
|------------|----------------|----------------|
| Screenshots | User-provided paths + Filesystem MCP | Read images from provided paths |
| Gemini Validation | Model Orchestrator + model-router.sh | Route via configured model routing |
| Search | MCP_search_knowledge, MCP_search_code | Use configured MCP search tools |
| Visual Testing | Playwright (TOOL_PLAYWRIGHT_MASTER.md) | Generate Playwright screenshot tests |
| File Operations | Filesystem MCP | Read/write UI files and reports |

## Best Practices

1. **Image Paths**: Always validate paths exist before processing
2. **Gemini Validation**: Use consensus rule to balance internal and external scores
3. **Search Queries**: Be specific - use design pattern names, WCAG references, etc.
4. **Visual Testing**: Generate Playwright tests for regression prevention
5. **Context Management**: Preserve iteration context for comparison
6. **Tool Restrictions**: Respect agent tool restrictions (no dangerous commands)

## Troubleshooting

**Issue**: Reference images not found
- **Solution**: Validate paths in workflow input validation
- **Fallback**: Continue without reference images, use code analysis only

**Issue**: Gemini validation fails
- **Solution**: Check model-router.sh configuration
- **Fallback**: Use internal scores only (log warning)

**Issue**: Search tools return no results
- **Solution**: Refine search queries, try alternative keywords
- **Fallback**: Use agent knowledge base

**Issue**: Playwright tests fail
- **Solution**: Check Playwright installation and configuration
- **Fallback**: Manual visual inspection recommended

## References

- Playwright Testing: `.claude/rules-master/TOOL_PLAYWRIGHT_MASTER.md`
- Model Routing: `.claude/tools/model-router.sh`
- Model Config: `.claude/tools/model-routing-config.yaml`
- Workflow Structure: `.claude/workflows/ui-perfection-loop.yaml`
- Schema: `.claude/schemas/ui-audit-report.schema.json`

