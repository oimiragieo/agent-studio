# CUJ-055: Publishing Retry Logic Test

## User Goal

Validate that publishing retry logic works correctly with exponential backoff and tracks all attempts in registry.

## Trigger

- "Test publishing retry logic"
- "Validate retry with backoff"
- "Check publishing retry tracking"

## Workflow

**Execution Mode**: workflow
**Workflow File**: `.claude/workflows/legacy-modernization.yaml`

### Step 0: Planning Phase

- Planner creates retry logic test plan
- Identifies test scenarios for retry behavior
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Test Successful Publishing (No Retry)

- Create artifact with `publishable: true`
- Publish artifact (should succeed on first attempt)
- Verify `publish_status: 'success'` set immediately
- Check `publish_attempts` array has single success entry
- Verify no retry delays occurred

### Step 2: Test Transient Error Retry

- Simulate transient network error (timeout)
- Verify retry logic triggers:
  - First attempt fails
  - Wait 1 second (initial_delay_ms)
  - Second attempt fails
  - Wait 2 seconds (2x backoff)
  - Third attempt succeeds
- Check `publish_attempts` array has 3 entries:
  - Entry 1: `status: 'failed'`, `error: 'Network timeout'`
  - Entry 2: `status: 'failed'`, `error: 'Network timeout'`
  - Entry 3: `status: 'success'`
- Verify `publish_status: 'success'` after final attempt

### Step 3: Test Max Retries Exceeded

- Simulate persistent error (permission denied)
- Verify retry logic stops after max_attempts (3):
  - Attempt 1: fails, wait 1s
  - Attempt 2: fails, wait 2s
  - Attempt 3: fails, wait 4s (max_delay_ms: 8000)
  - No 4th attempt
- Check `publish_status: 'failed'` after max retries
- Verify `publish_error` contains final error message
- Check `publish_attempts` array has exactly 3 failed entries

### Step 4: Test Exponential Backoff Timing

- Measure actual delays between retry attempts
- Verify delays match exponential backoff:
  - Delay 1: ~1000ms (initial_delay_ms)
  - Delay 2: ~2000ms (2x)
  - Delay 3: ~4000ms (4x, capped at max_delay_ms: 8000)
- Check delays don't exceed max_delay_ms

### Step 5: Test Retry Attempt Tracking

- Verify each retry attempt recorded in `publish_attempts`:
  - `timestamp`: ISO 8601 format
  - `status`: 'success' or 'failed'
  - `error`: Error message (if failed)
  - `target`: Publish target (e.g., 'project_feed')
- Check timestamps are sequential
- Verify error messages preserved for failed attempts

### Step 6: Test Registry Update After Each Attempt

- Verify `updateArtifactPublishingStatus()` called after each attempt
- Check registry updated incrementally:
  - After attempt 1: `publish_attempts` has 1 entry
  - After attempt 2: `publish_attempts` has 2 entries
  - After attempt 3: `publish_attempts` has 3 entries
- Verify registry persisted after each update

### Step 7: Test Permanent Error (No Retry)

- Simulate permanent error (invalid artifact format)
- Verify no retry attempted (fails immediately)
- Check `publish_status: 'failed'` set immediately
- Verify `publish_attempts` has single failed entry
- Check `publish_error` contains permanent error message

## Agents Used

- Planner (retry test planning)
- QA (retry logic validation)

## Skills Used

- `artifact-publisher` - Publishing with retry logic
- `plan-generator` - Creating retry test plan
- `response-rater` - Plan quality validation

## Capabilities/Tools Used

- Retry configuration: `max_attempts: 3`, `backoff_strategy: exponential`, `initial_delay_ms: 1000`, `max_delay_ms: 8000`
- Publishing status tracking: `updateArtifactPublishingStatus()` in `run-manager.mjs`
- Registry persistence: `.claude/context/runs/<run_id>/artifact-registry.json`

## Expected Outputs

- Retry test plan: `plan-{{workflow_id}}.json`
- Test artifacts with various publishing scenarios
- Registry files with retry attempt tracking: `.claude/context/runs/<run_id>/artifact-registry.json`
- Retry validation report: `publishing-retry-report.json`
- Timing measurements for backoff delays

## Success Criteria

| Criterion                      | Measurement                     | Target                                                                            |
| ------------------------------ | ------------------------------- | --------------------------------------------------------------------------------- |
| Plan rating                    | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded                | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`       |
| Successful publishing          | Registry status                 | No retry, `publish_status: 'success'` immediately                                 |
| Transient error retry          | Registry attempts count         | 3 attempts with exponential backoff                                               |
| Max retries exceeded           | Registry validation             | Stops after 3 attempts, `publish_status: 'failed'`                                |
| Exponential backoff timing     | Timing measurement              | Delays are 1s, 2s, 4s                                                             |
| Retry attempts tracked         | Schema validation               | Each attempt with timestamp, status, error                                        |
| Registry updated incrementally | Registry snapshots              | `publish_attempts` grows with each attempt                                        |
| Permanent error handling       | Error type validation           | No retry, immediate failure                                                       |

## Example Prompts

```
"Test publishing retry logic"
"Validate exponential backoff works"
"Check if retry attempts are tracked correctly"
```

## Related Documentation

- [Artifact Publisher Skill](../../skills/artifact-publisher/SKILL.md)
- [Run Manager Tool](../../tools/run-manager.mjs)
- [Artifact Registry Schema](../../schemas/artifact-registry.schema.json)
