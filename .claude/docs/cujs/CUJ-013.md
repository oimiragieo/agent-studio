# CUJ-013: Code Review

## User Goal
Comprehensive code review with systematic analysis.

## Trigger
- `/review`
- `/review src/components/`
- "Review this code"

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase
- Planner creates review plan
- Analyzes code scope and requirements
- Determines review depth and focus areas
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`


### Step 0.1: Plan Rating Gate
- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Code Analysis
- Code Reviewer analyzes code
- Checks quality, patterns, security
- Identifies issues

### Step 2: Review Report
- Generates review report
- Lists issues with severity
- Provides recommendations

### Step 3: Fix Suggestions
- Suggests specific fixes
- Provides code examples
- Prioritizes issues

## Agents Used
- Code Reviewer

## Skills Used
- `rule-auditor` - Rule compliance
- `response-rater` - Plan quality validation

## Expected Outputs
- Code review report
- Issue list with priorities
- Fix suggestions

## Success Criteria

| Criterion | Measurement | Target |
|-----------|-------------|--------|
| Review plan created | Artifact validated by gate | `plan-{{workflow_id}}.json` validated by gate file |
| Plan rating | response-rater skill score | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json` |
| Code analyzed | Artifact files_reviewed field | Files reviewed array populated in `code-review-report-{{workflow_id}}.json` |
| Issues identified with severity | Artifact issues field | Issues array with severity (critical\|high\|medium\|low) in `code-review-report-{{workflow_id}}.json` |
| Rule compliance checked | Artifact rule_violations field | Rule violations array in `code-review-report-{{workflow_id}}.json` |
| Security issues flagged | Artifact security_issues field | Security issues array in `code-review-report-{{workflow_id}}.json` |
| Recommendations provided | Artifact recommendations field | Recommendations array in `code-review-report-{{workflow_id}}.json` |
| Fix suggestions with code examples | Artifact suggested_fix field | Each issue has suggested_fix in `code-review-report-{{workflow_id}}.json` |
| Report validated | Schema validation | Validated against `.claude/schemas/code-review.schema.json` |

## Example Prompts
```
/review
/review src/components/auth
"Review the authentication module"
```

## Related Documentation
- [Code Reviewer Agent](../../agents/code-reviewer.md)
- [rule-auditor Skill](../../skills/rule-auditor/SKILL.md)
