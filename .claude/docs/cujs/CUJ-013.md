# CUJ-013: Code Review

## User Goal

Comprehensive code review with systematic analysis.

## Trigger

- `/review`
- `/review src/components/`
- "Review this code"

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase

- Planner creates review plan
- Analyzes code scope and requirements
- Determines review depth and focus areas
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Code Analysis

- Code Reviewer analyzes code
- Checks quality, patterns, security
- Identifies issues

### Step 1.5: Multi-AI Code Review (Optional)

**Agent**: code-reviewer
**Skill**: multi-ai-code-review
**Condition**: User requested multi-AI review OR critical security changes detected
**Inputs**:

- Git diff (staged changes or range: `origin/main...HEAD`)
- Security trigger flags from previous analysis
- Plan context from Step 0
  **Outputs**:
- `.claude/context/artifacts/multi-ai-review-report.json` - Structured findings from multiple AI providers
- `.claude/context/artifacts/multi-ai-review-synthesis.md` (optional) - Synthesized PR-ready review
  **Description**:
  Run multi-provider code review using Claude, Gemini, and optionally Codex for consensus validation.
  Uses headless AI CLIs to independently review git changes and identify security, bug, and performance issues.
  **Default Providers**: `claude,gemini` (fast, reliable dual validation)
  **Enterprise Providers**: `claude,gemini,codex` (adds third perspective for critical reviews)
  **CI Mode**: Use `--ci` flag for automated reviews with strict JSON output
  **Notes**:
- This step is triggered when user explicitly requests multi-AI validation
- Automatically triggered when security triggers indicate critical changes (auth, encryption, injection vulnerabilities)
- Can be used to validate PR changes before merge
- Output format supports both JSON (CI-friendly) and Markdown (PR comments)

### Step 2: Review Report

- Generates review report
- Lists issues with severity
- Provides recommendations

### Step 3: Fix Suggestions

- Suggests specific fixes
- Provides code examples
- Prioritizes issues

## Agents Used

- Code Reviewer

## Skills Used

- `rule-auditor` - Rule compliance validation
- `response-rater` - Plan quality validation
- `multi-ai-code-review` - Multi-provider code review (optional, triggered by user request or critical security changes)

## Expected Outputs

- Code review report
- Issue list with priorities
- Fix suggestions
- Multi-AI review report (optional) - `.claude/context/artifacts/multi-ai-review-report.json`

## Success Criteria

| Criterion                          | Measurement                     | Target                                                                                                |
| ---------------------------------- | ------------------------------- | ----------------------------------------------------------------------------------------------------- |
| Review plan created                | Artifact validated by gate      | `plan-{{workflow_id}}.json` validated by gate file                                                    |
| Plan rating                        | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`)                     |
| Rating recorded                    | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`                           |
| Code analyzed                      | Artifact files_reviewed field   | Files reviewed array populated in `code-review-report-{{workflow_id}}.json`                           |
| Issues identified with severity    | Artifact issues field           | Issues array with severity (critical\|high\|medium\|low) in `code-review-report-{{workflow_id}}.json` |
| Rule compliance checked            | Artifact rule_violations field  | Rule violations array in `code-review-report-{{workflow_id}}.json`                                    |
| Security issues flagged            | Artifact security_issues field  | Security issues array in `code-review-report-{{workflow_id}}.json`                                    |
| Recommendations provided           | Artifact recommendations field  | Recommendations array in `code-review-report-{{workflow_id}}.json`                                    |
| Fix suggestions with code examples | Artifact suggested_fix field    | Each issue has suggested_fix in `code-review-report-{{workflow_id}}.json`                             |
| Report validated                   | Schema validation               | Validated against `.claude/schemas/code-review.schema.json`                                           |
| Multi-AI consensus (optional)      | Multi-AI review report          | When triggered, `multi-ai-review-report.json` contains findings from â‰¥2 providers                     |

## Example Prompts

```
/review
/review src/components/auth
"Review the authentication module"
"Review this PR with multi-AI validation"
"Run code review with Claude, Gemini, and Codex consensus"
```

## Related Documentation

- [Code Reviewer Agent](../../agents/code-reviewer.md)
- [rule-auditor Skill](../../skills/rule-auditor/SKILL.md)
- [multi-ai-code-review Skill](../../../codex-skills/multi-ai-code-review/SKILL.md)
