# CUJ-049: Cursor Plan Mode Deep Integration

## User Goal

Test deep integration between Planner Agent (strategic planning) and Cursor Plan Mode (implementation planning), ensuring seamless handoff, artifact linking, and coordinated execution.

## Trigger

- "Test Cursor Plan Mode integration"
- "Validate Planner Agent to Plan Mode handoff"
- "Test strategic plan to implementation plan linking"
- User requests implementation after strategic plan created

## Workflow

**Execution Mode**: `workflow`

### Step 0: Strategic Planning (Planner Agent)

- Planner Agent creates comprehensive strategic plan
- Plan includes high-level steps, agent assignments, dependencies
- Plan saved to `.claude/context/artifacts/generated/plan-<id>.json`
- Plan includes `plan_mode_ready: true` flag
- Plan includes `implementation_plan_location` field (to be populated)

### Step 0.1: Plan Rating Gate

**Agent**: orchestrator
**Skill**: response-rater
**Validation**:

- Minimum score: 7/10
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to planner with feedback (max 3 attempts)
- If score >= 7: Proceed to Step 1
- Records rating in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Plan Mode Handoff

- Planner Agent provides Plan Mode with:
  - Strategic plan file path: `.claude/context/artifacts/generated/plan-<id>.json`
  - Plan summary for Plan Mode description
  - Link to plan markdown: `.claude/context/artifacts/generated/plan-<id>.md`
- User activates Cursor Plan Mode (`Shift+Tab`)
- Plan Mode auto-researches the repo
- Plan Mode references strategic plan in description

### Step 2: Implementation Planning (Cursor Plan Mode)

- Plan Mode creates implementation-level plan
- Plan Mode links back to strategic plan via `strategic_plan_id` field
- Plan Mode uses same `workflow_id` for traceability
- Plan Mode creates detailed implementation tasks
- Plan Mode saves plan to `.cursor/plans/plan-<id>.json` (or Plan Mode artifact location)

### Step 3: Artifact Linking Validation

- **Verify Strategic Plan References Plan Mode**:
  - Check strategic plan includes `implementation_plan_location` field
  - Verify field points to Plan Mode plan location
  - Validate both plans use same workflow ID

- **Verify Plan Mode References Strategic Plan**:
  - Check Plan Mode plan includes `strategic_plan_id` field
  - Verify field references strategic plan ID
  - Validate link is bidirectional

### Step 4: Implementation Execution

- Developer uses Plan Mode plan for implementation
- Plan Mode executes implementation with IDE integration
- Implementation follows both strategic and implementation plans
- Artifacts created reference both plans

### Step 5: Multi-File Change Coordination

- Plan Mode coordinates multi-file changes
- Changes reference strategic plan for context
- Changes follow implementation plan structure
- All changes linked to both plans

### Step 6: Plan Mode Artifact Persistence

- Plan Mode artifacts saved to `.cursor/plans/`
- Artifacts persist across sessions
- Artifacts linked to strategic plan
- Artifacts accessible for future reference

### Step 7: Integration Validation

- Verify strategic plan → Plan Mode handoff successful
- Verify Plan Mode → Implementation execution successful
- Verify artifact linking between Planner and Plan Mode
- Verify multi-file change coordination
- Verify Plan Mode artifact persistence

## Agents Used

- Planner (Cursor subagent) - Strategic planning
- Developer (Cursor subagent) - Implementation with Plan Mode
- Orchestrator (Cursor subagent) - Coordination

## Capabilities/Tools Used

- Cursor Plan Mode integration (Cursor IDE feature, not a skill)
- Strategic to implementation plan handoff
- Artifact linking
- Multi-file change coordination

## Expected Outputs

- Strategic plan: `.claude/context/artifacts/generated/plan-<id>.json`
- Implementation plan: `.cursor/plans/plan-<id>.json`
- Linked artifacts with bidirectional references
- Implementation code files
- Integration validation report

## Success Criteria

| Criterion                                            | Measurement                              | Target                                                                                     |
| ---------------------------------------------------- | ---------------------------------------- | ------------------------------------------------------------------------------------------ |
| Strategic plan created with Plan Mode ready flag     | `plan_mode_ready` field validation       | Field set to `true` in `plan-{id}.json`                                                    |
| Plan Mode handoff successful                         | Plan Mode plan references strategic plan | `.cursor/plans/plan-{id}.json` includes `strategic_plan_id` field                          |
| Implementation plan created with strategic plan link | Bidirectional link validation            | Both plans reference each other via `strategic_plan_id` and `implementation_plan_location` |
| Artifact linking bidirectional                       | Link integrity check                     | Both plans contain valid references to each other                                          |
| Multi-file changes coordinated successfully          | Change coordination validation           | All multi-file changes tracked in `multi-file-changes.json`                                |
| Plan Mode artifacts persist across sessions          | Artifact persistence check               | Artifacts in `.cursor/plans/artifacts/` accessible after session restart                   |
| Implementation follows both plans                    | Gate file validation                     | Implementation validated against both strategic and implementation plans                   |
| Integration seamless and transparent                 | Integration validation report            | `integration-validation.json` shows all validation checks passed                           |

## Example Prompts

```
"Test Cursor Plan Mode integration with Planner Agent"
"Validate strategic plan to Plan Mode handoff"
"Test artifact linking between Planner and Plan Mode"
```

## Related Documentation

- [Cursor Setup Guide](../../docs/setup-guides/CURSOR_SETUP_GUIDE.md)
- [Planner Agent](../../agents/planner.md) - Cursor Plan Mode Integration
- [CUJ-042: Cursor Subagent Coordination](./CUJ-042.md)

## Integration Test Scenarios

### Scenario 1: Strategic Plan → Plan Mode Handoff

- **Planner Agent**: Creates strategic plan, sets `plan_mode_ready: true`
- **Plan Mode**: Receives strategic plan reference, creates implementation plan
- **Validation**: Both plans linked, same workflow ID used
- **Expected**: Seamless handoff, no information loss

### Scenario 2: Plan Mode → Implementation Execution

- **Plan Mode**: Creates detailed implementation plan
- **Developer**: Uses Plan Mode plan for implementation
- **Validation**: Implementation follows both strategic and implementation plans
- **Expected**: Coordinated execution, both plans referenced

### Scenario 3: Artifact Linking

- **Strategic Plan**: Includes `implementation_plan_location` field
- **Implementation Plan**: Includes `strategic_plan_id` field
- **Validation**: Both fields reference each other correctly
- **Expected**: Bidirectional linking, traceability maintained

### Scenario 4: Multi-File Change Coordination

- **Plan Mode**: Coordinates changes across multiple files
- **Strategic Plan**: Provides context for changes
- **Validation**: Changes reference both plans
- **Expected**: Coordinated changes, context preserved

### Scenario 5: Plan Mode Artifact Persistence

- **Plan Mode**: Creates artifacts in `.cursor/plans/`
- **Persistence**: Artifacts saved and accessible
- **Validation**: Artifacts linked to strategic plan
- **Expected**: Artifacts persist, links maintained
