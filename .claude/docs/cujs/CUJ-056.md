# CUJ-056: Workflow Recovery Protocol Test

## User Goal
Test the recovery skill's ability to restore workflow state from file system artifacts after context loss or session interruption.

## Trigger
- "Test recovery protocol"
- "Validate workflow recovery"
- "Check recovery from file system"
- "Test stateless recovery from artifacts"

## Workflow

**Execution Mode**: `skill-only`

### Step 0: Planning Phase
- Planner creates recovery protocol test plan
- Identifies test scenarios for recovery behavior
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`

### Step 0.1: Plan Rating Gate
- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Create Initial Workflow State
- Create workflow artifacts: `project-brief.json`, `prd.json`, `ui-spec.json`
- Generate plan document: `plan-{{workflow_id}}.json`
- Create gate files for completed steps
- Save artifacts to `.claude/context/runs/<run_id>/artifacts/`

### Step 2: Simulate Context Loss
- Clear conversation history (simulate new session)
- Remove in-memory state
- Preserve only file system artifacts

### Step 3: Invoke Recovery Skill
- Call `recovery` skill with workflow ID
- Skill reads file system artifacts:
  - Plan document: `plan-{{workflow_id}}.json`
  - Artifact registry: `.claude/context/runs/<run_id>/artifact-registry.json`
  - Gate files: `.claude/context/runs/<run_id>/gates/*.json`
  - Reasoning files: `.claude/context/history/reasoning/<workflow_id>/*.json`

### Step 4: Verify State Reconstruction
- Check recovery skill correctly identifies:
  - Last completed step
  - Available artifacts
  - Next step to execute
  - Pending dependencies
- Verify no conversation history referenced

### Step 5: Resume Workflow Execution
- Resume from last completed step
- Create remaining artifacts
- Complete workflow successfully

### Step 6: Validate Recovery Accuracy
- Compare pre-recovery and post-recovery state
- Verify no data loss
- Check artifact integrity
- Validate workflow completion

## Agents Used
- Planner (recovery test planning)
- Orchestrator (recovery coordination)
- QA (recovery validation)

## Skills Used
- `recovery` - Workflow state recovery from file system
- `plan-generator` - Creating recovery test plan
- `response-rater` - Plan quality validation

## Capabilities/Tools Used
- File system artifact reading
- Stateless behavior validation
- Workflow state reconstruction
- Recovery protocol execution

## Expected Outputs
- Recovery test plan: `plan-{{workflow_id}}.json`
- Initial workflow artifacts (project-brief.json, prd.json, etc.)
- Recovery validation report: `recovery-validation-report.json`
- Recovered workflow state documentation
- Completed workflow artifacts

## Success Criteria
- [ ] Plan rating >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`)
- [ ] Rating recorded in run state (validation: rating file exists)

Each criterion references verifiable artifacts for objective pass/fail validation:
- [ ] Initial state created: all artifacts saved to file system (artifact: registry with artifact entries, validated by file existence checks)
- [ ] Context loss simulated: no conversation history available (validated by session reset)
- [ ] Recovery skill invoked: reads artifacts from file system (validated by skill execution logs)
- [ ] State reconstructed: last completed step identified correctly (artifact: recovery report with step status, validated by comparison with plan)
- [ ] Workflow resumed: execution continues from correct step (validated by new artifacts created)
- [ ] No data loss: all pre-recovery artifacts accessible (validated by artifact count comparison)
- [ ] Stateless behavior: no conversation history referenced (validated by reasoning file: no "as we discussed" phrases)
- [ ] Workflow completed: all steps executed successfully (artifact: final artifacts, validated by gate files)

## Example Prompts
```
"Test the recovery protocol"
"Validate workflow recovery from file system"
"Simulate context loss and recover"
"Test stateless recovery behavior"
```

## Related Documentation
- [Recovery Skill](../../skills/recovery/SKILL.md)
- [Stateless Recovery Protocol](../STATELESS_RECOVERY.md)
- [Workflow Guide](../../workflows/WORKFLOW-GUIDE.md)
- [Run Manager Tool](../../tools/run-manager.mjs)

## Related CUJs
- [CUJ-027: Workflow Recovery After Context Loss](./CUJ-027.md) - Basic recovery workflow
- [CUJ-040: Stateless Recovery Test](./CUJ-040.md) - Stateless behavior validation
- [CUJ-043: Workflow Interruption Recovery](./CUJ-043.md) - Mid-step recovery with checkpoints
- [CUJ-050: End-to-End Workflow Robustness](./CUJ-050.md) - Complete workflow resilience

## Recovery Protocol Details

**Stateless Behavior Validation**:
1. **Read from file system only** - No conversation history references
2. **Log file reads** - Document all file read operations with timestamps
3. **Verify file modification times** - Ensure reading current state
4. **Never reference conversation** - Avoid phrases like "as we discussed"

**Recovery Steps**:
1. Load plan document from `.claude/context/runs/<run_id>/plans/`
2. Load artifact registry from `.claude/context/runs/<run_id>/artifact-registry.json`
3. Load gate files from `.claude/context/runs/<run_id>/gates/`
4. Identify last completed step (latest gate file)
5. Load artifacts from `.claude/context/runs/<run_id>/artifacts/`
6. Resume workflow from next step

**Success Indicators**:
- All artifacts accessible from file system
- Workflow state correctly reconstructed
- No conversation history dependencies
- Execution resumes seamlessly
- No data loss during recovery
