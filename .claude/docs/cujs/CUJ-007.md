# CUJ-007: Technical Debt Planning

## User Goal

Plan refactoring of legacy code and technical debt.

## Trigger

- "Plan refactoring of legacy code"
- "Technical debt planning"
- "Refactoring plan"

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase

- Planner creates refactoring plan
- Analyzes scope and impact
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`

### Step 0.1: Plan Rating Gate

**Agent**: orchestrator
**Skill**: response-rater
**Validation**:

- Minimum score: 7/10
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to planner with feedback (max 3 attempts)
- If score >= 7: Proceed to Step 1
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Code Analysis

- Refactoring Specialist analyzes code
- Identifies technical debt
- Assesses refactoring impact

### Step 2: Refactoring Plan

- Creates detailed refactoring plan
- Prioritizes debt items
- Defines migration strategy

### Step 3: Validation

- Validates plan feasibility
- Checks dependencies
- Estimates effort

## Agents Used

- Planner -> Refactoring Specialist

## Skills Used

- `plan-generator` - Refactoring plan

## Expected Outputs

- Refactoring plan
- Technical debt inventory
- Migration roadmap

## Success Criteria

| Criterion                         | Measurement                       | Target                                                                            |
| --------------------------------- | --------------------------------- | --------------------------------------------------------------------------------- |
| Plan created                      | Artifact validated by gate        | `plan-{{workflow_id}}.json` validated by gate file                                |
| Technical debt inventory complete | Artifact debt_items field         | Debt items array populated in `refactor-plan-{{workflow_id}}.json`                |
| Debt items prioritized            | Artifact priority field           | Each item has priority: high\|medium\|low in `refactor-plan-{{workflow_id}}.json` |
| Effort estimates provided         | Artifact effort_hours field       | Each item has effort_hours field in `refactor-plan-{{workflow_id}}.json`          |
| Dependencies mapped               | Artifact dependencies field       | Dependencies array populated in `refactor-plan-{{workflow_id}}.json`              |
| Migration strategy defined        | Artifact migration_strategy field | Migration strategy object populated in `refactor-plan-{{workflow_id}}.json`       |
| Risk assessment complete          | Artifact risks field              | Risks array with probability and impact in `refactor-plan-{{workflow_id}}.json`   |
| Report validated                  | Schema validation                 | Validated against `.claude/schemas/refactoring-plan.schema.json`                  |

## Example Prompts

```
"Plan refactoring of the authentication module"
"Create a technical debt reduction plan"
"Plan migration from legacy code"
```

## Error Recovery

### Retry Strategy

- **Max Retries**: 3 attempts per step
- **Backoff**: Exponential (1s, 2s, 4s)
- **Retry Triggers**: Transient failures, timeouts, rate limits

### Rollback Procedures

1. **Partial Completion**: Save checkpoint to `.claude/context/runs/{{run_id}}/checkpoint.json`
2. **Failed Validation**: Return to previous passing gate
3. **Critical Failure**: Escalate to human with full context

### Fallback Options

- **Alternative Agent**: If primary agent fails 3x, route to backup agent
  - Refactoring-Specialist â†’ Developer (implementation fallback for refactoring analysis)
- **Manual Override**: User can force-proceed with documented risks
- **Graceful Degradation**: Create basic test outline instead of comprehensive refactoring plan (provide high-level debt inventory without detailed migration strategy)

### Recovery Artifacts

- Error log: `.claude/context/runs/{{run_id}}/errors.log`
- Recovery state: `.claude/context/runs/{{run_id}}/recovery-state.json`
- Checkpoint: `.claude/context/runs/{{run_id}}/checkpoint.json`

## Related Documentation

- [Refactoring Specialist Agent](../../agents/refactoring-specialist.md)
- [plan-generator Skill](../../skills/plan-generator/SKILL.md)
