# CUJ-028: Infrastructure-First Development

## User Goal
Define concrete infrastructure resources before implementation to prevent rework.

## Trigger
- "Build cloud-connected application"
- Greenfield project with cloud services
- Need for concrete resource names upfront

## Workflow

**Execution Mode**: `greenfield-fullstack.yaml`

### Step 4: System Architecture
- Architect creates logical architecture
- Identifies cloud services needed

### Step 4.5: Infrastructure Resource Definition (NEW)
- DevOps agent converts logical to concrete
- Generates resource names with unique suffixes
- Creates connection strings (with secret placeholders)
- Defines Secret Manager references
- Outputs infrastructure-config.json
- Security validation: no hardcoded secrets, all secrets use references, resource names have suffixes

### Step 5-7: Implementation with Concrete Resources
- Database Architect uses actual connection strings
- Developer uses concrete resource names
- Cloud-Integrator uses infrastructure-config.json

### Step 11: Infrastructure Provisioning
- GCP Cloud Agent provisions actual resources
- Uses infrastructure-config.json

## Agents Used
- Architect → DevOps (Step 4.5) → Database Architect → Developer → Cloud-Integrator → GCP Cloud Agent

## Skills Used
- Infrastructure-as-code generation
- Resource naming strategies
- Secret management

## Expected Outputs
- infrastructure-config.json (Step 4.5)
- terraform-plan.json (Step 4.5)
- deployment-config.json (Step 4.5)
- Code using concrete resource names (Step 7)

## Success Criteria
- ✅ Resource names defined before coding
- ✅ No rework needed when resources provisioned
- ✅ Connection strings use actual resource names
- ✅ Secrets properly referenced (never hardcoded)
- ✅ Infrastructure provisioned successfully
- ✅ Security validation passes

## Example Prompts
```
"Build a GCP application with storage and pubsub"
"Create cloud app with database and storage buckets"
```

## Error Recovery

### Retry Strategy
- **Max Retries**: 3 attempts per step
- **Backoff**: Exponential (1s, 2s, 4s)
- **Retry Triggers**: Transient failures, timeouts, rate limits

### Rollback Procedures
1. **Partial Completion**: Save checkpoint to `.claude/context/runs/{{run_id}}/checkpoint.json`
2. **Failed Validation**: Return to previous passing gate
3. **Critical Failure**: Escalate to human with full context

### Fallback Options
- **Alternative Agent**: If primary agent fails 3x, route to backup agent
  - DevOps → Architect (infrastructure design fallback)
  - GCP-Cloud-Agent → DevOps (provisioning fallback)
- **Manual Override**: User can force-proceed with documented risks
- **Graceful Degradation**: Use placeholder resource names (requires manual provisioning later)

### Recovery Artifacts
- Error log: `.claude/context/runs/{{run_id}}/errors.log`
- Recovery state: `.claude/context/runs/{{run_id}}/recovery-state.json`
- Checkpoint: `.claude/context/runs/{{run_id}}/checkpoint.json`
- Infrastructure config: `.claude/context/runs/{{run_id}}/infrastructure-config.json`

## Related Documentation
- [greenfield-fullstack Workflow](../../workflows/greenfield-fullstack.yaml) - Step 4.5
- [WORKFLOW-GUIDE.md](../../workflows/WORKFLOW-GUIDE.md) - Infrastructure-First Approach
- [DevOps Agent](../../agents/devops.md) - Infrastructure Resource Definition Process

