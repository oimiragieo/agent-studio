# CUJ-052: Artifact Registry Migration Test

## User Goal

Test migration from legacy artifact-registry.mjs to run-manager.mjs, ensuring backward compatibility and data integrity.

## Trigger

- "Test registry migration"
- "Validate run-manager migration"
- "Check registry consolidation"

## Workflow

**Execution Mode**: `workflow`

**Note**: Orchestrator must spawn Developer/QA agent to execute this skill.

### Step 0: Planning Phase

- Planner creates migration test plan
- Identifies test scenarios for registry migration
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Create Legacy Registry

- Create artifact using legacy `artifact-registry.mjs` functions
- Verify artifact registered in legacy path: `.claude/context/registry/<workflow_id>/artifacts.json`
- Check legacy registry structure

### Step 2: Migrate to Run Manager

- Use `run-manager.mjs` to read legacy registry
- Migrate artifacts to new path: `.claude/context/runs/<run_id>/artifact-registry.json`
- Verify all artifacts migrated correctly
- Check publishing metadata preserved

### Step 3: Validate Migration

- Compare artifact counts (legacy vs new)
- Verify all metadata fields preserved
- Check publishing status migrated correctly
- Validate artifact dependencies maintained

### Step 4: Test Backward Compatibility

- Verify legacy code can still read new registry format
- Test `enrichArtifactMetadata()` with new registry
- Check deprecation warnings appear correctly

### Step 5: Test Dual Write Period

- Write to both legacy and new registries during transition
- Verify consistency between both registries
- Test read from either registry works

## Agents Used

- Planner (migration planning)
- QA (migration validation)

## Skills Used

- `plan-generator` - Creating migration test plan
- `response-rater` - Plan quality validation

## Capabilities/Tools Used

- Legacy artifact registry: `artifact-registry.mjs` (deprecated)
- New artifact registry: `run-manager.mjs` (canonical)
- Registry migration utilities

## Expected Outputs

- Migration test plan: `plan-{{workflow_id}}.json`
- Legacy registry: `.claude/context/registry/<workflow_id>/artifacts.json`
- New registry: `.claude/context/runs/<run_id>/artifact-registry.json`
- Migration validation report: `migration-validation-report.json`
- Backward compatibility test results

## Success Criteria

| Criterion                     | Measurement                     | Target                                                                            |
| ----------------------------- | ------------------------------- | --------------------------------------------------------------------------------- |
| Plan rating                   | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded               | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`       |
| Legacy registry created       | Registry file exists            | Created at `.claude/context/registry/<workflow_id>/artifacts.json`                |
| Migration completed           | New registry exists             | All artifacts in `.claude/context/runs/<run_id>/artifact-registry.json`           |
| Artifact count matches        | Count comparison                | Legacy count equals new registry count                                            |
| Publishing metadata preserved | Metadata validation             | `publishable`, `published`, `published_at` fields migrated                        |
| Dependencies maintained       | Dependency validation           | All artifact dependencies preserved                                               |
| Backward compatibility        | Function testing                | `enrichArtifactMetadata()` works with new registry                                |
| Deprecation warnings          | Warning validation              | Legacy functions show deprecation notices                                         |

## Example Prompts

```
"Test artifact registry migration"
"Validate run-manager migration path"
"Check registry consolidation works"
```

## Related Documentation

- [Run Manager Tool](../../tools/run-manager.mjs)
- [Artifact Registry Tool](../../tools/artifact-registry.mjs) (deprecated)
- [Artifact Registry Schema](../../schemas/artifact-registry.schema.json)
