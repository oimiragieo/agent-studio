# CUJ-047: Multi-Agent Conflict Resolution

## User Goal

Test conflict detection and resolution when multiple agents produce conflicting outputs, ensuring conflicts are detected, escalated appropriately, and resolved through consensus or authority.

## Trigger

- "Test multi-agent conflict resolution"
- "Test conflict detection between agents"
- "Validate conflict resolution protocols"
- Agents produce conflicting requirements or decisions

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase

- Planner creates plan for conflict resolution testing
- **Mandatory**: Uses `conflict-resolution` skill if conflicts detected during coordination
- Identifies conflict scenarios to test
- Defines resolution protocols for each conflict type

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Create Conflicting Outputs

- **Scenario A: PM vs Architect Conflict**
  - PM creates PRD requesting technology X
  - Architect creates architecture specifying technology Y
  - Conflict: Incompatible technology choices
  - Expected: Architect has final authority on technical decisions

- **Scenario B: Analyst vs PM Conflict**
  - Analyst identifies feature priority A
  - PM creates PRD with feature priority B
  - Conflict: Conflicting feature priorities
  - Expected: PM has final authority on product decisions

- **Scenario C: Developer vs Architect Conflict**
  - Architect specifies implementation approach X
  - Developer suggests alternative approach Y
  - Conflict: Implementation approach disagreement
  - Expected: Developer implementation preference with architect approval

- **Scenario D: Multi-Agent Consensus Building**
  - Multiple agents (PM, Analyst, UX Expert) disagree on requirements
  - Conflict: Multi-domain disagreement
  - Expected: AI Council used for consensus building

### Step 2: Conflict Detection

- Orchestrator compares agent outputs
- Detects conflicts (direct contradictions, incompatible requirements)
- Assesses conflict severity (critical, high, medium, low)
- Documents conflicts in reasoning file

### Step 3: Conflict Resolution

- **Escalate to Resolution Agent**:
  - Technical conflicts → Architect
  - Requirements conflicts → PM
  - Design conflicts → UX Expert
  - Data conflicts → Database Architect
  - Multi-domain conflicts → AI Council
- **Consensus Building** (if needed):
  - Form AI Council with relevant agents
  - Conduct structured debate
  - Reach consensus
  - Document consensus decision

### Step 4: Apply Resolution

- Update affected artifacts based on resolution
- Notify all affected agents
- Update plan to reflect resolution
- Document resolution in reasoning file

### Step 5: Validation

- Verify conflicts resolved
- Check artifacts updated correctly
- Validate resolution documented
- Confirm workflow can continue

## Agents Used

- Planner (conflict resolution planning)
- Orchestrator (conflict detection and escalation)
- PM (requirements conflict resolution)
- Architect (technical conflict resolution)
- Analyst (market research conflict resolution)
- AI Council (multi-domain consensus building)

## Skills Used

- `conflict-resolution` - Multi-agent conflict resolution protocol
- `response-rater` - Plan quality validation

## Capabilities/Tools Used

- Consensus building (AI Council capability)
- Structured debate (AI Council capability)
- Conflict escalation
- Resolution documentation

## Expected Outputs

- Conflicting agent outputs
- Conflict detection report
- Resolution decisions
- Updated artifacts
- Resolution documentation

## Success Criteria

| Criterion             | Measurement                     | Target                                                                                    |
| --------------------- | ------------------------------- | ----------------------------------------------------------------------------------------- |
| Conflicts detected    | Conflict detection report       | Conflicts identified when comparing outputs                                               |
| Plan rating           | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded       | Rating file exists in run state | File present at `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`       |
| Conflict assessment   | Conflict severity analysis      | Type and severity correctly assessed                                                      |
| Conflicts escalated   | Resolution log                  | Escalated to appropriate resolution agent                                                 |
| Consensus built       | Consensus decision              | Successfully built when needed                                                            |
| Resolutions applied   | Updated artifacts               | Applied to affected artifacts                                                             |
| Agents notified       | Notification log                | All affected agents informed                                                              |
| Plan updated          | Plan artifact                   | Resolution reflected in plan                                                              |
| Resolution documented | Reasoning file                  | Resolution process documented                                                             |
| Workflow continues    | Gate validation                 | Workflow proceeds after resolution                                                        |

## Example Prompts

```
"Test PM vs Architect conflict resolution"
"Test multi-agent consensus building"
"Validate conflict detection protocols"
```

## Related Documentation

- [Orchestrator Agent](../../agents/orchestrator.md) - Conflict Detection and Resolution Protocol
- [Planner Agent](../../agents/planner.md) - Conflict Detection in Coordination
- [CUJ-039: Cross-Agent Validation](./CUJ-039.md)

## Conflict Test Scenarios

### Scenario 1: PM vs Architect Technical Conflict

- **PM Output**: PRD requests MongoDB for database
- **Architect Output**: Architecture specifies PostgreSQL
- **Conflict**: Incompatible database choices
- **Resolution**: Architect has final authority, proposes alternative that meets PM requirements
- **Expected**: Architecture updated, PM notified, PRD may be updated

### Scenario 2: Analyst vs PM Requirements Conflict

- **Analyst Output**: Market research suggests feature A is highest priority
- **PM Output**: PRD prioritizes feature B
- **Conflict**: Conflicting feature priorities
- **Resolution**: PM has final authority, considers market research in decision
- **Expected**: PRD reflects PM decision, market research considered

### Scenario 3: Developer vs Architect Implementation Conflict

- **Architect Output**: Architecture specifies microservices approach
- **Developer Output**: Suggests monolithic approach for simplicity
- **Conflict**: Implementation approach disagreement
- **Resolution**: Developer preference with architect approval, or architect decision
- **Expected**: Architecture may be updated, or developer implements as specified

### Scenario 4: Multi-Agent Consensus Building

- **PM Output**: Requests feature X
- **Analyst Output**: Market research suggests feature Y
- **UX Expert Output**: User research suggests feature Z
- **Conflict**: Multi-domain disagreement
- **Resolution**: AI Council forms, conducts debate, reaches consensus
- **Expected**: Consensus decision documented, all agents notified

### Scenario 5: Escalation Chain

- **Conflict**: Complex multi-domain conflict
- **Resolution**: Escalates through multiple agents
- **Final Authority**: AI Council makes final decision
- **Expected**: Resolution chain documented, final decision applied
