# CUJ-048: Artifact Registry Comprehensive Test

## User Goal
Test artifact registry robustness: corruption recovery, concurrent artifact registration, validation failures, missing registry recovery, and registry synchronization.

## Trigger
- "Test artifact registry robustness"
- "Test registry corruption recovery"
- "Validate registry synchronization"
- Registry corruption or synchronization issues detected

## Workflow

**Execution Mode**: `skill-only`

### Step 0: Planning Phase
- Planner creates plan for artifact registry testing
- Identifies test scenarios for registry robustness
- Defines validation criteria for each scenario

### Step 1: Normal Execution (Steps 1-2)
- Execute workflow steps 1-2 normally
- Create artifacts: `project-brief.json`, `prd.json`
- Register artifacts in registry
- Create gate files and reasoning files

### Step 2: Registry Corruption Simulation
- **Scenario A: Registry File Corrupted**
  - Corrupt registry JSON file (invalid JSON syntax)
  - Next step attempts to read registry
  - Expected: Registry corruption detected, recovery initiated

- **Scenario B: Registry File Missing**
  - Delete registry file
  - Next step attempts to read registry
  - Expected: Registry recreated from file system artifacts

- **Scenario C: Registry Out of Sync**
  - Artifact exists in file system but not in registry
  - Artifact exists in registry but not in file system
  - Expected: Registry synchronized with file system

### Step 3: Registry Integrity Validation
- **Check Registry File Exists**: Verify registry file exists
- **Validate JSON Structure**: Parse and verify registry JSON is valid
- **Verify Registry Matches File System**: Compare registry entries with actual files
- **Detect Discrepancies**: Identify files not in registry or registry entries without files
- **Log Validation Result**: Document validation outcome in reasoning file

### Step 4: Registry Corruption Recovery
- **Rebuild from File System**: Scan `.claude/context/artifacts/` directory
- **Reconstruct Registry**: Create registry entries from existing files
- **Validate Reconstructed Entries**: Check gate files for validation status
- **Update Registry**: Save reconstructed registry
- **Log Recovery**: Document recovery actions in reasoning file

### Step 5: Registry Synchronization
- **Check for Missing Artifacts**: Identify artifacts created but not registered
- **Check for Orphaned Entries**: Identify registry entries without corresponding files
- **Synchronize Registry**: Update registry to match file system state
- **Log Synchronization**: Document synchronization actions in reasoning file

### Step 6: Concurrent Registration Test
- **Simulate Concurrent Writes**: Multiple agents register artifacts simultaneously
- **Test Registry Locking**: Ensure no race conditions
- **Verify All Artifacts Registered**: Check all artifacts present in registry
- **Validate Registry Integrity**: Ensure registry remains valid after concurrent writes

### Step 7: Validation Failure Recovery
- **Artifact Validation Fails**: Create artifact that fails validation
- **Registry Status Update**: Update registry with validation status
- **Recovery Process**: Recreate artifact, re-validate, update registry
- **Verify Registry Updated**: Check registry reflects validation status

### Step 8: Continue Workflow
- Continue workflow from recovery point
- Use synchronized registry for artifact passing
- Complete remaining workflow steps
- Validate final outputs

## Agents Used
- Planner (registry testing planning)
- Orchestrator (registry integrity validation and recovery)
- [Other agents as specified in plan]

## Capabilities/Tools Used
- Registry integrity validation (orchestrator capability)
- Registry corruption recovery (orchestrator capability)
- Registry synchronization
- Concurrent access handling

## Expected Outputs
- Initial artifacts (project-brief.json, prd.json)
- Registry integrity validation reports
- Recovered registry files
- Synchronization reports
- Final workflow outputs

## Success Criteria
- [ ] Registry corruption detected correctly (artifact: corruption-detection.json)
- [ ] Registry corruption recovered successfully (artifact: registry-{id}.json, validated by gate file)
- [ ] Registry synchronized with file system (artifact: synchronization-report.json)
- [ ] Missing registry recreated from file system (artifact: registry-{id}.json)
- [ ] Concurrent registration handled correctly (artifact: concurrent-access-log.json)
- [ ] Validation failures reflected in registry (artifact: registry-{id}.json)
- [ ] Workflow continues seamlessly after recovery (validated by gate file)
- [ ] Registry integrity maintained throughout (artifact: integrity-validation-report.json)

## Example Prompts
```
"Test artifact registry corruption recovery"
"Test registry synchronization"
"Validate registry robustness"
```

## Related Documentation
- [Orchestrator Agent](../../agents/orchestrator.md) - Artifact Registry Management and Registry Integrity Validation
- [WORKFLOW-GUIDE.md](../../workflows/WORKFLOW-GUIDE.md) - Artifact Management
- [CUJ-045: Missing Required Artifact Recovery](./CUJ-045.md)

## Registry Test Scenarios

### Scenario 1: Registry File Corrupted
- **Action**: Corrupt registry JSON (invalid syntax)
- **Detection**: Registry integrity check fails
- **Recovery**: Rebuild registry from file system artifacts
- **Validation**: Registry restored, all artifacts registered

### Scenario 2: Registry File Missing
- **Action**: Delete registry file
- **Detection**: Registry file not found
- **Recovery**: Initialize new registry, scan file system for artifacts
- **Validation**: Registry recreated with all existing artifacts

### Scenario 3: Registry Out of Sync
- **Action**: Create artifact without registering, or delete artifact file
- **Detection**: Registry integrity check identifies discrepancies
- **Recovery**: Synchronize registry with file system state
- **Validation**: Registry matches file system, discrepancies resolved

### Scenario 4: Concurrent Registration
- **Action**: Multiple agents register artifacts simultaneously
- **Detection**: Registry handles concurrent writes
- **Recovery**: All artifacts registered correctly
- **Validation**: Registry integrity maintained, no data loss

### Scenario 5: Validation Status Mismatch
- **Action**: Artifact validation fails, registry not updated
- **Detection**: Registry shows incorrect validation status
- **Recovery**: Update registry with correct validation status
- **Validation**: Registry reflects actual validation state

