# CUJ-027: Workflow Recovery After Context Loss

## User Goal
Resume a workflow after context window exhaustion or session interruption.

## Trigger
- Context window exhausted mid-workflow
- Session interrupted
- Need to resume from last completed step

## Workflow

**Execution Mode**: `skill-only`

> **Note**: Skill-only CUJs execute directly without planning. If invoked via workflow, planning (Step 0) and rating (Step 0.1) occur first. Direct skill invocation skips planning and proceeds directly to recovery skill execution.
>
> This CUJ demonstrates the `recovery` skill as a shared primitive. All workflows should use this skill for recovery scenarios.

### Step 1: Recovery Initiation
- Orchestrator detects context loss or session interruption
- **Mandatory**: Uses `recovery` skill to identify last completed step

### Recovery Process (via `recovery` skill)
1. **Identify Last Completed Step** (recovery skill)
   - Check gate files for last successful validation
   - Review reasoning files for progress
   - Identify artifacts created

2. **Load Plan Documents** (recovery skill)
   - Read plan-{id}.json (stateless planner)
   - Load relevant phase plan if multi-phase
   - Understand current state from plan

3. **Context Recovery** (recovery skill)
   - Load artifacts from last completed step
   - Read reasoning files for context
   - Reconstruct workflow state

4. **Resume Execution** (recovery skill)
   - Continue from next step
   - Planner updates plan status (stateless)
   - Orchestrator coordinates next agents

## Agents Used
- Orchestrator (recovery) → Planner (stateless update) → [Resume agents]

## Skills Used
- `recovery` - Workflow recovery protocol for resuming after context loss

## Expected Outputs
- Updated plan-{id}.json (with current status)
- Continued workflow execution
- New artifacts from resumed steps

## Success Criteria
- [x] Workflow state recovered accurately
- [x] No duplicate work performed
- [x] Plan updated with current status
- [x] Workflow continues seamlessly
- [x] All context preserved
- [x] Recovery validation checklist completed

## Example Prompts
```
Context exhausted at Step 7 -> Resume from Step 8
Session lost at Step 4 -> Recover and continue from Step 5
```

## Related Documentation
- [Planner Agent](../../agents/planner.md) - Stateless Behavior Rule and Recovery Protocol
- [Orchestrator Agent](../../agents/orchestrator.md) - Context Recovery
- [PLANNER_CENTRIC_ARCHITECTURE.md](../../docs/PLANNER_CENTRIC_ARCHITECTURE.md)

