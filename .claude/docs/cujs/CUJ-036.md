# CUJ-036: Validation Failure Recovery

## User Goal
Test validation gate failures and retry logic to ensure the system handles validation errors gracefully and recovers automatically.

## Trigger
- "Test validation failure recovery"
- "Validate retry logic"
- "Test error recovery"

## Workflow

**Execution Mode**: `skill-only`

### Step 0: Planning Phase
- Planner creates plan for validation testing
- Includes scenarios for different validation failure types
- Defines retry strategy and max retry limits


### Step 0.1: Plan Rating Gate
- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Schema Validation Failure Test
- Agent creates output artifact
- Artifact fails schema validation (missing required field)
- System detects validation failure
- Gate file created with error details
- Agent receives error feedback
- Agent corrects output
- Re-validation succeeds

### Step 2: Invalid Data Type Test
- Agent creates output artifact
- Artifact fails validation (wrong data type)
- System detects validation failure
- Gate file created with specific error
- Agent receives type error feedback
- Agent corrects data type
- Re-validation succeeds

### Step 3: Missing Required Field Test
- Agent creates output artifact
- Artifact missing required field
- System detects validation failure
- Gate file lists missing fields
- Agent receives field list
- Agent adds missing fields
- Re-validation succeeds

### Step 4: Max Retry Enforcement Test
- Agent creates output artifact
- Artifact fails validation
- Agent attempts correction (retry 1)
- Validation still fails
- Agent attempts correction (retry 2)
- Validation still fails
- Agent attempts correction (retry 3)
- Validation still fails
- System enforces max retry limit (3)
- Workflow stops with error (does not retry again)

### Step 5: Recovery Validation
- Verify all retry attempts logged
- Confirm max retry limit enforced
- Validate error messages are clear
- Check gate files contain actionable feedback

## Agents Used
- Planner (planning)
- [Test agents that produce invalid outputs]
- QA (validation)

## Capabilities/Tools Used
- Schema validation (gate file validation)
- Error handling (workflow error recovery)
- Retry logic (workflow retry mechanism)

## Expected Outputs
- Test plan with validation scenarios
- Invalid artifacts (for testing)
- Gate files with error details
- Corrected artifacts (after retries)
- Retry attempt logs
- Recovery validation report

## Success Criteria
- ✅ Validation failures detected correctly
- [ ] Plan rating >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`)
- [ ] Rating recorded in run state (validation: rating file exists)
- ✅ Error feedback is clear and actionable
- ✅ Agents can correct outputs based on feedback
- ✅ Re-validation works after corrections
- ✅ Max retry limit (3) is enforced
- ✅ Workflow stops after max retries
- ✅ All retry attempts are logged
- ✅ Gate files contain detailed error information

## Example Prompts
```
"Test validation failure recovery with schema errors"
"Validate retry logic works correctly"
"Test max retry enforcement"
```

## Related Documentation
- [WORKFLOW-GUIDE.md](../../workflows/WORKFLOW-GUIDE.md) - Validation section
- [workflow_runner.js](../../tools/workflow_runner.js) - Validation implementation
- [Planner Agent](../../agents/planner.md) - Validation failure handling

## Test Scenarios

### Scenario 1: Missing Required Field
- Agent creates artifact without required field
- Validation fails with clear error
- Agent adds missing field
- Validation succeeds

### Scenario 2: Wrong Data Type
- Agent creates artifact with string instead of number
- Validation fails with type error
- Agent corrects data type
- Validation succeeds

### Scenario 3: Invalid Enum Value
- Agent creates artifact with invalid enum value
- Validation fails with allowed values list
- Agent uses valid enum value
- Validation succeeds

### Scenario 4: Max Retries Exceeded
- Agent creates artifact with multiple errors
- After 3 retry attempts, errors persist
- System stops workflow with error
- No 4th retry attempted

