# CUJ-043: Workflow Interruption Recovery

## User Goal
Test mid-workflow interruption and recovery to ensure no work is lost when workflows are interrupted mid-step, and the system can resume from checkpoints.

## Trigger
- "Test workflow interruption recovery"
- "Validate checkpoint protocol"
- "Test mid-step recovery"
- Workflow interrupted by user
- System crash or timeout
- Network interruption

## Workflow

**Execution Mode**: `skill-only`

### Step 0: Planning Phase
- Planner creates plan with checkpoint protocol
- Identifies long-running tasks requiring checkpoints
- Defines checkpoint intervals (every 5 minutes for long tasks)
- Specifies checkpoint artifact format

### Step 1: Normal Execution (Steps 1-2)
- Execute workflow steps 1-2 normally
- Create artifacts: `project-brief.json`, `prd.json`
- Create gate files and reasoning files
- No interruption

### Step 2: Long-Running Task Start
- Developer starts long-running implementation task
- Task expected to take >10 minutes
- Checkpoint protocol activated
- Initial checkpoint created

### Step 3: Mid-Step Interruption
- Workflow interrupted mid-step (user cancellation, system crash, timeout)
- Task partially complete
- Checkpoint artifacts exist
- Reasoning file partially written

### Step 4: Checkpoint Detection
- New orchestrator instance starts
- Detects incomplete task from checkpoint artifacts
- Reads checkpoint: `.claude/context/checkpoints/{{workflow_id}}/step-3-checkpoint.json`
- Reads partial reasoning: `.claude/context/history/reasoning/{{workflow_id}}/03-developer.json`
- Identifies what was completed before interruption

### Step 5: Resume from Checkpoint
- Load checkpoint state
- Identify completed work (files created, tests written, etc.)
- Identify remaining work
- Resume task from checkpoint
- Complete remaining work
- Finalize artifacts

### Step 6: Checkpoint Validation
- Verify no work was lost
- Verify all partial work preserved
- Verify resume was seamless
- Verify final artifacts complete

## Agents Used
- Planner (checkpoint protocol planning)
- Orchestrator (interruption detection and recovery)
- Developer (long-running task with checkpoints)
- QA (validation)

## Skills Used
- `recovery` - Workflow recovery protocol for checkpoint recovery
- State preservation
- Resume from checkpoint

## Expected Outputs
- Initial artifacts (project-brief.json, prd.json)
- Checkpoint artifacts: `.claude/context/checkpoints/{{workflow_id}}/step-3-checkpoint.json`
- Partial reasoning files
- Final artifacts after resume
- Recovery validation report

## Success Criteria
- [ ] Checkpoint protocol activated for long-running tasks (artifact: checkpoint-config.json)
- [ ] Checkpoints created every 5 minutes (artifact: checkpoint files)
- [ ] Interruption detected correctly (artifact: interruption-log.json)
- [ ] Checkpoint state loaded successfully (artifact: checkpoint-{step}.json)
- [ ] No work lost on interruption (validated by gate file)
- [ ] Resume from checkpoint seamless (artifact: resume-log.json)
- [ ] Final artifacts complete (artifact: final-artifacts.json)
- [ ] Recovery validation passes (validated by gate file)

## Example Prompts
```
"Test workflow interruption recovery"
"Validate checkpoint protocol for long-running tasks"
"Test mid-step recovery from checkpoint"
```

## Related Documentation
- [Planner Agent](../../agents/planner.md) - Checkpoint Protocol
- [Orchestrator Agent](../../agents/orchestrator.md) - Context Recovery
- [CUJ-027: Workflow Recovery After Context Loss](./CUJ-027.md)

## Checkpoint Protocol

### Checkpoint Creation
- **Interval**: Every 5 minutes for long-running tasks
- **Location**: `.claude/context/checkpoints/{{workflow_id}}/step-{{n}}-checkpoint.json`
- **Content**: Current task state, completed work, remaining work, file modifications
- **Format**: JSON with timestamp and state snapshot

### Checkpoint Structure
```json
{
  "workflow_id": "workflow-123",
  "step": 3,
  "agent": "developer",
  "checkpoint_timestamp": "2025-01-17T10:30:00Z",
  "task_status": "in_progress",
  "completed_work": {
    "files_created": ["src/components/Button.tsx", "src/components/Button.test.tsx"],
    "tests_written": 2,
    "lines_of_code": 150
  },
  "remaining_work": {
    "files_to_create": ["src/components/Modal.tsx"],
    "tests_to_write": 1,
    "estimated_time": "5 minutes"
  },
  "file_modifications": {
    "modified": ["src/components/index.ts"],
    "added": ["src/components/Button.tsx"]
  },
  "reasoning_snapshot": {
    "decisions_made": ["Used TypeScript for type safety", "Implemented accessibility features"],
    "open_questions": ["Should Modal support keyboard navigation?"]
  }
}
```

### Checkpoint Detection
- Check for checkpoint artifacts in checkpoint directory
- Compare checkpoint timestamp with current time
- Determine if task was interrupted
- Load checkpoint state if interruption detected

### Resume from Checkpoint
1. **Load Checkpoint**: Read checkpoint JSON file
2. **Verify State**: Check which files exist, which tests pass
3. **Resume Task**: Continue from checkpoint state
4. **Complete Work**: Finish remaining work
5. **Finalize**: Save final artifacts and reasoning

## Interruption Scenarios

### Scenario 1: User Cancellation
- User cancels workflow mid-step
- Checkpoint created before cancellation
- System detects cancellation
- Resume from checkpoint on next execution

### Scenario 2: System Crash
- System crashes during long-running task
- Last checkpoint preserved on disk
- System restarts
- Detect checkpoint and resume

### Scenario 3: Timeout
- Task exceeds timeout limit
- Checkpoint created before timeout
- System times out
- Resume from checkpoint on retry

### Scenario 4: Network Interruption
- Network connection lost during task
- Checkpoint created before interruption
- Connection restored
- Resume from checkpoint

## Recovery Validation

### Work Preservation
- Verify all files created before interruption exist
- Verify all tests written before interruption pass
- Verify no duplicate work performed
- Verify final artifacts complete

### State Consistency
- Verify checkpoint state matches actual file system
- Verify reasoning file reflects checkpoint state
- Verify no inconsistencies between checkpoint and reality
- Verify resume point correct

### Seamless Recovery
- Verify task continues naturally from checkpoint
- Verify no errors or warnings during resume
- Verify final output matches expected output
- Verify recovery transparent to user

## Test Scenarios

### Scenario 1: Mid-File Creation Interruption
- Developer creating large file
- File partially written (500/1000 lines)
- Interruption occurs
- Checkpoint saves file state
- Resume completes file creation

### Scenario 2: Mid-Test Writing Interruption
- Developer writing test suite
- 3/5 tests written
- Interruption occurs
- Checkpoint saves test state
- Resume completes test suite

### Scenario 3: Multi-File Task Interruption
- Developer creating multiple files
- 2/5 files created
- Interruption occurs
- Checkpoint saves file list
- Resume creates remaining files

### Scenario 4: Checkpoint Corruption Recovery
- Checkpoint file corrupted
- System detects corruption
- Fallback: Rebuild state from file system
- Verify state consistency
- Continue from rebuilt state

