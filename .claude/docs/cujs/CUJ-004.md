# CUJ-004: New Feature Planning

## User Goal
Create a comprehensive plan for implementing a new feature.

## Trigger
- "I want to build a user dashboard"
- "Plan feature X"
- "Create plan for [feature]"

## Workflow

**Execution Mode**: `workflow`

**Note**: Specialist coordination runs in parallel for faster planning. Planner coordinates with Analyst, PM, and Architect simultaneously, then aggregates results.

### Step 0: Planning Phase
- **Agent**: Planner
- **Input**: User requirements for new feature
- **Output**: Comprehensive feature plan (`plan-{workflow_id}.json`)
- **Validation**: Schema validation against `.claude/schemas/plan.schema.json`
- **Description**: Planner analyzes requirements, coordinates with specialists, creates structured plan for the new feature implementation.

### Step 0.1: Plan Rating Gate
- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Planning Initiation
- Planner agent activated
- Analyzes user requirements
- Determines planning scope

### Step 2: Specialist Coordination
- Planner coordinates with Analyst
- Analyst provides business context
- Planner coordinates with PM
- PM provides product requirements
- Planner coordinates with Architect
- Architect provides technical design

### Step 3: Plan Generation
- Planner synthesizes inputs
- Creates structured plan
- Defines steps, dependencies, risks
- Assigns agents to steps

### Step 4: Plan Validation
- Planner validates plan completeness
- Checks dependencies
- Verifies feasibility
- Generates plan artifacts

### Step 4.5: Publish Artifacts
- **Agent**: orchestrator
- **Skill**: artifact-publisher
- **Condition**: `validation_status == 'pass'`
- **Policy**: auto-on-pass
- **Inputs**: All validated artifacts from workflow (plan markdown, plan JSON, plan summary)
- **Outputs**: Published artifacts in project feed
- **Description**: Publish all validated planning artifacts to project feed for cross-platform visibility. Includes plan documents, dependency maps, risk assessments, and success criteria definitions.

## Agents Used
- Planner (orchestrates planning)
- Analyst (business requirements)
- PM (product requirements)
- Architect (technical design)

## Skills Used
- `plan-generator` - Creates structured plans
- `response-rater` - Plan quality validation

## Expected Outputs
- Plan markdown: `.claude/context/artifacts/plan-<id>.md`
- Plan JSON: `.claude/context/artifacts/plan-<id>.json`
- Plan summary

## Success Criteria

| Criterion | Measurement | Target |
|-----------|-------------|--------|
| Plan rating | response-rater skill score | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json` |
| Requirements addressed | Artifact validation | All requirements in `plan-{id}.json` validated by gate file |
| Dependencies mapped | Artifact dependencies field | Dependencies array populated in `plan-{id}.json` |
| Risks identified | Artifact risks field | Risks array populated in `plan-{id}.json` |
| Plan feasibility | Schema validation | Validated against `plan.schema.json` |
| Success criteria defined | Artifact success_criteria field | Success criteria defined in `plan-{id}.json` |

## Example Prompts
```
"I want to build a user dashboard with analytics"
"Plan the implementation of user authentication"
"Create a plan for adding payment processing"
```

## Error Recovery

### Retry Strategy
- **Max Retries**: 3 attempts per step
- **Backoff**: Exponential (1s, 2s, 4s)
- **Retry Triggers**: Transient failures, timeouts, rate limits

### Rollback Procedures
1. **Partial Completion**: Save checkpoint to `.claude/context/runs/{{run_id}}/checkpoint.json`
2. **Failed Validation**: Return to previous passing gate
3. **Critical Failure**: Escalate to human with full context

### Fallback Options
- **Alternative Agent**: If primary agent fails 3x, route to backup agent
  - Planner → Architect (technical planning fallback)
  - Analyst → PM (business context fallback)
- **Manual Override**: User can force-proceed with documented risks
- **Graceful Degradation**: Skip non-critical specialist inputs with warnings

### Recovery Artifacts
- Error log: `.claude/context/runs/{{run_id}}/errors.log`
- Recovery state: `.claude/context/runs/{{run_id}}/recovery-state.json`
- Checkpoint: `.claude/context/runs/{{run_id}}/checkpoint.json`

## Platform Compatibility

| Platform | Status | Notes |
|----------|--------|-------|
| **Claude** | ✅ Full Support | Primary platform with native workflow engine |
| **Cursor** | ✅ Full Support | Requires Cursor MCP integration; workflow engine support available |
| **Factory** | ⚠️ Partial | Requires manual adaptation; workflow engine may need custom integration |
| **OpenCode** | ❌ Not Tested | May work with adaptation of workflow engine |

**Notes**: This is a workflow-based CUJ that requires workflow engine support. Skill execution (`plan-generator`, `response-rater`) depends on skill availability on the target platform.

## Related Documentation
- [Planner Agent](../../agents/planner.md)
- [plan-generator Skill](../../skills/plan-generator/SKILL.md)
- [Plan Template](../../templates/plan-template.md)

