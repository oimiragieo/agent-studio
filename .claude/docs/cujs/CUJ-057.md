# CUJ-057: Plan Rating Validation

## User Goal
Validate that the response-rater skill correctly enforces the minimum 7/10 plan quality score.

## Trigger
- "Test plan rating"
- "Validate response-rater"
- "Check plan enforcement"
- "Test plan quality gates"

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase
- **Agent**: Planner
- **Input**: Test plan validation requirements
- **Output**: Test execution plan (`plan-{id}.json`)

### Step 0.1: Plan Rating Gate
- **Agent**: Orchestrator
- **Type**: Validation
- **Skill**: response-rater
- **Minimum Score**: 7/10
- **Rubric**: completeness, feasibility, risk mitigation, agent coverage, integration
- **Action if < 7**: Return to Planner with feedback, request improvements
- **Action if >= 7**: Proceed to execution

### Step 1: Create Test Plan
- **Agent**: Developer
- **Actions**: Generate plan with known quality level
- **Output**: Test plan artifact with varying quality levels

### Step 2: Rate Plan
- **Agent**: Orchestrator
- **Skill**: response-rater
- **Input**: Test plan from Step 1
- **Output**: Rating score (0-10), feedback, improvement suggestions

### Step 3: Verify Rating Enforcement
- **Agent**: QA
- **Validation**:
  - Score < 7 rejected
  - Score >= 7 approved
  - Rating recorded in registry
- **Output**: Validation report

## Agents Used
- Planner (creates test plans)
- Orchestrator (rates plans via response-rater)
- Developer (generates test artifacts)
- QA (validates rating enforcement)

## Skills Used
- `response-rater` - Plan quality evaluation
- `plan-generator` - Test plan creation

## Expected Outputs
- Test plan: `.claude/context/artifacts/test-plan-{id}.json`
- Rating artifact: `.claude/context/runs/{run_id}/plans/{plan_id}-rating.json`
- Validation report: `.claude/context/artifacts/rating-validation-{id}.json`

## Success Criteria

| Criterion | Measurement | Target |
|-----------|-------------|--------|
| response-rater invoked | Skill execution validation | Skill invoked correctly |
| Rating score captured | Rating artifact | Score on 0-10 scale captured |
| Low-quality plans rejected | Rating validation | Plans scoring < 7 rejected with feedback |
| High-quality plans approved | Rating validation | Plans scoring >= 7 approved for execution |
| Rating recorded | Rating file exists | Recorded in `.claude/context/runs/{run_id}/plans/{plan_id}-rating.json` |
| Feedback quality | Feedback content analysis | Includes specific improvement suggestions |
| Plan iteration supported | Iteration testing | Iteration works until score >= 7 achieved |

## Test Scenarios

### Scenario 1: Low-Quality Plan (Expected Score < 7)
```
1. Generate incomplete plan (missing risk mitigation)
2. Rate plan with response-rater
3. Verify score < 7
4. Confirm rejection with feedback
5. Improve plan based on feedback
6. Re-rate until score >= 7
```

### Scenario 2: High-Quality Plan (Expected Score >= 7)
```
1. Generate comprehensive plan (all rubric criteria met)
2. Rate plan with response-rater
3. Verify score >= 7
4. Confirm approval for execution
5. Verify rating recorded in registry
```

### Scenario 3: Iterative Improvement
```
1. Start with score 5/10 plan
2. Apply feedback from response-rater
3. Re-rate, achieve score 6/10
4. Apply more feedback
5. Re-rate, achieve score 8/10
6. Proceed to execution
```

## Example Prompts
```
"Test the plan rating enforcement"
"Validate that response-rater correctly scores plans"
"Create a low-quality plan and verify it's rejected"
"Test plan iteration until passing score achieved"
```

## Related Documentation
- [response-rater Skill](../../skills/response-rater/SKILL.md)
- [Plan Rating Enforcement](../../CLAUDE.md#1-plan-rating-enforcement)
- [Orchestrator Agent](../../agents/orchestrator.md)

## Related CUJs
- [CUJ-004: New Feature Planning](./CUJ-004.md) - Example of plan rating in basic workflows
- [CUJ-005: Greenfield Project Planning](./CUJ-005.md) - Comprehensive plan rating usage
- [CUJ-026: Multi-Phase Project Planning](./CUJ-026.md) - Complex multi-phase plan rating

## Rating Rubric Details

**Completeness (0-2 points)**:
- All requirements addressed
- Dependencies mapped
- Success criteria defined

**Feasibility (0-2 points)**:
- Plan is technically achievable
- Resources are available
- Timeline is realistic

**Risk Mitigation (0-2 points)**:
- Risks identified
- Mitigation strategies defined
- Contingency plans included

**Agent Coverage (0-2 points)**:
- Appropriate agents assigned
- Agent skills match tasks
- No missing expertise

**Integration (0-2 points)**:
- Dependencies between steps clear
- Workflow coherence
- Artifact flow defined

**Minimum Passing Score**: 7/10 (requires strong performance across all criteria)

## Error Recovery

### Retry Strategy
- **Max Retries**: 3 attempts per step
- **Backoff**: Exponential (1s, 2s, 4s)
- **Retry Triggers**: Transient failures, timeouts, rate limits

### Rollback Procedures
1. **Partial Completion**: Save checkpoint to `.claude/context/runs/{{run_id}}/checkpoint.json`
2. **Failed Validation**: Return to previous passing gate
3. **Critical Failure**: Escalate to human with full context

### Fallback Options
- **Alternative Agent**: If primary agent fails 3x, route to backup agent
  - Orchestrator → Planner (rating fallback)
  - QA → Orchestrator (validation fallback)
- **Manual Override**: User can force-proceed with documented risks (requires justification)
- **Graceful Degradation**: Accept lower quality plan with documented risks

### Recovery Artifacts
- Error log: `.claude/context/runs/{{run_id}}/errors.log`
- Recovery state: `.claude/context/runs/{{run_id}}/recovery-state.json`
- Checkpoint: `.claude/context/runs/{{run_id}}/checkpoint.json`
