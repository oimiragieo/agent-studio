# CUJ-046: Feature Distillation Edge Cases

## User Goal

Test feature distillation process with edge cases: very large documents, malformed markdown, missing critical information, multiple document formats, and validation failures.

## Trigger

- "Test feature distillation with large document" (>50KB)
- "Test feature distillation with malformed markdown"
- "Test feature distillation edge cases"
- User provides problematic requirements document

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase

- Planner creates plan for feature distillation edge case testing
- Identifies test scenarios for edge cases
- Defines validation criteria for each edge case

### Step 0.5: Feature Distillation (Edge Case Testing)

- Analyst agent processes edge case documents
- Tests various edge case scenarios:
  - **Very Large Documents** (>50KB): Test with 50KB, 100KB, 200KB documents
  - **Malformed Markdown**: Test with invalid markdown syntax, missing headers, broken lists
  - **Missing Critical Information**: Test with documents missing features, priorities, dependencies
  - **Multiple Document Formats**: Test with .md, .txt, .docx (if supported), mixed formats
  - **Validation Failures**: Test with documents that fail schema validation

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Edge Case Processing

- **Scenario A: Very Large Document** (>50KB)
  - Analyst reads large document
  - Distills to structured JSON
  - Validates all critical features preserved
  - Checks file size reduction
  - Verifies no information loss

- **Scenario B: Malformed Markdown**
  - Analyst reads malformed markdown
  - Attempts to extract features despite syntax errors
  - Handles missing headers gracefully
  - Recovers from broken list structures
  - Creates valid JSON output

- **Scenario C: Missing Critical Information**
  - Analyst processes document with missing features
  - Identifies missing information
  - Creates distilled JSON with placeholders or defaults
  - Documents missing information in metadata
  - Flags missing information for user attention

- **Scenario D: Multiple Document Formats**
  - Analyst processes different file formats
  - Converts formats to common structure
  - Extracts features consistently across formats
  - Creates unified JSON output

- **Scenario E: Validation Failures**
  - Analyst creates distilled JSON
  - Validation fails schema check
  - Analyst corrects JSON structure
  - Re-validates until passing
  - Documents correction process

### Step 2: Validation and Recovery

- Validate distilled features against schema
- Check for information loss
- Verify critical features preserved
- Test recovery from validation failures
- Document edge case handling

## Agents Used

- Planner (test planning)
- Analyst (feature distillation with edge cases)
- QA (validation testing)

## Capabilities/Tools Used

- Feature extraction and summarization (analyst capability)
- Structured data creation (analyst capability)
- Error handling and recovery
- Format conversion

## Expected Outputs

- `features-distilled.json` for each edge case scenario
- Edge case test report
- Validation results for each scenario
- Recovery documentation

## Success Criteria

| Criterion                      | Measurement                     | Target                                                                                    |
| ------------------------------ | ------------------------------- | ----------------------------------------------------------------------------------------- |
| Very large documents processed | Document processing validation  | >50KB documents successfully processed                                                    |
| Plan rating                    | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded                | Rating file exists in run state | File present at `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`       |
| Malformed markdown handled     | Markdown processing             | Gracefully processed despite syntax errors                                                |
| Missing information identified | Missing info report             | Missing information documented                                                            |
| Multiple formats processed     | Format processing report        | Consistent processing across formats                                                      |
| Validation failures recovered  | Recovery log                    | Successfully recovered from validation failures                                           |
| Critical features preserved    | Feature preservation report     | All critical features intact in all scenarios                                             |
| No information loss            | Gate validation                 | Critical details preserved                                                                |
| Edge case handling documented  | Edge case documentation         | All edge cases documented                                                                 |

## Example Prompts

```
"Test feature distillation with a 100KB requirements document"
"Test feature distillation with malformed markdown"
"Test feature distillation edge cases"
```

## Related Documentation

- [CUJ-025: Large Requirements Document Processing](./CUJ-025.md)
- [Analyst Agent](../../agents/analyst.md) - Feature Distillation section
- [Planner Agent](../../agents/planner.md) - Input Handling section

## Edge Case Test Scenarios

### Scenario 1: Very Large Document (100KB)

- Document size: 100KB markdown
- Expected: Distilled to <15KB JSON
- Validation: All features preserved, no information loss
- Performance: Processing completes in reasonable time

### Scenario 2: Malformed Markdown

- Document: Missing headers, broken lists, invalid syntax
- Expected: Features extracted despite syntax errors
- Validation: Valid JSON output created
- Recovery: Graceful handling of syntax errors

### Scenario 3: Missing Critical Information

- Document: Missing feature descriptions, priorities, dependencies
- Expected: Missing information identified and documented
- Validation: JSON includes placeholders or flags missing info
- Recovery: User notified of missing information

### Scenario 4: Multiple Document Formats

- Documents: .md, .txt, mixed formats
- Expected: Consistent feature extraction across formats
- Validation: Unified JSON structure regardless of input format
- Recovery: Format conversion handled gracefully

### Scenario 5: Validation Failures

- Document: Creates JSON that fails schema validation
- Expected: Validation errors identified and corrected
- Validation: JSON corrected and re-validated
- Recovery: Max retries respected, errors documented
