# CUJ-058: Error Recovery and Workflow Resilience Validation

## User Goal
Validate that workflows can recover from failures using retry logic, fallback agents, and checkpoint restoration.

## Trigger
User executes a workflow that encounters errors (timeout, network failure, agent unavailability, or validation failure).

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase
- Planner creates comprehensive error recovery test plan
- Analyzes failure scenarios and recovery paths
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`

### Step 0.1: Plan Rating Gate
**Agent**: orchestrator
**Skill**: response-rater
**Validation**:
- Minimum score: 7/10
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to planner with feedback (max 3 attempts)
- If score >= 7: Proceed to Step 1
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Simulate Workflow Failure
- Execute workflow with error injection (e.g., timeout, network error, rate limit)
- Verify workflow detects the failure type
- Confirm failure is logged in checkpoint directory

### Step 2: Retry with Backoff Strategy
- Verify workflow automatically retries failed step
- Confirm exponential backoff strategy is applied (initial_delay_ms: 1000)
- Check max_attempts limit (default: 3) is respected
- Validate retryable_errors list is honored (timeout, network_error, rate_limit)

### Step 3: Fallback Agent Activation
- Trigger scenario where primary agent fails or is unavailable
- Verify fallback agent is activated from fallback_agents configuration
- Confirm fallback agent completes the task
- Log fallback activation in workflow history

### Step 4: Checkpoint Restoration
- Simulate workflow interruption mid-execution
- Verify checkpoint was saved to `.claude/context/runs/{{run_id}}/checkpoints`
- Resume workflow from checkpoint
- Confirm workflow continues from last successful step

### Step 5: Error Recovery Validation
- Review recovery logs in `.claude/context/runs/{{run_id}}/recovery.json`
- Verify all retry attempts and fallback activations are documented
- Confirm workflow either succeeds or fails gracefully after max retries
- Validate error messages are actionable

## Agents Used
- **orchestrator**: Coordinates workflow execution and error recovery
- **developer**: Primary agent (may fail, triggering fallback)
- **code-reviewer**: Fallback agent for developer
- **qa**: Fallback agent for developer and code-reviewer

## Skills Used
- **recovery**: Handles checkpoint creation and restoration
- **conflict-resolution**: Resolves agent conflicts during fallback
- **optional-artifact-handler**: Handles missing optional inputs gracefully

## Expected Outputs
- `.claude/context/runs/{{run_id}}/checkpoints/step-{{n}}-checkpoint.json`: Checkpoint files for each step
- `.claude/context/runs/{{run_id}}/recovery.json`: Recovery log with retry attempts and fallback activations
- `.claude/context/runs/{{run_id}}/workflow-state.json`: Updated workflow state after recovery

## Success Criteria
- ✅ Workflow detects retryable errors correctly
- ✅ Retry logic respects max_attempts and backoff_strategy
- ✅ Fallback agents activate when primary agent fails
- ✅ Checkpoints created at configured intervals
- ✅ Workflow resumes from checkpoint after interruption
- ✅ Recovery logs complete and actionable
- ✅ Non-retryable errors fail gracefully with clear messages

## Error Recovery Configuration (All Workflows)

All 14 workflows now include error recovery configuration:

```yaml
recovery:
  enabled: true
  checkpoint_dir: ".claude/context/runs/{{run_id}}/checkpoints"

retry_config:
  max_attempts: 3
  backoff_strategy: exponential
  initial_delay_ms: 1000
  retryable_errors: [timeout, network_error, rate_limit]

fallback_agents:
  developer: [code-reviewer, qa]
  architect: [developer, security-architect]
  qa: [developer, code-reviewer]
  planner: [architect, pm]
  # ... workflow-specific fallback mappings
```

## Test Scenarios

### Scenario 1: Timeout Recovery
```
1. Start greenfield-fullstack workflow
2. Inject timeout error at Step 7 (Implementation)
3. Verify retry attempt #1 (delay: 1000ms)
4. Inject timeout error again
5. Verify retry attempt #2 (delay: 2000ms)
6. Allow retry #3 to succeed
7. Confirm workflow continues to Step 8
```

### Scenario 2: Fallback Agent Activation
```
1. Start code-quality-flow workflow
2. Simulate developer agent unavailable at Step 3
3. Verify fallback to code-reviewer agent
4. Confirm code-reviewer completes implementation
5. Workflow continues to Step 3.5 (Post-Refactoring Code Review)
```

### Scenario 3: Checkpoint Restoration
```
1. Start enterprise-track workflow
2. Complete Steps 0-5 successfully
3. Simulate system crash during Step 6
4. Verify checkpoint saved for Steps 0-5
5. Resume workflow using checkpoint
6. Confirm workflow resumes at Step 6
7. Complete workflow successfully
```

### Scenario 4: Non-Retryable Error Graceful Failure
```
1. Start quick-flow workflow
2. Inject validation_error (non-retryable) at Step 1
3. Verify workflow does NOT retry
4. Confirm workflow fails gracefully with actionable error message
5. Check recovery.json documents the failure reason
```

## Example Prompts
```
# Test error recovery
"Start greenfield workflow and simulate network errors during implementation"

# Test fallback agents
"Execute code-quality workflow with developer agent unavailable"

# Test checkpoint restoration
"Resume enterprise workflow from checkpoint after system crash"

# Validate recovery logs
"Show me the recovery logs for run-id workflow-123"
```

## Related Documentation
- [WORKFLOW-GUIDE.md](../../workflows/WORKFLOW-GUIDE.md)
- [recovery skill](../../skills/recovery/SKILL.md)
- [conflict-resolution skill](../../skills/conflict-resolution/SKILL.md)
- [All workflow YAML files](../../workflows/)

## Workflows Updated with Error Recovery

1. ✅ code-quality-flow.yaml
2. ✅ greenfield-fullstack.yaml
3. ✅ quick-flow.yaml
4. ✅ ai-system-flow.yaml
5. ✅ mobile-flow.yaml
6. ✅ incident-flow.yaml
7. ✅ ui-perfection-loop.yaml
8. ✅ browser-testing-flow.yaml
9. ✅ brownfield-fullstack.yaml
10. ✅ automated-enterprise-flow.yaml
11. ✅ bmad-greenfield-standard.yaml
12. ✅ performance-flow.yaml
13. ✅ legacy-modernization-flow.yaml
14. ✅ enterprise-track.yaml

## Implementation Notes

### Retry Logic
- **max_attempts**: 3 retries before failing or activating fallback
- **backoff_strategy**: exponential (1s, 2s, 4s)
- **retryable_errors**: timeout, network_error, rate_limit only

### Fallback Agents
- Each agent has 1-2 fallback agents configured
- Fallback agents are selected based on domain expertise
- Example: developer → [code-reviewer, qa]

### Checkpoint Strategy
- Checkpoints created after each successful step
- Checkpoint location: `.claude/context/runs/{{run_id}}/checkpoints/`
- Checkpoint format: JSON with step number, timestamp, artifacts, and state

### Recovery Priority
1. **Retry**: Attempt retry with backoff (up to max_attempts)
2. **Fallback**: Activate fallback agent if retries exhausted
3. **Checkpoint**: Restore from checkpoint if workflow interrupted
4. **Fail Gracefully**: Document failure and provide actionable error message
