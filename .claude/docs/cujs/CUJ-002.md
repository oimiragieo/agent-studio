# CUJ-002: Rule Configuration

## User Goal
Auto-detect project tech stack and configure appropriate rules.

## Trigger
- `/select-rules` command
- "Select rules for this project"
- "Configure rules for my stack"

## Workflow

**Execution Mode**: `skill-only`

### Step 1: Stack Detection
- rule-selector skill scans project files
- Detects: package.json, requirements.txt, go.mod, etc.
- Identifies technologies: React, Next.js, TypeScript, Python, etc.
- **Empty Directory Handling**: If no config files detected, prompts user to describe intended stack (e.g., "React with Python backend")

### Step 2: Load Rule Index (with Fallback)
- Attempts to load `.claude/context/rule-index.json` (pre-built index ships with repo)
- **Fallback Strategy**: If index missing:
  1. Attempts to load pre-built index (should exist)
  2. If missing: Falls back to direct directory scan of `.claude/rules-master/` and `.claude/rules-library/`
  3. Builds temporary index in memory
  4. Never fails - always provides rule recommendations

**Directory Structure**:
- `.claude/rules-master/` - Core, high-priority rule files (8 master rules)
- `.claude/rules-library/` - Technology-specific rule files (1,073+ rules). This directory exists and contains all rule files referenced by the rule index.

### Step 3: Rule Selection
- Queries rule index (or temporary index from fallback) for matching rules
- Selects relevant rule packs based on detected technologies
- Excludes irrelevant rules

### Step 4: Configuration Generation
- Generates/updates `manifest.yaml`
- Configures active rules
- Sets up rule hierarchy

### Step 5: Validation
- Validates rule configuration
- Checks for conflicts
- Reports selected rules

## Agents Used
- None (skill-based)

## Skills Used
- `rule-selector` - Auto-detects stack and configures rules

## Expected Outputs
- Updated `manifest.yaml` with selected rules
- Rule configuration report
- List of active rules

## Success Criteria
- [ ] Tech stack correctly identified (or user description parsed if empty directory)
- [ ] Rule index loaded (pre-built or via fallback directory scan)
- [ ] Relevant rules selected
- [ ] Irrelevant rules excluded
- [ ] Configuration valid
- [ ] Works out-of-the-box without requiring `pnpm index-rules`

## Example Prompts
```
/select-rules
"Select rules for this Next.js TypeScript project"
"Configure rules for my Python FastAPI project"
```

## Related Documentation
- [rule-selector Skill](../../skills/rule-selector/SKILL.md)
- [Rules Documentation](../../rules/)

