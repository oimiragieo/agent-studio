# CUJ-040: Stateless Recovery Test

## User Goal
Verify the system can recover from scratch without any conversation history, ensuring all agents read from file system state rather than relying on memory or chat history.

## Trigger
- "Test stateless recovery"
- "Verify file-based recovery"
- "Test recovery from scratch"
- Context window exhausted and new session started
- Session interrupted and resumed

## Workflow

**Execution Mode**: `skill-only`

### Step 0: Planning Phase
- Planner creates plan for stateless recovery test
- Defines test scenarios for complete recovery
- Identifies validation checkpoints

### Step 1: Initial Workflow Execution
- Execute workflow steps 1-3 normally
- Create artifacts: `project-brief.json`, `prd.json`, `system-architecture.json`
- Create plan: `plan-{{workflow_id}}.json`
- Create gate files for validation
- Create reasoning files

### Step 2: Simulate Context Loss
- Simulate context window exhaustion or session interruption
- No conversation history available
- Only file system state exists

### Step 3: Stateless Recovery
- New orchestrator instance starts with fresh context
- **CRITICAL**: Must read from file system only:
  - Read `plan-{{workflow_id}}.json` from file system
  - Check gate files in `.claude/context/history/gates/{{workflow_id}}/`
  - Review reasoning files in `.claude/context/history/reasoning/{{workflow_id}}/`
  - List artifacts in `.claude/context/artifacts/`
- **Validation**: Verify no references to "previous conversation" or "earlier in this chat"
- Compare plan status with actual file system state
- Identify last completed step from gate files

### Step 4: Plan Status Update (Stateless)
- Planner reads `plan-{{workflow_id}}.json` from file system
- Checks gate files to determine actual completion status
- Updates plan JSON with current state from file system
- **Validation**: Plan update based on file system, not assumptions
- Save updated plan document

### Step 5: Resume Execution
- Continue from next incomplete step
- Verify all dependencies for that step are satisfied
- Execute remaining workflow steps
- Validate recovery was seamless

### Step 6: Stateless Behavior Validation
- Verify all agents read from files, not memory
- Check reasoning files for file read timestamps
- Confirm no conversation history references
- Validate plan updates reflect actual file system state

## Agents Used
- Orchestrator (recovery coordination)
- Planner (stateless plan update)
- [Other agents as specified in plan]

## Skills Used
- `recovery` - Workflow recovery protocol for stateless recovery
- Stateless behavior validation

## Expected Outputs
- Initial workflow artifacts (project-brief.json, prd.json, etc.)
- Plan document: `plan-{{workflow_id}}.json`
- Gate files for each completed step
- Reasoning files documenting stateless behavior
- Updated plan document after recovery
- Recovery validation report

## Success Criteria
- [ ] System recovers from file system state only (validated by gate file)
- [ ] No references to "previous conversation" in agent outputs (artifact: reasoning files)
- [ ] Plan document read from file system (not memory) (artifact: plan-{id}.json, reasoning files)
- [ ] Gate files checked to determine actual completion status (artifact: gate files)
- [ ] Plan updates reflect actual file system state (artifact: plan-{id}.json)
- [ ] Workflow continues seamlessly after recovery (validated by gate file)
- [ ] All stateless behavior validation checkpoints pass (artifact: validation-report.json)
- [ ] File read timestamps logged in reasoning files (artifact: reasoning-{step}.json)

## Example Prompts
```
"Test stateless recovery from scratch"
"Verify file-based recovery works correctly"
"Test recovery after context loss"
```

## Related Documentation
- [Planner Agent](../../agents/planner.md) - Stateless Behavior Rule and Recovery Protocol
- [Orchestrator Agent](../../agents/orchestrator.md) - Context Recovery
- [CUJ-027: Workflow Recovery After Context Loss](./CUJ-027.md)

## Stateless Behavior Validation Checklist

### File System State Check
- [ ] Plan document (`plan-{{workflow_id}}.json`) read from file system
- [ ] Gate files checked in `.claude/context/history/gates/{{workflow_id}}/`
- [ ] Reasoning files reviewed in `.claude/context/history/reasoning/{{workflow_id}}/`
- [ ] Artifacts listed from `.claude/context/artifacts/`
- [ ] File modification times verified

### Stateless Behavior Verification
- [ ] No references to "previous conversation"
- [ ] No references to "earlier in this chat"
- [ ] No assumptions based on conversation history
- [ ] All state derived from file system
- [ ] File read timestamps logged

### Plan Update Validation
- [ ] Plan status compared with actual file system state
- [ ] Task completion verified via gate files
- [ ] Plan updated based on actual state (not assumptions)
- [ ] Updated plan saved to file system

### Recovery Validation
- [ ] Last completed step identified correctly
- [ ] Next incomplete step identified
- [ ] Dependencies verified for next step
- [ ] Workflow resumes from correct point
- [ ] No duplicate work performed

## Test Scenarios

### Scenario 1: Complete Context Loss
- Workflow executed through step 3
- Context window exhausted
- New session starts with no conversation history
- System recovers using only file system state
- Workflow continues from step 4

### Scenario 2: Session Interruption
- Workflow executed through step 5
- Session interrupted (user closes application)
- New session starts
- System recovers using file system state
- Workflow continues from step 6

### Scenario 3: Stateless Plan Update
- Plan document exists with status "in_progress"
- Planner reads plan from file system
- Checks gate files to determine actual status
- Updates plan based on actual file system state
- No conversation history used

### Scenario 4: Multi-Phase Recovery
- Multi-phase project in progress
- Phase 1 complete, Phase 2 in progress
- Context lost mid-Phase 2
- System recovers by reading master plan and phase plan
- Continues Phase 2 from last completed task

