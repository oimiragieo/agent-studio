# CUJ-063: Error Recovery and Checkpoint Restoration

## Overview

| Attribute | Value |
|-----------|-------|
| **ID** | CUJ-063 |
| **Title** | Error Recovery and Checkpoint Restoration |
| **Category** | Testing & Validation |
| **Execution Mode** | `workflow` |
| **Workflow** | `recovery-test-flow.yaml` |
| **Complexity** | Complex |
| **Priority** | High |
| **Status** | Active |

## Description

Tests the error recovery mechanisms to ensure workflows can recover from failures gracefully. Validates:

- **Checkpoint Creation**: Automatic checkpoint creation after major phases
- **Checkpoint Restoration**: State recovery from saved checkpoints
- **Fallback Agent Routing**: Automatic routing to fallback agents on failure
- **State Preservation**: Context and artifact preservation across recovery
- **Recovery Documentation**: Comprehensive logging of recovery events

## Preconditions

- Existing run with checkpoint support (e.g., `greenfield-fullstack.yaml`)
- Fallback agent configuration loaded (`.claude/config/fallback-agents.json`)
- Recovery tools available (`.claude/tools/fallback-router.mjs`)
- Checkpoint schema validated (`.claude/schemas/checkpoint.schema.json`)

## Success Criteria

### Mandatory

- [ ] Checkpoint created after each major phase (planning, design, implementation)
- [ ] Checkpoint file conforms to `checkpoint.schema.json`
- [ ] Checkpoint can be restored successfully with state intact
- [ ] Fallback agent receives task when primary agent fails
- [ ] Task context preserved across fallback routing
- [ ] Recovery events logged to `.claude/context/logs/recovery.log`
- [ ] All artifacts from checkpoint restored correctly

### Optional

- [ ] Checkpoint expiration handled correctly
- [ ] Multiple fallback levels tested (primary -> fallback1 -> fallback2)
- [ ] Escalation strategy triggered when all fallbacks exhausted
- [ ] Performance metrics collected for checkpoint/restore operations

## Test Scenarios

### Scenario 1: Checkpoint Creation and Validation

**Steps**:

1. Start `greenfield-fullstack` workflow
2. Complete Phase 1 (Planning) - Steps 0-1
3. Verify checkpoint created at `.claude/context/runs/<run_id>/checkpoints/checkpoint-phase-1.json`
4. Validate checkpoint against `checkpoint.schema.json`
5. Verify checkpoint contains:
   - All completed steps
   - All artifacts created
   - State snapshot
   - Recovery instructions

**Expected Result**:
- Checkpoint file exists and validates
- Contains accurate state representation
- Includes all required fields from schema

---

### Scenario 2: Checkpoint Restoration

**Steps**:

1. Start workflow and complete Phase 1-3
2. Create checkpoint at Step 3.5 (after design phase)
3. Simulate failure at Step 4 (implementation start)
4. Run restoration from Phase 3 checkpoint:
   ```bash
   node .claude/tools/restore-checkpoint.mjs \
     --checkpoint .claude/context/runs/run-001/checkpoints/checkpoint-phase-3.json \
     --run-id run-001
   ```
5. Verify state matches checkpoint:
   - Completed steps: [0, 1, 2, 3]
   - Artifacts restored to correct locations
   - Validation gates passed
6. Continue execution from Step 4
7. Verify workflow completes successfully

**Expected Result**:
- State restored exactly as checkpointed
- No data loss or corruption
- Workflow continues seamlessly from checkpoint

---

### Scenario 3: Fallback Agent Routing

**Steps**:

1. Assign implementation task to `developer` agent
2. Simulate agent failure (e.g., timeout, validation failure)
3. Run fallback router:
   ```bash
   node .claude/tools/fallback-router.mjs \
     --task task.json \
     --failed-agent developer \
     --error "Agent timeout after 120s"
   ```
4. Verify routing to `refactoring-specialist` (first fallback for developer)
5. Verify task context preserved:
   - Original task description
   - Input artifacts
   - Fallback history
6. Verify fallback agent completes task successfully
7. Check recovery log for fallback event

**Expected Result**:
- Task routed to correct fallback agent
- Context preserved across routing
- Recovery logged with timestamp and reason

---

### Scenario 4: Multi-Level Fallback

**Steps**:

1. Assign task to `developer` agent
2. Simulate first failure -> routes to `refactoring-specialist`
3. Simulate second failure -> routes to `code-simplifier` (second fallback)
4. Verify fallback attempt tracking:
   ```json
   {
     "fallbackAttempt": 2,
     "fallbackHistory": [
       { "agent": "developer", "error": "...", "timestamp": "..." },
       { "agent": "refactoring-specialist", "error": "...", "timestamp": "..." }
     ]
   }
   ```
5. Verify max attempts respected (default: 2)
6. If third failure, verify escalation to orchestrator

**Expected Result**:
- All fallback levels attempted in order
- Max attempts enforced
- Escalation triggered when exhausted

---

### Scenario 5: Full Recovery Flow (End-to-End)

**Steps**:

1. Start `greenfield-fullstack` workflow
2. Create checkpoints at:
   - Step 0.5 (after planning)
   - Step 2.5 (after design)
   - Step 5.5 (after implementation)
3. Simulate catastrophic failure at Step 6 (testing phase)
4. Run recovery from latest checkpoint (Step 5.5):
   ```bash
   node .claude/tools/restore-checkpoint.mjs \
     --checkpoint .claude/context/runs/run-001/checkpoints/checkpoint-phase-5.json \
     --run-id run-001 \
     --continue
   ```
5. Verify all artifacts restored:
   - Plan, architecture, dev-manifest, etc.
6. Verify validation gates re-passed
7. Complete remaining steps (6-8)
8. Verify final deliverables match expected output

**Expected Result**:
- Complete recovery from checkpoint
- All artifacts intact and validated
- Workflow completes successfully
- No duplicate work or data loss

---

## Validation Gates

### Checkpoint Validation

```bash
node .claude/tools/gate.mjs \
  --schema .claude/schemas/checkpoint.schema.json \
  --input .claude/context/runs/run-001/checkpoints/checkpoint-phase-3.json \
  --gate .claude/context/history/gates/run-001/checkpoint-phase-3-gate.json
```

### Fallback Configuration Validation

```bash
node .claude/tools/fallback-router.mjs --validate
```

### Recovery Log Validation

Verify recovery events logged:
```json
{
  "timestamp": "2026-01-06T10:30:00Z",
  "event": "checkpoint_created",
  "checkpoint_id": "checkpoint-phase-3",
  "run_id": "run-001",
  "step": 3.5
}
```

## Dependencies

### Tools

- `.claude/tools/fallback-router.mjs` - Fallback agent routing
- `.claude/tools/restore-checkpoint.mjs` - Checkpoint restoration (to be created)
- `.claude/tools/gate.mjs` - Schema validation

### Schemas

- `.claude/schemas/checkpoint.schema.json` - Checkpoint structure validation
- `.claude/schemas/fallback-agents.schema.json` - Fallback config validation

### Configuration

- `.claude/config/fallback-agents.json` - Fallback agent mappings

### Workflows

- `recovery-test-flow.yaml` - Dedicated recovery testing workflow

## Recovery Metrics

Track these metrics during testing:

| Metric | Target | Actual |
|--------|--------|--------|
| Checkpoint creation time | < 500ms | |
| Checkpoint file size | < 100KB | |
| Restoration time | < 2s | |
| State accuracy | 100% | |
| Fallback routing time | < 100ms | |
| Context preservation | 100% | |

## Error Handling

### Checkpoint Creation Failures

- Log error but continue workflow
- Mark checkpoint as `failed` in metadata
- Notify orchestrator for manual review

### Restoration Failures

- Validate checkpoint integrity first
- If corrupted, try previous checkpoint
- If all checkpoints invalid, escalate to manual recovery

### Fallback Routing Failures

- Log failure reason
- Attempt next fallback in chain
- If all fallbacks exhausted, escalate per `escalation_strategy`

## Post-Test Validation

After completing all scenarios:

1. **Review recovery logs**: Ensure all events logged
2. **Validate artifact integrity**: Check all artifacts match expected checksums
3. **Performance analysis**: Review checkpoint/restore performance metrics
4. **Documentation update**: Update recovery playbook based on findings

## Related CUJs

- **CUJ-001**: Greenfield Development (base workflow for testing)
- **CUJ-015**: Validation Gate Testing (checkpoint validation)
- **CUJ-050**: Workflow Execution (baseline workflow testing)

## Notes

- Checkpoints should be created automatically by orchestrator
- Manual checkpoint creation available via `create-checkpoint.mjs` tool
- Checkpoint expiration defaults to 7 days
- Recovery events trigger notifications if `notify_on_fallback: true`

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2026-01-06 | Initial CUJ creation |
