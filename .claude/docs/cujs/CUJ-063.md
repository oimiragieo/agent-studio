# CUJ-063: Error Recovery and Checkpoint Restoration

## User Goal

Tests the error recovery mechanisms to ensure workflows can recover from failures gracefully.

## Trigger

- "Test error recovery mechanisms"
- "Validate checkpoint restoration"
- "Test workflow resilience"

## Workflow

**Execution Mode**: workflow
**Workflow File**: `.claude/workflows/recovery-test-flow.yaml`

### Step 0: Planning Phase

- Planner creates comprehensive recovery test plan
- Analyzes checkpoint scenarios and recovery paths
- Identifies fallback strategies
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`

### Step 0.1: Plan Rating Gate

**Agent**: orchestrator
**Skill**: response-rater
**Validation**:

- Minimum score: 7/10
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to planner with feedback (max 3 attempts)
- If score >= 7: Proceed to Step 1
- Records rating in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Checkpoint Creation Test

- QA agent validates checkpoint creation after major phases
- Verifies checkpoint file conforms to `checkpoint.schema.json`
- Creates checkpoints at Phase 1, Phase 3, Phase 5 boundaries
- Outputs: Checkpoint files in `.claude/context/runtime/runs/<run_id>/checkpoints/`

### Step 2: Checkpoint Restoration Test

- QA agent simulates failure scenario
- Restores from saved checkpoint
- Verifies state integrity and artifact preservation
- Outputs: Restoration validation report

### Step 3: Fallback Agent Routing Test

- QA agent triggers primary agent failure
- Validates fallback routing to appropriate agent
- Verifies context preservation across routing
- Outputs: Fallback routing log

### Step 4: Recovery Documentation

- Technical Writer documents recovery events
- Logs all recovery operations
- Creates recovery playbook
- Outputs: Recovery documentation in `.claude/context/logs/recovery.log`

## Agents Used

- Planner → QA → Technical Writer

## Skills Used

- `response-rater` - Plan quality validation
- `recovery` - Checkpoint restoration and workflow recovery

## Expected Outputs

- Checkpoint files (`.claude/context/runtime/runs/<run_id>/checkpoints/checkpoint-phase-*.json`)
- Restoration validation report
- Fallback routing log
- Recovery documentation (`.claude/context/logs/recovery.log`)
- Recovery playbook

## Success Criteria

- [ ] Plan created and rated: `plan-{{workflow_id}}.json` validated with response-rater score >= 7/10
- [ ] Plan rating recorded: Rating file exists at `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`
- [ ] Checkpoint created after each major phase: Files exist at `.claude/context/runtime/runs/<run_id>/checkpoints/checkpoint-phase-{1,3,5}.json`
- [ ] Checkpoint validates against schema: All checkpoint files conform to `.claude/schemas/checkpoint.schema.json`
- [ ] Checkpoint restoration successful: State restored from checkpoint with 100% accuracy
- [ ] Fallback agent receives task: Task context preserved when primary agent fails
- [ ] Recovery events logged: All recovery operations logged to `.claude/context/logs/recovery.log`
- [ ] Artifacts restored: All artifacts from checkpoint restored correctly

## Test Scenarios

### Scenario 1: Checkpoint Creation and Validation

**Steps**:

1. Start `greenfield-fullstack` workflow
2. Complete Phase 1 (Planning) - Steps 0-1
3. Verify checkpoint created at `.claude/context/runtime/runs/<run_id>/checkpoints/checkpoint-phase-1.json`
4. Validate checkpoint against `checkpoint.schema.json`
5. Verify checkpoint contains:
   - All completed steps
   - All artifacts created
   - State snapshot
   - Recovery instructions

**Expected Result**:

- Checkpoint file exists and validates
- Contains accurate state representation
- Includes all required fields from schema

---

### Scenario 2: Checkpoint Restoration

**Steps**:

1. Start workflow and complete Phase 1-3
2. Create checkpoint at Step 3.5 (after design phase)
3. Simulate failure at Step 4 (implementation start)
4. Run restoration from Phase 3 checkpoint:
   ```bash
   node .claude/tools/checkpoint-manager.mjs restore \
     --checkpoint .claude/context/runtime/runs/run-001/checkpoints/checkpoint-phase-3.json \
     --run-id run-001
   ```
5. Verify state matches checkpoint:
   - Completed steps: [0, 1, 2, 3]
   - Artifacts restored to correct locations
   - Validation gates passed
6. Continue execution from Step 4
7. Verify workflow completes successfully

**Expected Result**:

- State restored exactly as checkpointed
- No data loss or corruption
- Workflow continues seamlessly from checkpoint

---

### Scenario 3: Fallback Agent Routing

**Steps**:

1. Assign implementation task to `developer` agent
2. Simulate agent failure (e.g., timeout, validation failure)
3. Run fallback router:
   ```bash
   node .claude/tools/fallback-router.mjs \
     --task task.json \
     --failed-agent developer \
     --error "Agent timeout after 120s"
   ```
4. Verify routing to `refactoring-specialist` (first fallback for developer)
5. Verify task context preserved:
   - Original task description
   - Input artifacts
   - Fallback history
6. Verify fallback agent completes task successfully
7. Check recovery log for fallback event

**Expected Result**:

- Task routed to correct fallback agent
- Context preserved across routing
- Recovery logged with timestamp and reason

---

### Scenario 4: Multi-Level Fallback

**Steps**:

1. Assign task to `developer` agent
2. Simulate first failure → routes to `refactoring-specialist`
3. Simulate second failure → routes to `code-simplifier` (second fallback)
4. Verify fallback attempt tracking:
   ```json
   {
     "fallbackAttempt": 2,
     "fallbackHistory": [
       { "agent": "developer", "error": "...", "timestamp": "..." },
       { "agent": "refactoring-specialist", "error": "...", "timestamp": "..." }
     ]
   }
   ```
5. Verify max attempts respected (default: 2)
6. If third failure, verify escalation to orchestrator

**Expected Result**:

- All fallback levels attempted in order
- Max attempts enforced
- Escalation triggered when exhausted

---

### Scenario 5: Full Recovery Flow (End-to-End)

**Steps**:

1. Start `greenfield-fullstack` workflow
2. Create checkpoints at:
   - Step 0.5 (after planning)
   - Step 2.5 (after design)
   - Step 5.5 (after implementation)
3. Simulate catastrophic failure at Step 6 (testing phase)
4. Run recovery from latest checkpoint (Step 5.5):
   ```bash
   node .claude/tools/checkpoint-manager.mjs restore \
     --checkpoint .claude/context/runtime/runs/run-001/checkpoints/checkpoint-phase-5.json \
     --run-id run-001 \
     --continue
   ```
5. Verify all artifacts restored:
   - Plan, architecture, dev-manifest, etc.
6. Verify validation gates re-passed
7. Complete remaining steps (6-8)
8. Verify final deliverables match expected output

**Expected Result**:

- Complete recovery from checkpoint
- All artifacts intact and validated
- Workflow completes successfully
- No duplicate work or data loss

## Validation Gates

### Checkpoint Validation

```bash
node .claude/tools/gates/gate.mjs \
  --schema .claude/schemas/checkpoint.schema.json \
  --input .claude/context/runtime/runs/run-001/checkpoints/checkpoint-phase-3.json \
  --gate .claude/context/history/gates/run-001/checkpoint-phase-3-gate.json
```

### Fallback Configuration Validation

```bash
node .claude/tools/fallback-router.mjs --validate
```

### Recovery Log Validation

Verify recovery events logged:

```json
{
  "timestamp": "2026-01-06T10:30:00Z",
  "event": "checkpoint_created",
  "checkpoint_id": "checkpoint-phase-3",
  "run_id": "run-001",
  "step": 3.5
}
```

## Dependencies

### Tools

- `.claude/tools/fallback-router.mjs` - Fallback agent routing
- `.claude/tools/checkpoint-manager.mjs` - Checkpoint creation and restoration
- `.claude/tools/gates/gate.mjs` - Schema validation

### Schemas

- `.claude/schemas/checkpoint.schema.json` - Checkpoint structure validation
- `.claude/schemas/fallback-agents.schema.json` - Fallback config validation

### Configuration

- `.claude/config/fallback-agents.json` - Fallback agent mappings

### Workflows

- `recovery-test-flow.yaml` - Dedicated recovery testing workflow

## Recovery Metrics

Track these metrics during testing:

| Metric                   | Target  | Actual |
| ------------------------ | ------- | ------ |
| Checkpoint creation time | < 500ms |        |
| Checkpoint file size     | < 100KB |        |
| Restoration time         | < 2s    |        |
| State accuracy           | 100%    |        |
| Fallback routing time    | < 100ms |        |
| Context preservation     | 100%    |        |

## Error Handling

### Checkpoint Creation Failures

- Log error but continue workflow
- Mark checkpoint as `failed` in metadata
- Notify orchestrator for manual review

### Restoration Failures

- Validate checkpoint integrity first
- If corrupted, try previous checkpoint
- If all checkpoints invalid, escalate to manual recovery

### Fallback Routing Failures

- Log failure reason
- Attempt next fallback in chain
- If all fallbacks exhausted, escalate per `escalation_strategy`

## Post-Test Validation

After completing all scenarios:

1. **Review recovery logs**: Ensure all events logged
2. **Validate artifact integrity**: Check all artifacts match expected checksums
3. **Performance analysis**: Review checkpoint/restore performance metrics
4. **Documentation update**: Update recovery playbook based on findings

## Example Prompts

### Example 1: Checkpoint Creation and Restoration Test

```
Test checkpoint creation for the greenfield workflow. Create checkpoints after Phase 1, Phase 3, and Phase 5, then simulate a failure at Step 6 and restore from the Phase 5 checkpoint.
```

### Example 2: Fallback Agent Routing Test

```
Test the fallback agent routing system. Simulate a developer agent failure during implementation and verify that the task routes to the refactoring-specialist agent with context preserved.
```

### Example 3: Full Recovery Flow Test

```
Run a complete recovery test: start greenfield-fullstack workflow, create checkpoints at each phase boundary, simulate catastrophic failure at Step 6, restore from latest checkpoint, and verify all artifacts are intact.
```

## Related CUJs

- **CUJ-001**: Greenfield Development (base workflow for testing)
- **CUJ-015**: Validation Gate Testing (checkpoint validation)
- **CUJ-050**: Workflow Execution (baseline workflow testing)

## Related Documentation

- [Planner Agent](../../agents/planner.md)
- [QA Agent](../../agents/qa.md)
- [recovery Skill](../../skills/recovery/SKILL.md)
- [response-rater Skill](../../skills/response-rater/SKILL.md)
- [recovery-test-flow Workflow](../../workflows/recovery-test-flow.yaml)

## Notes

- Checkpoints should be created automatically by orchestrator
- Manual checkpoint creation available via `create-checkpoint.mjs` tool
- Checkpoint expiration defaults to 7 days
- Recovery events trigger notifications if `notify_on_fallback: true`

## Version History

| Version | Date       | Changes                                                                            |
| ------- | ---------- | ---------------------------------------------------------------------------------- |
| 1.0.0   | 2026-01-06 | Initial CUJ creation                                                               |
| 1.1.0   | 2026-01-08 | Fixed format, added Step 0.1 Plan Rating Gate, converted to standard CUJ structure |
