# CUJ-044: Agent Fallback Chain

## User Goal

Test fallback agent routing when primary agents fail, ensuring fallback agents receive correct context, artifacts are preserved, and the system recovers gracefully.

## Trigger

- "Test agent fallback routing"
- "Validate fallback agent context"
- "Test fallback chain recovery"
- Primary agent fails with non-recoverable error
- Primary agent times out
- Primary agent produces invalid output after retries

## Workflow

**Execution Mode**: `workflow`

> **Note**: This CUJ requires workflow execution to test agent fallback routing. It includes planning (Step 0) and rating (Step 0.1) before testing fallback scenarios.

### Step 0: Planning Phase

- Planner creates plan with fallback scenarios
- Identifies primary and fallback agents
- Defines fallback routing logic
- Specifies context preservation requirements

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Primary Agent Execution

- Primary agent (e.g., Architect) receives task
- Creates initial artifacts
- Attempts to complete task
- **Failure**: Agent fails with non-recoverable error

### Step 2: Failure Detection

- Orchestrator detects primary agent failure
- Categorizes failure type:
  - Non-recoverable error
  - Timeout
  - Invalid output after max retries (3)
- Checks agent definition for `fallback_agent` field
- If not specified, uses capability matrix

### Step 3: Fallback Agent Selection

- **Option A**: Use explicit `fallback_agent` from agent definition
- **Option B**: Use capability matrix:
  - Architect → Developer (for implementation)
  - PM → Analyst (for requirements analysis)
  - Analyst → PM (for product requirements)
- Select fallback agent based on failure type

### Step 4: Context Preservation

- **Preserve All Artifacts**: Pass all artifacts from previous steps
- **Include Error Details**: Pass error details from primary agent
- **Provide Task Requirements**: Pass original task requirements
- **Include Constraints**: Pass technical/business constraints
- **Document Fallback**: Log fallback reason in reasoning file

### Step 5: Fallback Agent Execution

- Fallback agent receives full context
- Verifies required artifacts exist
- Verifies fallback agent has required tools/context
- Executes task using fallback approach
- Creates output artifacts

### Step 6: Fallback Validation

- Verify fallback agent received correct context
- Verify all artifacts preserved
- Verify error details included
- Verify task requirements clear
- Verify output quality acceptable

### Step 7: Plan Update

- Update plan document with fallback agent assignment
- Document fallback reason
- Update task status
- Track fallback success/failure

## Agents Used

- Planner (planning with fallback scenarios)
- Primary Agent (e.g., Architect) - Fails
- Fallback Agent (e.g., Developer) - Recovers
- Orchestrator (fallback routing)

## Capabilities/Tools Used

- Fallback agent routing (orchestrator capability)
- Context preservation (orchestrator capability)
- Error handling (orchestrator capability)
- Plan updating (planner capability)

## Expected Outputs

- Primary agent artifacts (partial)
- Error details from primary agent
- Fallback agent artifacts (complete)
- Fallback routing documentation
- Updated plan document

## Success Criteria

| Criterion                        | Measurement                     | Target                                                                                    |
| -------------------------------- | ------------------------------- | ----------------------------------------------------------------------------------------- |
| Primary agent failure detected   | Failure detection log           | Failure identified correctly                                                              |
| Plan rating                      | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded                  | Rating file exists in run state | File present at `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`       |
| Fallback agent selected          | Fallback routing decision       | Appropriate fallback agent chosen                                                         |
| Artifacts preserved              | Registry validation             | All artifacts preserved during fallback                                                   |
| Error details passed             | Error context validation        | Error details provided to fallback agent                                                  |
| Fallback agent receives context  | Context passing validation      | Correct context received                                                                  |
| Required tools/context available | Capability verification         | Fallback agent has necessary capabilities                                                 |
| Task completed by fallback       | Gate validation                 | Task successfully completed                                                               |
| Plan updated                     | Plan artifact                   | Fallback assignment documented                                                            |
| Fallback reason documented       | Reasoning file                  | Fallback rationale recorded                                                               |

## Example Prompts

```
"Test agent fallback routing when Architect fails"
"Validate fallback agent context preservation"
"Test fallback chain recovery"
```

## Related Documentation

- [Orchestrator Agent](../../agents/orchestrator.md) - Fallback Agent Routing
- [WORKFLOW-GUIDE.md](../../workflows/WORKFLOW-GUIDE.md) - Error Handling

## Fallback Agent Selection Logic

### Explicit Fallback (Preferred)

- Check agent definition for `fallback_agent` field
- Use specified fallback if available
- Example: `fallback_agent: developer` in architect.md

### Capability Matrix (Fallback)

If no explicit fallback specified, use capability matrix:

| Primary Agent        | Fallback Agent | Reason                    |
| -------------------- | -------------- | ------------------------- |
| Architect            | Developer      | Implementation capability |
| PM                   | Analyst        | Requirements analysis     |
| Analyst              | PM             | Product requirements      |
| Database Architect   | Architect      | Schema design             |
| UX Expert            | Developer      | UI implementation         |
| Technical Writer     | Developer      | Documentation             |
| QA                   | Developer      | Test implementation       |
| Performance Engineer | Architect      | Performance design        |
| Security Architect   | Architect      | Security design           |
| Mobile Developer     | Developer      | Mobile implementation     |
| Incident Responder   | DevOps         | Incident resolution       |

### Fallback Routing Decision Tree

```
Primary Agent Fails?
|- Yes -> Check agent definition for fallback_agent
|   |- Found -> Route to specified fallback
|   `- Not Found -> Use capability matrix
|       `- Route to fallback agent
`- No -> Continue with primary agent
```

## Context Preservation Requirements

### Artifacts

- **All Previous Artifacts**: Pass all artifacts from previous steps
- **Artifact Registry**: Include artifact registry state
- **Validation Status**: Include validation status for each artifact

### Error Details

- **Error Type**: Non-recoverable, timeout, invalid output
- **Error Message**: Specific error message from primary agent
- **Retry Attempts**: Number of retries attempted (max 3)
- **Failure Reason**: Detailed failure reason

### Task Context

- **Original Requirements**: Original task requirements
- **Constraints**: Technical/business constraints
- **Dependencies**: Task dependencies
- **Success Criteria**: Expected success criteria

### Agent Capabilities

- **Required Tools**: Tools needed for task
- **Required Context**: Context needed for task
- **Verify Fallback Agent**: Check fallback agent has required capabilities

## Fallback Validation Checklist

### Before Fallback Routing

- [ ] Primary agent failure confirmed (non-recoverable)
- [ ] Max retries exceeded (3 attempts)
- [ ] Fallback agent identified
- [ ] Fallback agent capabilities verified

### During Fallback Routing

- [ ] All artifacts preserved
- [ ] Error details included
- [ ] Task requirements clear
- [ ] Constraints passed
- [ ] Fallback reason logged

### After Fallback Execution

- [ ] Fallback agent received correct context
- [ ] Task completed successfully
- [ ] Output quality acceptable
- [ ] Plan updated with fallback assignment
- [ ] Fallback success tracked

## Test Scenarios

### Scenario 1: Explicit Fallback

- Architect fails with non-recoverable error
- Architect definition specifies `fallback_agent: developer`
- Route to Developer with full context
- Developer completes task successfully

### Scenario 2: Capability Matrix Fallback

- PM fails with timeout
- PM definition has no explicit fallback
- Use capability matrix: PM → Analyst
- Route to Analyst with full context
- Analyst completes task successfully

### Scenario 3: Context Preservation

- Architect fails mid-task
- Artifacts created: project-brief.json, prd.json
- Fallback to Developer
- Verify Developer receives both artifacts
- Verify Developer has architecture context
- Developer completes implementation

### Scenario 4: Fallback Chain

- Primary agent fails
- Fallback agent also fails
- Second fallback agent succeeds
- Verify context preserved through chain
- Verify final output acceptable

### Scenario 5: Invalid Output Fallback

- Primary agent produces invalid output
- After 3 retries, output still invalid
- Route to fallback agent
- Fallback agent produces valid output
- Verify output quality acceptable
