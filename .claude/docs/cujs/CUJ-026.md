# CUJ-026: Multi-Phase Project Planning

## User Goal

Plan a large project that requires multiple phases to manage context and complexity.

## Trigger

- "Plan a large-scale project with multiple phases"
- Project requires >3000 lines of code
- Complex dependencies requiring phase separation

## Workflow

**Execution Mode**: `greenfield-fullstack.yaml`

### Step 0: Planning Phase (Hierarchical)

- Planner creates master plan (plan-{id}.md) - <5KB overview
- Planner creates phase plans (plan-{id}-phase-{n}.json) - <20KB each
- Each phase contains 1-3k lines of code
- Phases organized by dependencies
- Phase boundary detection: detects when project exceeds 3000 lines, determines optimal boundaries

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1-N: Phase Execution

- Orchestrator loads only active phase plan
- Agents work on current phase only
- Phase completion tracked in master plan
- Next phase starts after previous completes

## Agents Used

- Planner → Orchestrator → [Phase-specific agents]

## Skills Used

- `plan-generator` - Hierarchical planning
- `dependency-analyzer` - Dependency management for phase organization
- `response-rater` - Plan quality validation

## Capabilities/Tools Used

- Phase organization (planner capability for phase boundary detection)

## Expected Outputs

- plan-{id}.md (master plan)
- plan-{id}-phase-1.json (phase 1)
- plan-{id}-phase-2.json (phase 2)
- [Additional phase plans as needed]

## Success Criteria

| Criterion                           | Measurement                     | Target                                                                                    |
| ----------------------------------- | ------------------------------- | ----------------------------------------------------------------------------------------- |
| Master plan provides clear overview | Master plan file size           | <5KB overview document                                                                    |
| Plan rating                         | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded                     | Rating file exists in run state | File present at `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`       |
| Phase plans size                    | Phase plan file sizes           | Each phase plan <20KB                                                                     |
| Dependencies properly sequenced     | Dependency validation           | Dependencies respect execution order                                                      |
| Context managed per phase           | Phase context loading           | Only active phase loaded during execution                                                 |
| Progress tracked across phases      | Master plan updates             | Phase status tracked in master plan                                                       |
| Phase boundaries logical            | Feature alignment validation    | Phases align with feature boundaries                                                      |

## Example Prompts

```
"Plan a multi-phase e-commerce platform"
"Create a phased plan for migrating legacy system"
```

## Error Recovery

### Retry Strategy

- **Max Retries**: 3 attempts per step
- **Backoff**: Exponential (1s, 2s, 4s)
- **Retry Triggers**: Transient failures, timeouts, rate limits

### Rollback Procedures

1. **Partial Completion**: Save checkpoint to `.claude/context/runtime/runs/{{run_id}}/checkpoint.json`
2. **Failed Validation**: Return to previous passing gate
3. **Critical Failure**: Escalate to human with full context

### Fallback Options

- **Alternative Agent**: If primary agent fails 3x, route to backup agent
  - Planner → Architect (phase planning fallback)
  - Orchestrator → Planner (coordination fallback)
- **Manual Override**: User can force-proceed with documented risks
- **Graceful Degradation**: Reduce phase granularity (larger phases) with warnings

### Recovery Artifacts

- Error log: `.claude/context/runtime/runs/{{run_id}}/errors.log`
- Recovery state: `.claude/context/runtime/runs/{{run_id}}/recovery-state.json`
- Checkpoint: `.claude/context/runtime/runs/{{run_id}}/checkpoint.json`
- Phase state: `.claude/context/runtime/runs/{{run_id}}/phase-state.json`

## Related Documentation

- [Planner Agent](../../agents/planner.md) - Hierarchical Plan Document Creation
- [PLANNER_CENTRIC_ARCHITECTURE.md](../../docs/PLANNER_CENTRIC_ARCHITECTURE.md)
