# CUJ-041: Complex Artifact Dependency Chain

## User Goal

Test deep artifact dependency chains (A→B→C→D→E) to ensure artifacts are properly passed between workflow steps and the artifact registry tracks all dependencies correctly.

## Trigger

- "Test complex artifact dependencies"
- "Validate artifact dependency chain"
- "Test deep dependency tracking"

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase

- Planner creates plan with 5-step dependency chain
- Defines artifact dependencies: A→B→C→D→E
- Identifies artifact registry requirements

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Artifact A Creation

- Analyst creates `project-brief.json` (Artifact A)
- Artifact saved to `.claude/context/artifacts/project-brief.json`
- Artifact registered in artifact registry
- Validation passes, gate file created

### Step 2: Artifact B Creation (Depends on A)

- PM creates `prd.json` (Artifact B)
- **Dependency Check**: Verifies Artifact A exists in registry
- **Input**: Reads `project-brief.json` from previous step
- Artifact saved to `.claude/context/artifacts/prd.json`
- Artifact registered in registry with dependency on A
- Validation passes, gate file created

### Step 3: Artifact C Creation (Depends on B)

- UX Expert creates `ui-spec.json` (Artifact C)
- **Dependency Check**: Verifies Artifact B exists in registry
- **Input**: Reads `prd.json` from previous step
- Artifact saved to `.claude/context/artifacts/ui-spec.json`
- Artifact registered in registry with dependency on B
- Validation passes, gate file created

### Step 4: Artifact D Creation (Depends on C)

- Architect creates `system-architecture.json` (Artifact D)
- **Dependency Check**: Verifies Artifact C exists in registry
- **Input**: Reads `ui-spec.json` from previous step
- Artifact saved to `.claude/context/artifacts/system-architecture.json`
- Artifact registered in registry with dependency on C
- Validation passes, gate file created

### Step 5: Artifact E Creation (Depends on D)

- Developer creates `dev-manifest.json` (Artifact E)
- **Dependency Check**: Verifies Artifact D exists in registry
- **Input**: Reads `system-architecture.json` from previous step
- Artifact saved to `.claude/context/artifacts/dev-manifest.json`
- Artifact registered in registry with dependency on D
- Validation passes, gate file created

### Step 6: Dependency Chain Validation

- Verify artifact registry contains all 5 artifacts
- Verify dependency chain: A→B→C→D→E
- Verify each artifact's dependencies are correctly recorded
- Verify all artifacts have validation status "pass"
- Verify artifact paths are correct

## Agents Used

- Planner (planning)
- Analyst (Artifact A)
- PM (Artifact B)
- UX Expert (Artifact C)
- Architect (Artifact D)
- Developer (Artifact E)
- Orchestrator (dependency validation)

## Capabilities/Tools Used

- Artifact registry management (orchestrator capability)
- Dependency tracking (orchestrator capability)
- Artifact validation

## Expected Outputs

- Artifact A: `project-brief.json`
- Artifact B: `prd.json` (depends on A)
- Artifact C: `ui-spec.json` (depends on B)
- Artifact D: `system-architecture.json` (depends on C)
- Artifact E: `dev-manifest.json` (depends on D)
- Artifact registry: `registry-{{workflow_id}}.json`
- Dependency chain validation report

## Success Criteria

| Criterion                  | Measurement                     | Target                                                                            |
| -------------------------- | ------------------------------- | --------------------------------------------------------------------------------- |
| All artifacts created      | Artifact count                  | 5 artifacts successfully created                                                  |
| Plan rating                | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded            | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`       |
| Registry initialized       | Registry existence              | Registry initialized at workflow start                                            |
| Artifacts registered       | Registry entries                | Each artifact registered after creation                                           |
| Dependencies recorded      | Registry dependency field       | Dependencies correctly recorded in registry                                       |
| Dependency verification    | Reasoning file validation       | Steps verify dependencies before execution                                        |
| Artifacts passed           | Registry validation             | Artifacts passed correctly between steps                                          |
| Dependency chain validated | Chain validation                | A→B→C→D→E validated                                                               |
| Validation status          | Registry status field           | All artifacts have status "pass"                                                  |
| No missing dependencies    | Gate validation                 | No missing dependencies detected                                                  |

## Example Prompts

```
"Test complex artifact dependency chain"
"Validate artifact registry with 5-step dependencies"
"Test deep dependency tracking"
```

## Related Documentation

- [Orchestrator Agent](../../agents/orchestrator.md) - Artifact Registry Management
- [WORKFLOW-GUIDE.md](../../workflows/WORKFLOW-GUIDE.md) - Artifact Passing

## Artifact Registry Structure

### Registry Format

```json
{
  "workflow_id": "workflow-123",
  "artifacts": {
    "project-brief.json": {
      "name": "project-brief.json",
      "step": 1,
      "agent": "analyst",
      "created_at": "2025-01-17T10:00:00Z",
      "path": ".claude/context/artifacts/project-brief.json",
      "dependencies": [],
      "version": 1,
      "metadata": {
        "size": 8234,
        "type": "project_brief",
        "validation_status": "pass"
      }
    },
    "prd.json": {
      "name": "prd.json",
      "step": 2,
      "agent": "pm",
      "created_at": "2025-01-17T10:15:00Z",
      "path": ".claude/context/artifacts/prd.json",
      "dependencies": ["project-brief.json"],
      "version": 1,
      "metadata": {
        "size": 15234,
        "type": "prd",
        "validation_status": "pass"
      }
    }
  }
}
```

## Dependency Verification Process

### Before Each Step Execution

1. **Check Artifact Registry**: Verify required artifacts exist
2. **Verify Validation Status**: Ensure dependencies have status "pass"
3. **Load Artifacts**: Read artifacts from file system
4. **Pass to Agent**: Explicitly pass artifacts as context
5. **Register New Artifact**: After creation, register in registry

### Dependency Chain Validation

- Verify registry contains all artifacts in chain
- Verify each artifact's dependencies are present
- Verify dependency order is correct (A→B→C→D→E)
- Verify no circular dependencies
- Verify all artifacts validated successfully

## Test Scenarios

### Scenario 1: Complete Dependency Chain

- All 5 artifacts created in sequence
- Each artifact depends on previous
- Registry tracks all dependencies
- Validation succeeds

### Scenario 2: Missing Dependency Detection

- Artifact B creation attempted
- Artifact A missing from registry
- System detects missing dependency
- Workflow stops with clear error
- Recovery: Create missing artifact, then continue

### Scenario 3: Invalid Dependency Status

- Artifact B creation attempted
- Artifact A exists but validation status is "fail"
- System detects invalid dependency
- Workflow stops with clear error
- Recovery: Fix Artifact A, re-validate, then continue

### Scenario 4: Registry Corruption Recovery

- Artifact registry corrupted or missing
- System detects registry issue
- Rebuild registry from existing artifacts
- Verify dependency chain integrity
- Continue workflow
