# CUJ-014: Rule Compliance Audit

## User Goal
Validate code against project rules and standards.

## Trigger
- `/audit src/components/`
- `/audit --format json`
- "Audit this code"

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase
- Planner creates audit plan
- Analyzes audit scope and requirements
- Determines rule sets to apply
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`


### Step 0.1: Plan Rating Gate
- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Rule Loading
- rule-auditor loads active rules
- Queries rule index
- Identifies applicable rules

### Step 2: Code Analysis
- Analyzes target files
- Checks against rules
- Identifies violations

### Step 3: Report Generation
- Generates audit report
- Lists violations with locations
- Provides fix instructions

### Step 4: Auto-Fix (Optional)
- Suggests auto-fixes
- Applies fixes where safe
- Reports manual fixes needed

## Agents Used
- None (skill-based)

## Skills Used
- `rule-auditor` - Code validation
- `response-rater` - Plan quality validation

## Expected Outputs
- Audit report
- Violation list
- Fix suggestions
- Compliance score

## Success Criteria

| Criterion | Measurement | Target |
|-----------|-------------|--------|
| Audit plan created | Artifact validated by gate | `plan-{{workflow_id}}.json` validated by gate file |
| Plan rating | response-rater skill score | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json` |
| Rules loaded from index | Artifact rules_applied field | Rules applied array populated in `audit-report-{{workflow_id}}.json` |
| Files scanned | Artifact files_scanned field | Files scanned array populated in `audit-report-{{workflow_id}}.json` |
| Violations identified with locations | Artifact violations field | Violations array with file, line, column in `audit-report-{{workflow_id}}.json` |
| Severity assigned to violations | Artifact severity field | Each violation has severity (error\|warning\|info) in `audit-report-{{workflow_id}}.json` |
| Fix instructions provided | Artifact fix_instruction field | Each violation has fix_instruction in `audit-report-{{workflow_id}}.json` |
| Compliance score calculated | Artifact compliance_score field | Compliance score (0-100) in `audit-report-{{workflow_id}}.json` |
| Report validated | Schema validation | Validated against `.claude/schemas/skill-rule-auditor-output.schema.json` |

## Example Prompts
```
/audit src/components/
"Audit the authentication module"
"Check code compliance"
```

## Related Documentation
- [rule-auditor Skill](../../skills/rule-auditor/SKILL.md)
- [Rule Index System](../../CLAUDE.md#rule-index-system)
