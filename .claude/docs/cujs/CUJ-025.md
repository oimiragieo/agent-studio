# CUJ-025: Large Requirements Document Processing

## User Goal

Process a large requirements document (>15KB) without context window overflow.

## Trigger

- User provides a markdown file > 15KB as requirements
- "Plan features from this document" (with large file)
- Automatic detection by workflow_runner.js

## Workflow

**Execution Mode**: `workflow`

### Step 0.5: Feature Distillation (Conditional)

- Analyst agent activated automatically
- Reads large markdown file
- Extracts and structures features
- Creates features-distilled.json
- Preserves critical details, removes verbose content
- Validates: all critical features preserved, acceptance criteria included, dependencies mapped

### Step 0: Planning Phase

- Planner uses features-distilled.json (not raw markdown)
- Creates plan from structured features
- Coordinates with specialists

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Subsequent Steps

- Normal workflow execution continues

## Agents Used

- Analyst (Step 0.5) → Planner (Step 0) → [Other agents]

## Skills Used

- `summarizer` - Feature extraction and summarization
- `response-rater` - Plan quality validation

## Capabilities/Tools Used

- Structured data creation (analyst capability for JSON schema generation)

## Expected Outputs

- features-distilled.json (Step 0.5)
- plan-{{workflow_id}}.md (Step 0)
- plan-{{workflow_id}}.json (Step 0)

## Success Criteria

| Criterion                       | Measurement                     | Target                                                                             |
| ------------------------------- | ------------------------------- | ---------------------------------------------------------------------------------- |
| Large document processed        | Context window usage            | Processed without context overflow                                                 |
| Plan rating                     | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`)  |
| Rating recorded                 | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`        |
| All critical features extracted | Feature extraction validation   | All critical features in distilled output                                          |
| Features properly structured    | JSON structure validation       | features-distilled.json properly formatted                                         |
| Planner compatibility           | Plan creation successful        | Planner creates plan from distilled features                                       |
| No information loss             | Critical detail validation      | Critical details preserved in distilled output                                     |
| Validation checks pass          | Validation gate results         | all_critical_features_preserved, acceptance_criteria_included, dependencies_mapped |

## Example Prompts

```
"Plan features from requirements.md" (file is 25KB)
"Create plan from this feature document" (large markdown)
```

## Related Documentation

- [greenfield-fullstack Workflow](../../workflows/greenfield-fullstack.yaml)
- [Analyst Agent](../../agents/analyst.md) - Feature Distillation section
- [Planner Agent](../../agents/planner.md) - Input Handling section
