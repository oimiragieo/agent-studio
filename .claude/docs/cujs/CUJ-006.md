# CUJ-006: Architecture Review

## User Goal

Review and analyze existing system architecture.

## Trigger

- "Review my system architecture"
- "Analyze architecture"
- "Architecture review"

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase

- Planner creates review plan
- Identifies review scope
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`

### Step 0.1: Plan Rating Gate

**Agent**: orchestrator
**Skill**: response-rater
**Validation**:

- Minimum score: 7/10
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to planner with feedback (max 3 attempts)
- If score >= 7: Proceed to Step 1
- Records rating in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Architecture Analysis

- Architect analyzes system
- Reviews components and relationships
- Identifies patterns and anti-patterns

### Step 2: Diagram Generation

- diagram-generator creates architecture diagrams
- Visualizes system structure
- Documents relationships

### Step 3: Review Report

- Architect generates review report
- Identifies issues and recommendations
- Provides improvement suggestions

## Agents Used

- Planner -> Architect

## Skills Used

- `diagram-generator` - Architecture diagrams

## Expected Outputs

- Architecture review report
- Architecture diagrams
- Recommendations document

## Success Criteria

| Criterion                       | Measurement                    | Target                                                                                            |
| ------------------------------- | ------------------------------ | ------------------------------------------------------------------------------------------------- |
| Review plan created             | Artifact validated by gate     | `plan-{{workflow_id}}.json` validated by gate file                                                |
| Architecture analyzed           | Artifact exists and complete   | `architecture-review-{{workflow_id}}.json` populated                                              |
| Component inventory documented  | Artifact components field      | Components array populated in `architecture-review-{{workflow_id}}.json`                          |
| Diagrams generated              | Diagram artifacts exist        | `diagrams/architecture-{{workflow_id}}.mmd` and `diagrams/components-{{workflow_id}}.mmd` created |
| Issues identified with severity | Artifact issues field          | Issues array with severity ratings in `architecture-review-{{workflow_id}}.json`                  |
| Recommendations prioritized     | Artifact recommendations field | Recommendations array with priority in `architecture-review-{{workflow_id}}.json`                 |
| Report validated                | Schema validation              | Validated against `.claude/schemas/architecture-review.schema.json`                               |

## Example Prompts

```
"Review my system architecture"
"Analyze the architecture of this application"
"Generate architecture diagrams"
```

## Error Recovery

### Retry Strategy

- **Max Retries**: 3 attempts per step
- **Backoff**: Exponential (1s, 2s, 4s)
- **Retry Triggers**: Transient failures, timeouts, rate limits

### Rollback Procedures

1. **Partial Completion**: Save checkpoint to `.claude/context/runtime/runs/{{run_id}}/checkpoint.json`
2. **Failed Validation**: Return to previous passing gate
3. **Critical Failure**: Escalate to human with full context

### Fallback Options

- **Alternative Agent**: If primary agent fails 3x, route to backup agent
  - Architect â†’ Developer (implementation fallback for complex analysis)
- **Manual Override**: User can force-proceed with documented risks
- **Graceful Degradation**: Proceed with partial review (skip diagram generation if diagram-generator fails; provide text-based architecture analysis only)

### Recovery Artifacts

- Error log: `.claude/context/runtime/runs/{{run_id}}/errors.log`
- Recovery state: `.claude/context/runtime/runs/{{run_id}}/recovery-state.json`
- Checkpoint: `.claude/context/runtime/runs/{{run_id}}/checkpoint.json`

## Related Documentation

- [Architect Agent](../../agents/architect.md)
- [diagram-generator Skill](../../skills/diagram-generator/SKILL.md)
