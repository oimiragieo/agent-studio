# CUJ-011: Bug Fix Workflow

## User Goal
Quickly fix a bug with validation.

## Trigger
- `/quick-ship Fix login button`
- "Quick fix for [issue]"
- "Bug fix"

## Workflow

**Execution Mode**: `quick-flow.yaml`

### Step 0: Planning Phase (MANDATORY)
- Planner creates fix plan
- Analyzes bug and determines fix approach
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`
- Note: Planner step is always required for proper workflow execution


### Step 0.1: Plan Rating Gate
- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Bug Analysis
- Developer analyzes bug
- Identifies root cause
- Plans fix

### Step 2: Implementation
- Developer implements fix
- Tests locally
- Validates solution

### Step 3: Quality Validation
- QA validates fix
- Runs regression tests
- Confirms resolution

### Step 3.5: Publish Artifacts
- **Agent**: orchestrator
- **Skill**: artifact-publisher
- **Condition**: `validation_status == 'pass'`
- **Policy**: auto-on-pass
- **Inputs**: All validated artifacts from workflow (fixed code, test results, validation report)
- **Outputs**: Published artifacts in project feed
- **Description**: Publish all validated bug fix artifacts to project feed for cross-platform visibility. Includes code changes, test results, regression test reports, and QA validation confirmations.

## Agents Used
- Planner → Developer → QA

## Skills Used
- `rule-auditor` - Code validation
- `response-rater` - Plan quality validation

## Expected Outputs
- Fixed code
- Test results
- Validation report

## Success Criteria

| Criterion | Measurement | Target |
|-----------|-------------|--------|
| Bug fixed | Gate validation | Validated by gate file |
| Plan rating | response-rater skill score | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json` |
| Tests passing | Test runner exit code | 0 (pass) in `test-results.json` |
| No regressions | QA gate validation | Validated by QA gate |
| Code validated | Schema validation | Validated against `code-review.schema.json` |

## Example Prompts
```
/quick-ship Fix the login button alignment
"Quick fix for the authentication error"
"Fix the bug in user profile loading"
```

## Error Recovery

### Retry Strategy
- **Max Retries**: 3 attempts per step
- **Backoff**: Exponential (1s, 2s, 4s)
- **Retry Triggers**: Transient failures, timeouts, rate limits

### Rollback Procedures
1. **Partial Completion**: Save checkpoint to `.claude/context/runs/{{run_id}}/checkpoint.json`
2. **Failed Validation**: Return to previous passing gate
3. **Critical Failure**: Escalate to human with full context

### Fallback Options
- **Alternative Agent**: If primary agent fails 3x, route to backup agent
  - Developer → Code-Reviewer (fix implementation fallback)
  - QA → Developer (validation fallback)
- **Manual Override**: User can force-proceed with documented risks
- **Graceful Degradation**: Deploy fix with limited testing (emergency only)

### Recovery Artifacts
- Error log: `.claude/context/runs/{{run_id}}/errors.log`
- Recovery state: `.claude/context/runs/{{run_id}}/recovery-state.json`
- Checkpoint: `.claude/context/runs/{{run_id}}/checkpoint.json`

## Platform Compatibility

| Platform | Status | Notes |
|----------|--------|-------|
| **Claude** | ✅ Full Support | Primary platform with native workflow engine (quick-flow.yaml) |
| **Cursor** | ✅ Full Support | Requires Cursor MCP integration; quick-flow workflow supported |
| **Factory** | ⚠️ Partial | Requires manual adaptation; workflow engine may need custom integration |
| **OpenCode** | ❌ Not Tested | May work with adaptation of workflow engine |

**Notes**: This is a workflow-based CUJ using `quick-flow.yaml`. Skills (`rule-auditor`, `response-rater`) must be available on target platform. Suitable for fast bug fixes with validation.

## Related Documentation
- [quick-flow Workflow](../../workflows/quick-flow.yaml)
- [Developer Agent](../../agents/developer.md)
- [QA Agent](../../agents/qa.md)

