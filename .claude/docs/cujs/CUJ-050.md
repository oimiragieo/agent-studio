# CUJ-050: End-to-End Workflow Robustness

## User Goal

Test complete workflow resilience: multiple failure points, recovery at each stage, context loss at different points, validation failures throughout, and complete workflow completion after failures.

## Trigger

- "Test end-to-end workflow robustness"
- "Test workflow recovery from multiple failures"
- "Validate complete workflow resilience"
- Workflow encounters failures at various stages

## Workflow

**Execution Mode**: workflow
**Workflow File**: `.claude/workflows/brownfield-fullstack.yaml`

### Step 0: Planning Phase

- Planner creates plan for end-to-end robustness testing
- Identifies failure points to test
- Defines recovery protocols for each failure type

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Initial Execution (Steps 1-3)

- Execute workflow steps 1-3 normally
- Create artifacts: `project-brief.json`, `prd.json`, `system-architecture.json`
- Create plan, gate files, reasoning files
- Register artifacts in registry

### Step 2: Failure Point Testing

- **Failure Point A: Step 1 Validation Failure**
  - Analyst creates project-brief.json
  - Validation fails (missing required field)
  - Recovery: Analyst corrects output, re-validates
  - Expected: Step 1 completes after recovery

- **Failure Point B: Step 2 Missing Artifact**
  - PM requires project-brief.json from Step 1
  - Artifact missing (deleted or not created)
  - Recovery: Detect missing artifact, recreate, continue
  - Expected: Step 2 completes after artifact recovery

- **Failure Point C: Step 3 Context Loss**
  - Architect working on system-architecture.json
  - Context window exhausted mid-step
  - Recovery: New orchestrator resumes from run record
  - Expected: Step 3 completes after context recovery

- **Failure Point D: Step 4 Validation Failure**
  - Developer creates code artifacts
  - Validation fails (code doesn't match architecture)
  - Recovery: Developer corrects code, re-validates
  - Expected: Step 4 completes after recovery

- **Failure Point E: Step 5 Registry Corruption**
  - QA requires artifacts from previous steps
  - Registry corrupted (invalid JSON)
  - Recovery: Registry integrity check, rebuild from file system
  - Expected: Step 5 completes after registry recovery

### Step 3: Recovery Validation

- Verify each failure point recovered successfully
- Check artifacts created correctly after recovery
- Validate registry updated after recovery
- Confirm plan updated to reflect recovery
- Document recovery actions in reasoning files

### Step 4: Continue Workflow

- Continue workflow from each recovery point
- Complete remaining workflow steps
- Validate final outputs
- Verify complete workflow completion

### Step 5: End-to-End Validation

- Verify workflow completed successfully despite failures
- Check all artifacts created and validated
- Validate registry complete and accurate
- Confirm plan reflects complete execution
- Document end-to-end resilience

## Agents Used

- Planner (robustness testing planning)
- Orchestrator (failure detection and recovery coordination)
- Analyst (Step 1 recovery)
- PM (Step 2 recovery)
- Architect (Step 3 recovery)
- Developer (Step 4 recovery)
- QA (Step 5 recovery and validation)

## Skills Used

- `recovery` - Workflow recovery protocol for failure recovery
- Registry integrity
- Context recovery
- Validation recovery
- `response-rater` - Plan quality validation

## Expected Outputs

- Initial artifacts (project-brief.json, prd.json, etc.)
- Recovered artifacts after each failure
- Recovery documentation
- Final workflow outputs
- End-to-end resilience report

## Success Criteria

- [ ] All failure points detected correctly (artifact: failure-detection-log.json)
- [ ] Plan rating >= 7/10 (recorded in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`)
- [ ] Rating recorded in run state (validation: rating file exists)
- [ ] All failures recovered successfully (artifact: recovery-log.json)
- [ ] Workflow continues after each recovery (validated by gate file)
- [ ] All artifacts created and validated (artifact: registry-{id}.json)
- [ ] Registry complete and accurate (artifact: registry-{id}.json)
- [ ] Plan reflects complete execution (artifact: plan-{id}.json)
- [ ] Complete workflow completion achieved (validated by gate file)
- [ ] End-to-end resilience validated (artifact: resilience-report.json)

## Example Prompts

```
"Test end-to-end workflow robustness"
"Test workflow recovery from multiple failures"
"Validate complete workflow resilience"
```

## Related Documentation

- [Orchestrator Agent](../../agents/orchestrator.md) - Error Handling and Recovery
- [Planner Agent](../../agents/planner.md) - Recovery Protocol
- [CUJ-040: Stateless Recovery Test](./CUJ-040.md)
- [CUJ-043: Workflow Interruption Recovery](./CUJ-043.md)
- [CUJ-045: Missing Required Artifact Recovery](./CUJ-045.md)

## Failure Point Test Scenarios

### Scenario 1: Validation Failure Recovery

- **Failure**: Step 1 validation fails
- **Recovery**: Analyst corrects output, re-validates
- **Validation**: Step 1 completes, artifact created
- **Expected**: Workflow continues to Step 2

### Scenario 2: Missing Artifact Recovery

- **Failure**: Step 2 missing required artifact
- **Recovery**: Detect missing artifact, recreate, continue
- **Validation**: Step 2 completes with recreated artifact
- **Expected**: Workflow continues to Step 3

### Scenario 3: Context Loss Recovery

- **Failure**: Context window exhausted mid-step
- **Recovery**: New orchestrator resumes from run record
- **Validation**: Step completes, no work lost
- **Expected**: Workflow continues seamlessly

### Scenario 4: Validation Failure Chain

- **Failure**: Multiple validation failures across steps
- **Recovery**: Each failure recovered individually
- **Validation**: All steps complete after recovery
- **Expected**: Complete workflow completion

### Scenario 5: Registry Corruption Recovery

- **Failure**: Registry corrupted mid-workflow
- **Recovery**: Registry integrity check, rebuild from file system
- **Validation**: Registry restored, workflow continues
- **Expected**: Complete workflow completion

### Scenario 6: Multiple Concurrent Failures

- **Failure**: Multiple failures occur simultaneously
- **Recovery**: Each failure recovered in priority order
- **Validation**: All failures resolved, workflow continues
- **Expected**: Complete workflow completion
