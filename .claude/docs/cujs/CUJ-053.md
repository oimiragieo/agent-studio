# CUJ-053: Publishing Metadata Persistence Test

## User Goal

Validate that publishing metadata persists correctly across workflow runs and system restarts.

## Trigger

- "Test publishing persistence"
- "Validate publishing metadata storage"
- "Check publishing status persistence"

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase

- Planner creates persistence test plan
- Identifies test scenarios for publishing metadata persistence
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Create and Publish Artifact

- Create test artifact with `publishable: true`
- Register artifact in registry using `run-manager.mjs`
- Publish artifact using `artifact-publisher` skill
- Verify publishing metadata in registry

### Step 2: Verify Persistence After Update

- Update artifact (modify content)
- Re-register artifact with new version
- Verify publishing metadata preserved from previous version
- Check `publish_attempts` history maintained

### Step 3: Test Registry Reload

- Save registry to disk
- Reload registry from disk
- Verify publishing metadata persisted correctly:
  - `published: true`
  - `published_at` timestamp
  - `publish_status: 'success'`
  - `publish_attempts` array
  - `publish_targets` array

### Step 4: Test Failed Publishing Persistence

- Create artifact that fails to publish
- Verify failure metadata persisted:
  - `publish_status: 'failed'`
  - `publish_error` message
  - Failed attempt in `publish_attempts` array
- Reload registry and verify failure metadata still present

### Step 5: Test Retry Persistence

- Retry publishing failed artifact
- Verify retry attempts added to `publish_attempts` array
- Check each attempt has timestamp, status, error
- Reload registry and verify all retry attempts persisted

### Step 6: Test Cross-Run Persistence

- Complete workflow run
- Start new workflow run
- Load previous run's registry
- Verify publishing metadata from previous run accessible

## Agents Used

- Planner (persistence test planning)
- QA (persistence validation)

## Skills Used

- `artifact-publisher` - Publishing artifacts with metadata tracking
- `plan-generator` - Creating persistence test plan
- `response-rater` - Plan quality validation

## Capabilities/Tools Used

- Artifact registry: `run-manager.mjs` with `registerArtifact()` and `updateArtifactPublishingStatus()`
- Registry persistence: `.claude/context/runs/<run_id>/artifact-registry.json`
- Publishing status tracking

## Expected Outputs

- Persistence test plan: `plan-{{workflow_id}}.json`
- Test artifacts with publishing metadata
- Registry files: `.claude/context/runs/<run_id>/artifact-registry.json`
- Persistence validation report: `publishing-persistence-report.json`

## Success Criteria

| Criterion                    | Measurement                     | Target                                                                            |
| ---------------------------- | ------------------------------- | --------------------------------------------------------------------------------- |
| Plan rating                  | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded              | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`       |
| Publishing metadata persists | Registry reload validation      | Metadata persists after save/reload                                               |
| Timestamp preserved          | ISO 8601 format validation      | `published_at` timestamp in correct format                                        |
| Publish attempts persist     | Array validation                | All attempts in `publish_attempts` array                                          |
| Failed metadata persists     | Registry content validation     | `publish_status: 'failed'` and `publish_error` preserved                          |
| Retry attempts accumulate    | Array growth validation         | Attempts accumulate in `publish_attempts`                                         |
| Cross-run persistence        | Previous run read validation    | Previous run metadata accessible                                                  |
| System restart survival      | Restart simulation validation   | Metadata survives restart                                                         |

## Example Prompts

```
"Test publishing metadata persistence"
"Validate publishing status storage"
"Check if publishing metadata survives restarts"
```

## Related Documentation

- [Artifact Publisher Skill](../../skills/artifact-publisher/SKILL.md)
- [Run Manager Tool](../../tools/run-manager.mjs)
- [Artifact Registry Schema](../../schemas/artifact-registry.schema.json)
