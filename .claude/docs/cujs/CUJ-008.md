# CUJ-008: Database Schema Planning

## User Goal

Design database schema for a feature or system.

## Trigger

- "Design database for user management"
- "Create database schema"
- "Database design"

## Workflow

**Execution Mode**: `workflow`

### Step 0: Planning Phase

- Planner creates schema design plan
- Identifies data requirements
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`

### Step 0.1: Plan Rating Gate

**Agent**: orchestrator
**Skill**: response-rater
**Validation**:

- Minimum score: 7/10
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to planner with feedback (max 3 attempts)
- If score >= 7: Proceed to Step 1
- Records rating in `.claude/context/runtime/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Schema Design

- Database Architect designs schema
- Creates data models
- Defines relationships

### Step 2: Diagram Generation

- diagram-generator creates ER diagrams
- Visualizes schema structure
- Documents relationships

### Step 3: Migration Planning

- Plans migration strategy
- Creates migration scripts
- Validates schema design

## Agents Used

- Planner → Database Architect

## Skills Used

- `diagram-generator` - ER diagrams

## Expected Outputs

- Database schema design
- ER diagrams
- Migration scripts
- Schema documentation

## Success Criteria

| Criterion             | Measurement                  | Target                                                            |
| --------------------- | ---------------------------- | ----------------------------------------------------------------- |
| Plan created          | Artifact validated by gate   | `plan-{{workflow_id}}.json` validated by gate file                |
| Schema designed       | Artifact exists              | `db-schema-{{workflow_id}}.json` populated with tables and fields |
| Relationships defined | Artifact relationships field | Relationships array populated in `db-schema-{{workflow_id}}.json` |
| Diagrams generated    | Diagram artifacts exist      | `diagrams/er-diagram-{{workflow_id}}.mmd` created                 |
| Migration planned     | Artifact migration field     | Migration strategy defined in `db-schema-{{workflow_id}}.json`    |
| Schema validated      | Schema validation            | Validated against `.claude/schemas/database-schema.schema.json`   |

## Example Prompts

```
"Design database schema for e-commerce"
"Create database design for user management"
"Generate ER diagram for the system"
```

## Error Recovery

### Retry Strategy

- **Max Retries**: 3 attempts per step
- **Backoff**: Exponential (1s, 2s, 4s)
- **Retry Triggers**: Transient failures, timeouts, rate limits

### Rollback Procedures

1. **Partial Completion**: Save checkpoint to `.claude/context/runtime/runs/{{run_id}}/checkpoint.json`
2. **Failed Validation**: Return to previous passing gate
3. **Critical Failure**: Escalate to human with full context

### Fallback Options

- **Alternative Agent**: If primary agent fails 3x, route to backup agent
  - Database-Architect → Architect (fallback for database design expertise)
- **Manual Override**: User can force-proceed with documented risks
- **Graceful Degradation**: Generate basic ERD only (skip migration scripts; provide schema structure without detailed migration strategy)

### Recovery Artifacts

- Error log: `.claude/context/runtime/runs/{{run_id}}/errors.log`
- Recovery state: `.claude/context/runtime/runs/{{run_id}}/recovery-state.json`
- Checkpoint: `.claude/context/runtime/runs/{{run_id}}/checkpoint.json`

## Related Documentation

- [Database Architect Agent](../../agents/database-architect.md)
- [diagram-generator Skill](../../skills/diagram-generator/SKILL.md)
