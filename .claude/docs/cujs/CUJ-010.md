# CUJ-010: API Endpoint Development

## User Goal
Create a new API endpoint with proper structure.

## Trigger
- "Create /api/users endpoint"
- "Add API endpoint"
- "Generate API route"

## Workflow

**Execution Mode**: `brownfield-fullstack.yaml`

### Step 0: Planning Phase
- Planner creates implementation plan
- Analyzes API endpoint requirements
- Coordinates with Architect for API design patterns
- Defines request/response schemas
- Outputs: `plan-{{workflow_id}}.md`, `plan-{{workflow_id}}.json`


### Step 0.1: Plan Rating Gate
- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: API Design
- Developer identifies endpoint requirements
- Determines HTTP methods
- Defines request/response schemas

### Step 2: Scaffolding
- scaffolder generates API route
- Creates validation schemas
- Sets up error handling

### Step 3: Implementation
- Developer implements business logic
- Adds database operations
- Implements authentication

### Step 4: API Contract Generation
- api-contract-generator creates OpenAPI/Swagger schema
- Validates contract matches implementation
- Saves contract to artifact registry

### Step 5: Documentation
- doc-generator creates API docs
- Uses OpenAPI contract for documentation
- Adds examples

## Agents Used
- Developer → Technical Writer

## Skills Used
- `scaffolder` - API generation
- `api-contract-generator` - OpenAPI/Swagger schema generation
- `doc-generator` - API documentation
- `response-rater` - Plan quality validation

## Expected Outputs
- API route file
- Validation schemas
- API documentation
- OpenAPI specification

## Success Criteria

| Criterion | Measurement | Target |
|-----------|-------------|--------|
| Endpoint implemented | API route file exists | File created at `src/app/api/{{endpoint}}/route.ts` (validated by `gates/step-2.json`) |
| Plan rating | response-rater skill score | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json` |
| Validation added | Validation schemas created | Schemas registered in artifact registry (`validation-schema-{{workflow_id}}.json`) |
| Documentation complete | API documentation file created | `api-docs-{{workflow_id}}.md` validated by `.claude/schemas/api-docs.schema.json` |
| OpenAPI contract generated | OpenAPI specification created | `openapi-{{workflow_id}}.json` validated by `.claude/schemas/openapi.schema.json` |
| Examples provided | Usage examples in documentation | Examples section populated in `api-docs-{{workflow_id}}.md` |

## Example Prompts
```
"Create /api/users endpoint with CRUD operations"
"Generate API route for authentication"
"Add REST endpoint for orders"
```

## Error Recovery

### Retry Strategy
- **Max Retries**: 3 attempts per step
- **Backoff**: Exponential (1s, 2s, 4s)
- **Retry Triggers**: Transient failures, timeouts, rate limits

### Rollback Procedures
1. **Partial Completion**: Save checkpoint to `.claude/context/runs/{{run_id}}/checkpoint.json`
2. **Failed Validation**: Return to previous passing gate
3. **Critical Failure**: Escalate to human with full context

### Fallback Options
- **Alternative Agent**: If primary agent fails 3x, route to backup agent
  - Developer → Code-Reviewer (implementation fallback)
  - Technical-Writer → Developer (documentation fallback)
- **Manual Override**: User can force-proceed with documented risks
- **Graceful Degradation**: Skip non-critical documentation with warnings

### Recovery Artifacts
- Error log: `.claude/context/runs/{{run_id}}/errors.log`
- Recovery state: `.claude/context/runs/{{run_id}}/recovery-state.json`
- Checkpoint: `.claude/context/runs/{{run_id}}/checkpoint.json`

## Platform Compatibility

| Platform | Status | Notes |
|----------|--------|-------|
| **Claude** | ✅ Full Support | Primary platform with native workflow engine and skill support |
| **Cursor** | ❌ Limited Support | Workflow engine may not be available; consider using Plan Mode instead |
| **Factory** | ❌ Limited Support | Requires manual adaptation; workflow engine may not be available |
| **OpenCode** | ❌ Not Tested | May work with adaptation of workflow engine |

**Notes**: This is a workflow-based CUJ that requires workflow engine support. Skills (`scaffolder`, `api-contract-generator`, `doc-generator`, `response-rater`) must be available on target platform. For Cursor, consider using Plan Mode for API development instead of workflow mode.

## Related Documentation
- [brownfield-fullstack Workflow](../../workflows/brownfield-fullstack.yaml)
- [Developer Agent](../../agents/developer.md)
- [scaffolder Skill](../../skills/scaffolder/SKILL.md)
- [api-contract-generator Skill](../../skills/api-contract-generator/SKILL.md)

