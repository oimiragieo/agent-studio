# CUJ-045: Missing Required Artifact Recovery

## User Goal
Test recovery when required artifacts are missing, ensuring the system can detect missing artifacts, recreate them when possible, and recover gracefully.

## Trigger
- "Test missing artifact recovery"
- "Validate artifact recreation protocol"
- "Test recovery from missing artifacts"
- Required artifact deleted or corrupted
- Previous step failed to create artifact
- Artifact path incorrect

## Workflow

**Execution Mode**: `skill-only`

### Step 0: Planning Phase
- Planner creates plan with artifact dependency requirements
- Identifies required vs optional artifacts
- Defines artifact recreation protocol
- Specifies recovery validation steps

### Step 1: Normal Execution (Steps 1-2)
- Execute workflow steps 1-2 normally
- Create artifacts: `project-brief.json`, `prd.json`
- Create gate files and reasoning files
- Artifacts registered in artifact registry

### Step 2: Artifact Loss Simulation
- **Scenario A**: Required artifact deleted
- **Scenario B**: Required artifact corrupted
- **Scenario C**: Previous step failed to create artifact
- **Scenario D**: Artifact path incorrect

### Step 3: Missing Artifact Detection
- Next step attempts to read required artifact
- **Check Artifact Registry**: Verify artifact exists in registry
- **Check File System**: Verify artifact file exists
- **Check Validation Status**: Verify artifact validation status
- **Detect Missing Artifact**: Identify missing/corrupted artifact

### Step 4: Artifact Recovery Protocol
- **Step 4.1: Determine Recovery Strategy**
  - Check if previous step completed successfully
  - Check if artifact should exist
  - Determine recovery approach

- **Step 4.2: Recovery Options**
  - **Option A**: Previous step incomplete → Re-run previous step
  - **Option B**: Previous step complete but artifact missing → Request artifact recreation
  - **Option C**: Artifact corrupted → Request artifact recreation with validation
  - **Option D**: Artifact path incorrect → Correct path and verify

- **Step 4.3: Artifact Recreation**
  - Route to appropriate agent for artifact recreation
  - Provide original context and requirements
  - Agent recreates artifact
  - Validate recreated artifact
  - Register in artifact registry

### Step 5: Recovery Validation
- Verify recreated artifact exists
- Verify artifact validation passes
- Verify artifact registered in registry
- Verify artifact dependencies satisfied
- Verify workflow can continue

### Step 6: Continue Workflow
- Continue workflow from recovery point
- Use recreated artifact as input
- Complete remaining workflow steps
- Validate final outputs

## Agents Used
- Planner (recovery protocol planning)
- Orchestrator (missing artifact detection and recovery)
- [Agent that created original artifact] (artifact recreation)
- QA (recovery validation)

## Skills Used
- `recovery` - Workflow recovery protocol for artifact recovery
- `optional-artifact-handler` - Optional artifact handling for missing artifacts

## Expected Outputs
- Initial artifacts (project-brief.json, prd.json)
- Missing artifact detection report
- Recreated artifact
- Recovery validation report
- Final workflow outputs

## Success Criteria
- [ ] Missing artifacts detected correctly (artifact: missing-artifact-detection.json)
- [ ] Recovery strategy determined appropriately (artifact: recovery-strategy.json)
- [ ] Artifacts recreated successfully (artifact: recreated-artifacts.json)
- [ ] Recreated artifacts validated (validated by gate file)
- [ ] Artifacts registered in registry (artifact: registry-{id}.json)
- [ ] Workflow continues seamlessly (validated by gate file)
- [ ] Recovery validation passes (artifact: recovery-validation.json)
- [ ] No duplicate work performed (artifact: work-log.json)

## Example Prompts
```
"Test missing artifact recovery"
"Validate artifact recreation protocol"
"Test recovery from corrupted artifacts"
```

## Related Documentation
- [Orchestrator Agent](../../agents/orchestrator.md) - Missing Artifact Recovery
- [WORKFLOW-GUIDE.md](../../workflows/WORKFLOW-GUIDE.md) - Artifact Management
- [CUJ-038: Optional Artifact Handling](./CUJ-038.md)

## Missing Artifact Detection

### Detection Process
1. **Check Artifact Registry**: Verify artifact exists in registry
2. **Check File System**: Verify artifact file exists at expected path
3. **Check Validation Status**: Verify artifact validation status is "pass"
4. **Check File Integrity**: Verify artifact file is not corrupted
5. **Detect Missing Artifact**: Identify missing/corrupted artifact

### Detection Scenarios
- **Artifact Not in Registry**: Artifact never registered
- **Artifact File Missing**: File deleted or never created
- **Artifact Corrupted**: File exists but invalid JSON/structure
- **Artifact Invalid**: File exists but validation failed
- **Artifact Path Incorrect**: File exists but at wrong path

## Artifact Recovery Protocol

### Recovery Strategy Decision Tree
```
Missing Artifact Detected?
|- Check Previous Step Status
|   |- Incomplete -> Re-run Previous Step
|   |- Complete but Artifact Missing -> Request Artifact Recreation
|   |- Complete but Artifact Corrupted -> Request Artifact Recreation with Validation
|   `- Artifact Path Incorrect -> Correct Path and Verify
└─ Recovery Action Executed
```

### Recovery Options

#### Option A: Re-run Previous Step
- **When**: Previous step incomplete or failed
- **Action**: Re-execute previous step
- **Validation**: Verify step completes successfully
- **Result**: Artifact created as part of step execution

#### Option B: Request Artifact Recreation
- **When**: Previous step complete but artifact missing
- **Action**: Route to agent that created original artifact
- **Context**: Provide original requirements and context
- **Result**: Agent recreates artifact

#### Option C: Request Artifact Recreation with Validation
- **When**: Artifact corrupted or invalid
- **Action**: Route to agent with validation requirements
- **Context**: Provide original requirements + validation errors
- **Result**: Agent recreates artifact with validation

#### Option D: Correct Artifact Path
- **When**: Artifact exists but at wrong path
- **Action**: Update artifact registry with correct path
- **Validation**: Verify artifact accessible at new path
- **Result**: Artifact path corrected

## Artifact Recreation Process

### Step 1: Identify Original Agent
- Determine which agent created original artifact
- Check artifact registry for agent assignment
- Verify agent still available

### Step 2: Provide Context
- **Original Requirements**: Task requirements from original step
- **Previous Artifacts**: All artifacts from previous steps
- **Error Details**: If artifact corrupted, include validation errors
- **Constraints**: Technical/business constraints

### Step 3: Request Recreation
- Route to original agent (or appropriate fallback)
- Provide full context
- Request artifact recreation
- Specify validation requirements

### Step 4: Validate Recreated Artifact
- Run schema validation
- Run gate validation
- Verify artifact structure
- Verify artifact content

### Step 5: Register Artifact
- Register in artifact registry
- Update validation status
- Update dependencies
- Save to file system

## Recovery Validation Checklist

### Artifact Detection
- [ ] Missing artifact identified correctly
- [ ] Artifact registry checked
- [ ] File system checked
- [ ] Validation status checked

### Recovery Strategy
- [ ] Recovery strategy determined appropriately
- [ ] Previous step status verified
- [ ] Recovery option selected correctly

### Artifact Recreation
- [ ] Original agent identified
- [ ] Context provided correctly
- [ ] Artifact recreated successfully
- [ ] Artifact validated

### Registry Update
- [ ] Artifact registered in registry
- [ ] Validation status updated
- [ ] Dependencies updated
- [ ] Path verified

### Workflow Continuation
- [ ] Workflow continues from recovery point
- [ ] No duplicate work performed
- [ ] Final outputs complete
- [ ] Recovery validation passes

## Test Scenarios

### Scenario 1: Deleted Artifact Recovery
- Artifact `prd.json` deleted from file system
- Next step detects missing artifact
- System requests artifact recreation
- PM recreates `prd.json`
- Validation passes, workflow continues

### Scenario 2: Corrupted Artifact Recovery
- Artifact `system-architecture.json` corrupted (invalid JSON)
- Next step detects corrupted artifact
- System requests artifact recreation with validation
- Architect recreates artifact
- Validation passes, workflow continues

### Scenario 3: Missing Artifact from Failed Step
- Previous step failed to create artifact
- Next step detects missing artifact
- System re-runs previous step
- Previous step completes successfully
- Artifact created, workflow continues

### Scenario 4: Incorrect Artifact Path
- Artifact exists but at wrong path
- Next step cannot find artifact
- System detects path mismatch
- Corrects artifact path in registry
- Verifies artifact accessible
- Workflow continues

### Scenario 5: Artifact Recreation Failure
- Artifact recreation attempted
- Recreation fails (agent unavailable, context insufficient)
- System escalates to fallback agent
- Fallback agent recreates artifact
- Validation passes, workflow continues

