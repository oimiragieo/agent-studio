# CUJ-037: Multi-Phase Project Execution

## User Goal

Test hierarchical planning with phase boundaries for large projects (>3000 lines), ensuring master plan and phase plans are structured correctly and only active phase plans are loaded.

## Trigger

- "Plan large project with phases"
- "Test multi-phase execution"
- "Validate phase boundaries"

## Workflow

**Execution Mode**: `greenfield-fullstack.yaml`

### Step 0: Planning Phase (Hierarchical)

- Planner analyzes large project requirements (>3000 lines)
- Detects project exceeds phase boundary threshold (3000 lines)
- Organizes project into logical phases based on:
  - Dependencies between features/components
  - Logical separation (frontend/backend, features)
  - File count and complexity
- Creates hierarchical plan structure:
  - **Master Plan** (`plan-{{workflow_id}}.md`): <5KB overview
    - Lists all phases with status
    - Location of each phase plan document
    - Overall progress tracking
  - **Phase Plans** (`plan-{{workflow_id}}-phase-{n}.json`): <20KB each
    - Tasks for this phase only
    - Agent assignments, dependencies, test requirements
    - Artifacts, status tracking
- Validates phase organization:
  - Each phase 1-3k lines of code
  - Phase boundaries align with feature boundaries
  - Dependencies respected (earlier phases before later phases)

### Step 0.1: Plan Rating Gate

- Agent: orchestrator
- Type: validation
- Skill: response-rater
- Validates plan quality (minimum score: 7/10)
- Rubric: completeness, feasibility, risk mitigation, agent coverage, integration
- If score < 7: Return to Planner with feedback
- If score >= 7: Proceed to execution
- Records rating in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`

### Step 1: Phase 1 Execution

- Orchestrator loads master plan
- Identifies Phase 1 as active
- Loads only `plan-{{workflow_id}}-phase-1.json` (not all phases)
- Executes Phase 1 tasks
- Updates Phase 1 status in master plan
- Creates Phase 1 artifacts

### Step 2: Phase 2 Execution

- Orchestrator checks master plan
- Identifies Phase 2 as next active phase
- Verifies Phase 1 dependencies are satisfied
- Loads only `plan-{{workflow_id}}-phase-2.json`
- Executes Phase 2 tasks
- Updates Phase 2 status in master plan
- Creates Phase 2 artifacts

### Step 3: Phase N Execution

- Continues for remaining phases
- Each phase loads only its own plan document
- Master plan updated with progress
- Dependencies verified before each phase

### Step 4: Phase Boundary Validation

- Verify master plan is <5KB
- Verify each phase plan is <20KB
- Confirm only active phase loaded (not all phases)
- Validate phase dependencies are correct
- Check phase boundaries are logical

## Agents Used

- Planner (hierarchical planning)
- Orchestrator (phase execution coordination)
- [Other agents as specified in phase plans]

## Skills Used

- `plan-generator` - Hierarchical plan creation
- `dependency-analyzer` - Dependency analysis for phase organization
- `response-rater` - Plan quality validation

## Capabilities/Tools Used

- Phase boundary detection (planner capability)

## Expected Outputs

- `plan-{{workflow_id}}.md` - Master plan (<5KB)
- `plan-{{workflow_id}}-phase-1.json` - Phase 1 plan (<20KB)
- `plan-{{workflow_id}}-phase-2.json` - Phase 2 plan (<20KB)
- `plan-{{workflow_id}}-phase-N.json` - Additional phase plans (<20KB each)
- Phase execution artifacts
- Phase boundary validation report

## Success Criteria

| Criterion                         | Measurement                     | Target                                                                            |
| --------------------------------- | ------------------------------- | --------------------------------------------------------------------------------- |
| Project identified as multi-phase | Project size analysis           | >3000 lines correctly identified                                                  |
| Plan rating                       | response-rater skill score      | >= 7/10 (recorded in `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`) |
| Rating recorded                   | Rating file exists in run state | File present at `.claude/context/runs/<run_id>/plans/<plan_id>-rating.json`       |
| Phases organized logically        | Phase organization validation   | Dependencies, features, complexity considered                                     |
| Master plan size                  | Master plan file size           | <5KB                                                                              |
| Phase plan sizes                  | Phase plan file sizes           | Each phase plan <20KB                                                             |
| Active phase loading              | Context loading validation      | Only active phase loaded during execution                                         |
| Phase dependencies respected      | Dependency validation           | Dependencies satisfied before phase execution                                     |
| Master plan updated               | Plan status tracking            | Phase progress tracked in master plan                                             |
| Phase boundaries align            | Feature alignment validation    | Boundaries align with feature boundaries                                          |
| Phase code size                   | Code line count                 | Each phase contains 1-3k lines                                                    |

## Example Prompts

```
"Plan a large e-commerce platform with multiple phases"
"Test multi-phase project execution"
"Validate phase boundaries for a 5000-line project"
```

## Related Documentation

- [Planner Agent](../../agents/planner.md) - Hierarchical Plan Document Creation
- [PLANNER_CENTRIC_ARCHITECTURE.md](../../docs/PLANNER_CENTRIC_ARCHITECTURE.md)
- [Orchestrator Agent](../../agents/orchestrator.md) - Multi-Phase Execution

## Error Recovery

### Retry Strategy

- **Max Retries**: 3 attempts per step
- **Backoff**: Exponential (1s, 2s, 4s)
- **Retry Triggers**: Transient failures, timeouts, rate limits

### Rollback Procedures

1. **Partial Completion**: Save checkpoint to `.claude/context/runs/{{run_id}}/checkpoint.json`
2. **Failed Validation**: Return to previous passing gate (rollback to previous phase if needed)
3. **Critical Failure**: Escalate to human with full context

### Fallback Options

- **Alternative Agent**: If primary agent fails 3x, route to backup agent
  - Planner → Architect (phase planning fallback)
  - Orchestrator → Planner (coordination fallback)
- **Manual Override**: User can force-proceed with documented risks
- **Graceful Degradation**: Continue with partial phase completion (defer failed tasks to next phase)

### Recovery Artifacts

- Error log: `.claude/context/runs/{{run_id}}/errors.log`
- Recovery state: `.claude/context/runs/{{run_id}}/recovery-state.json`
- Checkpoint: `.claude/context/runs/{{run_id}}/checkpoint.json`
- Phase state: `.claude/context/runs/{{run_id}}/phase-state.json`

## Phase Organization Rules

### Phase Boundary Detection

- **Threshold**: 3000 lines of code triggers phase organization
- **Organization Criteria**:
  - Dependencies between features/components
  - Logical separation (frontend/backend, features)
  - File count and complexity
- **Phase Size**: Each phase should contain 1-3k lines of code
- **Dependency Order**: Earlier phases must complete before later phases

### Master Plan Structure

- High-level overview with phases
- Simple list of all phases with status
- Location of each phase plan document
- Overall progress tracking
- Must be <5KB for easy ingestion

### Phase Plan Structure

- Tasks for this phase only
- Agent assignments, dependencies, test requirements
- Artifacts, status tracking
- Each phase plan <20KB (prevents context overload)
