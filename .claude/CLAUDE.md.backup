# LLM Rules Production Pack

## Overview
- **Type**: Multi-platform agent configuration bundle
- **Stack**: Claude Code, Cursor, Factory Droid with shared rule base
- **Agents**: 22 specialized agents with defined roles
- **Skills**: 41 utility skills (34 native + 7 MCP-converted) for rule management, code generation, and tool execution
- **Rules**: 1,081+ technology-specific rule packs (8 master + 1,073 archive)
- **Rule Index**: Dynamic discovery system for all rules via `.claude/context/rule-index.json`

This CLAUDE.md is authoritative. Subdirectories extend these rules.

Claude Code has unique capabilities that set it apart from generic agent configurations:

1. **Strict Instruction Hierarchy**: CLAUDE.md content is treated as **immutable system rules** with strict priority over user prompts
2. **Hierarchical Memory System**: Reads CLAUDE.md files recursively UP from CWD to root, AND discovers them in subdirectories
3. **Hooks System**: Lifecycle hooks (PreToolUse, PostToolUse, UserPromptSubmit, Notification, Stop) for deterministic automation
4. **Model Context Protocol (MCP)**: Native integration with external tools, databases, and APIs
5. **Custom Slash Commands**: Repeatable workflows stored in `.claude/commands/`
6. **Subagents**: Specialized agents with isolated context windows and tool permissions
7. **Extended Thinking**: Can use long-form reasoning with extended context windows (1M+ tokens)

### Core Principles for CLAUDE.md

1. **CLAUDE.md is AUTHORITATIVE** - Treated as system rules, not suggestions
2. **Modular Sections** - Use clear markdown headers to prevent instruction bleeding
3. **Front-load Critical Context** - Large CLAUDE.md files provide better instruction adherence
4. **Hierarchical Strategy**: Root = universal rules; Subdirs = specific context
5. **Token Efficiency Through Structure** - Use sections to keep related instructions together
6. **Living Documentation** - Use `#` key during sessions to add memories organically

## Model Identity

The assistant is Claude, created by Anthropic. The current model is Claude Sonnet 4.5 (for sonnet agents), Claude Opus 4.5 (for opus agents), or Claude Haiku 4.5 (for haiku agents).

When an LLM is needed, please default to Claude Sonnet 4.5 unless the user requests otherwise. The exact model string for Claude Sonnet 4.5 is `claude-sonnet-4-20250514`.

## Communication Style

Claude 4.5 models have a more concise and natural communication style:
- More direct and grounded: Provides fact-based progress reports rather than self-celebratory updates
- More conversational: Slightly more fluent and colloquial, less machine-like
- Less verbose: May skip detailed summaries for efficiency unless prompted otherwise

If you want Claude to provide updates as it works, add: "After completing a task that involves tool use, provide a quick summary of the work you've done."

## Response Formatting

Control output formatting by:
1. Telling Claude what to do instead of what not to do
   - Instead of: "Do not use markdown in your response"
   - Try: "Your response should be composed of smoothly flowing prose paragraphs"
2. Using XML format indicators
   - Try: "Write the prose sections of your response in <smoothly_flowing_prose_paragraphs> tags"
3. Matching your prompt style to the desired output style
4. Providing detailed prompts for specific formatting preferences

## Agents (23 Roles)

| Agent | Purpose | Model |
|-------|---------|-------|
| **Core Development** | | |
| orchestrator | Task routing and coordination | opus |
| model-orchestrator | Multi-model routing (Gemini, Cursor, etc.) | sonnet |
| analyst | Research and discovery | sonnet |
| pm | Product requirements, backlog, agile facilitation | sonnet |
| architect | System design, API design | opus |
| database-architect | Schema design, query optimization, migrations | opus |
| developer | Code implementation | sonnet |
| qa | Quality assurance and testing | opus |
| ux-expert | Interface design and UX | sonnet |
| **Enterprise** | | |
| security-architect | Security and compliance | opus |
| devops | Infrastructure, SRE, release management | sonnet |
| technical-writer | Documentation | haiku |
| **Code Quality** | | |
| code-reviewer | Systematic code review, PR analysis | opus |
| refactoring-specialist | Code transformation, tech debt reduction | opus |
| performance-engineer | Performance optimization, profiling | opus |
| **Specialized** | | |
| llm-architect | AI/LLM system design, RAG, prompt engineering | opus |
| api-designer | REST/GraphQL/gRPC API design | opus |
| legacy-modernizer | Legacy system modernization | opus |
| mobile-developer | iOS/Android/React Native/Flutter | sonnet |
| accessibility-expert | WCAG compliance, a11y testing | sonnet |
| compliance-auditor | GDPR/HIPAA/SOC2/PCI-DSS | opus |
| incident-responder | Crisis management, post-mortems | sonnet |

## Skills (41 Utilities)

Skills extend agent capabilities with 90%+ context savings vs MCP servers. Invoke with natural language or the Skill tool.

| Skill | Purpose | Location |
|-------|---------|----------|
| **Core Skills** | | |
| repo-rag | Codebase retrieval and symbol indexing | `.claude/skills/repo-rag/` |
| artifact-publisher | Publish artifacts to project feed | `.claude/skills/artifact-publisher/` |
| context-bridge | Sync state across Claude, Cursor, Factory | `.claude/skills/context-bridge/` |
| rule-auditor | Validate code against loaded rules | `.claude/skills/rule-auditor/` |
| rule-selector | Auto-detect stack and configure rules | `.claude/skills/rule-selector/` |
| scaffolder | Generate rule-compliant boilerplate | `.claude/skills/scaffolder/` |
| **Memory & Context** | | |
| memory-manager | Dual persistence (CLAUDE.md + Memory Tool) | `.claude/skills/memory-manager/` |
| memory | Knowledge graph storage (entities, relations, observations) | `.claude/skills/memory/` |
| **Document Generation** | | |
| excel-generator | Generate Excel workbooks with formulas and charts | `.claude/skills/excel-generator/` |
| powerpoint-generator | Generate PowerPoint presentations | `.claude/skills/powerpoint-generator/` |
| pdf-generator | Generate PDF documents | `.claude/skills/pdf-generator/` |
| **Evaluation & Analysis** | | |
| evaluator | Evaluate agent performance and rule compliance | `.claude/skills/evaluator/` |
| classifier | Classify code, documents, and data | `.claude/skills/classifier/` |
| summarizer | Generate summaries of documents and code | `.claude/skills/summarizer/` |
| **Database & Query** | | |
| text-to-sql | Convert natural language to SQL queries | `.claude/skills/text-to-sql/` |
| **Tool Management** | | |
| tool-search | Semantic tool search with embeddings | `.claude/skills/tool-search/` |
| mcp-converter | Convert MCP servers to Skills | `.claude/skills/mcp-converter/` |
| skill-manager | Create, validate, and manage Skills | `.claude/skills/skill-manager/` |
| **Code Generation** | | |
| claude-md-generator | Auto-generates claude.md files for modules | `.claude/skills/claude-md-generator/` |
| plan-generator | Creates structured plans from requirements | `.claude/skills/plan-generator/` |
| diagram-generator | Generates architecture/database diagrams | `.claude/skills/diagram-generator/` |
| test-generator | Generates test code from specifications | `.claude/skills/test-generator/` |
| api-contract-generator | Generate OpenAPI/Swagger schemas | `.claude/skills/api-contract-generator/` |
| dependency-analyzer | Analyzes and updates dependencies | `.claude/skills/dependency-analyzer/` |
| doc-generator | Generates comprehensive documentation | `.claude/skills/doc-generator/` |
| **Validation** | | |
| code-style-validator | Validates code style compliance | `.claude/skills/code-style-validator/` |
| commit-validator | Validates commit messages and format | `.claude/skills/commit-validator/` |
| response-rater | Rate responses with headless AI CLIs | `.claude/skills/response-rater/` |
| **MCP-Converted Skills** | | |
| sequential-thinking | Structured problem solving with revision | `.claude/skills/sequential-thinking/` |
| filesystem | File system operations (read, write, list) | `.claude/skills/filesystem/` |
| git | Git operations (status, diff, commit, branch) | `.claude/skills/git/` |
| github | GitHub API (repos, issues, PRs, actions) | `.claude/skills/github/` |
| puppeteer | Browser automation with Puppeteer | `.claude/skills/puppeteer/` |
| chrome-devtools | Chrome DevTools for debugging and performance | `.claude/skills/chrome-devtools/` |

### Skill Invocation

**Natural Language** (recommended):
```
"Audit src/components/ for rule violations"
"Scaffold a new UserProfile component"
"Select the right rules for this project"
"Search for authentication patterns"
```

**Skill Tool** (programmatic):
```
Skill: rule-auditor
Skill: scaffolder
Skill: rule-selector
```

### Skill Integration Points

| Workflow Stage | Skill | Purpose |
|----------------|-------|---------|
| Project Setup | rule-selector | Configure optimal rules for tech stack |
| Code Generation | scaffolder | Generate rule-compliant boilerplate |
| Implementation | repo-rag | Search codebase for patterns |
| Code Review | rule-auditor | Validate compliance before commit |
| Cross-Platform | context-bridge | Sync state to Cursor/Factory |
| Documentation | artifact-publisher | Publish to project feed |

See `.claude/skills/` for detailed skill workflows.

### MCP-Converted Skills

MCP servers have been converted to Skills for 90%+ context savings using progressive disclosure:

| Skill | Original MCP | Context Savings | Tools |
|-------|-------------|-----------------|-------|
| sequential-thinking | `@modelcontextprotocol/server-sequential-thinking` | ~97% | 1 |
| filesystem | `@modelcontextprotocol/server-filesystem` | ~90% | 11 |
| git | `@modelcontextprotocol/server-git` | ~90% | 15 |
| github | `@modelcontextprotocol/server-github` | ~95% | 30+ |
| puppeteer | `@modelcontextprotocol/server-puppeteer` | ~90% | 8 |
| memory | `@modelcontextprotocol/server-memory` | ~95% | 9 |
| chrome-devtools | `chrome-devtools-mcp@latest` | ~93% | 26 |

**Why Convert MCP to Skills?**
- **MCP Mode**: All tool definitions loaded at startup (~10-50k tokens)
- **Skill Mode**: ~100-500 tokens metadata + on-demand loading
- **Execution**: Tools run outside context window

**When to Use Skills vs MCP:**
- **Use Skills** when: Many tools (10+), most unused per conversation, context is limited
- **Use MCP** when: 1-5 tools, always needed, complex OAuth/persistent connections

**Converting More MCP Servers:**
```
"Convert the postgres MCP server to a Skill"
```
See `.claude/skills/mcp-converter/SKILL.md` for batch conversion.

## Rule Index System

The rule index enables Skills to discover all 1,081+ rules dynamically without hard-coding. This system uses progressive disclosure to minimize context usage.

### How It Works

1. **Index Generation**: Run `pnpm index-rules` to scan all rules and generate `.claude/context/rule-index.json`
2. **Rule Discovery**: Skills load the index and query `technology_map` to find relevant rules
3. **Progressive Disclosure**: Only relevant rules are loaded (5-10 rules), not all 1,081
4. **Dynamic Updates**: Adding new rules requires regenerating the index, not changing skill code

### Index Structure

The index contains:
- **Metadata**: Path, name, description, technologies for each rule
- **Technology Map**: Fast lookup of rules by technology (e.g., `nextjs`, `python`, `cypress`)
- **Rule Types**: Master rules (`.claude/rules-master/`) vs Archive rules (`.claude/archive/`)

### Regenerating the Index

When rules are added or updated:
```bash
pnpm index-rules
```

This scans all rules and updates `.claude/context/rule-index.json`. All Skills automatically discover new rules without code changes.

### Skills Using the Index

- **explaining-rules**: Discovers rules applicable to files
- **fixing-rule-violations**: Locates violated rules for fix instructions
- **recommending-rules**: Compares codebase against all indexed rules
- **migrating-rules**: Compares rule versions for migration plans
- **rule-auditor**: Finds applicable rules for auditing
- **rule-selector**: Discovers rules for tech stack configuration
- **scaffolder**: Finds relevant rules for code generation

See `.claude/docs/RULE_INDEX_MIGRATION.md` for detailed migration guide.

## Master Orchestrator Entry Point

**NEW: All user requests are routed through the Master Orchestrator first**

The Master Orchestrator (`.claude/agents/master-orchestrator.md`) is the single entry point for all user requests. It provides a seamless, infinite flow experience by managing the entire project lifecycle without user-visible interruptions.

### Master Orchestrator Flow

When a user prompt is received:

1. **Route to Master Orchestrator**: All requests go to Master Orchestrator first
2. **Spawn Planner**: Master Orchestrator spawns Planner to scope the work
3. **Review Plan**: Master Orchestrator reviews the plan for completeness
4. **Dynamic Workflow Instantiation**: Master Orchestrator dynamically creates or selects workflows based on plan
5. **Coordinate Execution**: Master Orchestrator delegates to specialized agents via Task tool
6. **Monitor Progress**: Master Orchestrator tracks progress via Project Database
7. **Update Dashboard**: Master Orchestrator maintains live dashboard.md artifact

### Backward Compatibility

The legacy workflow routing system (below) is still available as a fallback, but Master Orchestrator is the preferred entry point.

## Workflow Routing System (Legacy - Fallback)

The workflow routing system automatically selects and executes predefined workflows based on user prompts, ensuring consistent multi-agent coordination for complex tasks.

**Note**: This system is now a fallback. Master Orchestrator is the primary entry point.

### Automatic Workflow Selection

When a user prompt is received (fallback mode), follow this process:

1. **Load Configuration**: Read `.claude/config.yaml` and extract the `workflow_selection` section
2. **Keyword Matching**: 
   - Extract keywords from the user prompt (case-insensitive)
   - Match against each workflow's `keywords` array in `config.yaml`
   - Count matches for each workflow
3. **Priority Selection**: 
   - Among workflows with matches, select the one with the **lowest priority number** (0 = highest priority, 1 = high, 2 = medium, 3 = low)
   - **Example**: If both `incident` (priority 0) and `fullstack` (priority 2) match, select `incident` because 0 < 2
   - If no matches, use the `default_workflow` from `intelligent_routing` section (typically `fullstack`)
4. **Workflow Execution**: 
   - Load the workflow YAML file from the path specified in `workflow_file` (resolved from project root)
   - Execute steps sequentially starting with Step 0 (Planner)

### Workflow Selection Example

**User Prompt**: "Build a new authentication feature from scratch"

**Matching Process**:
- Keywords detected: "new", "from scratch"
- Matches `fullstack` workflow (keywords: "new project", "from scratch", "greenfield")
- Priority: 2 (medium priority)
- Selected: `fullstack` workflow
- Loads: `.claude/workflows/greenfield-fullstack.yaml` (resolved from project root)

**Example with Multiple Matches**:
**User Prompt**: "Fix the production incident with the authentication system"

**Matching Process**:
- Keywords detected: "incident", "production" (matches both `incident` and `fullstack`)
- `incident` workflow: 2 keyword matches, priority 0 (highest)
- `fullstack` workflow: 1 keyword match, priority 2
- Selected: `incident` workflow (lowest priority number = highest priority)
- Loads: `.claude/workflows/incident-flow.yaml`

### Workflow Execution Process

Once a workflow is selected:

1. **Read Workflow YAML**: Load the workflow file from the path specified in `config.yaml`'s `workflow_file` field (e.g., `.claude/workflows/<workflow-name>.yaml`). The path is resolved relative to the project root, not the current working directory.
2. **Execute Steps Sequentially**:
   - For each step in the `steps` array:
     - Activate the specified agent (load agent definition from `.claude/agents/<agent>.md`)
     - Load agent's context files (from `config.yaml` agent_routing section)
     - Pass inputs from previous steps (read artifacts from `.claude/context/artifacts/`)
     - Execute agent's task
     - Collect outputs as artifacts (save to `.claude/context/artifacts/`)
     - Validate against schema (if `validation.schema` is specified)
3. **Quality Gates**: After each step, run validation:
   ```bash
   node .claude/tools/workflow_runner.js --workflow .claude/workflows/<name>.yaml --step <N> --id <workflow_id> [--story-id <id>] [--epic-id <id>]
   ```
   - Validates output against JSON schema
   - Creates gate file in `.claude/context/history/gates/<workflow_id>/<step>-<agent>.json`
4. **Context Passing**: 
   - Save each agent's outputs to `.claude/context/artifacts/`
   - Next agent reads previous agent's artifacts as inputs
   - Maintain workflow session state in `.claude/context/session.json`

### Workflow Execution Flow

**Complete Flow Diagram:**

```mermaid
flowchart TD
    Start[User Prompt] --> LoadConfig[Load config.yaml]
    LoadConfig --> ExtractKeywords[Extract Keywords from Prompt]
    ExtractKeywords --> MatchWorkflows[Match Keywords Against Workflow Keywords]
    MatchWorkflows --> CountMatches[Count Matches per Workflow]
    CountMatches --> SelectWorkflow{Select Workflow}
    SelectWorkflow -->|Matches Found| PrioritySelect[Select Lowest Priority Number]
    SelectWorkflow -->|No Matches| DefaultWorkflow[Use Default: fullstack]
    PrioritySelect --> LoadYAML[Load Workflow YAML File]
    DefaultWorkflow --> LoadYAML
    
    LoadYAML --> InitSession[Initialize Workflow Session]
    InitSession --> ExecuteSteps[Execute Steps Sequentially]
    
    ExecuteSteps --> Step0[Step 0: Planner Creates Plan]
    Step0 --> Validate0[Validate Plan with workflow_runner.js]
    Validate0 -->|Pass| StepN[Step 1-N: Execute Workflow Steps]
    Validate0 -->|Fail| Retry0[Retry Step 0 with Feedback]
    Retry0 --> Validate0
    
    StepN --> ActivateAgent[Activate Agent from .claude/agents/]
    ActivateAgent --> LoadContext[Load Agent Context Files from config.yaml]
    LoadContext --> PassInputs[Load Previous Step Artifacts]
    PassInputs --> ExecuteTask[Execute Agent Task with Tools]
    ExecuteTask --> SaveOutputs[Save Artifacts to .claude/context/artifacts/]
    SaveOutputs --> Validate[Validate with workflow_runner.js]
    Validate -->|Pass| NextStep{More Steps?}
    Validate -->|Fail| Retry[Retry Step with Feedback]
    Retry --> ExecuteTask
    NextStep -->|Yes| StepN
    NextStep -->|No| Complete[Workflow Complete]
    
    style Start fill:#e1f5ff
    style Complete fill:#d4edda
    style Validate0 fill:#fff3cd
    style Validate fill:#fff3cd
    style Retry0 fill:#f8d7da
    style Retry fill:#f8d7da
```

**Key Execution Steps Explained:**

1. **Prompt Analysis**: System extracts keywords from user prompt
2. **Workflow Matching**: Keywords matched against `workflow_selection` in `config.yaml`
3. **Priority Selection**: Among matching workflows, select lowest priority number (0 = highest priority)
4. **Default Fallback**: If no matches, use `default_workflow` (typically `fullstack`)
5. **Session Initialization**: Create unique workflow ID and session directory
6. **Step Execution**: For each step (0-N):
   - Load agent definition from `.claude/agents/<agent>.md`
   - Load agent context files from `config.yaml`
   - Pass inputs from previous steps (artifacts from `.claude/context/artifacts/`)
   - Execute agent task
   - Save outputs as artifacts
   - Validate with `workflow_runner.js` (checks schema if provided, always creates gate file)
7. **Error Handling**: If validation fails, provide feedback and retry (max 3 attempts)
8. **Completion**: All steps validated successfully

### Manual Workflow Execution

To manually execute a workflow:

1. **Select Workflow**: Choose from available workflows in `config.yaml`
2. **Initialize Session**: Create workflow session ID
3. **Execute Steps**: For each step:
   - Read step configuration from YAML
   - Activate agent with proper context
   - Execute and collect outputs
   - Validate with `workflow_runner.js`
4. **Handle Failures**: If validation fails:
   - Review error feedback
   - Provide feedback to agent
   - Retry step or adjust approach

### Workflow Validation

Each workflow step can specify validation:

```yaml
validation:
  schema: .claude/schemas/project_brief.schema.json
  gate: .claude/context/history/gates/{{workflow_id}}/01-analyst.json
```

Validation process:
1. Run `workflow_runner.js` with step number
2. Script loads schema and validates output JSON
3. Creates gate file with validation results
4. If validation fails, agent receives feedback for correction

### Template Variables

Workflow artifacts and paths support template variable interpolation:

**Supported Variables:**
- `{{workflow_id}}`: Unique identifier for the workflow run (required, passed via `--id`)
- `{{story_id}}`: Story identifier for story loop iterations (optional, passed via `--story-id`)
- `{{epic_id}}`: Epic identifier for epic loop iterations (optional, passed via `--epic-id`)

**Usage in Artifacts:**
```yaml
outputs:
  - plan-{{workflow_id}}.json
  - story-{{story_id}}-implementation.json
  - epic-{{epic_id}}-summary.json
```

**Usage in Gate Paths:**
```yaml
validation:
  gate: .claude/context/history/gates/{{workflow_id}}/01-analyst.json
```

**Interpolation Behavior:**
- Variables are replaced with actual values when artifacts are created or paths are resolved
- **Required Variables**: `{{workflow_id}}` must be provided via `--id` or execution will fail
- **Optional Variables**: If `{{story_id}}` or `{{epic_id}}` are not provided, they remain as-is in the artifact name (e.g., `story-{{story_id}}.json` without `--story-id` becomes `story-{{story_id}}.json`)
  - Missing optional variables generate warnings but don't block execution
  - Un-interpolated optional variables may cause path resolution issues if not handled properly
- Template variables are case-sensitive and must use double curly braces

**Error Handling:**
- **Missing Required Variables**: The `{{workflow_id}}` variable is required. If not provided via `--id`, `workflow_runner.js` will exit with an error code and display an error message
- **Invalid Variable Syntax**: Variables must use double curly braces `{{variable_name}}`. Single braces or missing braces will not be interpolated
- **Case Sensitivity**: `{{workflow_id}}` and `{{WORKFLOW_ID}}` are different variables. Always use lowercase with underscores
- **Troubleshooting Common Errors**:
  - **Error: "Missing workflow_id"**: Ensure `--id <workflow-id>` is provided to workflow_runner.js
  - **Artifacts contain literal `{{workflow_id}}`**: Variable was not interpolated - check that `--id` was provided
  - **Gate path not found**: Verify workflow_id was correctly interpolated in the gate path
  - **Variable not replaced**: Check for typos in variable names (case-sensitive) and ensure double curly braces are used

**Example Command:**
```bash
node .claude/tools/workflow_runner.js \
  --workflow .claude/workflows/greenfield-fullstack.yaml \
  --step 1 \
  --id my-workflow-123 \
  --story-id story-456 \
  --epic-id epic-789
```

This will interpolate:
- `plan-{{workflow_id}}.json` → `plan-my-workflow-123.json`
- `story-{{story_id}}-implementation.json` → `story-story-456-implementation.json`
- Gate path: `.claude/context/history/gates/my-workflow-123/01-analyst.json`

## Workflow Execution Instructions

### Reading Workflow YAML Files

Workflow files are structured YAML with the following sections:

- **name**: Human-readable workflow name
- **description**: What the workflow accomplishes
- **type**: Workflow category (greenfield, brownfield, etc.)
- **steps**: Array of step definitions, each containing:
  - `step`: Step number
  - `name`: Step description
  - `agent`: Agent to activate
  - `inputs`: Required inputs (can reference previous step outputs)
  - `outputs`: Expected output artifacts
  - `validation`: Schema and gate file paths

**Example Step Structure**:
```yaml
- step: 1
  name: "Project Discovery"
  agent: analyst
  inputs:
    - user_requirements
    - business_objectives
  outputs:
    - project_brief.json
    - reasoning.json
  validation:
    schema: .claude/schemas/project_brief.schema.json
    gate: .claude/context/history/gates/{{workflow_id}}/01-analyst.json
```

### Executing Steps Sequentially

**Step-by-Step Execution**:

1. **Initialize Workflow Session**:
   - Generate unique workflow ID (UUID or timestamp-based)
   - Create session directory: `.claude/context/history/gates/<workflow_id>/`
   - Initialize session state in `.claude/context/session.json`

2. **For Each Step**:
   - **Activate Agent**: Load agent definition from `.claude/agents/<agent>.md`
   - **Load Context**: Load agent's context files from `config.yaml` (e.g., rules-master files)
   - **Prepare Inputs**: 
     - Read artifacts from previous steps (from `.claude/context/artifacts/`)
     - Resolve input references (e.g., `project_brief.json (from step 1)`)
     - Pass inputs to agent as context
   - **Execute Task**: Agent performs its work using available tools
   - **Collect Outputs**: 
     - Save outputs to `.claude/context/artifacts/<output-name>.json`
     - Save reasoning/logs to `.claude/context/history/reasoning/`
   - **Validate Output**: Run validation if schema is specified

3. **Context Passing Between Steps**:
   - Each agent's outputs become available to subsequent agents
   - Reference outputs using format: `<artifact-name>.json (from step N)`
   - Artifacts are JSON files with structured data matching schemas

### Validating with workflow_runner.js

The `workflow_runner.js` script validates workflow step outputs:

**Command Syntax**:
```bash
node .claude/tools/workflow_runner.js \
  --workflow .claude/workflows/<workflow-name>.yaml \
  --step <step-number> \
  --id <workflow-id>
```

**What It Does**:
1. Loads workflow YAML and finds the specified step
2. Reads the validation schema (if specified)
3. Loads the output artifact from `.claude/context/artifacts/`
4. Validates JSON structure against schema
5. Creates gate file with validation results
6. Returns exit code 0 (success) or 1 (failure)

**Gate File Structure**:
Gate files are created at the path specified in `validation.gate`:
- Contains validation status (pass/fail)
- Lists any schema violations
- Includes error messages for failures
- Timestamp and workflow metadata

### Error Handling and Retry Logic

**When Validation Fails**:

1. **Read Gate File**: Load the gate file to understand failures
2. **Analyze Errors**: Identify specific schema violations or missing fields
3. **Provide Feedback**: Give agent clear feedback about what needs correction
4. **Retry Step**: 
   - Agent receives feedback and corrects output
   - Re-validate with `workflow_runner.js`
   - Repeat until validation passes or max retries (3 recommended)

**Retry Strategy**:
- **First Retry**: Agent corrects based on validation errors
- **Second Retry**: If still failing, provide more detailed guidance
- **Third Retry**: If still failing, consider adjusting schema or workflow step definition

**Workflow Continuation**:
- Only proceed to next step after current step validates successfully
- If step fails after max retries, pause workflow and request user guidance
- Save workflow state to allow resumption later

### Workflow State Management

**Session State** (`session.json`):
```json
{
  "workflow_id": "uuid-here",
  "workflow_name": "greenfield-fullstack",
  "current_step": 3,
  "status": "in_progress",
  "started_at": "2025-01-XX...",
  "artifacts": {
    "project_brief": ".claude/context/artifacts/project-brief.json",
    "prd": ".claude/context/artifacts/prd.json"
  }
}
```

**Resuming Workflows**:
- Load session state from `session.json`
- Identify current step
- Continue from where workflow paused
- Re-validate previous steps if needed

## Universal Development Rules

### Code Quality (MUST)
- **MUST** create a Plan Mode artifact before modifying more than one file
- **MUST** generate or update automated tests covering critical paths before requesting merge
- **MUST** keep security controls (authz, secrets, PII) unchanged unless explicitly tasked
- **MUST** document decisions in Artifacts or repo ADRs when deviating from defaults

### Collaboration (SHOULD)
- **SHOULD** use Claude Projects instructions for shared vocabulary, business context, and tone [2].
- **SHOULD** sync Cursor and Droid executions back into the Claude Project activity feed after major milestones.
- **SHOULD** promote Artifacts to versioned documents for UI/UX deliverables.
- **SHOULD** prefer Claude's built-in repo search and diff MCP skills over manual file browsing.

### Safeguards (MUST NOT)
- **MUST NOT** delete secrets, env files, or production infrastructure manifests
- **MUST NOT** bypass lint/test hooks; rerun failed commands with context
- **MUST NOT** push directly to protected branches; use reviewed pull requests
- **MUST NOT** rely on hallucinated APIs—verify via docs or code search MCP.

## Default Action Behavior

<default_to_action>
By default, implement changes rather than only suggesting them. If the user's intent is unclear, infer the most useful likely action and proceed, using tools to discover any missing details instead of guessing. Try to infer the user's intent about whether a tool call (e.g., file edit or read) is intended or not, and act accordingly.
</default_to_action>

## Parallel Tool Execution

<use_parallel_tool_calls>
If you intend to call multiple tools and there are no dependencies between the tool calls, make all of the independent tool calls in parallel. Prioritize calling tools simultaneously whenever the actions can be done in parallel rather than sequentially. For example, when reading 3 files, run 3 tool calls in parallel to read all 3 files into context at the same time. Maximize use of parallel tool calls where possible to increase speed and efficiency. However, if some tool calls depend on previous calls to inform dependent values like the parameters, do NOT call these tools in parallel and instead call them sequentially. Never use placeholders or guess missing parameters in tool calls.
</use_parallel_tool_calls>

## Slash Commands

### Core Commands
| Command | Purpose |
|---------|---------|
| `/review` | Comprehensive code review |
| `/fix-issue <n>` | Fix GitHub issue by number |
| `/quick-ship` | Fast iteration for small changes |
| `/run-workflow` | Execute a workflow step with validation |

### Skill Commands
| Command | Purpose |
|---------|---------|
| `/select-rules` | Auto-detect tech stack and configure rules |
| `/audit` | Validate code against loaded rules |
| `/scaffold` | Generate rule-compliant boilerplate |

### Workflow Commands
| Command | Purpose |
|---------|---------|
| `/code-quality` | Code quality improvement workflow |
| `/performance` | Performance optimization workflow |
| `/ai-system` | AI/LLM system development workflow |
| `/mobile` | Mobile application workflow |
| `/incident` | Incident response workflow |

See `.claude/agents/developer.md` for common commands and workflows.

## Core Files

### Configuration
- `.claude/config.yaml`: Agent routing and workflow configuration
- `.claude/settings.json`: Tool permissions
- `CLAUDE.md`: This file (root instructions)

### Agent System
- `.claude/agents/`: 23 agent prompts
- `.claude/skills/`: 41 utility skills (34 native + 7 MCP-converted)
- `.claude/workflows/`: 11 workflow definitions (see `WORKFLOW-GUIDE.md`)
- `.claude/templates/`: 14 artifact templates
- `.claude/schemas/`: JSON validation schemas

### Templates (14 Artifacts)

| Template | Agent | Purpose |
|----------|-------|---------|
| project-brief.md | analyst | Project discovery and brief |
| prd.md | pm | Product requirements |
| architecture.md | architect | System architecture |
| ui-spec.md | ux-expert | Interface specifications |
| test-plan.md | qa | Test strategy |
| implementation-plan.md | developer | Implementation plan |
| code-review-report.md | code-reviewer | Code review findings |
| performance-plan.md | performance-engineer | Performance optimization |
| llm-architecture.md | llm-architect | AI/LLM system design |
| incident-report.md | incident-responder | Incident post-mortem |
| refactor-plan.md | refactoring-specialist | Refactoring strategy |

### Security
- `.claude/hooks/security-pre-tool.sh`: Security validation hook
- `.claude/hooks/audit-post-tool.sh`: Audit logging hook
- `.claude/system/guardrails/guardrails.md`: Command safety and PII policies
- `.claude/system/permissions/permissions.md`: Tool permission policies

## Security & Secrets Management

### Protected Operations
- **BLOCKED**: `.env*` files, `secrets/` directory, credential files
- **BLOCKED**: Dangerous commands (`rm -rf`, `sudo rm`, `mkfs`, `dd`)
- **BLOCKED**: Force push to main/master

### Tool Permissions
- **Always Allowed**: Read, Search
- **Require Confirmation**: Edit, Bash
- **Always Blocked**: Destructive operations

## Setup

1. Copy `.claude/`, `.cursor/`, `.factory/` into your project
2. Agents activate based on task keywords
3. Use slash commands for quick workflows

See `.claude/docs/setup-guides/CLAUDE_SETUP_GUIDE.md` for detailed setup and validation.

See `.claude/agents/` for agent-specific triggers and workflows.

## New Features (Cookbook Integration)

### Everlasting Agent System

**Context Window Management**: Phase-based project structure with orchestrator handoff enables unlimited project duration without context limits.

- **Phase-Based Structure**: Projects organized into phases (1-3k lines each)
- **Token Monitoring**: Continuous context usage monitoring
- **Orchestrator Handoff**: Seamless transitions at 90% threshold
- **Ephemeral Developer Agents**: Fresh context per task

See `.claude/docs/EVERLASTING_AGENTS.md` and `.claude/docs/PHASE_BASED_PROJECTS.md` for details.

### Dual Persistence (CLAUDE.md + Memory Skills)

**Redundancy Strategy**: All agents use both CLAUDE.md files and memory skills for fault tolerance and cross-conversation learning.

- **CLAUDE.md**: Static, version-controlled context (rules, standards)
- **memory skill**: Knowledge graph storage (entities, relations, observations) - converted from MCP
- **memory-manager skill**: High-level patterns for dual persistence and sync
- **Redundancy**: If one fails, the other provides backup
- **Synergy**: Both systems maintain knowledge

**Memory Skills Architecture**:
```
memory skill (low-level)          memory-manager skill (high-level)
├── create_entities               ├── Store learned patterns
├── create_relations              ├── Sync to CLAUDE.md
├── add_observations              ├── Cross-conversation learning
├── search_nodes                  └── Security validation
└── read_graph
```

See `.claude/docs/MEMORY_PATTERNS.md` and `.claude/skills/memory/SKILL.md` for details.

### Context Editing

**Automatic Context Compaction**: Automatic context management for long-running sessions.

- **Tool Use Clearing**: Clears old tool results when context grows large
- **Thinking Management**: Manages extended thinking blocks
- **Configurable Triggers**: Token-based triggers (30-40k tokens)
- **Retention Policies**: Keep recent content, clear old content

See `.claude/docs/CONTEXT_OPTIMIZATION.md` for details.

### Evaluation Framework

**Systematic Evaluation**: Evaluate agent performance, rule compliance, and workflow quality.

- **Code-Based Grading**: Exact matches, structured outputs
- **Model-Based Grading**: Subjective quality assessment
- **Human Grading**: Final validation
- **Promptfoo Integration**: Comprehensive evaluation system

See `.claude/docs/EVALUATION_GUIDE.md` for details.

### Tool Search with Embeddings

**Scalable Tool Discovery**: Semantic tool search enables thousands of tools with 90%+ context reduction.

- **On-Demand Loading**: Tools loaded only when needed
- **Embedding-Based Matching**: Semantic similarity for tool discovery
- **85% Context Reduction**: 80k → 12k tokens for MCP tools
- **Improved Accuracy**: 79.5% → 88.1% tool selection accuracy

See `.claude/skills/tool-search/SKILL.md` and `.claude/docs/ADVANCED_TOOL_USE.md` for details.

### Document Generation

**Professional Documents**: Generate Excel, PowerPoint, and PDF documents using Claude's Skills feature.

- **Excel**: Workbooks with formulas, charts, and formatting
- **PowerPoint**: Presentations with slides, charts, and transitions
- **PDF**: Formatted documents with text, tables, and images

See `.claude/docs/DOCUMENT_GENERATION.md` for details.

### Advanced Orchestration

**Subagent Patterns**: Advanced orchestration patterns from Claude Agent SDK.

- **Output Styles**: Different formats for different audiences
- **Plan Mode**: Approval before execution
- **Hooks**: Custom code after actions
- **Slash Commands**: Shortcuts for common actions

See `.claude/docs/ORCHESTRATION_PATTERNS.md` for details.

## Documentation

- **Setup Guide**: `.claude/docs/setup-guides/CLAUDE_SETUP_GUIDE.md`
- **Workflow Guide**: `.claude/workflows/WORKFLOW-GUIDE.md`
- **Enterprise Guardrails**: `.claude/system/guardrails/` and `.claude/system/permissions/`
- **Agent Details**: `.claude/agents/` (each agent has full documentation)
- **Skill Details**: `.claude/skills/` (each skill has SKILL.md documentation)
- **Instructions**: `.claude/instructions/` (operational playbooks)

## MCP Integration (Optional)

The `.claude/.mcp.json` file contains optional MCP server configurations. This project does NOT ship an MCP server - these are configs consumed by Claude Code when you set the required environment variables.

**Prefer Skills over MCP**: Most MCP servers have been converted to Skills for 90%+ context savings. Use Skills (`.claude/skills/`) instead of MCP when possible. See "MCP-Converted Skills" section above.

**When to Keep MCP**:
- Core tools needed every conversation (1-5 tools)
- Complex OAuth flows or persistent connections
- Tools not yet converted to Skills

| Server | Purpose | Skill Alternative | Environment Variable |
|--------|---------|-------------------|---------------------|
| repo | Codebase search | `repo-rag` skill | None (auto-configured) |
| github | GitHub integration | `github` skill | `GITHUB_TOKEN` |
| filesystem | File operations | `filesystem` skill | None |
| git | Git operations | `git` skill | None |
| memory | Knowledge graph | `memory` skill | None |
| linear | Linear issues | - | `LINEAR_API_KEY` |
| slack | Notifications | - | `SLACK_BOT_TOKEN` |

**Tool Search Tool (Beta)**: For projects still using many MCP tools (20+), enable Anthropic's Tool Search Tool beta feature with `deferLoading: true` in `.claude/.mcp.json`. See `.claude/docs/ADVANCED_TOOL_USE.md` for details.

## Context Management

**Lazy-Loaded Master Rules**: Master rule files are in `.claude/rules-master/` (outside `.claude/rules/` to prevent auto-loading). Reference them with `@filename` syntax for on-demand loading:

- `@.claude/rules-master/PROTOCOL_ENGINEERING.md` - Universal engineering standards
- `@.claude/rules-master/TECH_STACK_NEXTJS.md` - Next.js/React/TypeScript
- `@.claude/rules-master/TOOL_CYPRESS_MASTER.md` - Cypress testing
- `@.claude/rules-master/TOOL_PLAYWRIGHT_MASTER.md` - Playwright testing
- `@.claude/rules-master/LANG_PYTHON_GENERAL.md` - Python rules
- `@.claude/rules-master/FRAMEWORK_FASTAPI.md` - FastAPI rules
- `@.claude/rules-master/LANG_SOLIDITY.md` - Solidity rules

**Subagent Context Loading**: Rules load only when agents activate (configured in `.claude/config.yaml`). Archive rules (`.claude/archive/`) are excluded from global loading. See `.claude/docs/CONTEXT_OPTIMIZATION.md` for details.

**Session Management**: Use `/clear` between tasks, `/compact` for long sessions. Reference files with `@filename`. See `.claude/docs/CONTEXT_OPTIMIZATION.md` for best practices.

## Context Window Management

Your context window will be automatically compacted as it approaches its limit, allowing you to continue working indefinitely from where you left off. Therefore, do not stop tasks early due to token budget concerns. As you approach your token budget limit, save your current progress and state to memory before the context window refreshes. Always be as persistent and autonomous as possible and complete tasks fully, even if the end of your budget is approaching. Never artificially stop any task early regardless of the context remaining.

For tasks spanning multiple context windows:
1. Use the first context window to set up a framework (write tests, create setup scripts)
2. Use future context windows to iterate on a todo-list
3. Write tests in a structured format (e.g., `tests.json`) before starting work
4. Create setup scripts (e.g., `init.sh`) to gracefully start servers, run test suites, and linters
5. When a context window is cleared, start fresh by calling `pwd`, reviewing `progress.txt`, `tests.json`, and git logs
6. Manually run through a fundamental integration test before moving on to implementing new features

### State Management

For long-horizon tasks spanning multiple context windows:

**Use structured formats for state data**: When tracking structured information (like test results or task status), use JSON or other structured formats to help Claude understand schema requirements.

**Use unstructured text for progress notes**: Freeform progress notes work well for tracking general progress and context.

**Use git for state tracking**: Git provides a log of what's been done and checkpoints that can be restored. Claude 4.5 models perform especially well in using git to track state across multiple sessions.

**Emphasize incremental progress**: Explicitly ask Claude to keep track of its progress and focus on incremental work.

Example state files:
- `tests.json`: Structured test results
- `progress.txt`: Freeform progress notes
- Git commits: State checkpoints

## Escalation Playbook
1. Flag blockers in the Claude Project feed; attach the current artifact or plan.
2. Page the appropriate subagent (Architect vs. QA vs. PM) via Claude subagent commands.
3. If automation fails, fall back to manual CLI with the same rules and document the resolution artifact.

## References

[1] Anthropic, "Claude 3.5 Sonnet" (Jun 2024).  
[2] Anthropic, "Projects" (Jun 2024).  
[3] Cursor, "Introducing Cursor 2.0 and Composer" (Oct 29, 2025).  
[4] Cursor, "Introducing Plan Mode" (Oct 7, 2025).  
[5] Cursor, "Cloud Agents" (Oct 30, 2025).  
[6] Sid Bharath, "Factory.ai: A Guide To Building A Software Development Droid Army" (Sep 30, 2025).